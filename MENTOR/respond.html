<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>問卷填寫</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Noto Sans TC", sans-serif;
      background: #f5f5f5;
    }
    header {
      background: #1976d2;
      color: #fff;
      padding: 12px 16px;
    }
    header h1 {
      margin: 0;
      font-size: 20px;
    }
    main {
      max-width: 800px;
      margin: 16px auto 32px;
      padding: 16px;
      background: #fff;
      border-radius: 6px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.08);
    }
    h2 {
      margin-top: 0;
    }
    .hint {
      color: #666;
      font-size: 13px;
      margin-bottom: 8px;
    }
    label {
      display: block;
      font-size: 14px;
      margin-bottom: 4px;
    }
    .question {
      margin-bottom: 16px;
      padding-bottom: 12px;
      border-bottom: 1px solid #eee;
    }
    .question-title {
      font-weight: 600;
      margin-bottom: 4px;
    }
    .required {
      color: red;
      margin-left: 4px;
      font-size: 12px;
    }
    input[type="text"], textarea, select {
      width: 100%;
      padding: 6px 8px;
      border-radius: 4px;
      border: 1px solid #ccc;
      font-size: 14px;
    }
    textarea {
      resize: vertical;
    }
    .options {
      margin-top: 6px;
    }
    .options label {
      display: flex;
      align-items: center;
      gap: 6px;
      margin-bottom: 4px;
      font-weight: normal;
    }
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 8px 16px;
      border-radius: 4px;
      border: none;
      cursor: pointer;
      font-size: 14px;
      background: #1976d2;
      color: #fff;
    }
    .btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
    .error {
      color: #d32f2f;
      font-size: 13px;
      margin-top: 4px;
    }
    .success {
      color: #388e3c;
      font-size: 14px;
      margin-top: 8px;
    }
    .loading {
      font-size: 14px;
      color: #333;
    }
  </style>

  <!-- Firebase JS SDK (compat) -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
</head>
<body>
  <header>
    <h1 id="pageTitle">問卷填寫</h1>
  </header>

  <main>
    <div id="loading" class="loading">正在載入問卷…</div>
    <div id="errorBox" class="error" style="display:none;"></div>

    <div id="surveyContent" style="display:none;">
      <h2 id="surveyTitle"></h2>
      <p id="surveyDescription" class="hint"></p>
      <p class="hint" id="surveyMeta"></p>

      <form id="surveyForm"></form>

      <button class="btn" id="submitBtn">送出問卷</button>
      <div id="submitMsg"></div>
    </div>
  </main>

  <script>
    // ===== 1. 解析 URL 參數 =====
    function getQueryParam(name) {
      const urlParams = new URLSearchParams(location.search);
      return urlParams.get(name);
    }
    const surveyId = getQueryParam('surveyId');

    // ===== 2. 初始化 Firebase =====
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
      projectId: "YOUR_PROJECT_ID",
      storageBucket: "YOUR_PROJECT_ID.appspot.com",
      messagingSenderId: "YOUR_SENDER_ID",
      appId: "YOUR_APP_ID"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const serverTimestamp = firebase.firestore.FieldValue.serverTimestamp();

    const loadingEl = document.getElementById('loading');
    const errorBox = document.getElementById('errorBox');
    const surveyContent = document.getElementById('surveyContent');
    const surveyTitleEl = document.getElementById('surveyTitle');
    const surveyDescriptionEl = document.getElementById('surveyDescription');
    const surveyMetaEl = document.getElementById('surveyMeta');
    const surveyForm = document.getElementById('surveyForm');
    const submitBtn = document.getElementById('submitBtn');
    const submitMsg = document.getElementById('submitMsg');

    if (!surveyId) {
      loadingEl.style.display = 'none';
      errorBox.style.display = 'block';
      errorBox.textContent = '缺少 surveyId 參數，無法載入問卷。';
    } else {
      loadSurvey();
    }

    // ===== 3. 載入問卷 + 題目 =====
    async function loadSurvey() {
      try {
        const docRef = db.collection('surveys').doc(surveyId);
        const surveyDoc = await docRef.get();

        if (!surveyDoc.exists) {
          throw new Error('找不到這份問卷。');
        }

        const data = surveyDoc.data();

        if (data.status !== 'published') {
          throw new Error('此問卷尚未發佈或已封存，無法填寫。');
        }

        surveyTitleEl.textContent = data.title || '未命名問卷';
        surveyDescriptionEl.textContent = data.description || '';
        surveyMetaEl.textContent = [
          data.category ? `類別：${data.category}` : '',
          data.targetGroup ? `對象：${data.targetGroup}` : '',
          data.isAnonymous ? '此問卷為匿名填答' : ''
        ].filter(Boolean).join(' · ');

        const qSnap = await docRef.collection('questions')
          .orderBy('order', 'asc')
          .get();

        if (qSnap.empty) {
          throw new Error('此問卷尚未設定題目，請聯絡管理者。');
        }

        renderQuestions(qSnap.docs);

        loadingEl.style.display = 'none';
        errorBox.style.display = 'none';
        surveyContent.style.display = 'block';

      } catch (err) {
        console.error(err);
        loadingEl.style.display = 'none';
        errorBox.style.display = 'block';
        errorBox.textContent = err.message || '載入問卷時發生錯誤。';
      }
    }

    // ===== 4. 動態渲染題目 =====
    function renderQuestions(docs) {
      surveyForm.innerHTML = '';

      docs.forEach(doc => {
        const q = doc.data();
        const qId = doc.id;

        const wrapper = document.createElement('div');
        wrapper.className = 'question';

        const titleDiv = document.createElement('div');
        titleDiv.className = 'question-title';
        titleDiv.textContent = q.text || '(未命名題目)';
        if (q.required) {
          const span = document.createElement('span');
          span.className = 'required';
          span.textContent = '(必填)';
          titleDiv.appendChild(span);
        }
        wrapper.appendChild(titleDiv);

        if (q.type === 'single') {
          const container = document.createElement('div');
          container.className = 'options';
          (q.options || []).forEach(opt => {
            const label = document.createElement('label');
            const input = document.createElement('input');
            input.type = 'radio';
            input.name = qId;
            input.value = opt;
            label.appendChild(input);
            label.appendChild(document.createTextNode(opt));
            container.appendChild(label);
          });
          wrapper.appendChild(container);

        } else if (q.type === 'multiple') {
          const container = document.createElement('div');
          container.className = 'options';
          (q.options || []).forEach(opt => {
            const label = document.createElement('label');
            const input = document.createElement('input');
            input.type = 'checkbox';
            input.name = qId;
            input.value = opt;
            label.appendChild(input);
            label.appendChild(document.createTextNode(opt));
            container.appendChild(label);
          });
          wrapper.appendChild(container);

        } else if (q.type === 'scale') {
          const min = q.scaleMin || 1;
          const max = q.scaleMax || 5;

          const select = document.createElement('select');
          select.name = qId;
          for (let i = min; i <= max; i++) {
            const opt = document.createElement('option');
            opt.value = i;
            opt.textContent = i;
            select.appendChild(opt);
          }
          wrapper.appendChild(select);

          const hint = document.createElement('div');
          hint.className = 'hint';
          hint.textContent = `請選擇 ${min} 至 ${max} 分中的一個分數。`;
          wrapper.appendChild(hint);

        } else {
          const textarea = document.createElement('textarea');
          textarea.name = qId;
          textarea.rows = 3;
          wrapper.appendChild(textarea);
        }

        // meta 給前端驗證用
        const meta = document.createElement('input');
        meta.type = 'hidden';
        meta.name = `${qId}__meta`;
        meta.value = JSON.stringify({
          required: !!q.required,
          type: q.type || 'text'
        });
        wrapper.appendChild(meta);

        surveyForm.appendChild(wrapper);
      });
    }

    // ===== 5. 收集答案 & 寫入 responses =====
    submitBtn.addEventListener('click', async () => {
      submitMsg.textContent = '';
      submitMsg.className = '';
      submitBtn.disabled = true;

      try {
        const formData = new FormData(surveyForm);
        const answers = {};
        const errors = [];

        const metas = {};
        for (const [key, value] of formData.entries()) {
          if (key.endsWith('__meta')) {
            const qId = key.replace('__meta', '');
            metas[qId] = JSON.parse(value);
          }
        }

        for (const [qId, meta] of Object.entries(metas)) {
          const { required, type } = meta;
          let value = null;

          if (type === 'single' || type === 'scale') {
            value = formData.get(qId) || null;
          } else if (type === 'multiple') {
            const all = formData.getAll(qId);
            value = all;
          } else {
            value = formData.get(qId) || '';
          }

          if (required) {
            if (type === 'multiple') {
              if (!value || value.length === 0) {
                errors.push(`有必填題目尚未作答。`);
              }
            } else {
              if (!value) {
                errors.push(`有必填題目尚未作答。`);
              }
            }
          }
          answers[qId] = value;
        }

        if (errors.length > 0) {
          throw new Error(errors[0]);
        }

        await db.collection('responses').add({
          surveyId,
          createdAt: serverTimestamp,
          answers
        });

        submitMsg.textContent = '已成功送出問卷，感謝您的填寫！';
        submitMsg.className = 'success';
        submitBtn.disabled = true;

      } catch (err) {
        console.error(err);
        submitMsg.textContent = err.message || '送出問卷時發生錯誤，請稍後再試。';
        submitMsg.className = 'error';
        submitBtn.disabled = false;
      }
    });
  </script>
</body>
</html>
