<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>

  <meta charset="UTF-8">
  <title>å•å·å¾Œå°ç®¡ç†ç³»çµ±ï½œé·ºæ±Ÿåœ‹å°</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Google å­—é«” -->
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">

  <!-- Material Icons -->
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

  <!-- Google OAuth -->
  <script src="https://accounts.google.com/gsi/client" async defer></script>

<style>

/* =====================================================
   åŸºç¤è‰²ç³»ï¼ˆLight + Dark Modeï¼‰
===================================================== */

:root {
  --gf-primary: #673ab7;
  --gf-primary-light: #7e57c2;

  --bg: #f3f4f7;
  --card-bg: #ffffff;
  --text: #222;
  --text-light: #666;
  --border: #ddd;
  --sidebar-bg: #ffffff;

  --shadow: rgba(0,0,0,0.08);
}

body.dark {
  --bg: #1e1e1e;
  --card-bg: #2d2d2d;
  --text: #eeeeee;
  --text-light: #bbbbbb;
  --border: #444;
  --sidebar-bg: #252525;

  --shadow: rgba(0,0,0,0.4);
}

/* =====================================================
   Layout å…¨åŸŸè¨­å®š
===================================================== */

body {
  margin: 0;
  background: var(--bg);
  font-family: "Noto Sans TC", sans-serif;
  color: var(--text);
  display: flex;
  height: 100vh;
  overflow: hidden;
}

/* =====================================================
   å·¦å´ Sidebar
===================================================== */

#sidebar {
  width: 260px;
  background: var(--sidebar-bg);
  border-right: 1px solid var(--border);
  padding: 16px;
  display: flex;
  flex-direction: column;
  transition: 0.3s;
  overflow-y: auto;
}

#sidebar h2 {
  margin: 0 0 20px;
  font-size: 18px;
  font-weight: 600;
  display: flex;
  align-items: center;
  gap: 8px;
}

.sidebar-section-title {
  font-size: 14px;
  font-weight: 700;
  margin-top: 20px;
  margin-bottom: 6px;
  color: var(--text-light);
}

.sidebar-item {
  padding: 10px 12px;
  border-radius: 8px;
  margin-bottom: 6px;
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 10px;
  transition: 0.2s;
  color: var(--text);
}

.sidebar-item:hover {
  background: rgba(103, 58, 183, 0.1);
}

.sidebar-item.active {
  background: var(--gf-primary);
  color: white;
}

/* =====================================================
   é ‚éƒ¨ Navbar
===================================================== */

#navbar {
  height: 60px;
  background: var(--gf-primary);
  color: white;
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 0 20px;
}

#navbar-left {
  font-size: 20px;
  font-weight: 600;
}

#navbar-right {
  display: flex;
  align-items: center;
  gap: 16px;
}

#userAvatar {
  width: 36px;
  height: 36px;
  border-radius: 50%;
  display: none;
}

#userRole {
  background: rgba(255,255,255,0.2);
  padding: 5px 12px;
  border-radius: 20px;
  font-size: 13px;
}

#darkToggle {
  cursor: pointer;
  font-size: 26px;
}

/* =====================================================
   ä¸»å…§å®¹ Content å€åŸŸ
===================================================== */

#main {
  flex: 1;
  overflow-y: auto;
  padding: 20px;
}

/* =====================================================
   å¡ç‰‡å…ƒä»¶ï¼ˆå•å·å¡ç‰‡ã€è³‡æ–™å¡ç‰‡ï¼‰
===================================================== */

.card {
  background: var(--card-bg);
  padding: 18px;
  border-radius: 14px;
  margin-bottom: 20px;
  box-shadow: 0 2px 10px var(--shadow);
  transition: 0.3s;
}

.card:hover {
  transform: translateY(-2px);
}

/* =====================================================
   å•å·å¡ç‰‡
===================================================== */

.survey-card {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
}

.survey-title {
  font-size: 18px;
  font-weight: 600;
}

.survey-meta {
  font-size: 13px;
  color: var(--text-light);
  margin-top: 6px;
}

.survey-btns {
  display: flex;
  gap: 8px;
}

.btn-small {
  border: none;
  padding: 6px 10px;
  border-radius: 6px;
  cursor: pointer;
  font-size: 13px;
  display: flex;
  align-items: center;
  gap: 4px;
}

.btn-edit {
  background: #4caf50;
  color: white;
}
.btn-edit:hover { background: #449d48; }

.btn-stats {
  background: #2196f3;
  color: white;
}
.btn-stats:hover { background: #1e88e5; }

.btn-copy {
  background: #9c27b0;
  color: white;
}
.btn-copy:hover { background: #8e24aa; }

.btn-delete {
  background: #f44336;
  color: white;
}
.btn-delete:hover { background: #e53935; }

/* =====================================================
   æ–°å¢å•å· FAB æŒ‰éˆ•
===================================================== */

#fabAddSurvey {
  position: fixed;
  bottom: 26px;
  right: 26px;
  width: 60px;
  height: 60px;
  background: var(--gf-primary);
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  box-shadow: 0 2px 10px var(--shadow);
  cursor: pointer;
}

#fabAddSurvey .material-icons {
  color: white;
  font-size: 32px;
}

/* =====================================================
   RWDï¼šæ‰‹æ©Ÿç‰ˆ Sidebar â†’ Drawer
===================================================== */

@media (max-width: 768px) {
  #sidebar {
    position: fixed;
    left: -260px;
    top: 0;
    height: 100%;
    z-index: 20;
  }

  #sidebar.open {
    left: 0;
  }

  #sidebarOverlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    backdrop-filter: blur(2px);
    background: rgba(0,0,0,0.4);
    display: none;
    z-index: 10;
  }

  #sidebarOverlay.show {
    display: block;
  }

  #navbar-left {
    display: flex;
    align-items: center;
    gap: 12px;
  }

  #menuBtn {
    font-size: 28px;
    cursor: pointer;
    display: block;
  }
}

</style>
</head>

<body>

<!-- æ‰‹æ©Ÿç‰ˆ Sidebar é®ç½© -->
<div id="sidebarOverlay"></div>

<!-- å·¦å´ Sidebar -->
<div id="sidebar">
  <h2><span class="material-icons">dashboard</span> å¾Œå°ç®¡ç†</h2>

  <div class="sidebar-section-title">åˆ†é¡</div>
  <div class="sidebar-item active" data-category="å…¨éƒ¨"><span class="material-icons">folder_open</span> å…¨éƒ¨å•å·</div>
  <div class="sidebar-item" data-category="å­¸å‹™è™•"><span class="material-icons">account_balance</span> å­¸å‹™è™•</div>
  <div class="sidebar-item" data-category="å¥åº·ä¸­å¿ƒ"><span class="material-icons">health_and_safety</span> å¥åº·ä¸­å¿ƒ</div>
  <div class="sidebar-item" data-category="è‡ªç„¶é ˜åŸŸ"><span class="material-icons">eco</span> è‡ªç„¶é ˜åŸŸ</div>
  <div class="sidebar-item" data-category="å®¶é•·æœƒ"><span class="material-icons">groups</span> å®¶é•·æœƒ</div>
  <div class="sidebar-item" data-category="æ´»å‹•å ±å"><span class="material-icons">event</span> æ´»å‹•å ±å</div>

  <div class="sidebar-section-title">ç‹€æ…‹</div>
  <div class="sidebar-item" data-status="active"><span class="material-icons">check_circle</span> å•Ÿç”¨ä¸­</div>
  <div class="sidebar-item" data-status="draft"><span class="material-icons">edit_note</span> è‰ç¨¿</div>
  <div class="sidebar-item" data-status="archived"><span class="material-icons">inventory_2</span> å·²å°å­˜</div>
</div>

<!-- å³å´ ä¸»ç•«é¢ -->
<div id="rightPanel" style="flex:1;display:flex;flex-direction:column;overflow:hidden;">

  <!-- é ‚éƒ¨ Navbar -->
  <div id="navbar">
    <div id="navbar-left">
      <span id="menuBtn" class="material-icons" style="display:none;">menu</span>
      å•å·å¾Œå°ç®¡ç†ç³»çµ±
    </div>

    <div id="navbar-right">
      <img id="userAvatar" src="">
      <div id="userRole">æœªç™»å…¥</div>
      <span id="darkToggle" class="material-icons">dark_mode</span>
    </div>
  </div>

  <!-- ä¸»å…§å®¹ -->
  <div id="main">

    <div class="card">
      <h2>ğŸ“‹ å•å·åˆ—è¡¨</h2>
      <div id="surveyListArea"></div>
    </div>

  </div>
</div>

<!-- æ–°å¢å•å· FAB -->
<div id="fabAddSurvey"><span class="material-icons">add</span></div>

<script>
/* å¾ŒçºŒéƒ¨åˆ†ï¼ˆB / C / D / Eï¼‰æœƒæ”¾åœ¨é€™è£¡ */
</script>

</body>
</html>
/* ==========================================================
   ğŸŸ£ Firebase åˆå§‹åŒ–ï¼ˆè«‹å¡«å…¥ä½ çš„ configï¼‰
========================================================== */
const firebaseConfig = {
  apiKey: "YOUR_API_KEY",
  authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
  projectId: "YOUR_PROJECT_ID",
  storageBucket: "YOUR_PROJECT_ID.appspot.com",
  messagingSenderId: "YOUR_SENDER_ID",
  appId: "YOUR_APP_ID"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

/* ==========================================================
   ğŸŸ£ å…¨åŸŸè®Šæ•¸
========================================================== */
let currentUser = null;
let userRole = "viewer"; // é è¨­ï¼šæœ€ä½æ¬Šé™

// æŒ‡å®š adminï¼ˆä½ æœ¬äººï¼‰
const ADMIN_EMAIL = "YOUR_EMAIL@ntpc.edu.tw";

/* ==========================================================
   ğŸŸ£ Google OAuth Loginï¼ˆå«è‡ªå‹•è§’è‰²åˆ¤æ–·ï¼‰
========================================================== */
function onGoogleLogin(response) {
  const userData = parseJwt(response.credential);
  currentUser = userData;

  const email = userData.email;

  // è§’è‰²è‡ªå‹•åˆ¤æ–·
  if (email === ADMIN_EMAIL) {
    userRole = "admin";
  } else if (email.endsWith("@ntpc.edu.tw")) {
    userRole = "staff";
  } else {
    userRole = "viewer";
  }

  // UI æ›´æ–°
  document.getElementById("userAvatar").src = userData.picture;
  document.getElementById("userAvatar").style.display = "block";
  document.getElementById("userRole").textContent = roleToLabel(userRole);

  // ç™»å…¥å¾Œè¼‰å…¥å•å·åˆ—è¡¨
  loadSurveyList();
}

// Google JWT è§£ç¢¼
function parseJwt(token) {
  return JSON.parse(
    decodeURIComponent(
      escape(
        atob(token.split('.')[1].replace(/-/g, '+').replace(/_/g, '/'))
      )
    )
  );
}

// è§’è‰²é¡¯ç¤ºæ–‡å­—
function roleToLabel(r) {
  if (r === "admin") return "ç®¡ç†å“¡";
  if (r === "staff") return "æ•™å¸«";
  return "ç€è¦½è€…";
}

/* åˆå§‹åŒ– Google Login æŒ‰éˆ• */
window.onload = function () {
  google.accounts.id.initialize({
    client_id: "YOUR_GOOGLE_OAUTH_CLIENT_ID",
    callback: onGoogleLogin,
  });

  google.accounts.id.renderButton(
    document.getElementById("userRole"),
    { theme: "outline", size: "medium" }
  );

  google.accounts.id.prompt();
};

/* ==========================================================
   ğŸŒ™ æ·±è‰²æ¨¡å¼åˆ‡æ›
========================================================== */
const darkToggle = document.getElementById("darkToggle");
const body = document.body;

// è¼‰å…¥æ·±è‰²è¨­å®š
if (localStorage.getItem("adminDark") === "true") {
  body.classList.add("dark");
  darkToggle.textContent = "light_mode";
}

darkToggle.onclick = () => {
  body.classList.toggle("dark");
  const isDark = body.classList.contains("dark");
  darkToggle.textContent = isDark ? "light_mode" : "dark_mode";
  localStorage.setItem("adminDark", isDark);
};

/* ==========================================================
   ğŸ“± Sidebar Drawerï¼ˆæ‰‹æ©Ÿç‰ˆæœ¬ï¼‰
========================================================== */
const sidebar = document.getElementById("sidebar");
const menuBtn = document.getElementById("menuBtn");
const overlay = document.getElementById("sidebarOverlay");

menuBtn.style.display = "block"; // æ‰‹æ©Ÿç‰ˆé¡¯ç¤º menu æŒ‰éˆ•

menuBtn.onclick = () => {
  sidebar.classList.add("open");
  overlay.classList.add("show");
};

overlay.onclick = () => {
  sidebar.classList.remove("open");
  overlay.classList.remove("show");
};

/* ==========================================================
   ğŸŸ£ Sidebar é»æ“Šåˆ†é¡ / ç‹€æ…‹ï¼ˆUI åˆ‡æ›ï¼‰
========================================================== */
document.querySelectorAll(".sidebar-item").forEach(item => {
  item.onclick = () => {
    document.querySelectorAll(".sidebar-item").forEach(i => i.classList.remove("active"));
    item.classList.add("active");

    const category = item.dataset.category || null;
    const status = item.dataset.status || null;

    filterSurveyList(category, status);
  };
});

/* ==========================================================
   ğŸŸ¢ å¾Œå°ä¸»é â€”è¼‰å…¥å•å·åˆ—è¡¨ï¼ˆå¾… C éƒ¨åˆ†å¯¦ä½œï¼‰
========================================================== */
function loadSurveyList() {
  document.getElementById("surveyListArea").innerHTML =
    `<div style="padding:20px;font-size:16px;">è¼‰å…¥ä¸­â€¦</div>`;
}

function filterSurveyList(category, status) {
  // C éƒ¨åˆ†æœƒè£œä¸Š
}
/* ==========================================================
   ğŸŸ£ å–å¾—å•å·æ¸…å–®ï¼ˆä¾æ¬Šé™ï¼‰
========================================================== */

let allSurveys = []; // å„²å­˜æ‰€æœ‰å•å·ï¼ˆFirebase è¼‰å…¥å¾Œå­˜å…¥ï¼‰
let currentCategory = "å…¨éƒ¨";
let currentStatus = null;

async function loadSurveyList() {
  // UI åˆå§‹åŒ–
  document.getElementById("surveyListArea").innerHTML =
    `<div style="padding:20px;font-size:15px;">è³‡æ–™è¼‰å…¥ä¸­â€¦</div>`;

  const snap = await db.collection("surveys")
    .orderBy("createdAt", "desc")
    .get();

  allSurveys = snap.docs.map(doc => ({
    id: doc.id,
    ...doc.data()
  }));

  renderSurveyList();
}

/* ==========================================================
   ğŸŸ¢ æ’åº + ç¯©é¸å•å·
========================================================== */

function filterSurveyList(category, status) {
  if (category) currentCategory = category;
  if (status) currentStatus = status;
  renderSurveyList();
}

function surveyPassFilters(s) {
  // åˆ†é¡æ¢ä»¶
  if (currentCategory && currentCategory !== "å…¨éƒ¨") {
    if (s.category !== currentCategory) return false;
  }

  // ç‹€æ…‹æ¢ä»¶
  if (currentStatus && currentStatus !== s.status) {
    return false;
  }

  // staff åªèƒ½çœ‹åˆ°è‡ªå·±å»ºç«‹çš„å•å·
  if (userRole === "staff" && s.createdBy !== currentUser.email) {
    return false;
  }

  return true;
}

/* ==========================================================
   â­ æ¸²æŸ“å•å·å¡ç‰‡åˆ—è¡¨
========================================================== */
function renderSurveyList() {
  const container = document.getElementById("surveyListArea");
  container.innerHTML = "";

  const filtered = allSurveys.filter(s => surveyPassFilters(s));

  if (filtered.length === 0) {
    container.innerHTML = `<div style="padding:20px;">æ²’æœ‰ç¬¦åˆæ¢ä»¶çš„å•å·ã€‚</div>`;
    return;
  }

  filtered.forEach(s => {
    const card = document.createElement("div");
    card.className = "card";

    const created = s.createdAt?.toDate?.().toLocaleString() || "";
    const updated = s.updatedAt?.toDate?.().toLocaleString() || "";

    card.innerHTML = `
      <div class="survey-card">

        <div style="flex:1">
          <div class="survey-title">${s.title}</div>

          <div class="survey-meta">
            åˆ†é¡ï¼š${s.category || "æœªåˆ†é¡"} <br>
            ç‹€æ…‹ï¼š${statusLabel(s.status)} |
            å»ºç«‹è€…ï¼š${s.createdBy || "æœªçŸ¥"} <br>
            å»ºç«‹æ™‚é–“ï¼š${created}<br>
            æ›´æ–°æ™‚é–“ï¼š${updated}
          </div>
        </div>

        <div class="survey-btns">
          ${renderSurveyButtons(s)}
        </div>

      </div>
    `;

    container.appendChild(card);
  });
}

/* ==========================================================
   æŒ‰éˆ•é¡¯ç¤ºé™åˆ¶ï¼ˆä¾è§’è‰²ï¼‰
========================================================== */
function renderSurveyButtons(s) {
  const baseUrl = window.location.origin + "/respond.html?surveyId=" + s.id;

  // çµ±è¨ˆé€£çµï¼ˆæ‰€æœ‰è§’è‰²éƒ½èƒ½çœ‹ï¼‰
  let str = `
    <button class="btn-small btn-stats" onclick="gotoStats('${s.id}')">
      <span class='material-icons'>insights</span> çµ±è¨ˆ
    </button>

    <button class="btn-small btn-copy" onclick="copyUrl('${baseUrl}')">
      <span class='material-icons'>link</span> é€£çµ
    </button>
  `;

  // viewer æ²’æœ‰å…¶ä»–æ¬Šé™
  if (userRole === "viewer") return str;

  // staff åªèƒ½ç·¨è¼¯è‡ªå·±çš„å•å·
  if (userRole === "staff" && s.createdBy !== currentUser.email) return str;

  // staff + admin éƒ½å¯ç·¨è¼¯
  str += `
    <button class="btn-small btn-edit" onclick="editSurvey('${s.id}')">
      <span class='material-icons'>edit</span> ç·¨è¼¯
    </button>
  `;

  // admin åŠŸèƒ½ï¼šåˆªé™¤ + æ›´æ”¹ç‹€æ…‹
  if (userRole === "admin") {
    str += `
      <button class="btn-small btn-delete" onclick="deleteSurvey('${s.id}')">
        <span class='material-icons'>delete</span> åˆªé™¤
      </button>
    `;
  }

  return str;
}

/* ==========================================================
   ç‹€æ…‹é¡¯ç¤ºæ–‡å­—
========================================================== */
function statusLabel(s) {
  if (s === "active") return "ğŸŸ¢ å•Ÿç”¨ä¸­";
  if (s === "draft") return "ğŸ“ è‰ç¨¿";
  if (s === "archived") return "ğŸ“¦ å·²å°å­˜";
  return "â“ æœªçŸ¥";
}

/* ==========================================================
   â­ åŠŸèƒ½ï¼šè¤‡è£½å•å·ï¼ˆå«é¡Œç›®ï¼‰
========================================================== */
async function copySurvey(id) {
  const original = allSurveys.find(s => s.id === id);
  if (!original) return alert("æ‰¾ä¸åˆ°å•å·");

  // å»ºç«‹æ–°å•å·
  const newSurveyRef = await db.collection("surveys").add({
    title: original.title + "ï¼ˆè¤‡è£½ï¼‰",
    description: original.description,
    category: original.category,
    status: "draft",
    createdBy: currentUser.email,
    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
  });

  // è¤‡è£½é¡Œç›®
  const qSnap = await db.collection("surveys").doc(id).collection("questions").get();
  qSnap.forEach(doc => {
    db.collection("surveys").doc(newSurveyRef.id)
      .collection("questions").add(doc.data());
  });

  alert("å·²è¤‡è£½å•å·ï¼");
  loadSurveyList();
}

/* ==========================================================
   â­ åŠŸèƒ½ï¼šåˆªé™¤å•å·ï¼ˆAdmin onlyï¼‰
========================================================== */
async function deleteSurvey(id) {
  if (userRole !== "admin") return alert("æ²’æœ‰æ¬Šé™ï¼");
  if (!confirm("ç¢ºå®šè¦åˆªé™¤é€™ä»½å•å·ï¼Ÿï¼ˆæ‰€æœ‰å›è¦†å°‡ä¿ç•™ï¼Œä½†å•å·æœƒåˆªé™¤ï¼‰")) return;

  // åˆªé™¤å•å·åŸºæœ¬è³‡æ–™
  await db.collection("surveys").doc(id).delete();

  // åˆªé™¤é¡Œç›®
  const qSnap = await db.collection("surveys").doc(id).collection("questions").get();
  const batch = db.batch();
  qSnap.forEach(doc => {
    batch.delete(doc.ref);
  });
  await batch.commit();

  alert("å•å·å·²åˆªé™¤ï¼");
  loadSurveyList();
}

/* ==========================================================
   â­ åŠŸèƒ½ï¼šè·³è½‰å‰å°çµ±è¨ˆé ï¼ˆindex.htmlï¼‰
========================================================== */
function gotoStats(id) {
  window.location.href = `index.html?mode=stats&surveyId=${id}`;
}

/* ==========================================================
   â­ å–å¾—é€£çµï¼ˆè¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼‰
========================================================== */
function copyUrl(url) {
  navigator.clipboard.writeText(url);
  alert("å·²è¤‡è£½å•å·é€£çµï¼");
}

/* ==========================================================
   â­ åŠŸèƒ½ï¼šç·¨è¼¯å•å·ï¼ˆè·³åˆ° editor å€åŸŸ â€” D éƒ¨åˆ†æœƒè£œä¸Šï¼‰
========================================================== */
function editSurvey(id) {
  // D éƒ¨åˆ†ç”Ÿæˆå®Œæ•´ç·¨è¼¯å™¨
  openSurveyEditor(id);
}
/* ==========================================================
   ğŸŸ£ å•å·ç·¨è¼¯å™¨ï¼ˆSurvey Builderï¼‰
========================================================== */

let editingSurveyId = null;
let editingSurveyData = null;
let questionList = [];

/* ==========================================================
   â­ æ‰“é–‹å•å·ç·¨è¼¯å™¨ï¼ˆå–ä»£ä¸»é å…§å®¹ï¼‰
========================================================== */
async function openSurveyEditor(id) {
  editingSurveyId = id;

  // staff åªèƒ½ç·¨è¼¯è‡ªå·±çš„å•å·
  const survey = allSurveys.find(s => s.id === id);
  if (!survey) return alert("æ‰¾ä¸åˆ°å•å·è³‡æ–™");

  if (userRole === "staff" && survey.createdBy !== currentUser.email) {
    alert("æ²’æœ‰æ¬Šé™ç·¨è¼¯é€™ä»½å•å·");
    return;
  }

  // é é¢ä¸»é«”æ”¹ç‚ºç·¨è¼¯å™¨
  document.getElementById("main").innerHTML = `
    <div class="card">
      <h2>ğŸ“ ç·¨è¼¯å•å·ï¼š<span id="editorTitle"></span></h2>

      <label>æ¨™é¡Œï¼š</label>
      <input id="surveyTitle" class="editor-input">

      <label>æè¿°ï¼š</label>
      <textarea id="surveyDesc" class="editor-textarea"></textarea>

      <label>åˆ†é¡ï¼š</label>
      <select id="surveyCategory" class="editor-select">
        <option value="å­¸å‹™è™•">å­¸å‹™è™•</option>
        <option value="å¥åº·ä¸­å¿ƒ">å¥åº·ä¸­å¿ƒ</option>
        <option value="è‡ªç„¶é ˜åŸŸ">è‡ªç„¶é ˜åŸŸ</option>
        <option value="å®¶é•·æœƒ">å®¶é•·æœƒ</option>
        <option value="æ´»å‹•å ±å">æ´»å‹•å ±å</option>
      </select>

      <label>ç‹€æ…‹ï¼š</label>
      <select id="surveyStatus" class="editor-select">
        <option value="draft">è‰ç¨¿</option>
        <option value="active">å•Ÿç”¨ä¸­</option>
        <option value="archived">å°å­˜</option>
      </select>

      <label>
        <input type="checkbox" id="surveyAnonymous"> å…è¨±åŒ¿åå¡«å¯«
      </label>

    </div>

    <div class="card">
      <h3>ğŸ“š é¡Œç›®åˆ—è¡¨</h3>
      <div id="questionList"></div>
      <button class="btn-small btn-edit" onclick="addQuestion()">ï¼‹ æ–°å¢é¡Œç›®</button>
    </div>

    <button class="btn-small btn-stats" onclick="backToDashboard()">
      â† è¿”å›å¾Œå°
    </button>
  `;

  // è®€å–å•å·è³‡æ–™
  editingSurveyData = survey;

  document.getElementById("editorTitle").textContent = survey.title;
  document.getElementById("surveyTitle").value = survey.title;
  document.getElementById("surveyDesc").value = survey.description;
  document.getElementById("surveyCategory").value = survey.category || "å­¸å‹™è™•";
  document.getElementById("surveyStatus").value = survey.status || "draft";
  document.getElementById("surveyAnonymous").checked = survey.allowAnonymous ?? true;

  // ç›£è½æ¬„ä½è®Šæ›´ â†’ è‡ªå‹•å„²å­˜
  setupSurveyAutoSave();

  // è¼‰å…¥é¡Œç›®
  await loadQuestions();
}

/* ==========================================================
   â­ å›ä¸»é ï¼ˆDashboardï¼‰
========================================================== */
function backToDashboard() {
  location.reload();
}

/* ==========================================================
   â­ è‡ªå‹•å„²å­˜å•å·å±¬æ€§ 
========================================================== */
function setupSurveyAutoSave() {
  document.getElementById("surveyTitle").oninput = updateSurveyField;
  document.getElementById("surveyDesc").oninput = updateSurveyField;
  document.getElementById("surveyCategory").onchange = updateSurveyField;
  document.getElementById("surveyStatus").onchange = updateSurveyField;
  document.getElementById("surveyAnonymous").onchange = updateSurveyField;
}

async function updateSurveyField() {
  const newData = {
    title: document.getElementById("surveyTitle").value,
    description: document.getElementById("surveyDesc").value,
    category: document.getElementById("surveyCategory").value,
    status: document.getElementById("surveyStatus").value,
    allowAnonymous: document.getElementById("surveyAnonymous").checked,
    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
  };

  await db.collection("surveys").doc(editingSurveyId).update(newData);
}

/* ==========================================================
   â­ è¼‰å…¥é¡Œç›®
========================================================== */
async function loadQuestions() {
  const snap = await db.collection("surveys")
    .doc(editingSurveyId)
    .collection("questions")
    .orderBy("order")
    .get();

  questionList = snap.docs.map(doc => ({
    id: doc.id,
    ...doc.data()
  }));

  renderQuestionList();
}

/* ==========================================================
   â­ é¡Œç›®æ¸²æŸ“
========================================================== */
function renderQuestionList() {
  const container = document.getElementById("questionList");
  container.innerHTML = "";

  questionList.forEach((q, index) => {
    const div = document.createElement("div");
    div.className = "card";
    div.style.marginBottom = "14px";

    div.innerHTML = `
      <div style="display:flex;justify-content:space-between;">
        <div><b>Q${index + 1}</b>ï¼ˆ${typeLabel(q.type)}ï¼‰</div>

        <div>
          <button class="btn-small btn-copy" onclick="duplicateQuestion('${q.id}')">
            <span class="material-icons">content_copy</span>
          </button>
          <button class="btn-small btn-delete" onclick="deleteQuestion('${q.id}')">
            <span class="material-icons">delete</span>
          </button>
        </div>
      </div>

      <label>é¡Œç›®ï¼š</label>
      <input class="editor-input" value="${q.text}" 
        oninput="updateQuestionField('${q.id}', 'text', this.value)">

      <label>é¡Œå‹ï¼š</label>
      <select class="editor-select"
        onchange="updateQuestionField('${q.id}', 'type', this.value)">
        <option value="single" ${q.type==="single"?"selected":""}>å–®é¸</option>
        <option value="multiple" ${q.type==="multiple"?"selected":""}>å¤šé¸</option>
        <option value="scale" ${q.type==="scale"?"selected":""}>é‡è¡¨</option>
        <option value="text" ${q.type==="text"?"selected":""}>æ–‡å­—</option>
      </select>

      <div id="optionArea_${q.id}">
        ${renderQuestionOptions(q)}
      </div>

    `;

    container.appendChild(div);
  });

  setupSortable();
}

/* ==========================================================
   â­ é¡Œç›®å…§å®¹ï¼šä¾é¡Œå‹è¼¸å‡ºé¸é … UI
========================================================== */
function renderQuestionOptions(q) {
  if (q.type === "single" || q.type === "multiple") {
    return `
       <label>é¸é …ï¼š</label>
       ${q.options.map((opt, i) => `
         <div style="display:flex;margin-bottom:6px;">
           <input class="editor-input" 
             value="${opt}" 
             oninput="updateOption('${q.id}', ${i}, this.value)">
           <button class="btn-small btn-delete" 
             onclick="removeOption('${q.id}', ${i})">
             <span class="material-icons">close</span>
           </button>
         </div>
       `).join("")}

      <button class="btn-small btn-edit" onclick="addOption('${q.id}')">
        ï¼‹ æ–°å¢é¸é …
      </button>
    `;
  }

  if (q.type === "scale") {
    return `
      <label>é‡è¡¨ç¯„åœï¼š</label>
      <input class="editor-input" type="number" min="1" max="10"
        value="${q.scaleMin || 1}"
        oninput="updateQuestionField('${q.id}','scaleMin',this.value)">
      åˆ°
      <input class="editor-input" type="number" min="1" max="10"
        value="${q.scaleMax || 5}"
        oninput="updateQuestionField('${q.id}','scaleMax',this.value)">
    `;
  }

  return ""; // text é¡Œä¸ç”¨é¸é …
}

/* ==========================================================
   â­ é¡Œç›®æ–°å¢
========================================================== */
async function addQuestion() {
  const newRef = await db.collection("surveys")
    .doc(editingSurveyId)
    .collection("questions")
    .add({
      text: "æœªå‘½åå•é¡Œ",
      type: "single",
      options: ["é¸é … 1"],
      order: questionList.length
    });

  await loadQuestions();
}

/* ==========================================================
   â­ é¡Œç›®æ›´æ–°
========================================================== */
async function updateQuestionField(qid, field, value) {
  await db.collection("surveys").doc(editingSurveyId)
    .collection("questions").doc(qid)
    .update({
      [field]: field === "scaleMin" || field === "scaleMax" ? Number(value) : value
    });

  await loadQuestions();
}

/* ==========================================================
   â­ é¸é …æ–°å¢ / åˆªé™¤ / æ›´æ–°
========================================================== */
async function addOption(qid) {
  const q = questionList.find(x => x.id === qid);
  q.options.push("æ–°é¸é …");

  await db.collection("surveys").doc(editingSurveyId)
    .collection("questions").doc(qid)
    .update({ options: q.options });

  loadQuestions();
}

async function removeOption(qid, index) {
  const q = questionList.find(x => x.id === qid);
  q.options.splice(index, 1);

  await db.collection("surveys").doc(editingSurveyId)
    .collection("questions").doc(qid)
    .update({ options: q.options });

  loadQuestions();
}

async function updateOption(qid, index, value) {
  const q = questionList.find(x => x.id === qid);
  q.options[index] = value;

  await db.collection("surveys").doc(editingSurveyId)
    .collection("questions").doc(qid)
    .update({ options: q.options });
}

/* ==========================================================
   â­ é¡Œç›®åˆªé™¤
========================================================== */
async function deleteQuestion(qid) {
  if (!confirm("ç¢ºå®šåˆªé™¤é€™å€‹é¡Œç›®ï¼Ÿ")) return;

  await db.collection("surveys").doc(editingSurveyId)
    .collection("questions").doc(qid)
    .delete();

  loadQuestions();
}

/* ==========================================================
   â­ è¤‡è£½é¡Œç›®
========================================================== */
async function duplicateQuestion(qid) {
  const q = questionList.find(x => x.id === qid);
  if (!q) return;

  await db.collection("surveys").doc(editingSurveyId)
    .collection("questions").add({
      ...q,
      text: q.text + "ï¼ˆè¤‡è£½ï¼‰",
      order: questionList.length
    });

  loadQuestions();
}

/* ==========================================================
   â­ é¡Œç›®æ‹–æ›³æ’åºï¼ˆSortableJSï¼‰
========================================================== */
function setupSortable() {
  const el = document.getElementById("questionList");

  Sortable.create(el, {
    animation: 150,
    handle: ".card",
    onEnd: async (evt) => {
      // æ›´æ–° order æ¬„ä½
      const newOrder = Array.from(el.children).map((div, index) => {
        const qIndex = Array.from(el.children).indexOf(div);
        return questionList[qIndex].id;
      });

      // å¯«å› Firestore
      const batch = db.batch();

      newOrder.forEach((qid, idx) => {
        const ref = db.collection("surveys").doc(editingSurveyId)
          .collection("questions").doc(qid);
        batch.update(ref, { order: idx });
      });

      await batch.commit();
      await loadQuestions();
    }
  });
}

/* ==========================================================
   â­ é¡Œå‹ä¸­æ–‡
========================================================== */
function typeLabel(type) {
  return {
    single: "å–®é¸",
    multiple: "å¤šé¸",
    scale: "é‡è¡¨",
    text: "æ–‡å­—"
  }[type] || "æœªçŸ¥";
}
/* ==========================================================
   ğŸŸ£ â­ æ–°å¢å•å·ï¼ˆFAB æŒ‰éˆ•ï¼‰
========================================================== */
document.getElementById("fabAddSurvey").onclick = async () => {
  if (!currentUser) return alert("è«‹å…ˆç™»å…¥ Google å¸³è™Ÿæ‰èƒ½æ–°å¢å•å·");

  const title = prompt("è«‹è¼¸å…¥å•å·æ¨™é¡Œï¼š");
  if (!title) return;

  const newSurvey = {
    title,
    description: "",
    createdBy: currentUser.email,
    category: "å­¸å‹™è™•",
    tags: [],
    status: "draft",
    allowAnonymous: true,
    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
  };

  const ref = await db.collection("surveys").add(newSurvey);

  // è‡ªå‹•åŠ å…¥ç¬¬ä¸€é¡Œï¼ˆå¯çœç•¥ï¼‰
  await db.collection("surveys").doc(ref.id).collection("questions").add({
    text: "æœªå‘½åå•é¡Œ",
    type: "single",
    options: ["é¸é … 1"],
    order: 0
  });

  alert("å•å·å·²å»ºç«‹ï¼");
  loadSurveyList();

  // é–‹å•Ÿç·¨è¼¯å™¨
  openSurveyEditor(ref.id);
};


/* ==========================================================
   ğŸŸ¢ â­ å•å·ç‹€æ…‹æ›´æ–°ï¼ˆActive / Draft / Archivedï¼‰
========================================================== */
async function setSurveyStatus(id, status) {
  if (userRole !== "admin") return alert("æ²’æœ‰æ¬Šé™è®Šæ›´ç‹€æ…‹");

  await db.collection("surveys").doc(id).update({
    status,
    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
  });

  loadSurveyList();
  alert("ç‹€æ…‹å·²æ›´æ–°ç‚ºï¼š" + statusLabel(status));
}


/* ==========================================================
   ğŸŸ£ â­ å•å·æ›´æ–°ï¼ˆå¾Œå°è³‡æ–™æ›´æ–°äº’é€šï¼‰
   index.html å¯ç›´æ¥è®€åˆ°é€™äº›å€¼
========================================================== */
async function updateSurveyMetadata(id, data) {
  await db.collection("surveys").doc(id).update({
    ...data,
    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
  });
}


/* ==========================================================
   ğŸ” â­ å•å·é‡æ–°æ•´ç†ï¼ˆç·¨è¼¯å™¨æˆ– Dashboard å‘¼å«ï¼‰
========================================================== */
async function refreshSurveys() {
  const snap = await db.collection("surveys")
    .orderBy("createdAt", "desc")
    .get();

  allSurveys = snap.docs.map(doc => ({
    id: doc.id,
    ...doc.data()
  }));

  renderSurveyList();
}


/* ==========================================================
   ğŸŒ™ æ·±è‰²æ¨¡å¼åŒæ­¥ admin + editor
========================================================== */
function applyDarkModeToEditor() {
  if (document.body.classList.contains("dark")) {
    document.querySelectorAll(".editor-input, .editor-select, .editor-textarea")
      .forEach(el => el.style.background = "#1e1e1e");
  }
}


/* ==========================================================
   â­ å•å·åˆ—è¡¨èˆ‡ç·¨è¼¯å™¨äº’å‹•æ§åˆ¶
========================================================== */
// å•å·ç·¨è¼¯å™¨æ¨™é¡ŒåŒæ­¥æ›´æ–° Dashboard å¡ç‰‡ï¼ˆå³æ™‚ï¼‰
async function syncDashboardTitle(newTitle) {
  await db.collection("surveys").doc(editingSurveyId).update({
    title: newTitle,
    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
  });

  refreshSurveys();
}


/* ==========================================================
   â­ å•å·ç·¨è¼¯å™¨ CSSï¼ˆè£œå……æ¨£å¼ï¼‰
========================================================== */
const editorStyles = document.createElement("style");
editorStyles.innerHTML = `
  .editor-input {
    width: 100%;
    padding: 10px;
    margin: 6px 0 12px;
    border-radius: 8px;
    border: 1px solid var(--border);
    background: var(--card-bg);
    color: var(--text);
  }

  .editor-textarea {
    width: 100%;
    height: 80px;
    padding: 10px;
    margin: 6px 0 12px;
    border-radius: 8px;
    border: 1px solid var(--border);
    background: var(--card-bg);
    color: var(--text);
  }

  .editor-select {
    width: 200px;
    padding: 8px;
    margin: 6px 0 12px;
    border-radius: 8px;
    border: 1px solid var(--border);
    background: var(--card-bg);
    color: var(--text);
  }
`;
document.head.appendChild(editorStyles);


/* ==========================================================
   â­ å•å·åˆªé™¤å¾Œè‡ªå‹•åˆ·æ–°ï¼ˆä¿ç•™ responsesï¼‰
========================================================== */
async function deleteSurvey(id) {
  if (userRole !== "admin") return alert("æ²’æœ‰æ¬Šé™ï¼");
  if (!confirm("ç¢ºå®šåˆªé™¤é€™ä»½å•å·ï¼Ÿ")) return;

  // åˆªé™¤å•å·ä¸»è³‡æ–™
  await db.collection("surveys").doc(id).delete();

  // åˆªé™¤é¡Œç›®
  const qSnap = await db.collection("surveys").doc(id)
    .collection("questions").get();

  const batch = db.batch();
  qSnap.forEach(doc => batch.delete(doc.ref));
  await batch.commit();

  // å›è¦†ä¸åˆªé™¤ï¼ˆä¿ç•™æ­·å²ç´€éŒ„ï¼‰

  alert("å·²åˆªé™¤å•å·");
  refreshSurveys();
}


/* ==========================================================
   â­ Dashboard èˆ‡ç·¨è¼¯å™¨è³‡æ–™åŒæ­¥
========================================================== */
async function syncEditorHeader() {
  const survey = await db.collection("surveys").doc(editingSurveyId).get();
  editingSurveyData = survey.data();

  document.getElementById("editorTitle").textContent = editingSurveyData.title;
}


/* ==========================================================
   â­ ï¼ˆé‡è¦ï¼‰é é¢è¼‰å…¥æ™‚è‡ªå‹•åŸ·è¡Œæµç¨‹
========================================================== */
document.addEventListener("DOMContentLoaded", () => {
  // Google Login åœ¨ B éƒ¨åˆ†åˆå§‹åŒ–
  // Sidebar é»æ“Šåœ¨ B éƒ¨åˆ†åˆå§‹åŒ–
  // Dashboard åˆæ¬¡è¼‰å…¥åœ¨ B éƒ¨åˆ†ç”± login callback å‘¼å«
});
// ================================
// é·ºæ±Ÿåœ‹å°å•å·ç³»çµ± Firestore å®‰å…¨è¦å‰‡
// ================================

rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ================================
    // ğŸ”µ å…¨åŸŸè®Šæ•¸ï¼ˆæ–¹ä¾¿é‡è¤‡ä½¿ç”¨ï¼‰
    // ================================
    function isAdmin() {
      return request.auth != null
             && request.auth.token.email == "YOUR_EMAIL@ntpc.edu.tw";
    }

    function isStaff() {
      return request.auth != null
             && request.auth.token.email.matches(".*@ntpc.edu.tw$")
             && !isAdmin(); // é¿å… admin è¢«ç•¶æˆ staff
    }

    function isViewer() {
      return request.auth == null
             || (!isAdmin() && !isStaff());
    }

    // åˆ¤æ–·æ˜¯å¦ç‚ºè©²å•å·å»ºç«‹è€…ï¼ˆstaff ç”¨ï¼‰
    function isOwner(survey) {
      return request.auth != null
             && survey.createdBy == request.auth.token.email;
    }

    // ================================
    // ğŸ“‚ å•å·ä¸»é›†åˆï¼šsurveys
    // ================================
    match /surveys/{surveyId} {

      // ----------------------------
      // ğŸ”µ Readï¼šæ‰€æœ‰äººéƒ½èƒ½è®€ï¼ˆå‰å°å¡«ç­”éœ€è¦ï¼‰
      // ----------------------------
      allow get, list: if true;

      // ----------------------------
      // ğŸ”µ Createï¼šadmin / staff å¯å»ºç«‹å•å·
      // ----------------------------
      allow create: if isAdmin() || isStaff();

      // ----------------------------
      // ğŸŸ£ Updateï¼ˆä¿®æ”¹å•å·è¨­å®šï¼‰
      // ----------------------------
      allow update: if
        isAdmin()                       // admin å¯ä¿®æ”¹ä»»ä½•å•å·
        || (isStaff() && isOwner(resource.data));  // staff åƒ…èƒ½æ”¹è‡ªå·±çš„å•å·

      // ----------------------------
      // ğŸ”´ Deleteï¼šåªæœ‰ admin èƒ½åˆªé™¤å•å·
      // ----------------------------
      allow delete: if isAdmin();

      // ================================
      // ğŸ§© å­é›†åˆï¼šquestionsï¼ˆé¡Œç›®ï¼‰
      // ================================
      match /questions/{questionId} {

        // ğŸ”µ Readï¼šæ‰€æœ‰äººå¯è®€ï¼ˆå‰å°éœ€è¦é¡¯ç¤ºé¡Œç›®ï¼‰
        allow get, list: if true;

        // ğŸŸ£ Createï¼šadmin æˆ– staffï¼ˆå»ºç«‹è€…æœ¬äººï¼‰
        allow create: if
          isAdmin()
          || (isStaff() && isOwner(resource.data.parent().data));

        // ğŸŸ£ Updateï¼šadmin æˆ– staffï¼ˆè©²å•å·æ“æœ‰è€…ï¼‰
        allow update: if
          isAdmin()
          || (isStaff() && isOwner(get(/databases/$(database)/documents/surveys/$(surveyId)).data));

        // ğŸ”´ Deleteï¼šåªæœ‰ admin èƒ½åˆªé¡Œç›®
        allow delete: if isAdmin();
      }

      // ================================
      // ğŸ“Š å­é›†åˆï¼šresponsesï¼ˆå¡«ç­”ç´€éŒ„ï¼‰
      // ================================
      match /responses/{respId} {

        // ğŸ”µ Readï¼šadmin / staff å¯è®€ï¼ˆå¾Œå°çµ±è¨ˆï¼‰
        // viewer ä¸å¯è®€ responsesï¼ˆä¿è­·éš±ç§ï¼‰
        allow get, list: if isAdmin() || isStaff();

        // ğŸŸ¢ Createï¼šä»»ä½•äººå¯æ–°å¢ï¼ˆå…¬é–‹å¡«å¯«å•å·ï¼‰
        allow create: if true;

        // âŒ Update / Deleteï¼šä»»ä½•äººéƒ½ä¸èƒ½æ”¹ï¼ˆé˜²æ­¢è¢«ç«„æ”¹ï¼‰
        allow update, delete: if false;
      }
    }
  }
}
