<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>å•å·çµæœåˆ†æ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Noto Sans TC", sans-serif;
      background: #f5f5f5;
    }
    header {
      background: #1976d2;
      color: #fff;
      padding: 12px 16px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    header h1 {
      margin: 0;
      font-size: 20px;
    }
    main {
      max-width: 1000px;
      margin: 16px auto 32px;
      padding: 16px;
      background: #fff;
      border-radius: 6px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.08);
    }
    .hint {
      font-size: 13px;
      color: #666;
    }
    .row {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
    }
    .col {
      flex: 1;
      min-width: 240px;
    }
    label {
      display: block;
      font-size: 14px;
      margin-bottom: 4px;
    }
    input[type="text"] {
      width: 100%;
      padding: 6px 8px;
      border-radius: 4px;
      border: 1px solid #ccc;
      font-size: 14px;
    }
    select {
      width: 100%;
      padding: 6px 8px;
      border-radius: 4px;
      border: 1px solid #ccc;
      font-size: 14px;
    }
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 8px 14px;
      border-radius: 4px;
      border: none;
      cursor: pointer;
      font-size: 14px;
      margin-right: 8px;
      background: #1976d2;
      color: #fff;
    }
    .btn-secondary {
      background: #e0e0e0;
      color: #333;
    }
    .btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
    .section {
      margin-top: 16px;
      margin-bottom: 16px;
    }
    canvas {
      max-width: 100%;
      background: #fafafa;
      border-radius: 4px;
      padding: 8px;
    }
    .error {
      color: #d32f2f;
      font-size: 13px;
      margin-top: 4px;
    }
    .success {
      color: #388e3c;
      font-size: 13px;
      margin-top: 4px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
      margin-top: 8px;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 4px 6px;
      text-align: left;
    }
    th {
      background: #f0f0f0;
    }
  </style>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

  <!-- Chart.js ç”¢ç”Ÿçµ±è¨ˆåœ– -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <header>
    <h1>å•å·çµæœåˆ†æ</h1>
    <span id="headerSurveyTitle" style="font-size:13px;opacity:.9;"></span>
  </header>

  <main>
    <!-- è¼‰å…¥å•å· & å›è¦† -->
    <div class="section">
      <div class="row">
        <div class="col">
          <label>ç›®å‰å•å· ID</label>
          <input
            type="text"
            id="surveyIdInput"
            placeholder="ä¾‹å¦‚ï¼šL90wraDczK0Ok7alJVL6"
          >
          <div class="hint">
            âœ… å»ºè­°ç›´æ¥ç”¨ç¶²å€å¸¶åƒæ•¸ï¼š<code>results.html?surveyId=...</code><br>
            æˆ–åœ¨é€™è£¡è²¼ä¸Š <code>surveyId</code> å¾ŒæŒ‰ã€Œè¼‰å…¥å•å·çµæœã€ã€‚
          </div>
        </div>
        <div class="col" style="display:flex;align-items:flex-end;gap:8px;">
          <button class="btn" id="loadSurveyBtn">è¼‰å…¥å•å·çµæœ</button>
          <button class="btn btn-secondary" id="exportCsvBtn" disabled>åŒ¯å‡º CSV</button>
        </div>
      </div>
      <div id="loadMsg" class="hint" style="margin-top:4px;"></div>
    </div>

    <!-- é¡Œç›®é¸æ“‡ & çµ±è¨ˆåœ– -->
    <div class="section">
      <h3>é¡Œç›®é¸æ“‡ & çµ±è¨ˆåœ–</h3>
      <div class="row">
        <div class="col">
          <label>é¸æ“‡è¦åˆ†æçš„é¡Œç›®</label>
          <select id="questionSelect">
            <option value="">è«‹å…ˆè¼‰å…¥å•å·</option>
          </select>
        </div>
        <div class="col" style="display:flex;align-items:flex-end;gap:8px;">
          <button class="btn btn-secondary" id="barChartBtn" disabled>é•·æ¢åœ–</button>
          <button class="btn btn-secondary" id="pieChartBtn" disabled>åœ“é¤…åœ–</button>
        </div>
      </div>
      <div class="hint" id="chartHint" style="margin-top:4px;"></div>
      <div style="margin-top:12px;">
        <canvas id="chartCanvas" height="260"></canvas>
      </div>
    </div>

    <!-- åŸºæœ¬è³‡è¨Š & å›è¦†é è¦½ -->
    <div class="section">
      <h3>åŸºæœ¬è³‡è¨Š</h3>
      <p class="hint">
        å›è¦†æ•¸ï¼š<span id="responseCount">0</span> ç­†ï¼Œ
        æœ€å¾Œæ›´æ–°æ™‚é–“ï¼š<span id="lastUpdated">-</span>
      </p>
      <div class="hint">
        ä¸‹æ–¹åªé¡¯ç¤ºå‰å¹¾ç­†å›è¦†ï¼Œæ–¹ä¾¿å¿«é€Ÿç¢ºèªã€‚è©³ç´°åˆ†æè«‹åŒ¯å‡º CSV å¾Œç”¨ Excel / SPSS è™•ç†ã€‚
      </div>
      <div id="responsesPreview"></div>
    </div>
  </main>

  <script>
    // 1. è§£æ URL åƒæ•¸
    function getQueryParam(name) {
      const urlParams = new URLSearchParams(location.search);
      return urlParams.get(name);
    }

    // 2. åˆå§‹åŒ– Firebaseï¼ˆğŸ‘‰ å’Œ index.html / respond.html ä½¿ç”¨åŒä¸€çµ„è¨­å®šï¼‰
    const firebaseConfig = {
  apiKey: "AIzaSyAexk_JbIOQWV1Jw7hqfiZDDZYY9YF-Sdk",
  authDomain: "survey-49e8d.firebaseapp.com",
  projectId: "survey-49e8d",
  storageBucket: "survey-49e8d.firebasestorage.app",
  messagingSenderId: "547257703502",
  appId: "1:547257703502:web:85e147bed62333b11c771f"
};
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // 3. DOM å…ƒç´ æŠ“å–
    const surveyIdInput = document.getElementById('surveyIdInput');
    const loadSurveyBtn = document.getElementById('loadSurveyBtn');
    const exportCsvBtn = document.getElementById('exportCsvBtn');
    const loadMsg = document.getElementById('loadMsg');
    const headerSurveyTitle = document.getElementById('headerSurveyTitle');
    const questionSelect = document.getElementById('questionSelect');
    const barChartBtn = document.getElementById('barChartBtn');
    const pieChartBtn = document.getElementById('pieChartBtn');
    const chartCanvas = document.getElementById('chartCanvas');
    const chartHint = document.getElementById('chartHint');
    const responseCountEl = document.getElementById('responseCount');
    const lastUpdatedEl = document.getElementById('lastUpdated');
    const responsesPreview = document.getElementById('responsesPreview');

    // ç‹€æ…‹
    let currentSurveyId = null;
    let questions = [];   // [{id, data}]
    let responses = [];   // [{id, data}]
    let chartInstance = null;

    // å¦‚æœç¶²å€å¸¶æœ‰ surveyIdï¼Œé å…ˆå¡«å…¥
    const urlSurveyId = getQueryParam('surveyId');
    if (urlSurveyId) {
      surveyIdInput.value = urlSurveyId;
      // è‡ªå‹•è¼‰å…¥ï¼ˆä½ ä¸æƒ³è‡ªå‹•è¼‰ä¹Ÿå¯ä»¥è¨»è§£æ‰é€™è¡Œï¼‰
      // loadSurveyAndResponses(urlSurveyId);
    }

    // æŒ‰ä¸‹ã€Œè¼‰å…¥å•å·çµæœã€
    loadSurveyBtn.addEventListener('click', () => {
      const id = surveyIdInput.value.trim();
      if (!id) {
        loadMsg.textContent = 'è«‹å…ˆè¼¸å…¥ surveyIdã€‚';
        return;
      }
      loadSurveyAndResponses(id);
    });

    // 4. è¼‰å…¥å•å· + é¡Œç›® + å›è¦†
    async function loadSurveyAndResponses(surveyId) {
      loadMsg.textContent = 'æ­£åœ¨è¼‰å…¥å•å·èˆ‡å›è¦†è³‡æ–™â€¦';
      headerSurveyTitle.textContent = '';
      questionSelect.innerHTML = '<option value="">è¼‰å…¥ä¸­â€¦</option>';
      responsesPreview.innerHTML = '';
      responseCountEl.textContent = '0';
      lastUpdatedEl.textContent = '-';
      barChartBtn.disabled = true;
      pieChartBtn.disabled = true;
      exportCsvBtn.disabled = true;
      chartHint.textContent = '';
      destroyChart();

      currentSurveyId = surveyId;
      questions = [];
      responses = [];

      try {
        // 4-1 å•å·åŸºæœ¬è³‡æ–™
        const surveyDoc = await db.collection('surveys').doc(surveyId).get();
        if (!surveyDoc.exists) {
          throw new Error('æ‰¾ä¸åˆ°é€™ä»½å•å·ï¼Œè«‹ç¢ºèª surveyId æ˜¯å¦æ­£ç¢ºã€‚');
        }
        const sData = surveyDoc.data();
        const surveyTitle = sData.title || '(æœªå‘½åå•å·)';
        headerSurveyTitle.textContent = surveyTitle;
        document.title = surveyTitle + ' - çµæœåˆ†æ';

        // 4-2 é¡Œç›®ï¼ˆsubcollection: surveys/{id}/questionsï¼‰
        const qSnap = await db.collection('surveys').doc(surveyId)
          .collection('questions')
          .orderBy('order', 'asc')
          .get();

        if (qSnap.empty) {
          throw new Error('æ­¤å•å·å°šæœªè¨­å®šé¡Œç›®ï¼Œç„¡æ³•é€²è¡Œçµ±è¨ˆåˆ†æã€‚');
        }
        questions = qSnap.docs.map(doc => ({ id: doc.id, data: doc.data() }));
        renderQuestionOptions();

        // 4-3 å›è¦†ï¼ˆä¸»é›†åˆ responsesï¼Œä¾ surveyId ç¯©é¸ï¼‰
        const rSnap = await db.collection('responses')
          .where('surveyId', '==', surveyId)
          .orderBy('createdAt', 'asc')
          .get();

        responses = rSnap.docs.map(doc => ({ id: doc.id, data: doc.data() }));

        responseCountEl.textContent = responses.length;

        if (responses.length > 0) {
          const last = responses[responses.length - 1].data.createdAt;
          if (last && last.toDate) {
            lastUpdatedEl.textContent = last.toDate().toLocaleString();
          } else {
            lastUpdatedEl.textContent = '-';
          }
        } else {
          lastUpdatedEl.textContent = '-';
        }

        renderResponsesPreview();
        exportCsvBtn.disabled = responses.length === 0;

        loadMsg.textContent = 'è¼‰å…¥å®Œæˆã€‚';

      } catch (err) {
        console.error(err);
        loadMsg.textContent = 'è¼‰å…¥å¤±æ•—ï¼š' + (err.message || 'è«‹æª¢æŸ¥ Firestore è¦å‰‡æˆ–ç¶²è·¯é€£ç·šã€‚');
      }
    }

    // 5. é¡Œç›®ä¸‹æ‹‰é¸å–®
    function renderQuestionOptions() {
      questionSelect.innerHTML = '<option value="">è«‹é¸æ“‡é¡Œç›®</option>';
      questions.forEach((q, idx) => {
        const opt = document.createElement('option');
        opt.value = q.id;
        opt.textContent = `${idx + 1}. ${q.data.text || '(æœªå‘½åé¡Œç›®)'}`;
        questionSelect.appendChild(opt);
      });
      barChartBtn.disabled = false;
      pieChartBtn.disabled = false;
    }

    // 6. å›è¦†é è¦½ï¼ˆåªé¡¯ç¤ºå‰å¹¾ç­†ï¼‰
    function renderResponsesPreview() {
      if (responses.length === 0) {
        responsesPreview.innerHTML = '<p class="hint">ç›®å‰å°šç„¡ä»»ä½•å›è¦†ã€‚</p>';
        return;
      }

      const maxPreview = 5;
      const preview = responses.slice(0, maxPreview);

      let html = '<table><thead><tr><th>#</th><th>æ™‚é–“</th><th>answers JSON</th></tr></thead><tbody>';
      preview.forEach((r, idx) => {
        const d = r.data;
        const time = d.createdAt && d.createdAt.toDate
          ? d.createdAt.toDate().toLocaleString()
          : '-';
        html += `<tr>
          <td>${idx + 1}</td>
          <td>${time}</td>
          <td><code>${JSON.stringify(d.answers || {})}</code></td>
        </tr>`;
      });
      html += '</tbody></table>';

      if (responses.length > maxPreview) {
        html += `<p class="hint">å…± ${responses.length} ç­†ï¼Œåƒ…é¡¯ç¤ºå‰ ${maxPreview} ç­†ã€‚</p>`;
      }

      responsesPreview.innerHTML = html;
    }

    // 7. çµ±è¨ˆ & ç•«åœ–
    questionSelect.addEventListener('change', () => {
      chartHint.textContent = '';
      destroyChart();
    });

    barChartBtn.addEventListener('click', () => {
      drawChart('bar');
    });

    pieChartBtn.addEventListener('click', () => {
      drawChart('pie');
    });

    function drawChart(type) {
      const qId = questionSelect.value;
      if (!qId) {
        chartHint.textContent = 'è«‹å…ˆé¸æ“‡ä¸€å€‹é¡Œç›®ã€‚';
        return;
      }
      const q = questions.find(q => q.id === qId);
      if (!q) return;

      const qData = q.data;
      const agg = aggregateQuestion(qId, qData);

      if (!agg || agg.type === 'text') {
        destroyChart();
        chartHint.textContent = `æ­¤é¡Œç‚ºé–‹æ”¾å¼é¡Œç›®ï¼Œå…±æœ‰ ${agg ? agg.count : 0} å‰‡æ–‡å­—å›ç­”ï¼Œä¸é©åˆç”¨åœ–è¡¨å‘ˆç¾ã€‚`;
        return;
      }

      chartHint.textContent = `æ­¤é¡Œå…±æœ‰ ${agg.total} ç­”æ¡ˆæ¨£æœ¬ã€‚`;

      const ctx = chartCanvas.getContext('2d');
      destroyChart();

      chartInstance = new Chart(ctx, {
        type: type,
        data: {
          labels: agg.labels,
          datasets: [{
            label: qData.text || '',
            data: agg.data
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { display: type === 'pie' },
            tooltip: { enabled: true }
          },
          scales: type === 'bar' ? {
            y: {
              beginAtZero: true,
              ticks: { precision: 0 }
            }
          } : {}
        }
      });
    }

    function destroyChart() {
      if (chartInstance) {
        chartInstance.destroy();
        chartInstance = null;
      }
    }

    // æ ¹æ“šé¡Œå‹åšç°¡å–®çµ±è¨ˆ
    function aggregateQuestion(qId, qData) {
      const type = qData.type || 'text';

      if (responses.length === 0) {
        return { type, labels: [], data: [], total: 0, count: 0 };
      }

      if (type === 'single') {
        const map = {};
        (qData.options || []).forEach(o => { map[o] = 0; });
        let total = 0;
        responses.forEach(r => {
          const ans = (r.data.answers || {})[qId];
          if (ans && map.hasOwnProperty(ans)) {
            map[ans]++;
            total++;
          }
        });
        return {
          type,
          labels: Object.keys(map),
          data: Object.values(map),
          total
        };

      } else if (type === 'multiple') {
        const map = {};
        (qData.options || []).forEach(o => { map[o] = 0; });
        let total = 0;
        responses.forEach(r => {
          const ans = (r.data.answers || {})[qId];
          if (Array.isArray(ans)) {
            ans.forEach(a => {
              if (map.hasOwnProperty(a)) {
                map[a]++;
                total++;
              }
            });
          }
        });
        return {
          type,
          labels: Object.keys(map),
          data: Object.values(map),
          total
        };

      } else if (type === 'scale') {
        const min = qData.scaleMin || 1;
        const max = qData.scaleMax || 5;
        const map = {};
        for (let i = min; i <= max; i++) map[i] = 0;
        let total = 0;
        responses.forEach(r => {
          const ans = (r.data.answers || {})[qId];
          if (ans != null && ans !== '') {
            const n = Number(ans);
            if (!Number.isNaN(n) && map.hasOwnProperty(n)) {
              map[n]++;
              total++;
            }
          }
        });
        return {
          type,
          labels: Object.keys(map),
          data: Object.values(map),
          total
        };

      } else {
        // é–‹æ”¾å¼æ–‡å­—ï¼šåªçµ±è¨ˆæœ‰å¡«çš„æ¬¡æ•¸
        let count = 0;
        responses.forEach(r => {
          const ans = (r.data.answers || {})[qId];
          if (ans && String(ans).trim() !== '') count++;
        });
        return { type: 'text', count };
      }
    }

    // 8. åŒ¯å‡º CSVï¼ˆå¯ç›´æ¥ç”¨ Excel æ‰“é–‹ï¼‰
    exportCsvBtn.addEventListener('click', () => {
      if (!currentSurveyId || responses.length === 0) return;
      const csv = buildCsv();
      downloadCsv(csv, `survey_${currentSurveyId}_responses.csv`);
    });

    function buildCsv() {
      // æ¬„ä½ï¼šresponseId, createdAt, Q1_é¡Œç›®å…§å®¹, Q2_é¡Œç›®å…§å®¹...
      const header = ['responseId', 'createdAt'];
      questions.forEach((q, idx) => {
        const label = `Q${idx + 1}_${q.data.text || ''}`.replace(/[\r\n,]/g, ' ');
        header.push(label);
      });

      const lines = [header.join(',')];

      responses.forEach(r => {
        const d = r.data;
        const row = [];
        row.push(r.id);
        const time = d.createdAt && d.createdAt.toDate
          ? d.createdAt.toDate().toISOString()
          : '';
        row.push(time);

        const ans = d.answers || {};
        questions.forEach(q => {
          const qId = q.id;
          const v = ans[qId];
          let cell = '';
          if (Array.isArray(v)) {
            cell = v.join('|');    // å¤šé¸ç”¨ | ä¸²èµ·ä¾†
          } else if (v != null) {
            cell = String(v);
          }
          cell = cell.replace(/"/g, '""'); // escape "
          if (cell.indexOf(',') >= 0 || cell.indexOf('"') >= 0 || cell.indexOf('\n') >= 0) {
            cell = `"${cell}"`;
          }
          row.push(cell);
        });

        lines.push(row.join(','));
      });

      return lines.join('\r\n');
    }

    function downloadCsv(csvText, filename) {
      const blob = new Blob([csvText], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }
  </script>
</body>
</html>
