<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>å•å·ç³»çµ±ï½œGoogle Forms çµ±è¨ˆè¦–è¦ºåŒ–æ•´åˆç‰ˆ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Google å­—é«” -->
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

  <style>
    body {
      margin: 0;
      font-family: "Noto Sans TC", sans-serif;
      background: #eef2f7;
      display: flex;
      height: 100vh;
      overflow: hidden;
    }

    /* å·¦å´å•å·é¸å–® */
    #sidebar {
      width: 280px;
      background: #ffffff;
      border-right: 1px solid #ddd;
      padding: 16px;
      overflow-y: auto;
    }
    #sidebar h2 {
      margin-top: 0;
      font-size: 18px;
      font-weight: 600;
    }
    #surveyList li {
      list-style: none;
      padding: 10px;
      border-radius: 8px;
      margin-bottom: 6px;
      cursor: pointer;
      transition: 0.2s;
    }
    #surveyList li:hover { background: #f0f7ff; }
    #surveyList li.active { background: #e3f2fd; border-left: 4px solid #1976d2; }

    /* ä¸»å€åŸŸ */
    #main {
      flex: 1;
      display: flex;
      flex-direction: column;
    }

    header {
      padding: 14px 20px;
      background: #673ab7;
      color: white;
      font-size: 20px;
      font-weight: 600;
    }

    /* Tabs */
    #tabs {
      display: flex;
      background: white;
      border-bottom: 1px solid #ccc;
    }
    #tabs div {
      flex: 1;
      text-align: center;
      padding: 12px 20px;
      cursor: pointer;
      font-weight: 500;
    }
    #tabs .active {
      border-bottom: 3px solid #673ab7;
      background: #f3e5f5;
      color: #673ab7;
    }

    /* å…§å®¹é  */
    .tabPage {
      display: none;
      padding: 20px;
      height: calc(100vh - 120px);
      overflow-y: auto;
      animation: fadeIn 0.4s ease;
    }
    .tabPage.active { display: block; }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(7px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .card {
      background: white;
      padding: 16px;
      border-radius: 12px;
      margin-bottom: 20px;
      box-shadow: 0 3px 10px rgba(0,0,0,0.08);
    }

    /* Google Forms ç´«è‰² */
    :root {
      --gf-primary: #673ab7;
      --gf-primary-light: #7e57c2;
      --gf-primary-bg: #f3e5f5;
    }

    .result-section {
      padding: 0 5px;
    }

    .stat-card {
      background: white;
      border-radius: 16px;
      padding: 20px;
      margin-bottom: 24px;
      box-shadow: 0 4px 14px rgba(0,0,0,0.08);
      border-left: 6px solid var(--gf-primary);
      animation: fadeIn 0.5s ease;
    }

    .stat-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .stat-title {
      font-size: 18px;
      font-weight: 600;
    }
    .stat-count {
      background: var(--gf-primary);
      padding: 5px 12px;
      border-radius: 20px;
      font-size: 13px;
      color: white;
    }

    .open-text-box {
      background: var(--gf-primary-bg);
      padding: 14px;
      border-radius: 10px;
      margin-bottom: 8px;
      font-size: 14px;
    }

    button {
      padding: 10px 16px;
      border-radius: 6px;
      cursor: pointer;
      border: none;
    }
    button.primary {
      background: #673ab7;
      color: white;
    }
    button.primary:hover {
      background: #5e35b1;
    }
  </style>
</head>

<body>

  <!-- å·¦å´å•å·åˆ—è¡¨ -->
  <div id="sidebar">
    <h2>ğŸ“‹ å•å·åˆ—è¡¨</h2>
    <ul id="surveyList"></ul>
  </div>

  <!-- ä¸»å…§å®¹ -->
  <div id="main">

    <header id="headerTitle">è«‹é¸æ“‡å·¦å´å•å·</header>

    <!-- Tabs -->
    <div id="tabs">
      <div id="tabFill" class="active">ğŸ“ å¡«ç­”å•å·</div>
      <div id="tabResult">ğŸ“Š çµ±è¨ˆçµæœ</div>
    </div>

    <!-- å¡«ç­”é  -->
    <div id="pageFill" class="tabPage active">

      <div id="fillInfo" class="card" style="display:none;">
        <h3>å•å·è³‡è¨Š</h3>
        <p>æ¨™é¡Œï¼š<span id="fillTitle"></span></p>
        <p>æè¿°ï¼š<span id="fillDesc"></span></p>
      </div>

      <div id="fillFormCard" class="card" style="display:none;">
        <h3>å¡«å¯«å•å·</h3>
        <form id="fillForm"></form>
        <button class="primary" id="submitBtn">é€å‡º</button>
        <div id="submitMsg" style="margin-top:10px;"></div>
      </div>

    </div>

    <!-- çµ±è¨ˆé ï¼ˆGoogle Forms è¦–è¦ºåŒ–ï¼‰ -->
    <div id="pageResult" class="tabPage">
      <div id="gfResultArea" class="result-section"></div>
    </div>

  </div>

<script>

/* ----------------------------------------------------
   Firebaseï¼ˆè«‹è‡ªè¡Œæ›¿æ› configï¼‰
---------------------------------------------------- */
const firebaseConfig = {
  apiKey: "AIzaSyAexk_JbIOQWV1Jw7hqfiZDDZYY9YF-Sdk",
  authDomain: "survey-49e8d.firebaseapp.com",
  projectId: "survey-49e8d",
  storageBucket: "survey-49e8d.firebasestorage.app",
  messagingSenderId: "547257703502",
  appId: "1:547257703502:web:85e147bed62333b11c771f"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

/* ----------------------------------------------------
   Tabs åˆ‡æ›
---------------------------------------------------- */
const tabFill = document.getElementById("tabFill");
const tabResult = document.getElementById("tabResult");
const pageFill = document.getElementById("pageFill");
const pageResult = document.getElementById("pageResult");

function switchTab(page) {
  tabFill.classList.remove("active");
  tabResult.classList.remove("active");
  pageFill.classList.remove("active");
  pageResult.classList.remove("active");

  if (page === "fill") {
    tabFill.classList.add("active");
    pageFill.classList.add("active");
  } else {
    tabResult.classList.add("active");
    pageResult.classList.add("active");
  }
}

tabFill.onclick = () => switchTab("fill");
tabResult.onclick = () => switchTab("result");

/* ----------------------------------------------------
   å•å·åˆ—è¡¨è¼‰å…¥
---------------------------------------------------- */
let selectedSurveyId = null;
let selectedSurveyData = null;
let surveyQuestions = [];
let responses = [];

function loadSurveyList() {
  db.collection("surveys")
    .orderBy("createdAt", "desc")
    .onSnapshot((snap) => {
      const ul = document.getElementById("surveyList");
      ul.innerHTML = "";
      snap.forEach((doc) => {
        const li = document.createElement("li");
        li.textContent = doc.data().title;
        li.dataset.id = doc.id;

        li.onclick = () => selectSurvey(doc.id, doc.data());
        ul.appendChild(li);
      });
    });
}
loadSurveyList();

/* ----------------------------------------------------
   é¸å–å•å· â†’ è¼‰å…¥é¡Œç›® & å›è¦†
---------------------------------------------------- */
function selectSurvey(id, data) {
  selectedSurveyId = id;
  selectedSurveyData = data;

  document.getElementById("headerTitle").textContent = data.title;

  document.querySelectorAll("#surveyList li").forEach((li) => {
    li.classList.toggle("active", li.dataset.id === id);
  });

  loadFillPage(id, data);
  loadResultPage(id, data);
  switchTab("fill");
}

/* ----------------------------------------------------
   å¡«ç­”é ï¼ˆRespondï¼‰
---------------------------------------------------- */
async function loadFillPage(id, data) {
  document.getElementById("fillInfo").style.display = "block";
  document.getElementById("fillFormCard").style.display = "block";

  document.getElementById("fillTitle").textContent = data.title;
  document.getElementById("fillDesc").textContent = data.description;

  const qSnap = await db
    .collection("surveys")
    .doc(id)
    .collection("questions")
    .orderBy("order")
    .get();

  surveyQuestions = qSnap.docs.map((d) => ({
    id: d.id,
    data: d.data()
  }));

  const form = document.getElementById("fillForm");
  form.innerHTML = "";

  surveyQuestions.forEach((q) => {
    const div = document.createElement("div");
    div.className = "card";

    div.innerHTML = `<b>${q.data.text}</b><br><br>`;

    if (q.data.type === "single") {
      q.data.options.forEach((opt) => {
        div.innerHTML += `<label><input type="radio" name="${q.id}" value="${opt}"> ${opt}</label><br>`;
      });

    } else if (q.data.type === "multiple") {
      q.data.options.forEach((opt) => {
        div.innerHTML += `<label><input type="checkbox" name="${q.id}" value="${opt}"> ${opt}</label><br>`;
      });

    } else if (q.data.type === "scale") {
      div.innerHTML += `<select name="${q.id}">
        <option value="">é¸æ“‡åˆ†æ•¸</option>
        ${Array.from({ length: q.data.scaleMax - q.data.scaleMin + 1 }, (_, i) =>
          `<option value="${i + q.data.scaleMin}">${i + q.data.scaleMin}</option>`
        ).join("")}
      </select>`;

    } else {
      div.innerHTML += `<textarea name="${q.id}" rows="3" style="width:100%;"></textarea>`;
    }

    form.appendChild(div);
  });
}

/* ----------------------------------------------------
   é€å‡ºå¡«ç­”
---------------------------------------------------- */
document.getElementById("submitBtn").onclick = async () => {
  const form = document.getElementById("fillForm");
  const fd = new FormData(form);
  const answers = {};

  for (let q of surveyQuestions) {
    if (q.data.type === "multiple") {
      answers[q.id] = fd.getAll(q.id);
    } else {
      answers[q.id] = fd.get(q.id);
    }
  }

  await db.collection("responses").add({
    surveyId: selectedSurveyId,
    answers,
    createdAt: firebase.firestore.FieldValue.serverTimestamp()
  });

  document.getElementById("submitMsg").innerHTML = 
    "<span style='color:green'>å¡«å¯«æˆåŠŸï¼</span>";
};

/* ----------------------------------------------------
   çµ±è¨ˆé ï¼ˆGoogle Forms è¦–è¦ºåŒ–ï¼‰
---------------------------------------------------- */
async function loadResultPage(id, data) {
  const rSnap = await db
    .collection("responses")
    .where("surveyId", "==", id)
    .get();

  responses = rSnap.docs.map((d) => d.data());

  renderGoogleFormsStats();
}

function aggregateQuestion(qId) {
  const q = surveyQuestions.find((x) => x.id === qId);
  const type = q.data.type;

  if (type === "single" || type === "multiple") {
    const map = {};
    q.data.options.forEach((o) => (map[o] = 0));

    responses.forEach((r) => {
      const ans = r.answers[qId];
      if (type === "single" && ans) map[ans]++;
      if (type === "multiple" && Array.isArray(ans)) {
        ans.forEach((a) => (map[a]++));
      }
    });

    return { type, labels: Object.keys(map), values: Object.values(map), total: responses.length };
  }

  if (type === "scale") {
    const map = {};
    for (let i = q.data.scaleMin; i <= q.data.scaleMax; i++) map[i] = 0;

    responses.forEach((r) => {
      const ans = Number(r.answers[qId]);
      if (!isNaN(ans) && map[ans] !== undefined) map[ans]++;
    });

    return { type, labels: Object.keys(map), values: Object.values(map), total: responses.length };
  }

  if (type === "text") {
    let count = 0;
    responses.forEach((r) => {
      const ans = r.answers[qId];
      if (ans && ans.trim()) count++;
    });
    return { type, count };
  }
}

/* Google Forms è¦–è¦ºåŒ–ï¼šä¸»æ¸²æŸ“ */
function renderGoogleFormsStats() {
  const container = document.getElementById("gfResultArea");
  container.innerHTML = "";

  surveyQuestions.forEach((q, i) => {
    const agg = aggregateQuestion(q.id);

    const card = document.createElement("div");
    card.className = "stat-card";

    card.innerHTML = `
      <div class="stat-header">
        <div class="stat-title">${i + 1}. ${q.data.text}</div>
        <div class="stat-count">${agg.total || agg.count || 0} å›è¦†</div>
      </div>
      <div id="chart_${q.id}" class="stat-chart"></div>
    `;

    container.appendChild(card);

    if (q.data.type === "text") {
      renderTextBox(q.id);
    } else {
      renderChart(q.id, agg);
    }
  });
}

/* æ¸²æŸ“ Chart */
function renderChart(qId, agg) {
  const div = document.getElementById("chart_" + qId);
  div.innerHTML = `<canvas id="c_${qId}" height="250"></canvas>`;
  const ctx = document.getElementById("c_" + qId);

  new Chart(ctx, {
    type: agg.labels.length > 5 ? "bar" : "pie",
    data: {
      labels: agg.labels,
      datasets: [{
        data: agg.values,
        backgroundColor: [
          "#673ab7", "#9575cd", "#7e57c2",
          "#b39ddb", "#5e35b1", "#4527a0"
        ]
      }]
    },
    options: { plugins: { legend: { position: "bottom" } } }
  });
}

/* æ¸²æŸ“æ–‡å­—é¡Œ */
function renderTextBox(qId) {
  const div = document.getElementById("chart_" + qId);
  responses.forEach((r) => {
    const ans = r.answers[qId];
    if (ans) {
      const box = document.createElement("div");
      box.className = "open-text-box";
      box.textContent = ans;
      div.appendChild(box);
    }
  });
}

</script>

</html>
