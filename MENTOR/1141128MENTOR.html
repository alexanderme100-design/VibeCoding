<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>å•å·ç®¡ç†ç³»çµ± - Firebase Firestore</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- ç°¡å–®å…§åµŒæ¨£å¼ï¼Œä½ å¯ä»¥ä¹‹å¾Œæ”¹æˆè‡ªå·±å–œæ­¡çš„è¨­è¨ˆ -->
  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Noto Sans TC", sans-serif;
      background: #f5f5f5;
    }
    header {
      background: #1976d2;
      color: #fff;
      padding: 12px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    header h1 {
      margin: 0;
      font-size: 20px;
    }
    header small {
      font-size: 12px;
      opacity: 0.85;
    }
    main {
      display: flex;
      height: calc(100vh - 56px);
    }
    aside {
      width: 280px;
      border-right: 1px solid #ddd;
      background: #fafafa;
      padding: 12px;
      overflow-y: auto;
    }
    section {
      flex: 1;
      padding: 16px;
      overflow-y: auto;
    }
    h2 {
      margin-top: 0;
      font-size: 18px;
    }
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 6px 12px;
      border-radius: 4px;
      border: none;
      cursor: pointer;
      font-size: 14px;
      transition: 0.15s;
    }
    .btn-primary {
      background: #1976d2;
      color: #fff;
    }
    .btn-secondary {
      background: #e0e0e0;
      color: #333;
    }
    .btn-danger {
      background: #f44336;
      color: #fff;
    }
    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    .btn + .btn {
      margin-left: 8px;
    }
    input[type="text"],
    input[type="number"],
    textarea,
    select {
      width: 100%;
      padding: 6px 8px;
      margin-top: 4px;
      margin-bottom: 8px;
      border-radius: 4px;
      border: 1px solid #ccc;
      font-size: 14px;
    }
    label {
      font-size: 13px;
      display: block;
      margin-top: 4px;
    }
    .sidebar-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }
    .sidebar-header button {
      font-size: 13px;
    }
    #surveySearch {
      margin-bottom: 8px;
    }
    #surveyList {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    #surveyList li {
      padding: 6px 8px;
      margin-bottom: 4px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 13px;
      border: 1px solid transparent;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    #surveyList li span.title {
      flex: 1;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    #surveyList li span.badge {
      font-size: 11px;
      padding: 2px 6px;
      border-radius: 999px;
      margin-left: 4px;
    }
    #surveyList li.active {
      background: #e3f2fd;
      border-color: #1976d2;
    }
    #surveyList li:hover {
      background: #eee;
    }
    .badge-draft { background: #fff9c4; }
    .badge-published { background: #c8e6c9; }
    .badge-archived { background: #eeeeee; }

    .card {
      background: #fff;
      border-radius: 6px;
      padding: 12px 14px;
      margin-bottom: 12px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.06);
    }
    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }
    .card-header h3 {
      margin: 0;
      font-size: 16px;
    }
    .tagline {
      font-size: 12px;
      color: #555;
    }
    .row {
      display: flex;
      gap: 12px;
    }
    .col {
      flex: 1;
    }
    .question-item {
      border-bottom: 1px solid #eee;
      padding: 6px 0;
      font-size: 13px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
    }
    .question-main {
      flex: 1;
    }
    .question-meta {
      font-size: 11px;
      color: #777;
    }
    .question-actions button {
      font-size: 11px;
      padding: 3px 6px;
    }
    .hint {
      font-size: 12px;
      color: #777;
    }
    .pill {
      font-size: 11px;
      padding: 2px 6px;
      border-radius: 999px;
      background: #eeeeee;
      margin-right: 4px;
    }
    .flex {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .flex-between {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .mt8 { margin-top: 8px; }
    .mt12 { margin-top: 12px; }
    .hidden { display: none; }
  </style>

  <!-- Firebase JS SDK v9 (compat ç‰ˆï¼Œæ–¹ä¾¿åœ¨ä¸€å€‹æª”æ¡ˆè£¡ç›´æ¥ç”¨) -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
</head>
<body>
  <header>
    <div>
      <h1>å•å·ç®¡ç†ç³»çµ±</h1>
      <small>Firebase Firestore å¾Œç«¯ Â· åœ–å½¢åŒ–ä»‹é¢</small>
    </div>
    <div id="statusText" style="font-size: 12px; opacity: 0.85;">
      å°šæœªåˆå§‹åŒ– Firebase
    </div>
  </header>

  <main>
    <!-- å·¦å´ï¼šå•å·åˆ—è¡¨ -->
    <aside>
      <div class="sidebar-header">
        <strong>å•å·åˆ—è¡¨</strong>
        <button class="btn btn-primary" id="newSurveyBtn">ï¼‹ æ–°å¢å•å·</button>
      </div>
      <input type="text" id="surveySearch" placeholder="æœå°‹å•å·æ¨™é¡Œ..." />
      <ul id="surveyList"></ul>
    </aside>

    <!-- å³å´ï¼šå•å·ç·¨è¼¯ & é¡Œç›®ç®¡ç† -->
    <section>
      <!-- å•å·åŸºæœ¬è³‡æ–™ -->
      <div class="card">
        <div class="card-header">
          <h3>å•å·åŸºæœ¬è³‡æ–™</h3>
          <div>
            <button class="btn btn-secondary" id="duplicateSurveyBtn" disabled>è¤‡è£½å•å·</button>
            <button class="btn btn-danger" id="deleteSurveyBtn" disabled>åˆªé™¤å•å·</button>
            <button class="btn btn-primary" id="saveSurveyBtn">å„²å­˜å•å·</button>
          </div>
        </div>
        <div class="tagline">
          å¡«å®Œå¾ŒæŒ‰ã€Œå„²å­˜å•å·ã€ï¼Œå·¦å´åˆ—è¡¨æœƒå³æ™‚æ›´æ–°ã€‚
        </div>

        <label>å•å·æ¨™é¡Œ <span style="color:red">*</span>
          <input type="text" id="surveyTitle" placeholder="ä¾‹å¦‚ï¼š113å­¸å¹´åº¦äº¤é€šå®‰å…¨å•å·" />
        </label>

        <label>å•å·èªªæ˜
          <textarea id="surveyDescription" rows="3" placeholder="çµ¦å¡«ç­”è€…çœ‹çš„ç°¡çŸ­èªªæ˜ï¼Œä¾‹å¦‚ï¼šæœ¬å•å·ç‚ºåŒ¿åèª¿æŸ¥ï¼Œåƒ…ä¾›å­¸æ ¡æ•™å­¸èˆ‡ç ”ç©¶ä½¿ç”¨ã€‚"></textarea>
        </label>

        <div class="row">
          <div class="col">
            <label>ç‹€æ…‹
              <select id="surveyStatus">
                <option value="draft">è‰ç¨¿ï¼ˆå°šæœªç™¼ä½ˆï¼‰</option>
                <option value="published">å·²ç™¼ä½ˆï¼ˆå¯ä»¥å¡«ç­”ï¼‰</option>
                <option value="archived">å·²å°å­˜ï¼ˆä¸å†ä½¿ç”¨ï¼‰</option>
              </select>
            </label>
          </div>
          <div class="col">
            <label>å•å·é¡åˆ¥ï¼ˆé¸å¡«ï¼‰
              <input type="text" id="surveyCategory" placeholder="ä¾‹å¦‚ï¼šäº¤é€šå®‰å…¨ã€è¦–åŠ›ä¿å¥ã€å¥åº·ä¿ƒé€²..." />
            </label>
          </div>
        </div>

        <div class="row">
          <div class="col">
            <label>å°è±¡ï¼ˆé¸å¡«ï¼‰
              <input type="text" id="surveyTarget" placeholder="ä¾‹å¦‚ï¼šå­¸ç”Ÿã€å®¶é•·ã€æ•™å¸«..." />
            </label>
          </div>
          <div class="col" style="padding-top: 10px;">
            <label>
              <input type="checkbox" id="surveyIsAnonymous" />
              æ­¤å•å·ç‚ºåŒ¿åå¡«ç­”ï¼ˆä¸æ”¶é›†èº«åˆ†è³‡æ–™ï¼‰
            </label>
          </div>
        </div>

        <div class="hint">
          âœ¨ å»ºè­°æµç¨‹ï¼šå…ˆæŠŠå•å·ç¶­æŒåœ¨ã€Œè‰ç¨¿ã€ï¼Œç·¨å¥½é¡Œç›®å¾Œï¼Œç™¼ä½ˆå‰å†æ”¹ç‚ºã€Œå·²ç™¼ä½ˆã€ã€‚
        </div>
      </div>

      <!-- é¡Œç›®ç®¡ç† -->
      <div class="card">
        <div class="card-header">
          <h3>é¡Œç›®ç®¡ç†</h3>
          <div class="hint">
            å…ˆé¸æ“‡æˆ–å„²å­˜ä¸€ä»½å•å·å¾Œæ‰èƒ½æ–°å¢é¡Œç›®ã€‚
          </div>
        </div>

        <!-- é¡Œç›®åˆ—è¡¨ -->
        <div id="questionListContainer" class="mt8">
          <strong>å·²è¨­å®šé¡Œç›®ï¼š</strong>
          <div id="noQuestionHint" class="hint">ç›®å‰å°šæœªæ–°å¢ä»»ä½•é¡Œç›®ã€‚</div>
          <div id="questionList"></div>
        </div>

        <hr class="mt12" />

        <!-- é¡Œç›®ç·¨è¼¯è¡¨å–® -->
        <div>
          <div class="flex-between">
            <strong id="questionFormTitle">æ–°å¢é¡Œç›®</strong>
            <span class="hint" id="editingQuestionHint" style="display:none;">
              æ­£åœ¨ç·¨è¼¯é¡Œç›®ï¼Œä¿®æ”¹å¾Œè«‹æŒ‰ã€Œå„²å­˜é¡Œç›®ã€ã€‚
            </span>
          </div>

          <label>é¡Œç›®å…§å®¹ <span style="color:red">*</span>
            <textarea id="questionText" rows="2" placeholder="ä¾‹å¦‚ï¼šä¸Šã€æ”¾å­¸æ™‚ï¼Œä½ æœ€å¸¸ä½¿ç”¨å“ªä¸€ç¨®äº¤é€šæ–¹å¼ï¼Ÿ"></textarea>
          </label>

          <div class="row">
            <div class="col">
              <label>é¡Œå‹
                <select id="questionType">
                  <option value="single">å–®é¸é¡Œ</option>
                  <option value="multiple">å¤šé¸é¡Œ</option>
                  <option value="scale">é‡è¡¨é¡Œï¼ˆä¾‹å¦‚ 1â€“5 åˆ†åŒæ„ç¨‹åº¦ï¼‰</option>
                  <option value="text">é–‹æ”¾å¼å•ç­”</option>
                </select>
              </label>
            </div>
            <div class="col" style="padding-top: 10px;">
              <label>
                <input type="checkbox" id="questionRequired" />
                æ­¤é¡Œç‚ºå¿…å¡«
              </label>
            </div>
          </div>

          <div id="optionsField">
            <label>é¸é …ï¼ˆä»¥é€—è™Ÿ , åˆ†éš”ï¼‰
              <input type="text" id="questionOptions" placeholder="ä¾‹ï¼šéå¸¸åŒæ„,åŒæ„,æ™®é€š,ä¸åŒæ„,éå¸¸ä¸åŒæ„" />
            </label>
          </div>

          <div id="scaleField" class="hidden">
            <div class="row">
              <div class="col">
                <label>é‡è¡¨æœ€å°å€¼
                  <input type="number" id="scaleMin" value="1" />
                </label>
              </div>
              <div class="col">
                <label>é‡è¡¨æœ€å¤§å€¼
                  <input type="number" id="scaleMax" value="5" />
                </label>
              </div>
            </div>
            <div class="hint">
              ä¾‹ï¼š1 = éå¸¸ä¸åŒæ„ï¼Œ5 = éå¸¸åŒæ„ï¼ˆå¯¦éš›èªªæ˜å¯ä»¥åœ¨é¡Œç›®å…§å®¹è£¡å¯«æ¸…æ¥šï¼‰ã€‚
            </div>
          </div>

          <div class="mt8">
            <button class="btn btn-primary" id="saveQuestionBtn">å„²å­˜é¡Œç›®</button>
            <button class="btn btn-secondary" id="cancelEditQuestionBtn" style="display:none;">å–æ¶ˆç·¨è¼¯</button>
          </div>

          <hr class="mt12" />

          <!-- é¡å¤–åŠ åˆ†åŠŸèƒ½ï¼šæ‰¹æ¬¡æ–°å¢å¤šé¡Œ -->
          <div>
            <div class="flex-between">
              <strong>æ‰¹æ¬¡æ–°å¢å¤šé¡Œï¼ˆå¯é¸ï¼‰</strong>
              <span class="hint">æ¯ä¸€è¡Œæœƒè®Šæˆä¸€é¡Œã€Œé–‹æ”¾å¼å•ç­”ã€é¡Œå‹ã€‚</span>
            </div>
            <textarea id="bulkQuestions" rows="3" placeholder="åœ¨é€™è£¡è²¼ä¸Šå¤šè¡Œé¡Œç›®ï¼Œæ¯ä¸€è¡Œæœƒè‡ªå‹•è®Šæˆä¸€é¡Œã€‚"></textarea>
            <div class="mt8">
              <button class="btn btn-secondary" id="addBulkQuestionsBtn">ä¸€éµåŠ å…¥å¤šé¡Œ</button>
            </div>
          </div>
        </div>
      </div>

      <!-- å°æç¤ºï¼é ç•™ä½ç½® -->
      <div class="card">
        <strong>ä¹‹å¾Œå¯ä»¥å†åŠ çš„åŠŸèƒ½ï¼ˆå·²é ç•™æ¬„ä½ï¼‰ï¼š</strong>
        <ul class="hint">
          <li>å•å·å¡«ç­”ç¶²å€ç”¢ç”Ÿï¼ˆä¾‹å¦‚ï¼š<code>/respond.html?surveyId=...</code>ï¼‰</li>
          <li>å³æ™‚çµ±è¨ˆåœ–è¡¨ï¼ˆé•·æ¢åœ–ã€åœ“é¤…åœ–ï¼‰</li>
          <li>åŒ¯å‡ºå¡«ç­”çµæœæˆ CSV / Excelï¼ˆæ­é… <code>responses</code> é›†åˆï¼‰</li>
        </ul>
      </div>
    </section>
  </main>

  <script>
    // ========================
    // 1. åˆå§‹åŒ– Firebase
    // ========================
    // ğŸ‘‰ é€™è£¡æŠŠ YOUR_XXXX æ›æˆä½ åœ¨ Firebase å°ˆæ¡ˆè¨­å®šè£¡çš„ config
   const firebaseConfig = {
  apiKey: "AIzaSyAexk_JbIOQWV1Jw7hqfiZDDZYY9YF-Sdk",
  authDomain: "survey-49e8d.firebaseapp.com",
  projectId: "survey-49e8d",
  storageBucket: "survey-49e8d.firebasestorage.app",
  messagingSenderId: "547257703502",
  appId: "1:547257703502:web:85e147bed62333b11c771f"
};

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const serverTimestamp = firebase.firestore.FieldValue.serverTimestamp();

    const statusText = document.getElementById('statusText');
    statusText.textContent = 'Firebase å·²åˆå§‹åŒ–ï¼Œæ­£åœ¨è¼‰å…¥å•å·â€¦';

    // ========================
    // 2. å…¨åŸŸç‹€æ…‹
    // ========================
    let selectedSurveyId = null;
    let selectedSurveyData = null;
    let editingQuestionId = null;
    let questionsUnsubscribe = null;
    let surveysUnsubscribe = null;

    // ========================
    // 3. å•å·åˆ—è¡¨ & æœå°‹
    // ========================
    const surveyListEl = document.getElementById('surveyList');
    const surveySearchEl = document.getElementById('surveySearch');

    function subscribeSurveys() {
      if (surveysUnsubscribe) surveysUnsubscribe();

      // æ ¹æ“šå»ºç«‹æ™‚é–“æ’åºï¼Œæœ€æ–°çš„åœ¨ä¸Šé¢
      surveysUnsubscribe = db.collection('surveys')
        .orderBy('createdAt', 'desc')
        .onSnapshot(snapshot => {
          renderSurveyList(snapshot.docs);
          statusText.textContent = 'å•å·å·²åŒæ­¥ï¼ˆRealtime æ›´æ–°ï¼‰';
        }, error => {
          console.error(error);
          statusText.textContent = 'è¼‰å…¥å•å·æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹é–‹ F12 console æŸ¥çœ‹ã€‚';
        });
    }

    function renderSurveyList(docs) {
      const keyword = surveySearchEl.value.trim().toLowerCase();
      surveyListEl.innerHTML = '';

      docs.forEach(doc => {
        const data = doc.data();
        const title = data.title || '(æœªå‘½åå•å·)';
        if (keyword && !title.toLowerCase().includes(keyword)) return;

        const li = document.createElement('li');
        li.dataset.id = doc.id;

        const titleSpan = document.createElement('span');
        titleSpan.className = 'title';
        titleSpan.textContent = title;

        const badgeSpan = document.createElement('span');
        badgeSpan.className = 'badge';
        const status = data.status || 'draft';
        if (status === 'draft') {
          badgeSpan.classList.add('badge-draft');
          badgeSpan.textContent = 'è‰ç¨¿';
        } else if (status === 'published') {
          badgeSpan.classList.add('badge-published');
          badgeSpan.textContent = 'å·²ç™¼ä½ˆ';
        } else {
          badgeSpan.classList.add('badge-archived');
          badgeSpan.textContent = 'å·²å°å­˜';
        }

        li.appendChild(titleSpan);
        li.appendChild(badgeSpan);

        if (doc.id === selectedSurveyId) {
          li.classList.add('active');
        }

        li.addEventListener('click', () => {
          selectSurvey(doc.id, data);
        });

        surveyListEl.appendChild(li);
      });

      // è‹¥ç›®å‰é¸ä¸­çš„å•å·å·²è¢«åˆªé™¤ï¼Œæ¸…ç©ºå³å´
      if (selectedSurveyId && !docs.find(d => d.id === selectedSurveyId)) {
        clearSurveyForm();
        clearQuestionSection();
      }
    }

    surveySearchEl.addEventListener('input', () => {
      // é‡æ–° renderï¼ˆç¾åœ¨çš„ docs åœ¨ onSnapshot è£¡æ‰æœ‰ï¼Œæ‰€ä»¥é€™è£¡åªè§¸ç™¼äº‹ä»¶å³å¯ï¼‰
      subscribeSurveys();
    });

    // ========================
    // 4. å•å·ç·¨è¼¯è¡¨å–®
    // ========================
    const surveyTitleEl = document.getElementById('surveyTitle');
    const surveyDescriptionEl = document.getElementById('surveyDescription');
    const surveyStatusEl = document.getElementById('surveyStatus');
    const surveyCategoryEl = document.getElementById('surveyCategory');
    const surveyTargetEl = document.getElementById('surveyTarget');
    const surveyIsAnonymousEl = document.getElementById('surveyIsAnonymous');

    const newSurveyBtn = document.getElementById('newSurveyBtn');
    const saveSurveyBtn = document.getElementById('saveSurveyBtn');
    const deleteSurveyBtn = document.getElementById('deleteSurveyBtn');
    const duplicateSurveyBtn = document.getElementById('duplicateSurveyBtn');

    function clearSurveyForm() {
      selectedSurveyId = null;
      selectedSurveyData = null;
      surveyTitleEl.value = '';
      surveyDescriptionEl.value = '';
      surveyStatusEl.value = 'draft';
      surveyCategoryEl.value = '';
      surveyTargetEl.value = '';
      surveyIsAnonymousEl.checked = false;

      deleteSurveyBtn.disabled = true;
      duplicateSurveyBtn.disabled = true;
    }

    newSurveyBtn.addEventListener('click', () => {
      clearSurveyForm();
      clearQuestionSection();
      cancelQuestionEdit();
    });

    saveSurveyBtn.addEventListener('click', async () => {
      const title = surveyTitleEl.value.trim();
      if (!title) {
        alert('è«‹è¼¸å…¥å•å·æ¨™é¡Œ');
        return;
      }

      const data = {
        title,
        description: surveyDescriptionEl.value.trim(),
        status: surveyStatusEl.value,
        category: surveyCategoryEl.value.trim(),
        targetGroup: surveyTargetEl.value.trim(),
        isAnonymous: surveyIsAnonymousEl.checked,
        updatedAt: serverTimestamp
      };

      try {
        if (!selectedSurveyId) {
          // æ–°å¢å•å·
          data.createdAt = serverTimestamp;
          const docRef = await db.collection('surveys').add(data);
          selectedSurveyId = docRef.id;
          selectedSurveyData = data;
          statusText.textContent = 'å•å·å·²æ–°å¢ä¸¦å„²å­˜ã€‚';
        } else {
          // æ›´æ–°å•å·
          await db.collection('surveys').doc(selectedSurveyId).update(data);
          selectedSurveyData = { ...(selectedSurveyData || {}), ...data };
          statusText.textContent = 'å•å·å·²æ›´æ–°ã€‚';
        }

        deleteSurveyBtn.disabled = false;
        duplicateSurveyBtn.disabled = false;

        // å•å·å„²å­˜å¾Œï¼Œé–‹å§‹è¼‰å…¥é¡Œç›®
        if (selectedSurveyId) {
          subscribeQuestions(selectedSurveyId);
        }
      } catch (err) {
        console.error(err);
        alert('å„²å­˜å•å·å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚');
      }
    });

    deleteSurveyBtn.addEventListener('click', async () => {
      if (!selectedSurveyId) return;
      if (!confirm('ç¢ºå®šè¦åˆªé™¤é€™ä»½å•å·èˆ‡å…¶æ‰€æœ‰é¡Œç›®å—ï¼Ÿæ­¤å‹•ä½œç„¡æ³•æ¢å¾©ã€‚')) return;

      try {
        // å…ˆåˆªé™¤ questions å­é›†åˆ
        const qSnap = await db.collection('surveys').doc(selectedSurveyId)
          .collection('questions').get();
        const batch = db.batch();
        qSnap.forEach(doc => batch.delete(doc.ref));
        await batch.commit();

        // å†åˆªé™¤å•å·æœ¬èº«
        await db.collection('surveys').doc(selectedSurveyId).delete();

        clearSurveyForm();
        clearQuestionSection();
        cancelQuestionEdit();
        statusText.textContent = 'å•å·å·²åˆªé™¤ã€‚';
      } catch (err) {
        console.error(err);
        alert('åˆªé™¤å•å·å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚');
      }
    });

    // é¡å¤–åŠŸèƒ½ï¼šè¤‡è£½å•å·ï¼ˆå«é¡Œç›®ï¼‰
    duplicateSurveyBtn.addEventListener('click', async () => {
      if (!selectedSurveyId || !selectedSurveyData) return;

      const newTitle = selectedSurveyData.title + 'ï¼ˆè¤‡æœ¬ï¼‰';
      const baseData = {
        ...selectedSurveyData,
        title: newTitle,
        status: 'draft',
        createdAt: serverTimestamp,
        updatedAt: serverTimestamp
      };
      delete baseData.createdAt; // ä¿éšªèµ·è¦‹ï¼ˆé¿å…èˆŠçš„ serverTimestamp è¢«è¦†è“‹ï¼‰

      try {
        // 1) æ–°å»ºä¸€å€‹å•å·
        const newSurveyRef = await db.collection('surveys').add(baseData);

        // 2) è¤‡è£½å­é›†åˆ questions
        const qSnap = await db.collection('surveys').doc(selectedSurveyId)
          .collection('questions').get();
        const batch = db.batch();
        qSnap.forEach(doc => {
          const data = doc.data();
          const newQRef = newSurveyRef.collection('questions').doc();
          batch.set(newQRef, data);
        });
        await batch.commit();

        statusText.textContent = 'å•å·å·²è¤‡è£½ç‚ºè‰ç¨¿ã€‚';
      } catch (err) {
        console.error(err);
        alert('è¤‡è£½å•å·å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚');
      }
    });

    function selectSurvey(id, data) {
      selectedSurveyId = id;
      selectedSurveyData = data || null;

      // æ›´æ–°å·¦å´ active æ¨£å¼
      Array.from(surveyListEl.children).forEach(li => {
        li.classList.toggle('active', li.dataset.id === id);
      });

      // å¡«å…¥è¡¨å–®
      surveyTitleEl.value = data.title || '';
      surveyDescriptionEl.value = data.description || '';
      surveyStatusEl.value = data.status || 'draft';
      surveyCategoryEl.value = data.category || '';
      surveyTargetEl.value = data.targetGroup || '';
      surveyIsAnonymousEl.checked = !!data.isAnonymous;

      deleteSurveyBtn.disabled = false;
      duplicateSurveyBtn.disabled = false;

      // è¼‰å…¥é¡Œç›®
      subscribeQuestions(id);
      cancelQuestionEdit();
    }

    // ========================
    // 5. é¡Œç›®ç®¡ç†
    // ========================
    const questionListEl = document.getElementById('questionList');
    const noQuestionHintEl = document.getElementById('noQuestionHint');
    const questionFormTitleEl = document.getElementById('questionFormTitle');
    const editingQuestionHintEl = document.getElementById('editingQuestionHint');

    const questionTextEl = document.getElementById('questionText');
    const questionTypeEl = document.getElementById('questionType');
    const questionRequiredEl = document.getElementById('questionRequired');
    const questionOptionsEl = document.getElementById('questionOptions');
    const scaleMinEl = document.getElementById('scaleMin');
    const scaleMaxEl = document.getElementById('scaleMax');
    const optionsFieldEl = document.getElementById('optionsField');
    const scaleFieldEl = document.getElementById('scaleField');

    const saveQuestionBtn = document.getElementById('saveQuestionBtn');
    const cancelEditQuestionBtn = document.getElementById('cancelEditQuestionBtn');

    const bulkQuestionsEl = document.getElementById('bulkQuestions');
    const addBulkQuestionsBtn = document.getElementById('addBulkQuestionsBtn');

    // é¡Œå‹åˆ‡æ›æ™‚ï¼Œé¡¯ç¤ºä¸åŒæ¬„ä½
    function updateQuestionTypeFields() {
      const type = questionTypeEl.value;
      if (type === 'single' || type === 'multiple') {
        optionsFieldEl.classList.remove('hidden');
        scaleFieldEl.classList.add('hidden');
      } else if (type === 'scale') {
        optionsFieldEl.classList.add('hidden');
        scaleFieldEl.classList.remove('hidden');
      } else {
        // text
        optionsFieldEl.classList.add('hidden');
        scaleFieldEl.classList.add('hidden');
      }
    }
    questionTypeEl.addEventListener('change', updateQuestionTypeFields);
    updateQuestionTypeFields();

    function clearQuestionForm() {
      questionTextEl.value = '';
      questionTypeEl.value = 'single';
      questionRequiredEl.checked = false;
      questionOptionsEl.value = '';
      scaleMinEl.value = 1;
      scaleMaxEl.value = 5;
      updateQuestionTypeFields();
    }

    function cancelQuestionEdit() {
      editingQuestionId = null;
      clearQuestionForm();
      questionFormTitleEl.textContent = 'æ–°å¢é¡Œç›®';
      editingQuestionHintEl.style.display = 'none';
      cancelEditQuestionBtn.style.display = 'none';
    }

    cancelEditQuestionBtn.addEventListener('click', () => {
      cancelQuestionEdit();
    });

    function clearQuestionSection() {
      questionListEl.innerHTML = '';
      noQuestionHintEl.style.display = 'block';
    }

    // ç›£è½æŒ‡å®šå•å·çš„é¡Œç›®
    function subscribeQuestions(surveyId) {
      if (questionsUnsubscribe) questionsUnsubscribe();

      questionsUnsubscribe = db.collection('surveys').doc(surveyId)
        .collection('questions')
        .orderBy('order', 'asc')
        .onSnapshot(snapshot => {
          renderQuestionList(snapshot.docs);
        }, error => {
          console.error(error);
          statusText.textContent = 'è¼‰å…¥é¡Œç›®æ™‚ç™¼ç”ŸéŒ¯èª¤ã€‚';
        });
    }

    function renderQuestionList(docs) {
      questionListEl.innerHTML = '';

      if (docs.length === 0) {
        noQuestionHintEl.style.display = 'block';
        return;
      }
      noQuestionHintEl.style.display = 'none';

      docs.forEach(doc => {
        const data = doc.data();
        const item = document.createElement('div');
        item.className = 'question-item';

        const main = document.createElement('div');
        main.className = 'question-main';

        const textDiv = document.createElement('div');
        textDiv.textContent = data.text || '(æœªå¡«å¯«é¡Œç›®å…§å®¹)';

        const metaDiv = document.createElement('div');
        metaDiv.className = 'question-meta';

        const typeMap = {
          single: 'å–®é¸é¡Œ',
          multiple: 'å¤šé¸é¡Œ',
          scale: 'é‡è¡¨é¡Œ',
          text: 'é–‹æ”¾å¼'
        };
        const typeLabel = typeMap[data.type] || data.type || 'é¡Œå‹ä¸æ˜';

        const pills = [];
        pills.push(`<span class="pill">${typeLabel}</span>`);
        if (data.required) {
          pills.push('<span class="pill">å¿…å¡«</span>');
        }
        if (Array.isArray(data.options) && data.options.length > 0) {
          pills.push(`<span class="pill">é¸é …æ•¸ï¼š${data.options.length}</span>`);
        }
        if (data.type === 'scale') {
          pills.push(`<span class="pill">${data.scaleMin || 1}â€“${data.scaleMax || 5}</span>`);
        }
        metaDiv.innerHTML = pills.join('');

        main.appendChild(textDiv);
        main.appendChild(metaDiv);

        const actions = document.createElement('div');
        actions.className = 'question-actions';

        const editBtn = document.createElement('button');
        editBtn.className = 'btn btn-secondary';
        editBtn.textContent = 'ç·¨è¼¯';
        editBtn.addEventListener('click', () => {
          startEditQuestion(doc.id, data);
        });

        const delBtn = document.createElement('button');
        delBtn.className = 'btn btn-danger';
        delBtn.textContent = 'åˆªé™¤';
        delBtn.addEventListener('click', async () => {
          if (!confirm('ç¢ºå®šåˆªé™¤æ­¤é¡Œï¼Ÿ')) return;
          try {
            await db.collection('surveys').doc(selectedSurveyId)
              .collection('questions').doc(doc.id).delete();
          } catch (err) {
            console.error(err);
            alert('åˆªé™¤é¡Œç›®å¤±æ•—ã€‚');
          }
        });

        // é¡å¤–åŠŸèƒ½ï¼šä¸Šä¸‹ç§»å‹•æ’åº
        const upBtn = document.createElement('button');
        upBtn.className = 'btn btn-secondary';
        upBtn.textContent = 'â†‘';
        upBtn.addEventListener('click', () => {
          changeQuestionOrder(doc, -1);
        });

        const downBtn = document.createElement('button');
        downBtn.className = 'btn btn-secondary';
        downBtn.textContent = 'â†“';
        downBtn.addEventListener('click', () => {
          changeQuestionOrder(doc, +1);
        });

        actions.appendChild(upBtn);
        actions.appendChild(downBtn);
        actions.appendChild(editBtn);
        actions.appendChild(delBtn);

        item.appendChild(main);
        item.appendChild(actions);

        questionListEl.appendChild(item);
      });
    }

    // é¡Œç›®æ’åºï¼ˆç°¡å–®ç‰ˆï¼šorder Â±1ï¼Œå¯¦å‹™ä¸Šå¯ä»¥å†åŠ å¼·ï¼‰
    async function changeQuestionOrder(docSnap, delta) {
      if (!selectedSurveyId) return;
      const data = docSnap.data();
      const currentOrder = data.order || 0;
      try {
        await db.collection('surveys').doc(selectedSurveyId)
          .collection('questions').doc(docSnap.id)
          .update({ order: currentOrder + delta });
      } catch (err) {
        console.error(err);
      }
    }

    function startEditQuestion(id, data) {
      editingQuestionId = id;
      questionFormTitleEl.textContent = 'ç·¨è¼¯é¡Œç›®';
      editingQuestionHintEl.style.display = 'inline';
      cancelEditQuestionBtn.style.display = 'inline-flex';

      questionTextEl.value = data.text || '';
      questionTypeEl.value = data.type || 'single';
      questionRequiredEl.checked = !!data.required;
      questionOptionsEl.value = (data.options || []).join(',');
      scaleMinEl.value = data.scaleMin || 1;
      scaleMaxEl.value = data.scaleMax || 5;
      updateQuestionTypeFields();
    }

    saveQuestionBtn.addEventListener('click', async () => {
      if (!selectedSurveyId) {
        alert('è«‹å…ˆå„²å­˜ä¸€ä»½å•å·ï¼Œå†æ–°å¢é¡Œç›®ã€‚');
        return;
      }
      const text = questionTextEl.value.trim();
      if (!text) {
        alert('è«‹è¼¸å…¥é¡Œç›®å…§å®¹');
        return;
      }

      const type = questionTypeEl.value;
      const required = questionRequiredEl.checked;

      let options = [];
      let scaleMin = null;
      let scaleMax = null;

      if (type === 'single' || type === 'multiple') {
        if (questionOptionsEl.value.trim()) {
          options = questionOptionsEl.value.split(',')
            .map(s => s.trim())
            .filter(Boolean);
        }
        if (options.length === 0) {
          alert('å–®é¸/å¤šé¸é¡Œè«‹è‡³å°‘è¼¸å…¥ä¸€å€‹é¸é …ã€‚');
          return;
        }
      } else if (type === 'scale') {
        scaleMin = Number(scaleMinEl.value) || 1;
        scaleMax = Number(scaleMaxEl.value) || 5;
        if (scaleMin >= scaleMax) {
          alert('é‡è¡¨çš„æœ€å°å€¼å¿…é ˆå°æ–¼æœ€å¤§å€¼ã€‚');
          return;
        }
      }

      const baseData = {
        text,
        type,
        required,
        options,
        scaleMin,
        scaleMax
      };

      try {
        const questionsRef = db.collection('surveys').doc(selectedSurveyId)
          .collection('questions');

        if (!editingQuestionId) {
          // æ–°å¢é¡Œç›®æ™‚ï¼Œorder ç”¨ç›®å‰çš„æ•¸é‡ï¼ˆç°¡å–®ä½œæ³•ï¼‰
          const snap = await questionsRef.get();
          const newOrder = snap.size;

          await questionsRef.add({
            ...baseData,
            order: newOrder
          });
        } else {
          await questionsRef.doc(editingQuestionId).update(baseData);
        }

        cancelQuestionEdit();
      } catch (err) {
        console.error(err);
        alert('å„²å­˜é¡Œç›®å¤±æ•—ã€‚');
      }
    });

    // æ‰¹æ¬¡æ–°å¢å¤šé¡Œï¼šæ¯ä¸€è¡Œä¸€é¡Œï¼Œå…¨éƒ¨ç•¶ä½œé–‹æ”¾å¼é¡Œå‹ & éå¿…å¡«ï¼ˆä½ å¯ä»¥å†æ”¹ï¼‰
    addBulkQuestionsBtn.addEventListener('click', async () => {
      if (!selectedSurveyId) {
        alert('è«‹å…ˆå„²å­˜ä¸€ä»½å•å·ï¼Œå†æ‰¹æ¬¡æ–°å¢é¡Œç›®ã€‚');
        return;
      }
      const raw = bulkQuestionsEl.value.trim();
      if (!raw) {
        alert('è«‹å…ˆåœ¨æ–‡å­—æ¡†è¼¸å…¥è‡³å°‘ä¸€è¡Œé¡Œç›®ã€‚');
        return;
      }
      const lines = raw.split('\n').map(s => s.trim()).filter(Boolean);
      if (lines.length === 0) {
        alert('æ²’æœ‰æœ‰æ•ˆçš„é¡Œç›®å…§å®¹ã€‚');
        return;
      }

      try {
        const questionsRef = db.collection('surveys').doc(selectedSurveyId)
          .collection('questions');
        const snap = await questionsRef.get();
        let baseOrder = snap.size;

        const batch = db.batch();
        lines.forEach(line => {
          const docRef = questionsRef.doc();
          batch.set(docRef, {
            text: line,
            type: 'text',
            required: false,
            options: [],
            scaleMin: null,
            scaleMax: null,
            order: baseOrder++
          });
        });
        await batch.commit();
        bulkQuestionsEl.value = '';
        alert(`å·²æ–°å¢ ${lines.length} é¡Œé–‹æ”¾å¼é¡Œç›®ã€‚`);
      } catch (err) {
        console.error(err);
        alert('æ‰¹æ¬¡æ–°å¢é¡Œç›®å¤±æ•—ã€‚');
      }
    });

    // ä¸€é–‹å§‹å°±è¨‚é–±å•å·åˆ—è¡¨
    subscribeSurveys();
  </script>
</body>
</html>
