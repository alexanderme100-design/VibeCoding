<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>å•å·ç³»çµ±ï½œæ•´åˆç‰ˆï¼ˆå¡«ç­” + çµ±è¨ˆï¼‰</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Google å­—é«” -->
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

  <style>
    body {
      margin: 0;
      font-family: "Noto Sans TC", sans-serif;
      background: #eef2f7;
      display: flex;
      height: 100vh;
    }

    /* å·¦å´å•å·é¸å–® */
    #sidebar {
      width: 280px;
      background: #ffffff;
      border-right: 1px solid #ddd;
      padding: 16px;
      overflow-y: auto;
    }
    #sidebar h2 {
      margin-top: 0;
      font-size: 18px;
      font-weight: 600;
    }
    #surveyList {
      list-style: none;
      padding: 0;
    }
    #surveyList li {
      padding: 10px;
      border-radius: 8px;
      margin-bottom: 6px;
      cursor: pointer;
      transition: 0.2s;
      border: 1px solid transparent;
    }
    #surveyList li:hover {
      background: #f0f7ff;
    }
    #surveyList li.active {
      border: 1px solid #2196f3;
      background: #e3f2fd;
    }

    /* å³å´ä¸»å€åŸŸ */
    #main {
      flex: 1;
      display: flex;
      flex-direction: column;
    }

    header {
      padding: 14px 20px;
      background: #1976d2;
      color: white;
      font-size: 20px;
      font-weight: 600;
    }

    /* Tabs */
    #tabs {
      display: flex;
      background: white;
      border-bottom: 1px solid #ccc;
    }
    #tabs div {
      padding: 12px 20px;
      cursor: pointer;
      flex: 1;
      text-align: center;
      font-weight: 500;
      transition: 0.2s;
    }
    #tabs div.active {
      border-bottom: 3px solid #1976d2;
      background: #f0f0f0;
      color: #1976d2;
    }

    /* å…§å®¹å€ */
    .tabPage {
      padding: 20px;
      overflow-y: auto;
      height: calc(100vh - 120px);
      display: none;
    }
    .tabPage.active {
      display: block;
      animation: fadeIn 0.4s;
    }

    /* å¡ç‰‡ */
    .card {
      background: white;
      padding: 16px;
      border-radius: 12px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.08);
      margin-bottom: 20px;
    }

    /* æ¼¸å…¥å‹•ç•« */
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(8px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* é¡Œç›®å€ */
    .question {
      margin-bottom: 14px;
      border-bottom: 1px solid #eee;
      padding-bottom: 10px;
    }
    .question-title {
      font-weight: 600;
      margin-bottom: 6px;
    }

    /* å–®é¸ å¤šé¸ */
    .options label {
      display: flex;
      align-items: center;
      gap: 6px;
      margin-bottom: 4px;
    }

    /* æŒ‰éˆ• */
    button {
      padding: 10px 16px;
      border-radius: 6px;
      border: none;
      font-size: 14px;
      cursor: pointer;
      transition: 0.2s;
    }
    button.primary {
      background: #1976d2;
      color: white;
    }
    button.primary:hover {
      background: #0f5ea5;
    }
    button.secondary {
      background: #e0e0e0;
      color: #333;
    }
  </style>
</head>

<body>
  <!-- ä¸»å…§å®¹ -->
  <div id="main">

    <header id="headerTitle">è«‹é¸æ“‡å·¦å´å•å·</header>

    <!-- Tabs -->
    <div id="tabs">
      <div id="tabFill" class="active">ğŸ“ å¡«å¯«å•å·</div>
      <div id="tabResult">ğŸ“Š çµ±è¨ˆåˆ†æ</div>
    </div>

    <!-- å¡«ç­”é  Tab -->
    <div id="pageFill" class="tabPage active">

      <div class="card" id="fillInfo" style="display:none;">
        <h3>å•å·èªªæ˜</h3>
        <p><strong>æ¨™é¡Œï¼š</strong> <span id="fillTitle"></span></p>
        <p><strong>æè¿°ï¼š</strong> <span id="fillDesc"></span></p>
        <p><strong>æ˜¯å¦åŒ¿åï¼š</strong> <span id="fillAnon"></span></p>
      </div>

      <div class="card" id="fillFormCard" style="display:none;">
        <h3>å¡«å¯«å€</h3>
        <form id="fillForm"></form>
        <button class="primary" id="submitBtn">é€å‡ºå•å·</button>
        <div id="submitMsg" style="margin-top:10px;"></div>
      </div>

    </div>

    <!-- çµ±è¨ˆé  Tab -->
    <div id="pageResult" class="tabPage">

      <div class="card" id="resultInfo" style="display:none;">
        <h3>å•å·è³‡è¨Š</h3>
        <p><strong>æ¨™é¡Œï¼š</strong> <span id="resultTitle"></span></p>
        <p><strong>å›è¦†æ•¸é‡ï¼š</strong> <span id="resultCount"></span></p>
      </div>

      <div class="card" id="analysisCard" style="display:none;">
        <h3>é¡Œç›®çµ±è¨ˆ</h3>

        <label>é¸æ“‡é¡Œç›®ï¼š</label>
        <select id="questionSelect"><option>è«‹å…ˆé¸æ“‡å•å·</option></select>

        <div style="margin-top:12px;">
          <button class="secondary" id="barChartBtn" disabled>é•·æ¢åœ–</button>
          <button class="secondary" id="pieChartBtn" disabled>åœ“é¤…åœ–</button>
        </div>

        <div id="chartContainer">
          <canvas id="chartCanvas" height="260"></canvas>
        </div>
      </div>

    </div>

  </div>

</body>

<script>
/* ----------------------------------------------------
   ğŸ”¥ 1. åˆå§‹åŒ– Firebaseï¼ˆæ›¿æ›æˆä½ çš„è¨­å®šï¼‰
----------------------------------------------------- */
const firebaseConfig = {
  apiKey: "AIzaSyAexk_JbIOQWV1Jw7hqfiZDDZYY9YF-Sdk",
  authDomain: "survey-49e8d.firebaseapp.com",
  projectId: "survey-49e8d",
  storageBucket: "survey-49e8d.firebasestorage.app",
  messagingSenderId: "547257703502",
  appId: "1:547257703502:web:85e147bed62333b11c771f"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

/* ----------------------------------------------------
   2. Tabs åˆ‡æ›
----------------------------------------------------- */
const tabFill = document.getElementById("tabFill");
const tabResult = document.getElementById("tabResult");
const pageFill = document.getElementById("pageFill");
const pageResult = document.getElementById("pageResult");

function switchTab(who) {
  tabFill.classList.remove("active");
  tabResult.classList.remove("active");
  pageFill.classList.remove("active");
  pageResult.classList.remove("active");

  if (who === "fill") {
    tabFill.classList.add("active");
    pageFill.classList.add("active");
  } else {
    tabResult.classList.add("active");
    pageResult.classList.add("active");
  }
}

tabFill.addEventListener("click", () => switchTab("fill"));
tabResult.addEventListener("click", () => switchTab("result"));

/* ----------------------------------------------------
   3. å·¦å´ï¼šè¼‰å…¥æ‰€æœ‰å•å·åˆ—è¡¨
----------------------------------------------------- */
const surveyListEl = document.getElementById("surveyList");
let selectedSurveyId = null;
let selectedSurveyData = null;
let surveyQuestions = [];
let responses = [];

function loadSurveyList() {
  db.collection("surveys").orderBy("createdAt", "desc").onSnapshot((snap) => {
    surveyListEl.innerHTML = "";
    snap.docs.forEach((doc) => {
      const d = doc.data();
      const li = document.createElement("li");
      li.dataset.id = doc.id;
      li.innerHTML = d.title || "æœªå‘½åå•å·";

      li.addEventListener("click", () => {
        selectSurvey(doc.id, d);
      });

      surveyListEl.appendChild(li);
    });
  });
}
loadSurveyList();

/* ----------------------------------------------------
   4. é¸å–å•å· â†’ è¼‰å…¥é¡Œç›® & å›è¦†
----------------------------------------------------- */
function selectSurvey(id, data) {
  selectedSurveyId = id;
  selectedSurveyData = data;

  document.querySelectorAll("#surveyList li").forEach(li => {
    li.classList.toggle("active", li.dataset.id === id);
  });

  document.getElementById("headerTitle").textContent = data.title;

  switchTab("fill");

  loadFillPage(id, data);
  loadResultPage(id, data);
}

/* ----------------------------------------------------
   5. è¼‰å…¥å¡«ç­”å€ï¼ˆrespondï¼‰
----------------------------------------------------- */
async function loadFillPage(id, data) {
  document.getElementById("fillInfo").style.display = "block";
  document.getElementById("fillFormCard").style.display = "block";

  document.getElementById("fillTitle").textContent = data.title;
  document.getElementById("fillDesc").textContent = data.description || "(ç„¡æè¿°)";
  document.getElementById("fillAnon").textContent = data.isAnonymous ? "æ˜¯" : "å¦";

  const qSnap = await db.collection("surveys").doc(id)
    .collection("questions")
    .orderBy("order").get();

  surveyQuestions = qSnap.docs.map(d => ({ id: d.id, data: d.data() }));

  const form = document.getElementById("fillForm");
  form.innerHTML = "";

  surveyQuestions.forEach(q => {
    const div = document.createElement("div");
    div.className = "question";

    div.innerHTML = `<div class="question-title">${q.data.text} ${q.data.required ? "<span style='color:red'>(å¿…å¡«)</span>" : ""}</div>`;

    if (q.data.type === "single") {
      const optDiv = document.createElement("div");
      optDiv.className = "options";
      q.data.options.forEach(opt => {
        const label = document.createElement("label");
        label.innerHTML = `<input type="radio" name="${q.id}" value="${opt}"> ${opt}`;
        optDiv.appendChild(label);
      });
      div.appendChild(optDiv);

    } else if (q.data.type === "multiple") {
      const optDiv = document.createElement("div");
      optDiv.className = "options";
      q.data.options.forEach(opt => {
        const label = document.createElement("label");
        label.innerHTML = `<input type="checkbox" name="${q.id}" value="${opt}"> ${opt}`;
        optDiv.appendChild(label);
      });
      div.appendChild(optDiv);

    } else if (q.data.type === "scale") {
      const select = document.createElement("select");
      select.name = q.id;
      select.innerHTML = `<option value="">è«‹é¸æ“‡</option>`;
      for (let i = q.data.scaleMin; i <= q.data.scaleMax; i++) {
        select.innerHTML += `<option value="${i}">${i}</option>`;
      }
      div.appendChild(select);

    } else {
      div.innerHTML += `<textarea name="${q.id}" rows="3" style="width:100%;"></textarea>`;
    }

    form.appendChild(div);
  });
}

/* ----------------------------------------------------
   6. æ•æ‰é€å‡ºå¡«ç­”
----------------------------------------------------- */
document.getElementById("submitBtn").addEventListener("click", async () => {
  if (!selectedSurveyId) return;

  const form = document.getElementById("fillForm");
  const fd = new FormData(form);
  const answerObj = {};

  for (let q of surveyQuestions) {
    let val = null;

    if (q.data.type === "single") {
      val = fd.get(q.id);

    } else if (q.data.type === "multiple") {
      val = fd.getAll(q.id);

    } else {
      val = fd.get(q.id);
    }

    if (q.data.required && (!val || val.length === 0)) {
      alert("æœ‰å¿…å¡«é¡Œç›®æœªå¡«å¯«");
      return;
    }

    answerObj[q.id] = val;
  }

  await db.collection("responses").add({
    surveyId: selectedSurveyId,
    answers: answerObj,
    createdAt: firebase.firestore.FieldValue.serverTimestamp()
  });

  document.getElementById("submitMsg").innerHTML =
    "<span style='color:green'>å·²æˆåŠŸé€å‡ºï¼Œæ„Ÿè¬æ‚¨çš„å¡«å¯«ï¼</span>";

  form.reset();
});

/* ----------------------------------------------------
   7. è¼‰å…¥çµ±è¨ˆçµæœï¼ˆresultsï¼‰
----------------------------------------------------- */
async function loadResultPage(id, data) {
  const rSnap = await db.collection("responses")
    .where("surveyId", "==", id)
    .orderBy("createdAt").get();

  responses = rSnap.docs.map(d => ({ id: d.id, data: d.data() }));

  document.getElementById("resultInfo").style.display = "block";
  document.getElementById("analysisCard").style.display = "block";

  document.getElementById("resultTitle").textContent = data.title;
  document.getElementById("resultCount").textContent = responses.length;

  const qs = document.getElementById("questionSelect");
  qs.innerHTML = "<option value=''>è«‹é¸æ“‡é¡Œç›®</option>";
  surveyQuestions.forEach((q, i) => {
    qs.innerHTML += `<option value="${q.id}">${i + 1}. ${q.data.text}</option>`;
  });

  document.getElementById("barChartBtn").disabled = false;
  document.getElementById("pieChartBtn").disabled = false;
}
/* ----------------------------------------------------
   8. çµ±è¨ˆï¼šè¨ˆç®—æ¯é¡Œçš„è³‡æ–™
----------------------------------------------------- */
function aggregateQuestion(qId) {
  const q = surveyQuestions.find(q => q.id === qId);
  if (!q) return null;

  const type = q.data.type;

  // ğŸ‘‰ å–®é¸é¡Œ
  if (type === "single") {
    const map = {};
    q.data.options.forEach(opt => map[opt] = 0);
    let total = 0;

    responses.forEach(r => {
      const ans = r.data.answers[qId];
      if (ans && map.hasOwnProperty(ans)) {
        map[ans]++;
        total++;
      }
    });

    return {
      type,
      labels: Object.keys(map),
      values: Object.values(map),
      total
    };
  }

  // ğŸ‘‰ å¤šé¸é¡Œ
  if (type === "multiple") {
    const map = {};
    q.data.options.forEach(opt => map[opt] = 0);
    let total = 0;

    responses.forEach(r => {
      const arr = r.data.answers[qId];
      if (Array.isArray(arr)) {
        arr.forEach(a => {
          if (map[b] !== undefined) {
            map[a]++;
            total++;
          }
        });
      }
    });

    return {
      type,
      labels: Object.keys(map),
      values: Object.values(map),
      total
    };
  }

  // ğŸ‘‰ é‡è¡¨é¡Œ
  if (type === "scale") {
    const map = {};
    for (let i = q.data.scaleMin; i <= q.data.scaleMax; i++) {
      map[i] = 0;
    }
    let total = 0;

    responses.forEach(r => {
      const ans = Number(r.data.answers[qId]);
      if (!isNaN(ans) && map[ans] !== undefined) {
        map[ans]++;
        total++;
      }
    });

    return {
      type,
      labels: Object.keys(map),
      values: Object.values(map),
      total
    };
  }

  // ğŸ‘‰ é–‹æ”¾å¼ï¼šåƒ…è¨ˆç®—å¡«ç­”æ•¸
  if (type === "text") {
    let count = 0;
    responses.forEach(r => {
      const ans = r.data.answers[qId];
      if (ans && String(ans).trim() !== "") count++;
    });
    return {
      type: "text",
      count
    };
  }

  return null;
}

/* ----------------------------------------------------
   9. é¡Œç›®é¸æ“‡å¾Œï¼Œæ¸…é™¤ç¾æœ‰åœ–è¡¨
----------------------------------------------------- */
let chartInstance = null;
document.getElementById("questionSelect").addEventListener("change", () => {
  if (chartInstance) {
    chartInstance.destroy();
    chartInstance = null;
  }
});

/* ----------------------------------------------------
   10. æŒ‰éˆ•ï¼šç•«é•·æ¢åœ–
----------------------------------------------------- */
document.getElementById("barChartBtn").addEventListener("click", () => {
  drawChart("bar");
});

/* ----------------------------------------------------
   11. æŒ‰éˆ•ï¼šç•«åœ“é¤…åœ–
----------------------------------------------------- */
document.getElementById("pieChartBtn").addEventListener("click", () => {
  drawChart("pie");
});

/* ----------------------------------------------------
   12. Chart.js è¦–è¦ºåŒ–
----------------------------------------------------- */
function drawChart(mode) {
  const qId = document.getElementById("questionSelect").value;
  if (!qId) {
    alert("è«‹å…ˆé¸æ“‡é¡Œç›®");
    return;
  }

  const agg = aggregateQuestion(qId);

  const ctx = document.getElementById("chartCanvas").getContext("2d");

  if (chartInstance) chartInstance.destroy();

  // ğŸ‘‰ é–‹æ”¾å¼ä¸ç•«åœ–
  if (agg.type === "text") {
    chartInstance = null;
    document.getElementById("chartContainer").innerHTML = `
      <div style="padding:20px;text-align:center;color:#888;">
        æ­¤é¡Œç‚ºé–‹æ”¾å¼é¡Œç›®ï¼Œå…±æœ‰ ${agg.count} å‰‡æ–‡å­—å›ç­”ã€‚
      </div>
    `;
    return;
  }

  // é‡å»º canvas
  document.getElementById("chartContainer").innerHTML =
    `<canvas id="chartCanvas" height="260"></canvas>`;
  const ctxNew = document.getElementById("chartCanvas").getContext("2d");

  chartInstance = new Chart(ctxNew, {
    type: mode,
    data: {
      labels: agg.labels,
      datasets: [{
        label: "å›ç­”æ•¸",
        data: agg.values,
        backgroundColor: [
          "#42a5f5", "#66bb6a", "#ffca28",
          "#ef5350", "#ab47bc", "#26c6da",
        ]
      }]
    },
    options: {
      responsive: true,
      plugins: {
        legend: { display: mode === "pie" }
      },
      scales: mode === "bar"
        ? { y: { beginAtZero: true, ticks: { stepSize: 1 } } }
        : {}
    }
  });
}

</script>

</html>
