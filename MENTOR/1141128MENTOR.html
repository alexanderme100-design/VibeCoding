<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>AI å•å·ç³»çµ±ï½œGoogle Forms å¼·åŒ–ç‰ˆ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Google å­—é«” -->
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">

  <!-- Material Icons -->
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

  <!-- Google OAuth 2 -->
  <script src="https://accounts.google.com/gsi/client" async defer></script>

<style>

/* ---------------------------------------------------
   ğŸŒ™ Google Forms Dark Mode & Light Mode Variables
--------------------------------------------------- */
:root {
  --gf-primary: #673ab7;
  --gf-primary-light: #9575cd;
  --gf-primary-bg: #f3e5f5;

  --bg: #eef2f7;
  --card-bg: white;
  --text: #222;
  --border: #ccc;
  --sidebar-bg: #fff;
  --sidebar-text: #333;

  --icon-gray: #666;
}

body.dark {
  --bg: #1e1e1e;
  --card-bg: #2b2b2b;
  --text: #f5f5f5;
  --border: #444;
  --sidebar-bg: #252525;
  --sidebar-text: #eaeaea;

  --gf-primary-bg: #4a2f7f !important;
}

/* èƒŒæ™¯ */
body {
  margin: 0;
  font-family: "Noto Sans TC", sans-serif;
  background: var(--bg);
  color: var(--text);
  display: flex;
  height: 100vh;
}

/* ---------------------------------------------------
   ğŸŸ¢ å´é‚Šé¸å–® + æœå°‹åˆ— + å‹•ç•«
--------------------------------------------------- */
#sidebar {
  width: 300px;
  background: var(--sidebar-bg);
  border-right: 1px solid var(--border);
  padding: 16px;
  overflow-y: auto;
  transition: background 0.3s, color 0.3s;
}

#sidebar h2 {
  margin: 0 0 12px 0;
  font-size: 18px;
  font-weight: 600;
  color: var(--sidebar-text);
  display: flex;
  align-items: center;
  gap: 6px;
}

/* æœå°‹åˆ— */
#searchBar {
  width: 100%;
  padding: 10px;
  border-radius: 8px;
  border: 1px solid var(--border);
  margin-bottom: 14px;
  background: var(--card-bg);
  color: var(--text);
}

#surveyList {
  list-style: none;
  padding: 0;
  margin: 0;
}

#surveyList li {
  padding: 12px 14px;
  border-radius: 10px;
  margin-bottom: 8px;
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 8px;
  color: var(--sidebar-text);
  border: 1px solid transparent;
  transition: 0.2s;
}

#surveyList li:hover {
  background: var(--gf-primary-bg);
  color: white;
}

#surveyList li.active {
  border-left: 4px solid var(--gf-primary);
  background: rgba(103,58,183,0.1);
}

/* é¸å–®åœ–ç¤º */
.menu-icon {
  font-size: 22px;
  color: var(--icon-gray);
}

/* ---------------------------------------------------
   ä¸»å…§å®¹å€
--------------------------------------------------- */
#main {
  flex: 1;
  display: flex;
  flex-direction: column;
  overflow: hidden;
}

/* Header */
header {
  padding: 14px 20px;
  background: var(--gf-primary);
  color: white;
  font-size: 20px;
  font-weight: 600;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

/* Google Login Button */
#googleLoginBtn {
  background: white;
  color: #444;
  border-radius: 6px;
  padding: 6px 12px;
  font-size: 14px;
  cursor: pointer;
  border: none;
  display: flex;
  align-items: center;
  gap: 6px;
}

/* Dark Mode Toggle */
#darkToggle {
  cursor: pointer;
  color: white;
  font-size: 24px;
  margin-left: 12px;
}

/* Tabs */
#tabs {
  display: flex;
  background: var(--card-bg);
  border-bottom: 1px solid var(--border);
}

#tabs div {
  flex: 1;
  padding: 12px 20px;
  cursor: pointer;
  text-align: center;
  transition: 0.2s;
}

#tabs div.active {
  border-bottom: 3px solid var(--gf-primary);
  background: var(--gf-primary-bg);
  color: var(--gf-primary);
}

.tabPage {
  height: calc(100vh - 120px);
  overflow-y: auto;
  padding: 20px;
  display: none;
}
.tabPage.active { display: block; }

/* å¡ç‰‡ */
.card {
  background: var(--card-bg);
  padding: 18px;
  border-radius: 14px;
  margin-bottom: 20px;
  box-shadow: 0 4px 14px rgba(0,0,0,0.08);
  transition: background 0.3s, color 0.3s;
}

/* é€²åº¦æ¢ï¼ˆGoogle Forms æ¨£å¼ï¼‰ */
#progressBarContainer {
  width: 100%;
  background: #ddd;
  height: 6px;
  border-radius: 3px;
  margin: 14px 0;
  overflow: hidden;
}

#progressBar {
  height: 100%;
  width: 0%;
  background: var(--gf-primary);
  transition: width 0.3s;
}

</style>
</head>

<body>
  <!-- å·¦å´å•å·é¸å–® -->
  <div id="sidebar">
    <h2><span class="material-icons">assignment</span> å•å·åˆ—è¡¨</h2>

    <!-- ğŸŸ¡ å•å·æœå°‹åˆ— -->
    <input id="searchBar" placeholder="æœå°‹å•å·â€¦" />

    <ul id="surveyList"></ul>
  </div>

  <!-- ä¸»å€åŸŸ -->
  <div id="main">

    <header id="headerTitle">
      <span>è«‹é¸æ“‡å·¦å´å•å·</span>

      <div style="display:flex;align-items:center;gap:10px;">

        <!-- ğŸŸ£ Google OAuth Login -->
        <button id="googleLoginBtn" title="ç™»å…¥ Google å¸³è™Ÿ">
          <span class="material-icons">login</span> Login
        </button>
        <img id="googleUserPic" src="" style="width:36px;height:36px;border-radius:50%;display:none;">

        <!-- ğŸŒ™ æ·±è‰²æ¨¡å¼é–‹é—œ -->
        <span id="darkToggle" class="material-icons">dark_mode</span>
      </div>
    </header>

    <!-- åˆ†é  Tabs -->
    <div id="tabs">
      <div id="tabFill" class="active">
        <span class="material-icons">edit</span> å¡«å¯«å•å·
      </div>
      <div id="tabResult">
        <span class="material-icons">insights</span> çµ±è¨ˆåˆ†æ
      </div>
      <div id="tabExport">
        <span class="material-icons">file_download</span> åŒ¯å‡ºè³‡æ–™
      </div>
    </div>

    <!-- é€²åº¦æ¢ï¼ˆGoogle Forms Styleï¼‰ -->
    <div id="progressBarContainer">
      <div id="progressBar"></div>
    </div>

    <!-- å¡«ç­”é  -->
    <div id="pageFill" class="tabPage active">

      <!-- å•å·è³‡è¨Š -->
      <div id="fillInfo" class="card" style="display:none;">
        <h3><span class="material-icons" style="vertical-align:middle;">description</span> å•å·è³‡è¨Š</h3>
        <p><b>æ¨™é¡Œï¼š</b><span id="fillTitle"></span></p>
        <p><b>æè¿°ï¼š</b><span id="fillDesc"></span></p>
      </div>

      <!-- å¡«ç­”è¡¨å–® -->
      <div id="fillFormCard" class="card" style="display:none;">
        <h3><span class="material-icons" style="vertical-align:middle;">edit_note</span> å¡«å¯«å€</h3>

        <form id="fillForm"></form>

        <button class="primary" id="submitBtn">
          <span class="material-icons">send</span> é€å‡º
        </button>

        <div id="submitMsg" style="margin-top:10px;font-weight:600;"></div>
      </div>

    </div>
    <!-- çµ±è¨ˆåˆ†æé  -->
    <div id="pageResult" class="tabPage">

      <!-- ğŸ”µ å›è¦†æ™‚é–“åˆ†å¸ƒåœ– -->
      <div class="card" id="responseTimeCard" style="display:none;">
        <h3>
          <span class="material-icons" style="vertical-align:middle;">schedule</span>
          å›è¦†æ™‚é–“åˆ†å¸ƒ
        </h3>
        <canvas id="responseTimeChart" height="180"></canvas>
      </div>

      <!-- ğŸŸ£ Google Forms è¦–è¦ºåŒ–çµ±è¨ˆå€ -->
      <div id="gfResultArea" class="result-section"></div>

    </div>

    <!-- åŒ¯å‡ºé  -->
    <div id="pageExport" class="tabPage">
      <div class="card">
        <h3><span class="material-icons">file_download</span> åŒ¯å‡ºå•å·è³‡æ–™</h3>
        <p>å¯å°‡æ‰€æœ‰å›è¦†åŒ¯å‡ºç‚ºï¼š</p>
        <button class="primary" id="exportCsvBtn">
          <span class="material-icons">table_view</span> åŒ¯å‡º CSV
        </button>
        <button class="primary" id="exportSheetBtn" style="margin-left:10px;">
          <span class="material-icons">cloud_upload</span> åŒ¯å‡º Google Sheets
        </button>
        <div id="exportMsg" style="margin-top:12px;"></div>
      </div>
    </div>

</div> <!-- end #main -->


<!-- -------------------------------------------------------
     ğŸŒŸã€Šçµ±è¨ˆé ï¼šGoogle Forms è¦–è¦ºåŒ–ç”Ÿæˆå™¨ã€‹
     ğŸŸ£ ç¬¬ 3 éƒ¨åˆ† JSï¼ˆä¸»è¦–è¦º + æ–‡å­—é¡Œ + æ™‚é–“åˆ†å¸ƒåœ–ï¼‰
-------------------------------------------------------- -->
<script>

/* ======================================================
   ğŸŸ£ Google Forms è¦–è¦ºåŒ–ï¼šçµ±è¨ˆä¸»æ¸²æŸ“
====================================================== */
function renderGoogleFormsStats() {
  const container = document.getElementById("gfResultArea");
  container.innerHTML = "";

  if (!responses || responses.length === 0) {
    container.innerHTML = `
      <div class="stat-card">
        <div class="stat-title">å°šç„¡ä»»ä½•å›è¦†</div>
      </div>`;
    return;
  }

  // ğŸŸ£ è·‘æ¯ä¸€é¡Œ â†’ å‹•æ…‹ç”Ÿæˆä¸€å¼µå¡ç‰‡
  surveyQuestions.forEach((q, index) => {
    const agg = aggregateQuestion(q.id);

    const card = document.createElement("div");
    card.className = "stat-card";

    card.innerHTML = `
      <div class="stat-header">
        <div class="stat-title">${index + 1}. ${q.data.text}</div>
        <div class="stat-count">${agg.total || agg.count || 0} å›è¦†</div>
      </div>
      <div id="chart_${q.id}" class="stat-chart"></div>
    `;

    container.appendChild(card);

    if (q.data.type === "text") {
      renderTextAnswers(q.id);
    } else {
      renderChartForQuestion(q.id, agg);
    }
  });
}


/* ======================================================
   ğŸŸ£ æ–‡å­—é¡Œï¼ˆé–‹æ”¾å¼å›ç­”ï¼‰ â†’ Google Forms æ–‡å­—é›²å¡ç‰‡
====================================================== */
function renderTextAnswers(qId) {
  const div = document.getElementById("chart_" + qId);
  div.innerHTML = "";

  responses.forEach((r) => {
    const ans = r.answers[qId];
    if (ans && ans.trim()) {
      const box = document.createElement("div");
      box.className = "open-text-box";
      box.textContent = ans;
      div.appendChild(box);
    }
  });
}


/* ======================================================
   ğŸŸ£ å–®é¸ã€å¤šé¸ã€é‡è¡¨ â†’ åœ“é¤…åœ– / é•·æ¢åœ–ï¼ˆè‡ªå‹•åˆ¤æ–·ï¼‰
====================================================== */
function renderChartForQuestion(qId, agg) {
  const div = document.getElementById("chart_" + qId);

  div.innerHTML = `<canvas id="c_${qId}" height="260"></canvas>`;
  const ctx = document.getElementById("c_" + qId);

  new Chart(ctx, {
    type: agg.labels.length > 5 ? "bar" : "pie",
    data: {
      labels: agg.labels,
      datasets: [{
        data: agg.values,
        backgroundColor: [
          "#673ab7", "#9575cd", "#7e57c2",
          "#b39ddb", "#5e35b1", "#4527a0"
        ]
      }]
    },
    options: {
      plugins: { legend: { position: "bottom" } },
      scales: agg.labels.length > 5 ? {
        y: {
          beginAtZero: true,
          ticks: { stepSize: 1, color: "var(--text)" }
        },
        x: { ticks: { color: "var(--text)" } }
      } : {}
    }
  });
}


/* ======================================================
   ğŸ”µ å›è¦†æ™‚é–“åˆ†å¸ƒåœ–ï¼ˆHistogramï¼‰
====================================================== */
let responseTimeChart = null;

function renderResponseTimeChart() {
  const card = document.getElementById("responseTimeCard");

  if (!responses || responses.length === 0) {
    card.style.display = "none";
    return;
  }
  card.style.display = "block";

  // å–å¾—æ‰€æœ‰å›è¦† timestamps
  const timestamps = responses
    .map((r) => r.createdAt?.toDate?.() ?? null)
    .filter((t) => t);

  if (timestamps.length === 0) {
    card.style.display = "none";
    return;
  }

  // æ’åº
  timestamps.sort((a, b) => a - b);

  // åˆ†æ¡¶ histogramï¼ˆæ¯ä¸€å°æ™‚ï¼‰
  const buckets = {};
  timestamps.forEach((t) => {
    const label = t.toISOString().slice(0, 13) + ":00"; // 2025-11-28 14:00
    if (!buckets[label]) buckets[label] = 0;
    buckets[label]++;
  });

  const labels = Object.keys(buckets);
  const values = Object.values(buckets);

  const ctx = document.getElementById("responseTimeChart");

  if (responseTimeChart) responseTimeChart.destroy();

  responseTimeChart = new Chart(ctx, {
    type: "bar",
    data: {
      labels,
      datasets: [{
        label: "å›è¦†æ•¸",
        data: values,
        backgroundColor: "#9575cd"
      }]
    },
    options: {
      plugins: { legend: { display: false } },
      scales: {
        y: {
          beginAtZero: true,
          ticks: { stepSize: 1, color: "var(--text)" }
        },
        x: { ticks: { color: "var(--text)" } }
      }
    }
  });
}

</script>
/* ======================================================
   ğŸŸ£ Firebase åˆå§‹åŒ–ï¼ˆè«‹å¡«å…¥ä½ çš„ configï¼‰
====================================================== */
const firebaseConfig = {
  apiKey: "AIzaSyAexk_JbIOQWV1Jw7hqfiZDDZYY9YF-Sdk",
  authDomain: "survey-49e8d.firebaseapp.com",
  projectId: "survey-49e8d",
  storageBucket: "survey-49e8d.firebasestorage.app",
  messagingSenderId: "547257703502",
  appId: "1:547257703502:web:85e147bed62333b11c771f"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();


/* ======================================================
   ğŸŸ¢ Tabs åˆ‡æ›
====================================================== */
const tabFill = document.getElementById("tabFill");
const tabResult = document.getElementById("tabResult");
const tabExport = document.getElementById("tabExport");

const pageFill = document.getElementById("pageFill");
const pageResult = document.getElementById("pageResult");
const pageExport = document.getElementById("pageExport");

function switchTab(page) {
  [tabFill, tabResult, tabExport].forEach(t => t.classList.remove("active"));
  [pageFill, pageResult, pageExport].forEach(p => p.classList.remove("active"));

  if (page === "fill") {
    tabFill.classList.add("active");
    pageFill.classList.add("active");
  } else if (page === "result") {
    tabResult.classList.add("active");
    pageResult.classList.add("active");
  } else {
    tabExport.classList.add("active");
    pageExport.classList.add("active");
  }
}

tabFill.onclick = () => switchTab("fill");
tabResult.onclick = () => switchTab("result");
tabExport.onclick = () => switchTab("export");


/* ======================================================
   ğŸŸ¢ æ·±è‰²æ¨¡å¼åˆ‡æ›ï¼ˆDark Modeï¼‰
====================================================== */
const body = document.body;
const darkToggle = document.getElementById("darkToggle");

// è®€å–å…ˆå‰è¨­å®š
if (localStorage.getItem("darkMode") === "true") {
  body.classList.add("dark");
  darkToggle.textContent = "light_mode";
}

darkToggle.onclick = () => {
  body.classList.toggle("dark");
  const isDark = body.classList.contains("dark");
  darkToggle.textContent = isDark ? "light_mode" : "dark_mode";
  localStorage.setItem("darkMode", isDark);
};


/* ======================================================
   ğŸŸ£ Google OAuth Login
====================================================== */
let googleUser = null;
const googleLoginBtn = document.getElementById("googleLoginBtn");
const googleUserPic = document.getElementById("googleUserPic");

googleLoginBtn.onclick = () => {
  google.accounts.id.initialize({
    client_id: "YOUR_GOOGLE_OAUTH_CLIENT_ID",
    callback: handleGoogleLogin
  });

  google.accounts.id.prompt(); // å‘¼å« Google Login
};

function handleGoogleLogin(response) {
  const data = parseJwt(response.credential);

  googleUser = data;
  googleUserPic.src = data.picture;
  googleUserPic.style.display = "block";
  googleLoginBtn.style.display = "none";
  console.log("Logged in as:", data);
}

// helper è§£æ JWT
function parseJwt(token) {
  return JSON.parse(decodeURIComponent(escape(atob(token.split('.')[1].replace(/-/g, '+').replace(/_/g, '/')))));
}


/* ======================================================
   ğŸŸ¡ å•å·æœå°‹åˆ—
====================================================== */
document.getElementById("searchBar").addEventListener("input", function () {
  const keyword = this.value.trim().toLowerCase();
  document.querySelectorAll("#surveyList li").forEach(li => {
    const txt = li.textContent.toLowerCase();
    li.style.display = txt.includes(keyword) ? "flex" : "none";
  });
});


/* ======================================================
   ğŸŸ¢ å•å·åˆ—è¡¨è¼‰å…¥
====================================================== */
let selectedSurveyId = null;
let selectedSurveyData = null;
let surveyQuestions = [];
let responses = [];

function loadSurveyList() {
  db.collection("surveys")
    .orderBy("createdAt", "desc")
    .onSnapshot((snap) => {
      const ul = document.getElementById("surveyList");
      ul.innerHTML = "";

      snap.forEach((doc) => {
        const li = document.createElement("li");
        li.dataset.id = doc.id;

        li.innerHTML = `
          <span class="material-icons menu-icon">list_alt</span>
          <span>${doc.data().title}</span>
        `;

        li.onclick = () => selectSurvey(doc.id, doc.data());
        ul.appendChild(li);
      });
    });
}
loadSurveyList();


/* ======================================================
   ğŸŸ£ é¸å–å•å· â†’ è¼‰å…¥é¡Œç›® + å›è¦†
====================================================== */
function selectSurvey(id, data) {
  selectedSurveyId = id;
  selectedSurveyData = data;

  document.getElementById("headerTitle").innerHTML = data.title;

  // highlight
  document.querySelectorAll("#surveyList li").forEach(li => {
    li.classList.toggle("active", li.dataset.id === id);
  });

  switchTab("fill");

  loadFillPage(id, data);
  loadResultPage(id);
}


/* ======================================================
   ğŸ“ å¡«ç­”é ç›®ä¸»æ¸²æŸ“
====================================================== */
async function loadFillPage(id, data) {
  document.getElementById("fillInfo").style.display = "block";
  document.getElementById("fillFormCard").style.display = "block";

  document.getElementById("fillTitle").textContent = data.title;
  document.getElementById("fillDesc").textContent = data.description;

  const qSnap = await db.collection("surveys").doc(id)
    .collection("questions")
    .orderBy("order")
    .get();

  surveyQuestions = qSnap.docs.map(d => ({ id: d.id, data: d.data() }));

  const form = document.getElementById("fillForm");
  form.innerHTML = "";

  surveyQuestions.forEach((q, index) => {
    const div = document.createElement("div");
    div.className = "card";
    div.innerHTML = `<b>${index + 1}. ${q.data.text}</b><br><br>`;

    if (q.data.type === "single") {
      q.data.options.forEach(opt => {
        div.innerHTML += `<label><input type="radio" name="${q.id}" value="${opt}"> ${opt}</label><br>`;
      });

    } else if (q.data.type === "multiple") {
      q.data.options.forEach(opt => {
        div.innerHTML += `<label><input type="checkbox" name="${q.id}" value="${opt}"> ${opt}</label><br>`;
      });

    } else if (q.data.type === "scale") {
      div.innerHTML += `<select name="${q.id}">
        <option value="">è«‹é¸æ“‡</option>
        ${Array.from({length: q.data.scaleMax - q.data.scaleMin + 1}, (_, i) =>
          `<option value="${q.data.scaleMin + i}">${q.data.scaleMin + i}</option>`
        ).join("")}
      </select>`;

    } else {
      div.innerHTML += `<textarea name="${q.id}" rows="3" style="width:100%;"></textarea>`;
    }

    form.appendChild(div);
  });

  updateProgressBar(0);
}


/* ======================================================
   ğŸ”´ å¡«ç­”é€²åº¦æ¢æ›´æ–°
====================================================== */
function updateProgressBar(filledCount) {
  const total = surveyQuestions.length;
  const percent = total === 0 ? 0 : Math.round((filledCount / total) * 100);
  document.getElementById("progressBar").style.width = percent + "%";
}


/* ======================================================
   ğŸ“¨ é€å‡ºå¡«ç­” â†’ Firestore
====================================================== */
document.getElementById("submitBtn").onclick = async () => {
  const fd = new FormData(document.getElementById("fillForm"));
  const answers = {};
  let requiredMissing = false;

  surveyQuestions.forEach(q => {
    let val = null;

    if (q.data.type === "multiple") {
      val = fd.getAll(q.id);
    } else {
      val = fd.get(q.id);
    }

    if (q.data.required && (!val || val.length === 0)) {
      requiredMissing = true;
    }

    answers[q.id] = val;
  });

  if (requiredMissing) {
    alert("æœ‰å¿…å¡«é¡Œæœªå¡«å¯«ï¼");
    return;
  }

  await db.collection("responses").add({
    surveyId: selectedSurveyId,
    answers,
    createdAt: firebase.firestore.FieldValue.serverTimestamp()
  });

  document.getElementById("submitMsg").innerHTML =
    `<span style="color:green;">å·²æˆåŠŸæäº¤ï¼Œæ„Ÿè¬æ‚¨çš„å¡«å¯«ï¼</span>`;
};


/* ======================================================
   ğŸŸ£ è¼‰å…¥å›è¦† â†’ çµ±è¨ˆæ¸²æŸ“
====================================================== */
async function loadResultPage(id) {
  const rSnap = await db.collection("responses")
    .where("surveyId", "==", id)
    .get();

  responses = rSnap.docs.map(d => ({
    ...d.data(),
    id: d.id,
    createdAt: d.data().createdAt
  }));

  renderGoogleFormsStats();
  renderResponseTimeChart();
}
/* ======================================================
   ğŸŸ¢ åŒ¯å‡º CSVï¼ˆæœ¬æ©Ÿä¸‹è¼‰ï¼‰
====================================================== */
document.getElementById("exportCsvBtn").onclick = () => {
  if (!responses.length) {
    document.getElementById("exportMsg").innerHTML =
      "<span style='color:red'>æ²’æœ‰å¯åŒ¯å‡ºçš„å›è¦†è³‡æ–™</span>";
    return;
  }

  const csv = buildCsv();
  downloadCsv(csv, `survey_${selectedSurveyId}_responses.csv`);
  document.getElementById("exportMsg").innerHTML =
    "<span style='color:green'>CSV å·²æˆåŠŸåŒ¯å‡ºï¼</span>";
};

function buildCsv() {
  const header = ["responseId", "createdAt"];
  surveyQuestions.forEach((q, idx) =>
    header.push(`Q${idx + 1}_${q.data.text.replace(/\,|\n|\r/g, " ")}`)
  );

  const rows = [header.join(",")];

  responses.forEach((r) => {
    const row = [
      r.id,
      r.createdAt?.toDate?.().toISOString() || ""
    ];

    surveyQuestions.forEach((q) => {
      const val = r.answers[q.id];
      if (Array.isArray(val)) {
        row.push(`"${val.join("|")}"`);
      } else {
        row.push(`"${(val || "").toString().replace(/\"/g, '""')}"`);
      }
    });

    rows.push(row.join(","));
  });

  return rows.join("\r\n");
}

function downloadCsv(csvText, filename) {
  const blob = new Blob([csvText], { type: "text/csv;charset=utf-8;" });
  const url = URL.createObjectURL(blob);

  const a = document.createElement("a");
  a.href = url;
  a.download = filename;
  a.click();

  URL.revokeObjectURL(url);
}


/* ======================================================
   ğŸŸ£ åŒ¯å‡º Google Sheetsï¼ˆè‡ªå‹•å»ºç«‹è©¦ç®—è¡¨ï¼‰
====================================================== */

document.getElementById("exportSheetBtn").onclick = async () => {
  if (!googleUser) {
    document.getElementById("exportMsg").innerHTML =
      "<span style='color:red'>è«‹å…ˆç™»å…¥ Google æ‰èƒ½åŒ¯å‡ºè‡³è©¦ç®—è¡¨</span>";
    return;
  }
  if (!responses.length) {
    document.getElementById("exportMsg").innerHTML =
      "<span style='color:red'>æ²’æœ‰å¯åŒ¯å‡ºçš„å›è¦†è³‡æ–™</span>";
    return;
  }

  document.getElementById("exportMsg").innerHTML =
    "ğŸ“¤ æ­£åœ¨å»ºç«‹ Google Sheetâ€¦";

  const sheetUrl = await exportToGoogleSheet();
  document.getElementById("exportMsg").innerHTML =
    `âœ” åŒ¯å‡ºå®Œæˆï¼š<a href="${sheetUrl}" target="_blank">${sheetUrl}</a>`;
};

async function exportToGoogleSheet() {
  return new Promise(async (resolve, reject) => {
    /* 1. è¼‰å…¥ Google Sheets API */
    const script = document.createElement("script");
    script.src = "https://apis.google.com/js/api.js";
    script.onload = async () => {
      await gapi.load("client", async () => {
        await gapi.client.init({
          apiKey: "YOUR_GOOGLE_API_KEY",
          discoveryDocs: [
            "https://sheets.googleapis.com/$discovery/rest?version=v4"
          ]
        });

        /* 2. ç”¨ OAuth Access Token ç™»å…¥ */
        const token = google.accounts.oauth2.initTokenClient({
          client_id: "YOUR_GOOGLE_OAUTH_CLIENT_ID",
          scope: "https://www.googleapis.com/auth/spreadsheets",
        });

        token.callback = async (res) => {
          gapi.client.setToken({ access_token: res.access_token });

          /* 3. å»ºç«‹ç©ºçš„ Google Sheet */
          const title = `Survey_${selectedSurveyId}_Export`;
          const sheet = await gapi.client.sheets.spreadsheets.create({
            properties: { title }
          });

          const spreadsheetId = sheet.result.spreadsheetId;

          /* 4. å°‡è³‡æ–™å¯«å…¥ Sheet */
          const values = buildSheetValues();
          await gapi.client.sheets.spreadsheets.values.update({
            spreadsheetId,
            range: "Sheet1!A1",
            valueInputOption: "RAW",
            resource: { values }
          });

          resolve(`https://docs.google.com/spreadsheets/d/${spreadsheetId}/edit`);
        };

        token.requestAccessToken();
      });
    };

    document.body.append(script);
  });
}

function buildSheetValues() {
  const rows = [];

  // æ¨™é¡Œåˆ—
  const header = ["responseId", "createdAt"];
  surveyQuestions.forEach((q, i) =>
    header.push(`Q${i + 1}_${q.data.text}`)
  );
  rows.push(header);

  // è³‡æ–™åˆ—
  responses.forEach((r) => {
    const row = [
      r.id,
      r.createdAt?.toDate?.().toISOString() || ""
    ];
    surveyQuestions.forEach((q) => {
      const v = r.answers[q.id];
      row.push(Array.isArray(v) ? v.join("|") : (v || ""));
    });
    rows.push(row);
  });

  return rows;
}

</script>

</body>
</html>
