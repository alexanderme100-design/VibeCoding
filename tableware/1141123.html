<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é¤å…·å€Ÿç”¨ç³»çµ±</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <style>
        button { touch-action: manipulation; }
        /* éš±è—æ²è»¸ä½†ä¿æŒåŠŸèƒ½ */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body class="bg-gray-50">
    <div id="root"></div>

    <script type="text/babel">
        // --- âš ï¸ è¨­å®šå€ ---
        const firebaseConfig = {
  apiKey: "AIzaSyDKXhvIBrQpJ2zfXFB544aFDiVmTWW1zaE",
  authDomain: "schooltablewaresystem.firebaseapp.com",
  projectId: "schooltablewaresystem",
  storageBucket: "schooltablewaresystem.firebasestorage.app",
  messagingSenderId: "652083653766",
  appId: "1:652083653766:web:1efbf2e614a4b935e1b507"
};
        // -----------------

        // --- ğŸ« å­¸æ ¡ç­ç´šè³‡æ–™ ---
        const SCHOOL_DATA = {
            "1": [
                { id: "101", teacher: "ç¿é›…è“" }, { id: "102", teacher: "å³éŒ¦é³³" }, { id: "103", teacher: "å³é´»é‘«" },
                { id: "104", teacher: "é‚±ç§€è“®" }, { id: "105", teacher: "æ¶‚ç¾èŠ³" }, { id: "106", teacher: "æ¢é›…é’" },
                { id: "107", teacher: "ææ¢…æ…ˆ" }, { id: "108", teacher: "æ—ç¿ è–‡" }, { id: "109", teacher: "ææ–‡å›" },
                { id: "110", teacher: "è˜‡è™¹å¦‚" }, { id: "111", teacher: "è”¡é³³æ´¥" }, { id: "112", teacher: "æ›¾ç¬ç¥º" },
                { id: "113", teacher: "å‘¨æ¶µèˆ’" }, { id: "114", teacher: "é™³æ±¶è¯" }
            ],
            "2": [
                { id: "201", teacher: "æ¸¸æ·‘æƒ " }, { id: "202", teacher: "è¨±é›…åªš" }, { id: "203", teacher: "é™³æè˜‹" },
                { id: "204", teacher: "ç‹ç®å›" }, { id: "205", teacher: "å¼µç´”ç¦" }, { id: "206", teacher: "è³´éœå¦‚" },
                { id: "207", teacher: "é™³éƒæ–¹" }, { id: "208", teacher: "æ—ç‘éš†" }, { id: "209", teacher: "å‘¨é èŒ¹" },
                { id: "210", teacher: "é™³å©‰è²" }, { id: "211", teacher: "é„­å©·æ–¹" }, { id: "212", teacher: "é™³å¹¼æ¨º" },
                { id: "213", teacher: "å³æƒ å©·" }
            ],
            "3": [
                { id: "301", teacher: "æŸ¯ä¼ŠèŠ³" }, { id: "302", teacher: "ä½•ä½©ç‘œ" }, { id: "303", teacher: "å¼µæ‡¿å¿ƒ" },
                { id: "304", teacher: "æ—ç‡•å¨¥" }, { id: "305", teacher: "æ—å®›äº­" }, { id: "306", teacher: "å³é›ªåªº" },
                { id: "307", teacher: "é»ƒé–é©Š" }, { id: "308", teacher: "æä½©å‹³" }, { id: "309", teacher: "å³è•™å›" },
                { id: "310", teacher: "é‚±æ·‘ç‡•" }, { id: "311", teacher: "è”¡å®œå¨Ÿ" }, { id: "312", teacher: "è”¡å®›å€«" },
                { id: "313", teacher: "å³åŸ¹ç‘œ" }, { id: "314", teacher: "é™³ç«‹éŠ˜" }, { id: "315", teacher: "å­«å¾·æ˜Œ" },
                { id: "316", teacher: "é™³é›ªå¿" }
            ],
            "4": [
                { id: "401", teacher: "è‘‰å­ç¶­" }, { id: "402", teacher: "æ¹¯æ·‘å¨Ÿ" }, { id: "403", teacher: "é„­é›…å¦‚" },
                { id: "404", teacher: "è¨±éƒç¿" }, { id: "405", teacher: "é„­ä»•æ°" }, { id: "406", teacher: "æ¼†åº¶é½Š" },
                { id: "407", teacher: "ç‹ä¿Šä»" }, { id: "408", teacher: "æ—ä½³è“‰" }, { id: "409", teacher: "èŠç‘©ç" },
                { id: "410", teacher: "è‘‰æ¨¹èŠ±" }, { id: "411", teacher: "å³ç´ å¨Ÿ" }, { id: "412", teacher: "è¬äºåº­" },
                { id: "413", teacher: "ç‹èŠŠæ¶µ" }, { id: "414", teacher: "å¼µéŠ€ç " }, { id: "415", teacher: "é»ƒéœ–å‚‘" },
                { id: "416", teacher: "é„­è±è£•" }, { id: "417", teacher: "æ›¾é¦¨å„€" }, { id: "418", teacher: "ææ˜è•™" }
            ],
            "5": [
                { id: "501", teacher: "è³´é›…è" }, { id: "502", teacher: "å¼µæ¦•ç©" }, { id: "503", teacher: "å³ææ¢…" },
                { id: "504", teacher: "å¼µç”„è‚²" }, { id: "505", teacher: "æ—æ˜€" },   { id: "506", teacher: "å³å®¶é³³" },
                { id: "507", teacher: "æ¢è© æ¶µ" }, { id: "508", teacher: "é™³å“å‡" }, { id: "509", teacher: "é™³å† ç”«" },
                { id: "510", teacher: "ä½•æ–¹å®œ" }, { id: "511", teacher: "å´”ç¿”æ£»" }, { id: "512", teacher: "æ—å‚‘ç« " },
                { id: "513", teacher: "ç¿é´»å‹³" }, { id: "514", teacher: "æ—éƒéœ" }, { id: "515", teacher: "è©¹å‡±ç½" },
                { id: "516", teacher: "è³´ç«‹å‹³" }, { id: "517", teacher: "æéº—è¯" }, { id: "518", teacher: "æˆ´ç§€çœŸ" }
            ],
            "6": [
                { id: "601", teacher: "é‚±æ¹˜æ·©" }, { id: "602", teacher: "æ›¾éŸ»å¦‚" }, { id: "603", teacher: "æä½³ç’‰" },
                { id: "604", teacher: "è˜‡å»£æ—" }, { id: "605", teacher: "é™³å­Ÿå“²" }, { id: "606", teacher: "é™³ä¹ƒç¶º" },
                { id: "607", teacher: "ææ¬£ç—" }, { id: "608", teacher: "å¼µå¤§åƒ" }, { id: "609", teacher: "è”¡ä½³å®¶" },
                { id: "610", teacher: "è¨±è€˜è˜" }, { id: "611", teacher: "åŠ‰æ½”å„’" }, { id: "612", teacher: "é™³å¬¿å¦‚" },
                { id: "613", teacher: "è¨±ç“Šå‹»" }, { id: "614", teacher: "å³å¾‹ç‘©" }, { id: "615", teacher: "è™ç¹¼å®" },
                { id: "616", teacher: "æ›¾è© å˜‰" }, { id: "617", teacher: "é»ƒå´§æ†" }, { id: "618", teacher: "è•­ä¸»æ‚…" }
            ]
        };

        const { useState, useEffect } = React;
        let auth, db;
        let isConfigured = false;

        if (firebaseConfig.apiKey !== "ä½ çš„_API_KEY" && firebaseConfig.projectId !== "ä½ çš„å°ˆæ¡ˆID") {
            if (!firebase.apps.length) {
                try { firebase.initializeApp(firebaseConfig); isConfigured = true; } 
                catch (e) { console.error("Firebase Init Error:", e); }
            } else { isConfigured = true; }
            if (isConfigured) { auth = firebase.auth(); db = firebase.firestore(); }
        }

        const ConfigError = () => (
            <div className="min-h-screen flex items-center justify-center bg-red-50 p-4">
                <div className="bg-white p-8 rounded-2xl shadow-xl max-w-lg text-center border-l-8 border-red-500">
                    <h1 className="text-2xl font-bold text-red-600 mb-4">âš ï¸ ç³»çµ±å°šæœªè¨­å®š</h1>
                    <p className="text-gray-600 mb-4">è«‹ç·¨è¼¯ index.html å¡«å…¥æ­£ç¢ºçš„ Firebase API Keyã€‚</p>
                </div>
            </div>
        );

        // --- å…ƒä»¶ï¼šæ•¸å­—éµç›¤ (é™åˆ¶åº§è™Ÿè¼¸å…¥) ---
        const NumberPad = ({ value, onChange, maxDigits = 2 }) => {
            const handleNumClick = (num) => {
                if (value.length < maxDigits) onChange(value + num);
            };
            return (
                <div className="grid grid-cols-3 gap-3 max-w-xs mx-auto mt-4">
                    {[1, 2, 3, 4, 5, 6, 7, 8, 9].map((num) => (
                        <button key={num} onClick={() => handleNumClick(num.toString())}
                            className="bg-white hover:bg-blue-50 text-blue-600 font-bold text-3xl py-4 rounded-xl shadow-sm border-b-4 border-blue-200 active:border-b-0 active:translate-y-1 transition-all">
                            {num}
                        </button>
                    ))}
                    <button onClick={() => onChange('')} className="bg-red-100 text-red-600 font-bold text-lg py-4 rounded-xl shadow-sm border-b-4 border-red-200 active:border-b-0 active:translate-y-1">æ¸…é™¤</button>
                    <button onClick={() => handleNumClick('0')} className="bg-white text-blue-600 font-bold text-3xl py-4 rounded-xl shadow-sm border-b-4 border-blue-200 active:border-b-0 active:translate-y-1">0</button>
                    <button onClick={() => onChange(value.slice(0, -1))} className="bg-gray-100 text-gray-600 font-bold text-lg py-4 rounded-xl shadow-sm border-b-4 border-gray-300 active:border-b-0 active:translate-y-1">âŒ«</button>
                </div>
            );
        };

        function TablewareSystem() {
            if (!isConfigured) return <ConfigError />;

            const [user, setUser] = useState(null);
            const [view, setView] = useState('home');
            
            // --- æ–°å¢ï¼šé¸æ“‡ç‹€æ…‹ ---
            const [inputStep, setInputStep] = useState('grade'); // grade, class, seat
            const [selectedGrade, setSelectedGrade] = useState(null);
            const [selectedClassData, setSelectedClassData] = useState(null); // {id: '101', teacher: 'xxx'}
            const [seatNumber, setSeatNumber] = useState('');

            const [selectedItems, setSelectedItems] = useState({ bowl: false, spoon: false, chopsticks: false });
            const [loading, setLoading] = useState(false);
            const [activeBorrows, setActiveBorrows] = useState([]);
            const [allActiveBorrows, setAllActiveBorrows] = useState([]);
            const [successMessage, setSuccessMessage] = useState('');
            const appId = 'default-app-id'; 

            useEffect(() => {
                auth.signInAnonymously().catch(e => console.error("Auth error", e));
                return auth.onAuthStateChanged(setUser);
            }, []);

            useEffect(() => {
                if (!user || view !== 'admin') return;
                const unsubscribe = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('tableware_records')
                    .where('status', '==', 'borrowed')
                    .onSnapshot(snapshot => {
                        const records = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        records.sort((a, b) => new Date(b.borrowTime) - new Date(a.borrowTime));
                        setAllActiveBorrows(records);
                    });
                return () => unsubscribe();
            }, [user, view]);

            // --- é‚è¼¯ï¼šçµ„åˆå­¸è™Ÿ ---
            const getFullStudentId = () => {
                if (!selectedClassData || !seatNumber) return "";
                // è£œé›¶ï¼šå¦‚æœåº§è™Ÿæ˜¯ 5ï¼Œè®Šæˆ 05ã€‚å¦‚æœ 23ï¼Œä¿æŒ 23ã€‚
                const paddedSeat = seatNumber.padStart(2, '0');
                return `${selectedClassData.id}${paddedSeat}`;
            };

            const handleStartAuth = (targetView) => {
                // é‡ç½®æ‰€æœ‰è¼¸å…¥ç‹€æ…‹
                setInputStep('grade');
                setSelectedGrade(null);
                setSelectedClassData(null);
                setSeatNumber('');
                setView(targetView); // borrow_auth æˆ– return_auth
            };

            const handleNextStep = () => {
                // å¦‚æœæ˜¯ã€Œå€Ÿç”¨æµç¨‹ã€ä¸”åœ¨åº§è™Ÿè¼¸å…¥å®Œç•¢ -> å»é¸é¤å…·
                if (view === 'borrow_auth') {
                    setView('borrow_select');
                } 
                // å¦‚æœæ˜¯ã€Œæ­¸é‚„æµç¨‹ã€ä¸”åº§è™Ÿè¼¸å…¥å®Œç•¢ -> å»æŸ¥å€Ÿé–±ç´€éŒ„
                else if (view === 'return_auth') {
                    checkBorrowsForReturn();
                }
            };

            const handleBorrow = async () => {
                const finalId = getFullStudentId();
                if (!finalId) return alert("è³‡æ–™ä¸å®Œæ•´");
                
                const items = [];
                if (selectedItems.bowl) items.push('ç¢—');
                if (selectedItems.spoon) items.push('æ¹¯åŒ™');
                if (selectedItems.chopsticks) items.push('ç­·å­');
                if (items.length === 0) return alert("è«‹é¸æ“‡é¤å…·");

                setLoading(true);
                try {
                    await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('tableware_records').add({
                        studentId: finalId, 
                        items, 
                        borrowTime: new Date().toISOString(), 
                        returnTime: null, 
                        status: 'borrowed'
                    });
                    setSuccessMessage(`å¥½æ£’ï¼${finalId} (${selectedClassData.teacher}è€å¸«ç­) å€Ÿç”¨æˆåŠŸï¼`);
                    setView('success');
                    setTimeout(resetForm, 3000);
                } catch (e) { alert("å€Ÿç”¨å¤±æ•—: " + e.message); } finally { setLoading(false); }
            };

            const checkBorrowsForReturn = async () => {
                const finalId = getFullStudentId();
                if (!finalId) return;
                setLoading(true);
                try {
                    const snapshot = await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('tableware_records')
                        .where('studentId', '==', finalId).where('status', '==', 'borrowed').get();
                    setActiveBorrows(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
                    setView('return_list');
                } catch (e) { alert("æŸ¥è©¢å¤±æ•—"); } finally { setLoading(false); }
            };

            const handleReturn = async (recordId) => {
                setLoading(true);
                try {
                    await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('tableware_records').doc(recordId)
                        .update({ returnTime: new Date().toISOString(), status: 'returned' });
                    const remaining = activeBorrows.filter(item => item.id !== recordId);
                    setActiveBorrows(remaining);
                    if (remaining.length === 0) {
                        setSuccessMessage(`è¬è¬æ­¸é‚„ï¼`);
                        setView('success');
                        setTimeout(resetForm, 3000);
                    }
                } catch (e) { alert("æ­¸é‚„å¤±æ•—"); } finally { setLoading(false); }
            };

            const resetForm = () => {
                setInputStep('grade'); setSelectedGrade(null); setSelectedClassData(null); setSeatNumber('');
                setSelectedItems({ bowl: false, spoon: false, chopsticks: false });
                setView('home'); setSuccessMessage('');
            };
            
            const exportToCSV = async () => {
                if (!confirm("ç¢ºå®šè¦ä¸‹è¼‰å—ï¼Ÿ")) return;
                try {
                    const snapshot = await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('tableware_records').orderBy('borrowTime', 'desc').get();
                    let csv = "\uFEFFå­¸è™Ÿ,ç‰©å“,å€Ÿç”¨æ™‚é–“,ç‹€æ…‹\n";
                    snapshot.docs.forEach(doc => {
                        const d = doc.data();
                        csv += `"${d.studentId}","${d.items.join('ã€')}","${new Date(d.borrowTime).toLocaleString()}","${d.status === 'borrowed' ? 'å€Ÿå‡º' : 'å·²é‚„'}"\n`;
                    });
                    const link = document.createElement("a");
                    link.href = URL.createObjectURL(new Blob([csv], { type: 'text/csv;charset=utf-8;' }));
                    link.download = `ç´€éŒ„_${new Date().toISOString().slice(0,10)}.csv`;
                    link.click();
                } catch (e) { alert("åŒ¯å‡ºå¤±æ•—"); }
            };

            // --- æ¸²æŸ“ï¼šèº«ä»½è¼¸å…¥æµç¨‹ (å…±ç”¨å…ƒä»¶) ---
            const renderAuthStep = () => {
                // 1. é¸å¹´ç´š
                if (inputStep === 'grade') {
                    return (
                        <div className="w-full max-w-lg">
                            <h2 className="text-2xl font-bold text-center mb-6 text-gray-700">è«‹å•ä½ æ˜¯å¹¾å¹´ç´šï¼Ÿ</h2>
                            <div className="grid grid-cols-2 gap-4">
                                {Object.keys(SCHOOL_DATA).map(grade => (
                                    <button key={grade} onClick={() => { setSelectedGrade(grade); setInputStep('class'); }}
                                        className="bg-white border-b-4 border-blue-200 text-blue-600 hover:bg-blue-50 py-6 rounded-2xl text-3xl font-bold shadow-sm active:border-b-0 active:translate-y-1 transition-all">
                                        {grade} å¹´ç´š
                                    </button>
                                ))}
                            </div>
                        </div>
                    );
                }
                // 2. é¸ç­ç´š (é¡¯ç¤ºå°å¸«)
                if (inputStep === 'class') {
                    const classes = SCHOOL_DATA[selectedGrade];
                    return (
                        <div className="w-full max-w-2xl">
                             <div className="flex items-center justify-between mb-4">
                                <button onClick={() => setInputStep('grade')} className="text-gray-400 font-bold px-3 py-1 bg-gray-100 rounded-lg">â¬… å›ä¸Šä¸€æ­¥</button>
                                <h2 className="text-2xl font-bold text-gray-700">{selectedGrade} å¹´ç´š - é¸ç­ç´š</h2>
                                <div className="w-20"></div>
                            </div>
                            <div className="grid grid-cols-3 sm:grid-cols-4 gap-3 max-h-[60vh] overflow-y-auto no-scrollbar pb-10">
                                {classes.map(cls => (
                                    <button key={cls.id} onClick={() => { setSelectedClassData(cls); setInputStep('seat'); }}
                                        className="bg-white border-2 border-gray-100 hover:border-blue-400 hover:bg-blue-50 p-3 rounded-xl shadow-sm flex flex-col items-center gap-1 active:scale-95 transition-all">
                                        <span className="text-2xl font-bold text-blue-700">{cls.id}</span>
                                        <span className="text-sm text-gray-500 font-bold">{cls.teacher}</span>
                                    </button>
                                ))}
                            </div>
                        </div>
                    );
                }
                // 3. è¼¸å…¥åº§è™Ÿ
                if (inputStep === 'seat') {
                    return (
                        <div className="w-full max-w-md">
                            <div className="flex items-center justify-between mb-2">
                                <button onClick={() => setInputStep('class')} className="text-gray-400 font-bold px-3 py-1 bg-gray-100 rounded-lg">â¬… é‡é¸ç­ç´š</button>
                                <div className="text-center">
                                    <div className="text-3xl font-bold text-blue-600">{selectedClassData.id}</div>
                                    <div className="text-xs text-gray-400">{selectedClassData.teacher}è€å¸«</div>
                                </div>
                                <div className="w-20"></div>
                            </div>
                            
                            <h2 className="text-xl font-bold text-center text-gray-700 mb-2">è«‹è¼¸å…¥åº§è™Ÿ</h2>
                            
                            <div className="bg-gray-100 p-4 rounded-xl text-center mb-4 border-2 border-blue-100 h-24 flex items-center justify-center">
                                {seatNumber ? (
                                    <span className="text-6xl font-mono font-bold text-gray-800">{seatNumber}</span>
                                ) : (
                                    <span className="text-gray-400 text-lg animate-pulse">è«‹æŒ‰ä¸‹æ–¹æ•¸å­—...</span>
                                )}
                            </div>

                            <NumberPad value={seatNumber} onChange={setSeatNumber} maxDigits={2} />
                            
                            <button onClick={handleNextStep} disabled={!seatNumber}
                                className={`w-full mt-6 py-4 rounded-xl text-xl font-bold text-white shadow-md transition-all ${seatNumber ? 'bg-blue-500 border-b-4 border-blue-700 active:translate-y-1' : 'bg-gray-300'}`}>
                                ä¸‹ä¸€æ­¥
                            </button>
                        </div>
                    );
                }
            };

            // --- é é¢æ¸²æŸ“ ---
            if (view === 'home') return (
                <div className="min-h-screen bg-amber-50 flex flex-col items-center justify-center p-4 font-sans">
                    <div className="bg-white p-8 rounded-3xl shadow-xl w-full max-w-lg text-center border-b-8 border-amber-200">
                        <h1 className="text-3xl font-bold text-amber-800 mb-2">ğŸ« é¤å…·å€Ÿç”¨ç«™</h1>
                        <p className="text-gray-500 mb-8">è«‹é¸æ“‡ä½ è¦åšä»€éº¼ï¼Ÿ</p>
                        <div className="grid grid-cols-2 gap-6">
                            <button onClick={() => handleStartAuth('borrow_auth')} className="bg-green-100 hover:bg-green-200 border-b-4 border-green-300 active:border-b-0 active:translate-y-1 p-6 rounded-2xl transition-all h-48 flex flex-col items-center justify-center">
                                <span className="text-4xl mb-3">ğŸ´</span><span className="text-2xl font-bold text-green-800">æˆ‘è¦å€Ÿ</span>
                            </button>
                            <button onClick={() => handleStartAuth('return_auth')} className="bg-blue-100 hover:bg-blue-200 border-b-4 border-blue-300 active:border-b-0 active:translate-y-1 p-6 rounded-2xl transition-all h-48 flex flex-col items-center justify-center">
                                <span className="text-4xl mb-3">â†©ï¸</span><span className="text-2xl font-bold text-blue-800">æˆ‘è¦é‚„</span>
                            </button>
                        </div>
                        <button onClick={() => setView('admin')} className="mt-8 text-gray-400 hover:text-gray-600 text-sm block mx-auto">ğŸ“‹ è€å¸«å°ˆç”¨ç®¡ç†å€</button>
                    </div>
                </div>
            );

            if (view === 'borrow_auth' || view === 'return_auth') return (
                <div className={`min-h-screen flex flex-col items-center justify-center p-4 ${view === 'borrow_auth' ? 'bg-blue-50' : 'bg-indigo-50'}`}>
                    <div className="bg-white p-6 rounded-3xl shadow-xl w-full max-w-md border-b-8 border-gray-200 flex flex-col items-center relative">
                        {/* å·¦ä¸Šè§’è¿”å›é¦–é  (åªæœ‰åœ¨ç¬¬ä¸€æ­¥æ™‚é¡¯ç¤ºï¼Œé¿å…æ··äº‚) */}
                        {inputStep === 'grade' && (
                             <button onClick={() => setView('home')} className="absolute top-6 left-6 text-gray-400 hover:text-gray-600 font-bold">ğŸ  å›é¦–é </button>
                        )}
                        {renderAuthStep()}
                    </div>
                </div>
            );

            if (view === 'borrow_select') return (
                <div className="min-h-screen bg-green-50 flex flex-col items-center justify-center p-4">
                    <div className="bg-white p-6 rounded-3xl shadow-xl w-full max-w-md border-b-8 border-green-200">
                        <div className="flex justify-between items-center mb-2">
                            <button onClick={() => { setView('borrow_auth'); setInputStep('seat'); }} className="bg-gray-100 p-2 rounded-full text-xl">â¬…ï¸</button>
                            <span className="font-bold text-green-700 text-lg">{getFullStudentId()}</span>
                        </div>
                        <h2 className="text-2xl font-bold text-center text-gray-800 mb-6">ä½ è¦å€Ÿä»€éº¼ï¼Ÿ</h2>
                        <div className="space-y-4">
                            <button onClick={() => setSelectedItems({ ...selectedItems, bowl: !selectedItems.bowl })} className={`w-full flex items-center justify-between p-4 rounded-2xl border-2 ${selectedItems.bowl ? 'bg-orange-100 border-orange-500' : 'bg-white border-gray-200'}`}>
                                <div className="flex items-center gap-4"><span className="text-3xl">ğŸ¥£</span><span className="text-2xl font-bold text-gray-700">ç¢—</span></div>{selectedItems.bowl && <span className="text-2xl text-orange-500">âœ…</span>}
                            </button>
                            <button onClick={() => setSelectedItems({ ...selectedItems, spoon: !selectedItems.spoon })} className={`w-full flex items-center justify-between p-4 rounded-2xl border-2 ${selectedItems.spoon ? 'bg-cyan-100 border-cyan-500' : 'bg-white border-gray-200'}`}>
                                <div className="flex items-center gap-4"><span className="text-3xl">ğŸ¥„</span><span className="text-2xl font-bold text-gray-700">æ¹¯åŒ™</span></div>{selectedItems.spoon && <span className="text-2xl text-cyan-500">âœ…</span>}
                            </button>
                            <button onClick={() => setSelectedItems({ ...selectedItems, chopsticks: !selectedItems.chopsticks })} className={`w-full flex items-center justify-between p-4 rounded-2xl border-2 ${selectedItems.chopsticks ? 'bg-purple-100 border-purple-500' : 'bg-white border-gray-200'}`}>
                                <div className="flex items-center gap-4"><span className="text-3xl">ğŸ¥¢</span><span className="text-2xl font-bold text-gray-700">ç­·å­</span></div>{selectedItems.chopsticks && <span className="text-2xl text-purple-500">âœ…</span>}
                            </button>
                        </div>
                        <button onClick={handleBorrow} disabled={loading} className="w-full mt-8 bg-green-500 text-white text-xl font-bold py-4 rounded-xl shadow-lg border-b-4 border-green-700 active:border-b-0 active:translate-y-1">{loading ? 'è™•ç†ä¸­...' : 'ç¢ºèªå€Ÿç”¨'}</button>
                    </div>
                </div>
            );

            if (view === 'return_list') return (
                <div className="min-h-screen bg-blue-50 flex flex-col items-center justify-center p-4">
                    <div className="bg-white p-6 rounded-3xl shadow-xl w-full max-w-md border-b-8 border-blue-200">
                        <div className="flex justify-between items-center mb-4">
                            <button onClick={() => { setView('return_auth'); setInputStep('seat'); }} className="bg-gray-100 p-2 rounded-full text-xl">â¬…ï¸</button>
                            <span className="font-bold text-blue-700 text-lg">{getFullStudentId()}</span>
                        </div>
                        <h2 className="text-xl font-bold text-center text-gray-800 mb-2">æœªæ­¸é‚„é …ç›®</h2>
                        {activeBorrows.length === 0 ? (
                            <div className="text-center py-8"><p className="text-lg text-gray-600">ç›®å‰æ²’æœ‰å€Ÿç”¨ç´€éŒ„å–”ï¼</p><button onClick={resetForm} className="mt-4 text-blue-500 font-bold">å›é¦–é </button></div>
                        ) : (
                            <div className="space-y-4 max-h-[60vh] overflow-y-auto">
                                {activeBorrows.map((r) => (
                                    <div key={r.id} className="bg-gray-50 p-4 rounded-xl border border-gray-200 shadow-sm flex items-center justify-between">
                                        <div>
                                            <div className="flex gap-2 mb-1">{r.items.map((i, idx) => <span key={idx} className="px-2 py-1 bg-blue-100 text-blue-700 rounded-md text-sm font-bold">{i}</span>)}</div>
                                            <div className="text-xs text-gray-400">ğŸ•’ {new Date(r.borrowTime).toLocaleString('zh-TW')}</div>
                                        </div>
                                        <button onClick={() => handleReturn(r.id)} className="bg-blue-500 text-white px-4 py-2 rounded-lg font-bold shadow-sm">æ­¸é‚„</button>
                                    </div>
                                ))}
                            </div>
                        )}
                    </div>
                </div>
            );

            if (view === 'success') return (
                <div className="min-h-screen bg-green-50 flex flex-col items-center justify-center p-4">
                    <div className="bg-white p-8 rounded-full shadow-2xl animate-bounce mb-8"><span className="text-6xl">âœ…</span></div>
                    <h2 className="text-3xl font-bold text-green-800 text-center mb-4 animate-pulse">å®Œæˆï¼</h2>
                    <p className="text-xl text-gray-600 text-center">{successMessage}</p>
                </div>
            );

            if (view === 'admin') return (
                <div className="min-h-screen bg-gray-100 p-6">
                    <div className="max-w-4xl mx-auto">
                        <div className="flex justify-between items-center mb-6">
                            <div className="flex items-center gap-3"><button onClick={resetForm} className="bg-white p-2 rounded-lg shadow">â¬…ï¸</button><h1 className="text-2xl font-bold text-gray-800">ğŸ“Š ç®¡ç†å¾Œå°</h1></div>
                            <div className="flex gap-2">
                                <button onClick={exportToCSV} className="bg-green-600 text-white px-4 py-2 rounded-lg shadow font-bold text-sm">ğŸ“¥ åŒ¯å‡º CSV</button>
                                <div className="bg-white px-4 py-2 rounded-lg shadow text-sm font-bold text-red-500 flex items-center">æœªæ­¸é‚„: {allActiveBorrows.length}</div>
                            </div>
                        </div>
                        <div className="bg-white rounded-2xl shadow-sm overflow-hidden overflow-x-auto">
                            <table className="w-full text-left">
                                <thead className="bg-gray-50 border-b border-gray-100"><tr><th className="p-4">å­¸è™Ÿ</th><th className="p-4">ç‰©å“</th><th className="p-4">æ™‚é–“</th><th className="p-4">æ“ä½œ</th></tr></thead>
                                <tbody className="divide-y divide-gray-100">
                                    {allActiveBorrows.length === 0 ? <tr><td colSpan="4" className="p-8 text-center text-gray-400">å¤ªæ£’äº†ï¼æ‰€æœ‰é¤å…·éƒ½å·²æ­¸é‚„</td></tr> : allActiveBorrows.map(r => (
                                        <tr key={r.id} className="hover:bg-gray-50"><td className="p-4 font-bold">{r.studentId}</td><td className="p-4">{r.items.join(', ')}</td><td className="p-4 text-sm text-gray-500">{new Date(r.borrowTime).toLocaleString()}</td><td className="p-4"><button onClick={() => handleReturn(r.id)} className="text-blue-500 font-bold">å¼·åˆ¶æ­¸é‚„</button></td></tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<TablewareSystem />);
    </script>
</body>
</html>
