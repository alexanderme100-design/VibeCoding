<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Firebase å•å·ç³»çµ±</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <!-- å¼•å…¥å¤šå…ƒå­—é«” -->
    <link href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@400;700&family=Noto+Serif+TC:wght@400;700&family=DotGothic16&family=Space+Mono:wght@700&display=swap" rel="stylesheet">

    <style>
        /* --- æ ¸å¿ƒè®Šæ•¸ç³»çµ± (Theming System) --- */
        :root {
            --bg-color: #FAF7F0;
            --bg-image: none;
            --text-color: #4A4A4A;
            
            --card-bg: #ffffff;
            --card-border: 1px solid rgba(0,0,0,0.05);
            --card-radius: 20px;
            --card-shadow: 0 10px 15px -3px rgba(86, 138, 102, 0.1);
            
            --primary-color: #568A66;
            --primary-text: #ffffff;
            --secondary-color: #E67F65;
            
            --input-bg: #ffffff;
            --input-border: 2px solid #eeeeee;
            
            --select-bg: #eff6ff;
            --select-border: #2563eb;
            --select-text: #1e3a8a;
            
            --font-family: 'Zen Maru Gothic', 'Noto Sans TC', sans-serif;
            
            /* é€²éšè£é£¾ */
            --btn-shadow: 0 4px 0 var(--ghibli-green-dark);
            --btn-transform: translateY(0);
            --btn-hover-filter: brightness(110%);
            --blob-opacity: 0.3;
        }

        /* å…¨åŸŸæ¨£å¼æ‡‰ç”¨ */
        html, body { 
            overflow-x: hidden; 
            min-height: 100dvh; 
            background-color: var(--bg-color); 
            background-image: var(--bg-image);
            background-attachment: fixed; /* è®“èƒŒæ™¯ç´‹ç†å›ºå®š */
            font-family: var(--font-family);
            color: var(--text-color);
            -webkit-tap-highlight-color: transparent; 
            transition: background-color 0.5s ease, color 0.3s ease;
        }
        
        body { display: flex; flex-direction: column; }
        
        /* å¡ç‰‡æ¨¡çµ„ */
        .theme-card {
            background-color: var(--card-bg);
            border-radius: var(--card-radius);
            border: var(--card-border);
            box-shadow: var(--card-shadow);
            transition: all 0.3s ease;
            backdrop-filter: blur(0px); /* é è¨­ç„¡ */
        }

        /* æŒ‰éˆ•æ¨¡çµ„ */
        .theme-btn {
            background-color: var(--primary-color);
            color: var(--primary-text);
            border-radius: var(--card-radius);
            box-shadow: var(--btn-shadow);
            border: none;
            transition: all 0.1s;
            filter: var(--btn-hover-filter);
            position: relative;
            overflow: hidden;
        }
        .theme-btn:active { 
            transform: translateY(2px); 
            box-shadow: none !important;
        }
        
        /* è¼¸å…¥æ¡†æ¨¡çµ„ */
        .theme-input {
            background-color: var(--input-bg);
            border: var(--input-border);
            color: var(--text-color);
            border-radius: calc(var(--card-radius) / 2);
            transition: all 0.2s;
        }
        .theme-input:focus {
            border-color: var(--primary-color);
            outline: none;
            box-shadow: 0 0 0 3px rgba(var(--primary-color), 0.1);
        }

        /* é¸é …äº’å‹• (Checked) */
        input:checked + div { 
            transform: scale(0.98); 
            background-color: var(--select-bg) !important;
            border-color: var(--select-border) !important;
            color: var(--select-text) !important;
            box-shadow: inset 0 0 0 2px var(--select-border);
            font-weight: bold;
        }

        /* ç‰¹æ®Šæ•ˆæœï¼šèƒŒæ™¯å™ªé» (Paper Style) */
        .noise-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; z-index: -1; opacity: 0.05;
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.65' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)'/%3E%3C/svg%3E");
            display: none; /* é è¨­éš±è— */
        }

        /* è£é£¾æ€§å…ƒç´  */
        .cloud { position: absolute; background: white; border-radius: 100px; z-index: -1; opacity: 0.6; display: none; } /* é è¨­éš±è—ï¼Œå‰åœåŠ›é¢¨é–‹å•Ÿ */
        .cloud-1 { width: 100px; height: 40px; top: 20px; left: -10px; animation: float 20s infinite linear; }
        .cloud-2 { width: 160px; height: 60px; top: 50px; right: -30px; animation: float 35s infinite linear reverse; }
        @keyframes float { 0% { transform: translateX(0); } 50% { transform: translateX(20px); } 100% { transform: translateX(0); } }

        /* å…¶ä»–å·¥å…· */
        .fade-in { animation: fadeIn 0.4s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .error-shake { animation: shake 0.4s cubic-bezier(.36,.07,.19,.97) both; border-color: #ef4444 !important; background-color: #fef2f2 !important; }
        @keyframes shake { 10%, 90% { transform: translate3d(-1px, 0, 0); } 20%, 80% { transform: translate3d(2px, 0, 0); } 30%, 50%, 70% { transform: translate3d(-4px, 0, 0); } 40%, 60% { transform: translate3d(4px, 0, 0); } }
        .tap-target { min-height: 48px; cursor: pointer; }
        .safe-pb { padding-bottom: env(safe-area-inset-bottom, 20px); }
        .drag-handle { cursor: grab; touch-action: none; }
        
        /* é‡è¡¨é¡è‰² (å¯è¢« Theme è¦†è“‹) */
        .likert-opt-1 { color: #ef4444; } .likert-opt-2 { color: #f97316; } .likert-opt-3 { color: #eab308; } .likert-opt-4 { color: #84cc16; } .likert-opt-5 { color: #22c55e; } 
        .opt-default { border: 1px solid #e5e7eb; background-color: white; }
    </style>

    <script>
        window.app = {}; 

        // --- 20 ç¨®æ¥µè‡´é¢¨æ ¼å®šç¾© ---
        // é€™è£¡å®šç¾©æ¯ç¨®é¢¨æ ¼çš„ "DNA"ï¼ŒåŒ…å«èƒŒæ™¯åœ–ã€å­—é«”ã€é™°å½±é‚è¼¯
        const THEMES = {
            'ghibli': { 
                name: 'å‰åœåŠ›é¢¨', 
                bg: '#FAF7F0', 
                image: 'radial-gradient(#E5E0D0 1px, transparent 1px)', // é»é»èƒŒæ™¯
                text: '#4A4A4A', card: '#ffffff', primary: '#568A66', radius: '20px', 
                shadow: '0 10px 15px -3px rgba(86, 138, 102, 0.15)', // ç¶ è‰²æŸ”å…‰
                font: "'Zen Maru Gothic', sans-serif",
                btnShadow: '0 4px 0 #3E664B'
            },
            'muji': { 
                name: 'éŸ“ç³»æ–‡é’ (MUJI)', 
                bg: '#F3F2ED', 
                text: '#595750', card: '#FCFAF7', primary: '#8C8376', radius: '2px', 
                shadow: 'none', border: '1px solid #E6E4E0',
                font: "'Noto Serif TC', serif",
                btnShadow: 'none',
                selectBg: '#EAE8E4', selectBorder: '#8C8376', selectText: '#595750'
            },
            'taiwan': { 
                name: 'å°ç£æ’ç•«é¢¨', 
                bg: '#FFF8E1', 
                image: 'linear-gradient(45deg, #FFECB3 25%, transparent 25%, transparent 75%, #FFECB3 75%, #FFECB3), linear-gradient(45deg, #FFECB3 25%, transparent 25%, transparent 75%, #FFECB3 75%, #FFECB3)', // è±æ ¼ç´‹
                bgSize: '20px 20px',
                bgPos: '0 0, 10px 10px',
                text: '#5D4037', card: '#FFFFFF', primary: '#FF7043', radius: '16px', 
                shadow: '4px 4px 0px #FFCCBC', // ç¡¬é™°å½±
                font: "'Zen Maru Gothic', sans-serif",
                border: '2px solid #5D4037'
            },
            'blackboard': { 
                name: 'æ–‡é’é»‘æ¿', 
                bg: '#2F3E46', 
                text: '#F0F0F0', card: '#354F52', primary: '#F4D35E', radius: '4px', 
                border: '2px dashed #84A98C', 
                shadow: 'none',
                font: "'DotGothic16', monospace",
                selectBg: '#52796F', selectBorder: '#F4D35E', selectText: '#F4D35E',
                inputBg: '#2F3E46', inputBorder: '1px solid #84A98C'
            },
            'cyberpunk': { 
                name: 'æœªä¾†æ„Ÿéœ“è™¹', 
                bg: '#050505', 
                image: 'linear-gradient(0deg, rgba(0,255,255,0.1) 1px, transparent 1px), linear-gradient(90deg, rgba(0,255,255,0.1) 1px, transparent 1px)',
                bgSize: '40px 40px',
                text: '#00FFFF', card: '#0A0A0A', primary: '#FF00FF', radius: '0px', 
                border: '1px solid #00FFFF', 
                shadow: '0 0 10px #00FFFF, inset 0 0 20px rgba(0,255,255,0.1)',
                font: "'Space Mono', monospace",
                selectBg: '#1A1A1A', selectBorder: '#FF00FF', selectText: '#FF00FF',
                inputBg: '#000', inputBorder: '1px solid #00FFFF'
            },
            'comic': { 
                name: 'æ¼«ç•«é¢¨', 
                bg: '#FFFFFF', 
                image: 'radial-gradient(#000 15%, transparent 16%)', 
                bgSize: '8px 8px',
                text: '#000000', card: '#FFFFFF', primary: '#FFE600', radius: '0px', 
                border: '3px solid #000000', 
                shadow: '6px 6px 0px #000000', // æ¼«ç•«ç¡¬é™°å½±
                font: "sans-serif",
                btnShadow: '4px 4px 0 #000',
                selectBg: '#000', selectBorder: '#000', selectText: '#FFF'
            },
            'paper': { 
                name: 'é«˜ç´šç´™å¼µ', 
                bg: '#F5F1E6', 
                text: '#2C2825', card: '#FDFBF7', primary: '#8C7B70', radius: '2px', 
                shadow: '0 2px 10px rgba(0,0,0,0.05)', 
                font: "'Noto Serif TC', serif",
                noise: true // é–‹å•Ÿå™ªé»
            },
            'geometric': { 
                name: 'æ¥µç°¡å¹¾ä½•', 
                bg: '#EEF2FF', 
                image: 'linear-gradient(30deg, #E0E7FF 12%, transparent 12.5%, transparent 87%, #E0E7FF 87.5%, #E0E7FF), linear-gradient(150deg, #E0E7FF 12%, transparent 12.5%, transparent 87%, #E0E7FF 87.5%, #E0E7FF)', 
                bgSize: '80px 140px',
                text: '#1E1B4B', card: '#FFFFFF', primary: '#4F46E5', radius: '0px', 
                shadow: '0 20px 25px -5px rgba(0, 0, 0, 0.1)',
                font: "sans-serif",
                selectBg: '#EEF2FF', selectBorder: '#4F46E5', selectText: '#4338CA'
            },
            'watercolor': { name: 'æ‰‹ç¹ªæ°´å½©', bg: '#F0F8FF', image: 'radial-gradient(circle at 50% 50%, #E3F2FD, #F3E5F5)', text: '#5D6D7E', card: 'rgba(255,255,255,0.85)', primary: '#7FB3D5', radius: '30px', shadow: '0 8px 32px rgba(31, 38, 135, 0.1)', font: "serif" },
            'disney': { name: 'è¿ªå£«å°¼/çš®å…‹æ–¯', bg: '#CAF0F8', text: '#023E8A', card: '#FFFFFF', primary: '#0077B6', radius: '24px', shadow: '0 10px 20px rgba(0,119,182,0.2)', font: "sans-serif", btnShadow: '0 5px 0 #023E8A' },
            'flat': { name: 'æ‰å¹³åŒ– (Flat)', bg: '#ECF0F1', text: '#2C3E50', card: '#FFFFFF', primary: '#2980B9', radius: '4px', shadow: 'none', border: '1px solid #BDC3C7', font: "sans-serif" },
            'cute': { name: 'å¯æ„› Q ç‰ˆ', bg: '#FFF0F5', text: '#5D4037', card: '#FFFFFF', primary: '#FF80AB', radius: '30px', shadow: '0 8px 20px rgba(255, 128, 171, 0.2)', font: "'Zen Maru Gothic', sans-serif", border: '3px solid #FF80AB', btnShadow: '0 4px 0 #C51162' },
            'fresh': { name: 'å°ç´…æ›¸æ¸…æ–°', bg: '#FAFAFA', text: '#333333', card: '#FFFFFF', primary: '#FF5252', radius: '12px', shadow: '0 4px 12px rgba(0,0,0,0.05)', font: "sans-serif" },
            'map': { name: 'æ—…éŠåœ°åœ–', bg: '#EFEBE9', image: 'repeating-linear-gradient(90deg, #D7CCC8 0, #D7CCC8 1px, transparent 1px, transparent 40px), repeating-linear-gradient(0deg, #D7CCC8 0, #D7CCC8 1px, transparent 1px, transparent 40px)', text: '#4E342E', card: '#FFF8E1', primary: '#D84315', radius: '8px', shadow: '4px 4px 0 rgba(0,0,0,0.1)', font: "serif", border: '1px dashed #8D6E63' },
            'japanese': { name: 'æ—¥ç³»æ¥µç°¡', bg: '#FFFFFF', text: '#333', card: '#FFFFFF', primary: '#222', radius: '0', border: '1px solid #ddd', shadow: 'none', font: "'Noto Serif TC', serif", selectBg: '#F5F5F5', selectBorder: '#333', selectText: '#000' },
            'animal': { name: 'å‹•ç‰©æ£®å‹æœƒ', bg: '#B8E994', image: 'repeating-linear-gradient(45deg, #78E08F 0, #78E08F 20px, #B8E994 20px, #B8E994 40px)', text: '#3C6382', card: '#F8F3D4', primary: '#FA983A', radius: '20px', border: '4px solid #FFF', shadow: '0 10px 0 rgba(0,0,0,0.1)', font: "'Zen Maru Gothic', sans-serif" },
            'forest': { name: 'è‡ªç„¶æ£®æ—', bg: '#1B4332', text: '#D8F3DC', card: '#2D6A4F', primary: '#52B788', radius: '12px', border: 'none', shadow: '0 4px 20px rgba(0,0,0,0.3)', font: "sans-serif", selectBg: '#40916C', selectBorder: '#74C69D', selectText: '#fff', inputBg: '#1B4332', inputBorder: '1px solid #52B788' },
            'vogue': { name: 'é«˜ç´šé›œèªŒ', bg: '#F5F5F5', text: '#000', card: '#FFFFFF', primary: '#000', radius: '0', border: '1px solid #000', shadow: 'none', font: "'Noto Serif TC', serif", btnShadow: 'none' },
            'corporate': { name: 'ä¼æ¥­ç°¡å ±', bg: '#F3F4F6', text: '#1F2937', card: '#FFFFFF', primary: '#2563EB', radius: '6px', border: '1px solid #E5E7EB', shadow: '0 1px 3px rgba(0,0,0,0.1)', font: "sans-serif" },
            'edtech': { name: 'æ•™è‚²ç§‘æŠ€', bg: '#F0FDF4', text: '#064E3B', card: '#FFFFFF', primary: '#10B981', radius: '10px', border: '1px solid #D1FAE5', shadow: '0 4px 6px -1px rgba(16, 185, 129, 0.1)', font: "sans-serif" }
        };

        window.applyTheme = function(themeKey) {
            const theme = THEMES[themeKey] || THEMES['ghibli'];
            const r = document.documentElement;
            
            r.style.setProperty('--bg-color', theme.bg);
            r.style.setProperty('--bg-image', theme.image || 'none');
            r.style.setProperty('background-size', theme.bgSize || 'auto');
            r.style.setProperty('background-position', theme.bgPos || '0 0');
            
            r.style.setProperty('--text-color', theme.text);
            r.style.setProperty('--card-bg', theme.card);
            r.style.setProperty('--primary-color', theme.primary);
            r.style.setProperty('--card-radius', theme.radius);
            r.style.setProperty('--font-family', theme.font);
            
            // é€²éšè®Šæ•¸ (æœ‰é è¨­å€¼)
            r.style.setProperty('--card-border', theme.border || '1px solid rgba(0,0,0,0.05)');
            r.style.setProperty('--card-shadow', theme.shadow || '0 4px 6px -1px rgba(0,0,0,0.05)');
            r.style.setProperty('--btn-shadow', theme.btnShadow || '0 2px 4px rgba(0,0,0,0.1)');
            
            // é¸é …é¡è‰²
            r.style.setProperty('--select-bg', theme.selectBg || '#eff6ff');
            r.style.setProperty('--select-border', theme.selectBorder || theme.primary);
            r.style.setProperty('--select-text', theme.selectText || theme.primary);
            
            // è¼¸å…¥æ¡†é¡è‰²
            r.style.setProperty('--input-bg', theme.inputBg || '#ffffff');
            r.style.setProperty('--input-border', theme.inputBorder || '2px solid #eeeeee');

            // ç‰¹æ®Šæ•ˆæœé–‹é—œ
            const noise = document.querySelector('.noise-overlay');
            if(noise) noise.style.display = theme.noise ? 'block' : 'none';
            
            const clouds = document.querySelectorAll('.cloud');
            clouds.forEach(c => c.style.display = themeKey === 'ghibli' || themeKey === 'disney' ? 'block' : 'none');
        };

        window.showToast = function(msg, type = 'success') {
            const toast = document.getElementById('toast');
            const icon = document.getElementById('toast-icon');
            const msgSpan = document.getElementById('toast-msg');
            if(!toast) return;
            
            msgSpan.textContent = msg;
            const colorClass = type === 'error' ? 'text-red-500' : 'text-green-700';
            const bgClass = type === 'error' ? 'bg-red-50 border-red-200' : 'bg-green-50 border-green-200';
            
            icon.className = type === 'error' ? 'fa-solid fa-circle-exclamation ' + colorClass : 'fa-solid fa-leaf ' + colorClass;
            toast.className = `fixed top-20 right-5 z-[100] px-6 py-3 rounded-2xl shadow-lg flex items-center gap-3 transition-transform duration-300 border-2 ${bgClass}`;
            
            toast.style.transform = 'translateX(0)';
            setTimeout(() => { toast.style.transform = 'translateX(150%)'; }, 3000);
        };

        window.safeGet = function(id) {
            const el = document.getElementById(id);
            return el || { classList: { remove:()=>{}, add:()=>{}, toggle:()=>{}, contains:()=>false }, style: {}, value: '', disabled: false, innerHTML: '', addEventListener: ()=>{} }; 
        };

        window.escapeHtml = function(text) {
            if (text === null || text === undefined) return '';
            return String(text).replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
        };

        window.onerror = function(msg, url, line) {
            console.error("Global Error:", msg);
            const errorDiv = document.getElementById('global-error');
            if(errorDiv) {
                errorDiv.classList.remove('hidden');
                document.getElementById('global-error-msg').innerText = `${msg} (Line: ${line})`;
            }
            const loading = document.getElementById('loading-view');
            if(loading) loading.classList.add('hidden');
        };

        window.scrollToNext = function(currentElement) {
            const currentCard = currentElement.closest('.public-q-item');
            if (!currentCard) return;
            const nextElement = currentCard.nextElementSibling;
            if (nextElement) {
                setTimeout(() => nextElement.scrollIntoView({ behavior: 'smooth', block: 'center' }), 300);
            } else {
                setTimeout(() => {
                    const submitBtn = document.getElementById('public-submit-btn');
                    if (submitBtn) submitBtn.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }, 300);
            }
        };
        
        window.closeWindow = function() { try { window.close(); } catch(e) {} }
    </script>
</head>
<body class="text-gray-800">

    <div class="noise-overlay"></div>
    <div class="cloud cloud-1"></div>
    <div class="cloud cloud-2"></div>

    <div id="global-error" class="hidden fixed inset-0 bg-red-50 z-[200] flex flex-col items-center justify-center p-6 text-center">
        <h2 class="text-xl font-bold text-red-600 mb-2">ç³»çµ±ç™¼ç”ŸéŒ¯èª¤</h2>
        <p id="global-error-msg" class="text-sm text-gray-600 mb-4 break-all">Unknown</p>
        <button onclick="location.reload()" class="bg-red-600 text-white px-4 py-2 rounded">é‡æ–°æ•´ç†</button>
    </div>

    <div id="public-progress-bar" class="fixed top-0 left-0 w-full h-2 bg-gray-200 z-[60] hidden">
        <div id="progress-fill" class="h-full bg-[var(--primary-color)] transition-all duration-500 ease-out rounded-r-full" style="width: 0%"></div>
    </div>

    <nav id="admin-nav" class="bg-[var(--primary-color)] text-white shadow-lg sticky top-0 z-50 hidden transition-colors duration-500">
        <div class="max-w-6xl mx-auto px-4 py-3 flex justify-between items-center">
            <div class="flex items-center gap-3">
                <i class="fa-solid fa-leaf text-xl"></i>
                <h1 class="text-lg font-bold tracking-wide">å•å·å¤§å¸« <span class="text-xs bg-white/20 px-2 py-0.5 rounded ml-1">Pro</span></h1>
            </div>
            <div class="flex items-center gap-3">
                <div id="user-info" class="text-xs bg-black/20 px-3 py-1.5 rounded-full opacity-90 hidden md:block">è¨ªå®¢</div>
                <button onclick="window.app.logout()" class="hover:bg-black/20 p-2 rounded-full transition"><i class="fa-solid fa-right-from-bracket"></i></button>
            </div>
        </div>
    </nav>

    <main class="flex-1 w-full max-w-5xl mx-auto p-4 pb-20 safe-pb relative z-10">
        <div id="loading-view" class="fixed inset-0 flex flex-col items-center justify-center bg-[var(--bg-color)] z-[150]">
            <i class="fa-solid fa-circle-notch fa-spin text-4xl text-[var(--primary-color)]"></i>
        </div>
        <div id="toast" class="fixed top-20 right-5 z-[100] bg-white px-6 py-3 rounded-lg shadow-lg flex items-center gap-3 transition-transform duration-300 translate-x-full border-l-4">
            <i id="toast-icon"></i><span id="toast-msg"></span>
        </div>

        <!-- 1. Login -->
        <div id="view-login" class="hidden flex flex-col items-center justify-center min-h-[60vh] fade-in">
            <div class="theme-card p-10 w-full max-w-sm text-center">
                <h2 class="text-2xl font-bold mb-6" style="color: var(--primary-color)">ç®¡ç†å“¡ç™»å…¥</h2>
                <div id="file-protocol-warning" class="hidden mb-4 p-3 bg-yellow-50 text-yellow-800 text-xs rounded-lg text-left">è­¦å‘Šï¼šè«‹ä½¿ç”¨ç¶²é ä¼ºæœå™¨é–‹å•Ÿã€‚</div>
                <div class="space-y-4 text-left">
                    <div><label class="text-xs font-bold opacity-70">é›»å­éƒµä»¶</label><input type="email" id="login-email" class="w-full theme-input p-3 text-sm" placeholder="email@example.com"></div>
                    <div><label class="text-xs font-bold opacity-70">å¯†ç¢¼</label><input type="password" id="login-password" class="w-full theme-input p-3 text-sm" placeholder="******"></div>
                </div>
                <div class="mt-8 space-y-3">
                    <button onclick="window.app.login()" class="theme-btn w-full py-3 font-bold">ç™»å…¥</button>
                    <button onclick="window.app.resetPassword()" class="text-xs opacity-60 hover:opacity-100 block w-full text-center">å¿˜è¨˜å¯†ç¢¼ï¼Ÿ</button>
                </div>
            </div>
        </div>

        <!-- 2. Dashboard -->
        <div id="view-dashboard" class="hidden fade-in">
            <div class="flex justify-between items-center mb-8">
                <h2 class="text-3xl font-bold tracking-tight">æˆ‘çš„å•å·</h2>
                <button onclick="window.app.createSurvey()" class="theme-btn px-6 py-3 flex items-center gap-2 font-bold">
                    <i class="fa-solid fa-plus"></i> æ–°å»ºå•å·
                </button>
            </div>
            <div id="survey-list-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
            <div id="empty-state" class="hidden flex flex-col items-center justify-center py-32 opacity-50 border-4 border-dashed border-gray-300 rounded-3xl">
                <i class="fa-solid fa-wind text-5xl mb-4"></i>
                <p>é€™è£¡ç©ºç©ºçš„...</p>
            </div>
        </div>

        <!-- 3. Editor -->
        <div id="view-editor" class="hidden fade-in">
            <div class="sticky top-0 z-30 bg-[var(--bg-color)]/90 backdrop-blur-sm py-3 flex justify-between items-center mb-4 -mx-4 px-4 border-b border-[var(--card-border)]">
                <button onclick="window.app.backToDashboard()" class="theme-card px-4 py-2 text-sm font-bold"><i class="fa-solid fa-arrow-left mr-1"></i> è¿”å›</button>
                <div class="flex gap-2">
                    <span id="unsaved-badge" class="hidden px-3 py-1 bg-orange-100 text-orange-600 text-xs rounded-full border border-orange-200 flex items-center font-bold">æœªå„²å­˜</span>
                    <button onclick="window.app.openBatchModal()" class="theme-card px-4 py-2 text-sm font-bold text-[var(--primary-color)]"><i class="fa-solid fa-bolt mr-1"></i> åŒ¯å…¥</button>
                </div>
            </div>
            
            <div class="theme-card p-6 md:p-8 mb-8 relative overflow-hidden">
                <div class="absolute top-0 left-0 w-2 h-full bg-[var(--primary-color)]"></div>
                <div class="mb-4">
                    <label class="text-xs font-bold opacity-60 uppercase">å•å·æ¨™é¡Œ</label>
                    <input type="text" id="edit-title" class="w-full text-2xl font-bold bg-transparent border-b-2 border-transparent hover:border-gray-200 focus:border-[var(--primary-color)] outline-none py-2 transition" placeholder="è«‹è¼¸å…¥æ¨™é¡Œ" oninput="window.app.markDirty()">
                </div>
                <div class="mb-4">
                    <label class="text-xs font-bold opacity-60 uppercase">å•å·èªªæ˜</label>
                    <textarea id="edit-desc" class="w-full mt-1 bg-transparent border-b-2 border-transparent hover:border-gray-200 focus:border-[var(--primary-color)] outline-none py-2 transition resize-none leading-relaxed" rows="1" placeholder="è«‹è¼¸å…¥èªªæ˜..." oninput="window.app.markDirty(); window.app.autoGrow(this)"></textarea>
                </div>
                <div>
                    <label class="text-xs font-bold opacity-60 uppercase"><i class="fa-solid fa-palette mr-1"></i> è¦–è¦ºé¢¨æ ¼</label>
                    <select id="edit-theme" class="w-full mt-1 p-2 rounded-lg border-2 border-gray-200 focus:border-[var(--primary-color)] outline-none bg-white/50" onchange="window.app.changeTheme(this.value); window.app.markDirty()">
                        <!-- JS Populated -->
                    </select>
                </div>
            </div>
            <div id="editor-questions" class="space-y-6 mb-32"></div>
            <div id="editor-toolbar" class="fixed bottom-6 left-1/2 transform -translate-x-1/2 bg-white border border-gray-200 px-6 py-3 rounded-full shadow-2xl flex items-center gap-4 z-40 safe-pb hover:-translate-y-1 transition duration-300">
                 <div class="flex gap-2 pr-4 border-r border-gray-200">
                    <button onclick="window.app.addQuestion('text')" class="flex flex-col items-center justify-center w-10 h-10 text-gray-500 hover:text-[var(--primary-color)] transition" title="æ–°å¢é¡Œç›®"><i class="fa-solid fa-plus text-xl"></i></button>
                    <button onclick="window.app.addQuestion('section')" class="flex flex-col items-center justify-center w-10 h-10 text-gray-500 hover:text-orange-500 transition" title="æ–°å¢æ®µè½"><i class="fa-solid fa-align-left text-xl"></i></button>
                 </div>
                 <button onclick="window.app.saveSurvey()" class="theme-btn px-6 py-2 font-bold shadow-md flex items-center gap-2"><i class="fa-solid fa-cloud-arrow-up"></i> å„²å­˜</button>
            </div>
        </div>

        <!-- 4. Public View -->
        <div id="view-public" class="hidden w-full max-w-2xl mx-auto fade-in pb-24 pt-4">
            <div class="theme-card overflow-hidden mb-8">
                <div class="bg-[var(--primary-color)] h-4 opacity-80"></div>
                <div class="p-8">
                    <h1 id="public-title" class="text-3xl font-bold mb-4 leading-tight text-center">è¼‰å…¥ä¸­...</h1>
                    <div id="public-desc" class="whitespace-pre-wrap text-base leading-relaxed text-justify opacity-80"></div>
                </div>
            </div>
            <form id="public-form" class="space-y-6"></form>
            <div class="mt-12 text-center">
                <button id="public-submit-btn" type="button" onclick="window.app.submitResponse()" class="w-full max-w-xs theme-btn py-4 text-xl font-bold shadow-xl hover:shadow-2xl transform hover:-translate-y-1 transition">é€å‡ºå•å· <i class="fa-solid fa-paper-plane ml-2"></i></button>
            </div>
        </div>

        <!-- 5. Thank You -->
        <div id="view-thankyou" class="hidden flex flex-col items-center justify-center min-h-[80vh] text-center fade-in px-4 relative">
            <div class="theme-card p-12 w-full max-w-md relative overflow-hidden">
                <div class="w-24 h-24 bg-green-100 text-green-600 rounded-full flex items-center justify-center mx-auto mb-6 border-4 border-white shadow-inner"><i class="fa-solid fa-check text-5xl"></i></div>
                <h2 class="text-3xl font-bold mb-3">æ„Ÿè¬æ‚¨çš„å¡«å¯«ï¼</h2>
                <p class="opacity-60 mb-8">æ‚¨çš„å›è¦†å·²æˆåŠŸé€å‡ºã€‚</p>
                <div class="border-t border-gray-100 pt-6">
                    <div class="bg-gray-50 p-4 rounded-xl">
                        <p class="font-bold mb-1 text-sm">æ‚¨ç¾åœ¨å¯ä»¥å®‰å…¨åœ°é›¢é–‹</p>
                        <p class="text-xs opacity-50">è«‹ç›´æ¥é—œé–‰ç€è¦½å™¨åˆ†é å³å¯ã€‚</p>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <div id="modal-overlay" class="hidden fixed inset-0 bg-black/50 z-[60] flex items-center justify-center p-4 fade-in backdrop-blur-sm">
        <div id="modal-content" class="bg-white rounded-3xl shadow-2xl w-full max-w-lg max-h-[90vh] flex flex-col overflow-hidden relative border-4 border-white"></div>
    </div>

    <div id="delete-modal" class="hidden fixed inset-0 bg-black/50 z-[70] flex items-center justify-center p-4 fade-in backdrop-blur-sm">
        <div class="bg-white rounded-3xl shadow-2xl p-8 max-w-sm w-full text-center border-4 border-white">
            <div class="w-16 h-16 bg-red-100 text-red-500 rounded-full flex items-center justify-center mx-auto mb-4"><i class="fa-solid fa-trash-can text-2xl"></i></div>
            <h3 class="text-lg font-bold">ç¢ºå®šåˆªé™¤ï¼Ÿ</h3>
            <p class="text-sm opacity-60 mt-2 mb-8">åˆªé™¤å¾Œç„¡æ³•å¾©åŸã€‚</p>
            <div class="flex gap-3">
                <button onclick="safeGet('delete-modal').classList.add('hidden')" class="flex-1 py-3 border-2 border-gray-200 rounded-2xl font-bold text-gray-600 hover:bg-gray-50 transition">å–æ¶ˆ</button>
                <button onclick="window.app.confirmDelete()" class="flex-1 py-3 bg-red-500 text-white rounded-2xl font-bold shadow-md hover:bg-red-600 transition">ç¢ºèªåˆªé™¤</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken, signOut, createUserWithEmailAndPassword, signInWithEmailAndPassword, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, getDoc, getDocs, deleteDoc, addDoc, serverTimestamp, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
          apiKey: "AIzaSyAexk_JbIOQWV1Jw7hqfiZDDZYY9YF-Sdk",
          authDomain: "survey-49e8d.firebaseapp.com",
          projectId: "survey-49e8d",
          storageBucket: "survey-49e8d.firebasestorage.app",
          messagingSenderId: "547257703502",
          appId: "1:547257703502:web:85e147bed62333b11c771f"
        };
        
        const APP_ID = 'survey-app';
        const ADMIN_EMAIL = 'alexanderme100@gmail.com'; 

        const state = { db: null, auth: null, user: null, currentSurveyId: null, surveysCache: {}, isDirty: false, mode: 'admin' };
        let surveyIdToDelete = null;

        const urlParams = new URLSearchParams(window.location.search);
        const sId = urlParams.get('s');
        const uId = urlParams.get('u');
        if (sId && uId) state.mode = 'public';

        try {
            const app = initializeApp(firebaseConfig);
            state.auth = getAuth(app);
            state.db = getFirestore(app);
            if (state.mode === 'public') signInAnonymously(state.auth).catch(console.error);
        } catch (e) { console.error(e); alert("Firebase Init Error"); }

        const getEmoji = (idx, total) => {
            const emojis = ['ğŸ˜¡', 'ğŸ™', 'ğŸ˜', 'ğŸ˜Š', 'ğŸ¤©'];
            if (total <= 5) return idx < 5 ? emojis[idx] : '';
            if (total <= 7) return idx < 7 ? ['ğŸ˜¡', 'ğŸ˜ ', 'ğŸ™', 'ğŸ˜', 'ğŸ™‚', 'ğŸ˜Š', 'ğŸ¤©'][idx] : '';
            return '';
        };
        const getColor = (idx, total) => {
             if(total <= 7) {
                 const n = idx + 1;
                 if(n <= 2) return 'likert-opt-1'; 
                 if(n <= 3 && total > 3) return 'likert-opt-2'; 
                 if(n == Math.ceil(total/2)) return 'likert-opt-3'; 
                 if(n >= total-1) return 'likert-opt-5'; 
                 return 'likert-opt-4';
             }
             return 'opt-default';
        };

        window.app.login = async () => { 
            const email = safeGet('login-email').value.trim();
            const pass = safeGet('login-password').value;
            if (email !== ADMIN_EMAIL) return showToast('éç®¡ç†å“¡å¸³è™Ÿ', 'error');
            try { await signInWithEmailAndPassword(state.auth, email, pass); } catch(e) { showToast('ç™»å…¥å¤±æ•—', 'error'); } 
        };
        
        window.app.resetPassword = async () => {
            const email = safeGet('login-email').value.trim();
            if (!email) return showToast('è«‹è¼¸å…¥Email', 'error');
            try { await sendPasswordResetEmail(state.auth, email); showToast('é‡è¨­ä¿¡å·²å¯„å‡º'); } catch(e) { showToast('ç™¼é€å¤±æ•—', 'error'); }
        };

        window.app.logout = async () => { await signOut(state.auth); location.reload(); };
        window.app.backToDashboard = () => { if(state.isDirty && !confirm("æœªå„²å­˜è®Šæ›´å°‡éºå¤±")) return; switchView('view-dashboard'); renderList(); };

        window.app.createSurvey = () => {
            state.currentSurveyId = crypto.randomUUID();
            safeGet('edit-title').value = ''; safeGet('edit-desc').value = ''; safeGet('editor-questions').innerHTML = '';
            window.app.addQuestion(); 
            window.app.changeTheme('ghibli'); 
            state.isDirty = false; updateDirtyUI();
            switchView('view-editor');
        };

        window.app.editSurvey = async (surveyId) => {
            let survey = state.surveysCache[surveyId];
            if (!survey) {
                try {
                    showToast("è®€å–ä¸­...", "info");
                    const snap = await getDoc(doc(state.db, 'artifacts', APP_ID, 'users', state.user.uid, 'surveys', surveyId));
                    if(snap.exists()) {
                        survey = { id: snap.id, ...snap.data() };
                        state.surveysCache[surveyId] = survey;
                    } else { return showToast("å•å·ä¸å­˜åœ¨", "error"); }
                } catch (e) { return showToast("è®€å–å¤±æ•—", "error"); }
            }
            state.currentSurveyId = surveyId;
            safeGet('edit-title').value = survey.title || '';
            safeGet('edit-desc').value = survey.description || '';
            window.app.autoGrow(safeGet('edit-desc'));
            
            const themeSelect = safeGet('edit-theme');
            themeSelect.value = survey.theme || 'ghibli';
            window.app.changeTheme(survey.theme || 'ghibli');

            // Removed lock logic
            const container = safeGet('editor-questions');
            container.innerHTML = '';
            (survey.questions || []).forEach(q => window.app.addQuestion(q.type, q));
            switchView('view-editor');
        };
        
        window.app.changeTheme = (key) => window.applyTheme(key);

        window.app.addQuestion = (type = 'text', data = null) => {
            const container = safeGet('editor-questions');
            const id = `q-${Date.now()}-${Math.random().toString(36).substr(2,4)}`;
            const div = document.createElement('div');
            const qText = data ? data.text : '';
            const qDesc = data ? data.description : '';
            const qOpts = data ? (data.options || []).join('\n') : '';
            const qType = data ? data.type : type;
            const qReq = (data && data.required !== undefined) ? data.required : true;

            div.className = `question-item theme-card p-6 mb-6 relative group ${qType === 'section' ? 'border-l-8 border-orange-300' : ''}`;
            div.dataset.qtype = qType;
            div.draggable = true; div.id = id; 
            div.addEventListener('dragstart', () => { div.classList.add('dragging'); });
            div.addEventListener('dragend', () => { div.classList.remove('dragging'); window.app.markDirty(); });

            if (qType === 'section') {
                div.innerHTML = `<div class="flex justify-between mb-4 cursor-grab active:cursor-grabbing drag-handle border-b pb-2"><span class="text-xs font-bold opacity-60 flex items-center gap-1"><i class="fa-solid fa-grip-vertical"></i> æ®µè½èªªæ˜</span><button onclick="this.closest('.question-item').remove(); window.app.markDirty()" class="text-gray-300 hover:text-red-500 transition"><i class="fa-solid fa-trash"></i></button></div><input type="text" class="q-input w-full bg-transparent border-b-2 border-transparent focus:border-[var(--primary-color)] p-2 mb-3 font-bold text-lg transition outline-none" placeholder="æ®µè½æ¨™é¡Œ" value="${escapeHtml(qText)}" oninput="window.app.markDirty()"><textarea class="q-desc w-full theme-input border-0 rounded-lg p-3 text-sm opacity-80 resize-none" rows="2" placeholder="èªªæ˜..." oninput="window.app.markDirty()">${escapeHtml(qDesc)}</textarea>`;
            } else {
                div.innerHTML = `<div class="flex justify-between mb-4 cursor-grab active:cursor-grabbing drag-handle"><span class="text-xs font-bold px-3 py-1 rounded-full bg-gray-100 flex items-center gap-1"><i class="fa-solid fa-grip-vertical"></i> å•é¡Œ</span><div class="flex items-center gap-3"><label class="text-xs cursor-pointer flex items-center opacity-70 hover:opacity-100"><input type="checkbox" class="q-req mr-1" ${qReq ? 'checked' : ''} onchange="window.app.markDirty()">å¿…å¡«</label><button onclick="this.closest('.question-item').remove(); window.app.markDirty()" class="text-gray-300 hover:text-red-500 transition"><i class="fa-solid fa-trash"></i></button></div></div><input type="text" class="q-input w-full theme-input p-3 mb-3" placeholder="é¡Œç›®å…§å®¹" value="${escapeHtml(qText)}" oninput="window.app.markDirty()"><div class="flex gap-3 mb-3"><select class="q-type w-1/3 theme-input p-2 text-sm" onchange="window.app.toggleOpts(this)"><option value="text" ${qType==='text'?'selected':''}>ç°¡ç­”é¡Œ</option><option value="radio" ${qType==='radio'?'selected':''}>å–®é¸é¡Œ</option><option value="checkbox" ${qType==='checkbox'?'selected':''}>å¤šé¸é¡Œ</option></select></div><textarea class="q-opts w-full theme-input p-3 h-24 font-mono text-sm ${qType==='text'?'hidden':''}" placeholder="é¸é …1&#10;é¸é …2&#10;é¸é …3" oninput="window.app.markDirty()">${escapeHtml(qOpts)}</textarea>`;
            }
            container.appendChild(div);
            window.app.markDirty();
        };

        window.app.toggleOpts = (el) => { const item = el.closest('.question-item'); item.dataset.qtype = el.value; const area = item.querySelector('.q-opts'); if(area) { if (el.value === 'text') area.classList.add('hidden'); else area.classList.remove('hidden'); } window.app.markDirty(); };

        window.app.saveSurvey = async () => {
            if (!state.user) return;
            const btn = document.querySelector('#editor-toolbar button:last-child');
            btn.disabled = true; btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> å„²å­˜ä¸­';
            try {
                const title = safeGet('edit-title').value.trim();
                const desc = safeGet('edit-desc').value.trim();
                const theme = safeGet('edit-theme').value;
                if (!title) throw new Error("è«‹è¼¸å…¥æ¨™é¡Œ");
                
                const questions = [];
                document.querySelectorAll('.question-item').forEach(item => {
                    const type = item.dataset.qtype || 'text';
                    const text = item.querySelector('.q-input').value.trim();
                    if (!text) return;
                    if (type === 'section') { questions.push({ type, text, description: item.querySelector('.q-desc').value.trim() }); } 
                    else {
                        const req = item.querySelector('.q-req').checked;
                        let opts = [];
                        const optsArea = item.querySelector('.q-opts');
                        if (type !== 'text' && optsArea) opts = optsArea.value.split('\n').map(x=>x.trim()).filter(x=>x);
                        questions.push({ type: type, text, required: req, options: opts });
                    }
                });
                const data = { title, description: desc, theme, questions, updatedAt: serverTimestamp(), status: state.surveysCache[state.currentSurveyId]?.status || 'draft' };
                await setDoc(doc(state.db, 'artifacts', APP_ID, 'users', state.user.uid, 'surveys', state.currentSurveyId), data, {merge: true});
                state.isDirty = false; updateDirtyUI(); showToast('å„²å­˜æˆåŠŸ');
                state.surveysCache[state.currentSurveyId] = { ...data, id: state.currentSurveyId };
            } catch (e) { console.error(e); showToast(e.message, 'error'); } finally { btn.disabled = false; btn.innerHTML = '<i class="fa-solid fa-cloud-arrow-up"></i> å„²å­˜'; }
        };

        window.app.openBatchModal = () => { safeGet('modal-overlay').classList.remove('hidden'); safeGet('modal-content').innerHTML = `<div class="p-8"><h3 class="text-xl font-bold mb-4 text-[#5B6C78]">æ‰¹é‡åŒ¯å…¥é¡Œç›®</h3><p class="text-sm text-gray-500 mb-2">è«‹å°‡é¡Œç›®è²¼åœ¨ä¸‹æ–¹ï¼Œä¸€è¡Œä¸€é¡Œã€‚</p><textarea id="batch-text" class="w-full border-2 border-[#eee] rounded-xl p-4 h-60 text-sm focus:border-[#568A66] outline-none resize-none" placeholder="é¡Œç›®1\né¡Œç›®2..."></textarea><div class="mt-6 flex justify-end gap-3"><button onclick="safeGet('modal-overlay').classList.add('hidden')" class="px-6 py-2 rounded-xl font-bold text-gray-500 hover:bg-gray-100 transition">å–æ¶ˆ</button><button onclick="window.app.doImport()" class="btn-ghibli-primary px-6 py-2 font-bold">é–‹å§‹åŒ¯å…¥</button></div></div>`; };
        window.app.doImport = () => { const lines = safeGet('batch-text').value.split('\n').filter(l=>l.trim()); lines.forEach(l => window.app.addQuestion('radio', {text: l, type: 'radio', required: true, options: ['éå¸¸æ»¿æ„','æ»¿æ„','æ™®é€š','ä¸æ»¿æ„','éå¸¸ä¸æ»¿æ„']})); safeGet('modal-overlay').classList.add('hidden'); window.app.markDirty(); };
        window.app.openShare = (id) => { const link = `${window.location.origin}${window.location.pathname}?s=${id}&u=${state.user.uid}`; safeGet('modal-overlay').classList.remove('hidden'); safeGet('modal-content').innerHTML = `<div class="p-8 text-center"><h3 class="text-xl font-bold mb-6 text-[#5B6C78]">ç™¼å¸ƒå•å·</h3><div class="bg-[#F0F9F4] p-4 rounded-2xl mb-6 border border-[#C3DEC9]"><p class="text-xs text-[#3E664B] mb-2 font-bold uppercase tracking-widest">å•å·é€£çµ</p><input class="w-full bg-white border border-[#C3DEC9] p-3 rounded-xl text-sm text-[#3E664B] mb-3 font-mono" value="${link}" readonly><button onclick="navigator.clipboard.writeText('${link}');showToast('å·²è¤‡è£½')" class="btn-ghibli-primary w-full py-2 font-bold text-sm">è¤‡è£½é€£çµ</button></div><div class="text-center"><p class="text-xs text-gray-400 mb-2">æ‰‹æ©Ÿæƒæ QR Code</p><img src="https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=${encodeURIComponent(link)}" class="mx-auto rounded-xl border-4 border-white shadow-lg"></div><button onclick="safeGet('modal-overlay').classList.add('hidden')" class="mt-8 text-gray-400 hover:text-gray-600 underline text-sm">é—œé–‰è¦–çª—</button></div>`; const s = state.surveysCache[id]; if(s && s.status!=='published') updateDoc(doc(state.db, 'artifacts', APP_ID, 'users', state.user.uid, 'surveys', id), {status:'published'}); };
        window.app.viewStats = async (id) => { 
            safeGet('modal-overlay').classList.remove('hidden'); 
            safeGet('modal-content').innerHTML = '<div class="p-10 text-center"><i class="fa-solid fa-circle-notch fa-spin text-3xl text-[#568A66]"></i></div>';
            const snap = await getDocs(collection(state.db, 'artifacts', APP_ID, 'users', state.user.uid, 'surveys', id, 'responses'));
            safeGet('modal-content').innerHTML = `<div class="p-8"><div class="flex justify-between items-center mb-6"><h3 class="text-xl font-bold text-[#5B6C78]">çµ±è¨ˆæ¦‚è¦½</h3><span class="bg-[#F0F9F4] text-[#3E664B] px-3 py-1 rounded-full text-sm font-bold">å…± ${snap.size} ä»½å›è¦†</span></div><div class="bg-yellow-50 border-l-4 border-yellow-400 p-4 mb-6 rounded-r"><p class="text-sm text-yellow-800">è©³ç´°æ•¸æ“šè«‹åŒ¯å‡º Excel é€²è¡Œåˆ†æã€‚</p></div><div class="flex justify-end gap-3"><button onclick="safeGet('modal-overlay').classList.add('hidden')" class="px-4 py-2 text-gray-500 hover:bg-gray-100 rounded-xl font-bold">é—œé–‰</button><button class="btn-ghibli-primary px-6 py-2 font-bold" id="export-btn" onclick="window.app.exportToCSV('${id}')"><i class="fa-solid fa-file-csv mr-2"></i>åŒ¯å‡º Excel</button></div></div>`;
        };
        window.app.exportToCSV = async (id) => { const btn = document.getElementById('export-btn'); btn.innerText = "è™•ç†ä¸­..."; btn.disabled = true; try { const survey = state.surveysCache[id]; const snap = await getDocs(collection(state.db, 'artifacts', APP_ID, 'users', state.user.uid, 'surveys', id, 'responses')); let csv = "\uFEFFæ™‚é–“,"; survey.questions.forEach((q, i) => csv += `"${q.text.replace(/"/g,'""')}",`); csv += "\n"; snap.forEach(doc => { const d = doc.data(); csv += `"${new Date(d.submittedAt.seconds*1000).toLocaleString()}",`; survey.questions.forEach((q, i) => { if(q.type==='section') csv += ","; else { let a = d.answers[`q_${i}`]; if(Array.isArray(a)) a = a.join(';'); csv += `"${(a||'').toString().replace(/"/g,'""')}",`; } }); csv += "\n"; }); const url = URL.createObjectURL(new Blob([csv], {type: 'text/csv'})); const a = document.createElement('a'); a.href = url; a.download = `${survey.title}.csv`; a.click(); } catch(e) { alert("åŒ¯å‡ºå¤±æ•—"); } finally { btn.innerText = "åŒ¯å‡º Excel"; btn.disabled = false; } };
        window.app.requestDelete = (id) => { surveyIdToDelete = id; safeGet('delete-modal').classList.remove('hidden'); };
        window.app.confirmDelete = async () => { if(!surveyIdToDelete) return; safeGet('delete-modal').classList.add('hidden'); try { await deleteDoc(doc(state.db, 'artifacts', APP_ID, 'users', state.user.uid, 'surveys', surveyIdToDelete)); showToast("åˆªé™¤æˆåŠŸ"); loadSurveys(); } catch(e) { showToast("åˆªé™¤å¤±æ•—", "error"); } };
        window.app.duplicateCurrent = async () => { if(!confirm("è¤‡è£½å•å·ï¼Ÿ")) return; const s = state.surveysCache[state.currentSurveyId]; const newId = crypto.randomUUID(); await setDoc(doc(state.db, 'artifacts', APP_ID, 'users', state.user.uid, 'surveys', newId), { ...s, title: s.title+"(å‰¯æœ¬)", status: 'draft', updatedAt: serverTimestamp() }); showToast("è¤‡è£½æˆåŠŸ"); loadSurveys(); switchView('view-dashboard'); };
        window.app.markDirty = () => { state.isDirty = true; updateDirtyUI(); };
        window.app.autoGrow = (el) => { el.style.height = 'auto'; el.style.height = el.scrollHeight + 'px'; };
        window.app.updateProgressBar = () => { const form = safeGet('public-form'); const total = form.querySelectorAll('.public-q-item:not([data-type="section"])').length; if(total === 0) return; const answered = new Set(); new FormData(form).forEach((v, k) => { if(v) answered.add(k); }); safeGet('progress-fill').style.width = Math.round((answered.size / total) * 100) + '%'; };

        window.app.submitResponse = async () => {
             const form = safeGet('public-form');
             let firstInvalid = null;
             form.querySelectorAll('.public-q-item:not([data-type="section"])').forEach(item => {
                 item.classList.remove('error-shake', 'ring-2', 'ring-red-500');
                 if (item.dataset.req === 'true') {
                     const name = item.dataset.name;
                     const type = item.dataset.type;
                     let valid = false;
                     if (type === 'text') { if(form.querySelector(`[name="${name}"]`).value.trim()) valid = true; }
                     else { if(form.querySelector(`[name="${name}"]:checked`)) valid = true; }
                     
                     if (!valid) { item.classList.add('error-shake', 'ring-2', 'ring-red-500', 'rounded-xl'); if(!firstInvalid) firstInvalid = item; }
                 }
             });
             if (firstInvalid) { showToast("é‚„æœ‰å¿…å¡«æœªå®Œæˆ", 'error'); firstInvalid.scrollIntoView({behavior:'smooth', block:'center'}); return; }
             const btn = safeGet('public-submit-btn'); btn.disabled = true; btn.innerText = "æäº¤ä¸­...";
             try {
                 const formData = new FormData(form);
                 const answers = {};
                 form.querySelectorAll('.public-q-item').forEach(div => {
                     const type = div.dataset.type;
                     if (type === 'section') return; 
                     const name = div.dataset.name;
                     if (type === 'checkbox') answers[name] = formData.getAll(name);
                     else answers[name] = formData.get(name);
                 });
                 await addDoc(collection(state.db, 'artifacts', APP_ID, 'users', uId, 'surveys', sId, 'responses'), { answers, submittedAt: serverTimestamp() });
                 switchView('view-thankyou');
             } catch(e) { showToast("æäº¤å¤±æ•—", 'error'); btn.disabled = false; btn.innerText = "é€å‡ºå•å·"; }
        };

        function switchView(id) { ['view-login','view-dashboard','view-editor','view-public','view-thankyou'].forEach(v => safeGet(v).classList.add('hidden')); safeGet(id).classList.remove('hidden'); window.scrollTo(0,0); }
        function updateLock(isLocked) { /* No-op */ }
        function updateDirtyUI() { safeGet('unsaved-badge').classList.toggle('hidden', !state.isDirty); }
        function renderList() {
            const container = safeGet('survey-list-container'); container.innerHTML = '';
            const surveys = Object.values(state.surveysCache).sort((a, b) => (b.updatedAt?.seconds || 0) - (a.updatedAt?.seconds || 0));
            if (surveys.length === 0) return safeGet('empty-state').classList.remove('hidden');
            safeGet('empty-state').classList.add('hidden');
            surveys.forEach(s => {
                container.innerHTML += `<div class="theme-card p-6 cursor-pointer hover:-translate-y-1" onclick="window.app.editSurvey('${s.id}')"><div class="flex justify-between mb-2"><h3 class="font-bold text-xl truncate">${escapeHtml(s.title) || 'æœªå‘½å'}</h3>${s.status==='published'?'<span class="text-xs bg-[#F0F9F4] text-[#3E664B] px-2 py-1 rounded-full border border-[#C3DEC9]">å·²ç™¼å¸ƒ</span>':'<span class="text-xs bg-gray-100 text-gray-500 px-2 py-1 rounded-full">è‰ç¨¿</span>'}</div><p class="text-sm opacity-60 mb-6 line-clamp-2 h-10">${escapeHtml(s.description)}</p><div class="flex justify-end gap-2 pt-4 border-t border-gray-100" onclick="event.stopPropagation()"><button onclick="window.app.viewStats('${s.id}')" class="text-gray-500 text-xs bg-gray-50 hover:bg-gray-100 px-3 py-1.5 rounded-lg font-bold">çµ±è¨ˆ</button><button onclick="window.app.openShare('${s.id}')" class="text-[#568A66] text-xs bg-[#F0F9F4] hover:bg-[#C3DEC9] px-3 py-1.5 rounded-lg font-bold">åˆ†äº«</button><button onclick="window.app.requestDelete('${s.id}')" class="text-red-400 text-xs bg-red-50 hover:bg-red-100 px-3 py-1.5 rounded-lg font-bold">åˆªé™¤</button></div></div>`;
            });
        }

        async function loadSurveys() { try { const snap = await getDocs(collection(state.db, 'artifacts', APP_ID, 'users', state.user.uid, 'surveys')); state.surveysCache = {}; snap.forEach(doc => { state.surveysCache[doc.id] = { id: doc.id, ...doc.data() }; }); renderList(); } catch(e) { showToast('è®€å–å¤±æ•—', 'error'); } }

        async function loadPublic() {
            try {
                const snap = await getDoc(doc(state.db, 'artifacts', APP_ID, 'users', uId, 'surveys', sId));
                if(!snap.exists()) throw new Error("å•å·ä¸å­˜åœ¨");
                const data = snap.data();
                window.applyTheme(data.theme || 'ghibli'); // Apply Theme
                safeGet('public-title').textContent = data.title;
                safeGet('public-desc').textContent = data.description;
                const form = safeGet('public-form');
                form.innerHTML = (data.questions || []).map((q, idx) => {
                    if (q.type === 'section') return `<div class="public-q-item mt-10 mb-6 relative pl-4" data-type="section"><div class="absolute left-0 top-1 bottom-1 w-1.5 bg-[var(--secondary-color)] rounded-full"></div><h3 class="text-2xl font-bold text-[var(--text-color)] mb-2">${escapeHtml(q.text)}</h3><p class="opacity-80 whitespace-pre-wrap text-base">${escapeHtml(q.description)}</p></div>`;
                    const name = `q_${idx}`; const reqAttr = q.required ? 'data-req="true"' : ''; const reqMark = q.required ? '<span class="text-red-400 ml-1">*</span>' : ''; const qId = `pq-${idx}`;
                    let inputHtml = '';
                    if (q.type === 'text') { inputHtml = `<input type="text" name="${name}" class="w-full theme-input p-4 text-lg" placeholder="è«‹è¼¸å…¥..." oninput="window.app.updateProgressBar()">`; } 
                    else if (q.type === 'radio') {
                        const count = q.options.length; let grid = 'w-[48%]'; if(count >= 7) grid = 'w-[23%]'; else if(count===5) grid = 'w-[31%]'; else if(count===3) grid = 'w-[31%]';
                        inputHtml = `<div class="flex flex-wrap justify-center gap-2">` + q.options.map((opt, i) => { const emoji = getEmoji(i, count); const col = getColor(i, count); return `<label class="${grid} flex-grow-0 flex-shrink-0 cursor-pointer group"><input type="radio" name="${name}" value="${escapeHtml(opt)}" class="peer sr-only" onchange="window.app.updateProgressBar(); window.scrollToNext(this)"><div class="h-full p-3 theme-card text-center text-sm font-bold flex flex-col items-center justify-center min-h-[70px] group-hover:border-[var(--primary-color)] opacity-90 ${col}"><div class="text-2xl mb-1">${emoji}</div><div class="leading-tight">${escapeHtml(opt)}</div></div></label>`; }).join('') + `</div>`;
                    } else { inputHtml = `<div class="space-y-3">` + q.options.map(opt => `<label class="flex items-center gap-3 p-4 theme-card cursor-pointer"><input type="checkbox" name="${name}" value="${escapeHtml(opt)}" class="w-5 h-5 accent-[var(--primary-color)]" onchange="window.app.updateProgressBar()"><span class="font-medium">${escapeHtml(opt)}</span></label>`).join('') + `</div>`; }
                    return `<div id="${qId}" class="public-q-item theme-card p-6 mb-6 relative" ${reqAttr} data-type="${q.type}" data-name="${name}"><h4 class="font-bold text-xl mb-4 leading-snug">${escapeHtml(q.text)} ${reqMark}</h4>${inputHtml}</div>`;
                }).join('');
                switchView('view-public');
            } catch(e) { safeGet('loading-view').innerHTML = `<div class="text-red-500 p-10 text-center">${e.message}</div>`; }
        }

        // Init
        const select = safeGet('edit-theme');
        Object.keys(THEMES).forEach(k => { const opt = document.createElement('option'); opt.value = k; opt.innerText = THEMES[k].name; select.appendChild(opt); });

        onAuthStateChanged(state.auth, (user) => {
            safeGet('loading-view').classList.add('hidden');
            state.user = user;
            if (state.mode === 'public') { if (!user) signInAnonymously(state.auth).catch(console.error); else loadPublic(); } 
            else {
                if (user) {
                    safeGet('admin-nav').classList.remove('hidden');
                    if (user.isAnonymous) { signOut(state.auth); return; }
                    safeGet('user-info').textContent = user.email;
                    switchView('view-dashboard'); loadSurveys();
                } else switchView('view-login');
            }
        });
    </script>
</body>
</html>
