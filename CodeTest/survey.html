<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Firebase 問卷系統</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">

    <style>
        /* 基礎設定 */
        html, body { overflow-x: hidden; min-height: 100vh; background-color: #f3f4f6; font-family: 'Noto Sans TC', sans-serif; -webkit-tap-highlight-color: transparent; }
        body { display: flex; flex-direction: column; }
        .fade-in { animation: fadeIn 0.4s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        
        /* 選項卡片被選中時的動畫 */
        input:checked + div { 
            transform: scale(0.98); 
            box-shadow: inset 0 0 0 2px currentColor; 
            font-weight: bold;
        }

        .tap-target { min-height: 48px; }
        .progress-transition { transition: width 0.3s ease-out; }
        .safe-pb { padding-bottom: env(safe-area-inset-bottom, 20px); }
        .question-card.dragging { opacity: 0.5; border: 2px dashed #3b82f6; background-color: #eff6ff; }
        .drag-handle { cursor: grab; touch-action: none; }
        .drag-handle:active { cursor: grabbing; }
        .locked-input { background-color: #f9fafb; border-color: #e5e7eb; color: #6b7280; cursor: not-allowed; }
        
        /* 量表顏色 */
        .likert-opt-1 { color: #ef4444; border-color: #fca5a5; background-color: #fef2f2; } 
        .likert-opt-2 { color: #f97316; border-color: #fdba74; background-color: #fff7ed; } 
        .likert-opt-3 { color: #eab308; border-color: #fde047; background-color: #fefce8; } 
        .likert-opt-4 { color: #84cc16; border-color: #bef264; background-color: #f7fee7; } 
        .likert-opt-5 { color: #22c55e; border-color: #86efac; background-color: #f0fdf4; } 
        .opt-default { color: #374151; border-color: #e5e7eb; background-color: white; }
        input:checked + div.opt-default { border-color: #2563eb; background-color: #eff6ff; color: #1d4ed8; }
    </style>

    <!-- 預先定義全域工具函式，防止載入順序錯誤 -->
    <script>
        // 1. 初始化全域 app 物件
        window.app = window.app || {};

        // 2. Toast 提示
        window.showToast = function(msg, type = 'success') {
            const toast = document.getElementById('toast');
            const icon = document.getElementById('toast-icon');
            const msgSpan = document.getElementById('toast-msg');
            if(!toast) return;
            
            msgSpan.textContent = msg;
            if (type === 'error') {
                icon.className = 'fa-solid fa-circle-exclamation text-red-400';
                toast.className = `fixed top-20 right-5 z-[100] bg-gray-800 text-white px-6 py-3 rounded-lg shadow-lg flex items-center gap-3 transition-transform duration-300 border-l-4 border-red-500`;
            } else {
                icon.className = 'fa-solid fa-check-circle text-green-400';
                toast.className = `fixed top-20 right-5 z-[100] bg-gray-800 text-white px-6 py-3 rounded-lg shadow-lg flex items-center gap-3 transition-transform duration-300 border-l-4 border-green-500`;
            }
            
            toast.style.transform = 'translateX(0)';
            setTimeout(() => { toast.style.transform = 'translateX(120%)'; }, 3000);
        };

        // 3. 安全 DOM 獲取
        window.safeGet = function(id) {
            const el = document.getElementById(id);
            if (!el) {
                console.warn(`Element missing: #${id}`);
                return { classList: { remove:()=>{}, add:()=>{}, contains:()=>false }, style: {}, value: '', disabled: false, innerHTML: '', addEventListener: ()=>{} }; 
            }
            return el;
        };

        // 4. XSS 防護
        window.escapeHtml = function(text) {
            if (text === null || text === undefined) return '';
            return String(text).replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
        };

        // 5. 全域錯誤攔截
        window.onerror = function(msg, url, line, col, error) {
            const errorDiv = document.getElementById('global-error');
            const errorMsg = document.getElementById('global-error-msg');
            if(errorDiv && errorMsg) {
                errorDiv.classList.remove('hidden');
                errorMsg.innerText = `${msg} (Line: ${line})`;
            }
            console.error("Global Error:", msg, error);
            const loading = document.getElementById('loading-view');
            if(loading) loading.classList.add('hidden');
        };
    </script>
</head>
<body class="text-gray-800">

    <!-- 錯誤遮罩 -->
    <div id="global-error" class="hidden fixed inset-0 bg-red-50 z-[200] flex flex-col items-center justify-center p-6 text-center">
        <i class="fa-solid fa-bug text-5xl text-red-500 mb-4"></i>
        <h2 class="text-xl font-bold text-gray-800">系統發生錯誤</h2>
        <p id="global-error-msg" class="text-sm text-gray-600 mt-2 font-mono bg-white p-2 rounded border break-all">Unknown Error</p>
        <button onclick="location.reload()" class="mt-6 bg-red-600 text-white px-6 py-2 rounded-lg shadow hover:bg-red-700">重新整理</button>
    </div>

    <!-- 進度條 -->
    <div id="public-progress-bar" class="fixed top-0 left-0 w-full h-1.5 bg-gray-200 z-[60] hidden">
        <div id="progress-fill" class="h-full bg-green-500 progress-transition" style="width: 0%"></div>
    </div>

    <nav id="admin-nav" class="bg-blue-600 text-white shadow-lg sticky top-0 z-50 hidden">
        <div class="max-w-6xl mx-auto px-4 py-3 flex justify-between items-center">
            <div class="flex items-center gap-3">
                <i class="fa-solid fa-clipboard-list text-2xl"></i>
                <h1 class="text-lg font-bold tracking-wide">問卷大師 <span class="text-xs font-normal opacity-80 bg-blue-700 px-2 py-0.5 rounded ml-1">Pro</span></h1>
            </div>
            <div class="flex items-center gap-3">
                <div id="user-info" class="text-xs bg-blue-800 px-2 py-1 rounded opacity-80 hidden md:block">User</div>
                <button onclick="window.app.logout()" class="hover:bg-blue-700 p-2 rounded-lg transition" title="登出"><i class="fa-solid fa-right-from-bracket"></i></button>
            </div>
        </div>
    </nav>

    <main class="flex-1 w-full max-w-5xl mx-auto p-4 pb-20 safe-pb">
        <div id="loading-view" class="fixed inset-0 flex flex-col items-center justify-center bg-gray-100 z-[150]">
            <i class="fa-solid fa-circle-notch fa-spin text-4xl text-blue-500"></i>
            <p class="mt-4 text-gray-500 font-medium">系統載入中...</p>
            <div id="loading-timeout" class="hidden mt-4 text-center"><p class="text-xs text-red-400 mb-2">連線回應較慢</p><button onclick="location.reload()" class="text-xs border border-gray-300 px-3 py-1 rounded bg-white">重新載入</button></div>
        </div>
        <div id="toast" class="fixed top-20 right-5 z-[100] bg-gray-800 text-white px-6 py-3 rounded-lg shadow-lg flex items-center gap-3 transition-transform duration-300 translate-x-full"><i id="toast-icon"></i><span id="toast-msg"></span></div>

        <!-- Login -->
        <div id="view-login" class="hidden flex flex-col items-center justify-center min-h-[60vh] fade-in">
            <div class="bg-white p-8 rounded-2xl shadow-xl w-full max-w-sm border border-gray-100 text-center">
                <div class="w-16 h-16 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center mx-auto mb-6"><i class="fa-solid fa-user-shield text-3xl"></i></div>
                <h2 class="text-2xl font-bold text-gray-800 mb-2">管理員登入</h2>
                <div id="file-protocol-warning" class="hidden mb-4 p-3 bg-yellow-50 text-yellow-800 text-xs rounded-lg text-left"><i class="fa-solid fa-triangle-exclamation mr-1"></i> 警告：請勿直接開啟檔案，請使用網頁伺服器。</div>
                <div class="space-y-3 text-left">
                    <div><label class="text-xs font-bold text-gray-500 ml-1">電子郵件</label><input type="email" id="login-email" class="w-full bg-gray-50 border border-gray-300 rounded-lg p-3 focus:ring-2 focus:ring-blue-500 focus:outline-none transition" placeholder="name@example.com"></div>
                    <div><label class="text-xs font-bold text-gray-500 ml-1">密碼</label><input type="password" id="login-password" class="w-full bg-gray-50 border border-gray-300 rounded-lg p-3 focus:ring-2 focus:ring-blue-500 focus:outline-none transition" placeholder="••••••"></div>
                </div>
                <div class="grid grid-cols-2 gap-3 mt-6">
                    <button onclick="window.app.login()" class="bg-blue-600 text-white py-3 rounded-xl font-bold shadow hover:bg-blue-700 transition tap-target">登入</button>
                    <button onclick="window.app.register()" class="bg-white text-gray-700 border border-gray-300 py-3 rounded-xl font-bold hover:bg-gray-50 transition tap-target">註冊</button>
                </div>
            </div>
        </div>

        <!-- Dashboard -->
        <div id="view-dashboard" class="hidden fade-in">
            <div id="guest-warning" class="hidden bg-orange-50 border-l-4 border-orange-400 p-4 mb-6 rounded-r shadow-sm flex gap-3 items-start"><i class="fa-solid fa-triangle-exclamation text-orange-500 mt-1"></i><div class="text-sm text-orange-800"><strong>訪客模式：</strong> 資料僅暫存。建議<button onclick="window.app.logout()" class="underline font-bold">登出並註冊</button>以永久保存。</div></div>
            <div class="flex justify-between items-center mb-6"><h2 class="text-2xl font-bold text-gray-800">我的問卷</h2><button onclick="window.app.createSurvey()" class="bg-blue-600 text-white px-4 py-2 rounded-lg shadow hover:bg-blue-700 transition flex items-center gap-2 tap-target"><i class="fa-solid fa-plus"></i> <span class="hidden sm:inline">新建問卷</span></button></div>
            <div id="survey-list-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
            <div id="empty-state" class="hidden flex flex-col items-center justify-center py-20 text-gray-400 border-2 border-dashed border-gray-300 rounded-xl"><i class="fa-regular fa-folder-open text-4xl mb-2"></i><p>尚無問卷資料</p></div>
        </div>

        <!-- Editor -->
        <div id="view-editor" class="hidden fade-in">
            <div class="sticky top-[56px] z-30 bg-[#f3f4f6] py-2 flex justify-between items-center gap-2 mb-2">
                <button onclick="window.app.backToDashboard()" class="text-gray-600 bg-white border px-3 py-1.5 rounded-lg text-sm shadow-sm hover:bg-gray-50"><i class="fa-solid fa-arrow-left mr-1"></i> 返回</button>
                <div class="flex gap-2">
                    <span id="unsaved-badge" class="hidden px-2 py-1 bg-orange-100 text-orange-600 text-xs rounded border border-orange-200 flex items-center"><i class="fa-solid fa-circle text-[6px] mr-1"></i> 未儲存</span>
                    <button onclick="window.app.openPreview()" class="bg-white text-gray-700 border px-3 py-1.5 rounded-lg text-sm shadow-sm hover:bg-gray-50"><i class="fa-solid fa-eye mr-1"></i> 預覽</button>
                    <button id="btn-import" onclick="window.app.openImport()" class="bg-white text-blue-600 border border-blue-200 px-3 py-1.5 rounded-lg text-sm shadow-sm hover:bg-blue-50"><i class="fa-solid fa-bolt mr-1"></i> 匯入</button>
                </div>
            </div>
            <div id="locked-banner" class="hidden bg-yellow-50 border-l-4 border-yellow-400 p-3 mb-4 rounded shadow-sm text-sm text-yellow-800 flex justify-between items-center"><span><i class="fa-solid fa-lock mr-1"></i> 問卷已發布鎖定</span><button onclick="window.app.duplicateCurrent()" class="text-xs underline">複製以編輯</button></div>
            <div class="bg-white p-4 md:p-6 rounded-xl shadow-sm border border-gray-200 mb-6">
                <input type="text" id="edit-title" class="w-full text-xl font-bold border-b-2 border-transparent hover:border-gray-200 focus:border-blue-500 outline-none py-2 transition bg-transparent" placeholder="問卷標題" oninput="window.app.markDirty()">
                <textarea id="edit-desc" class="w-full text-gray-600 mt-2 border-b-2 border-transparent hover:border-gray-200 focus:border-blue-500 outline-none py-2 transition bg-transparent resize-none" rows="1" placeholder="問卷說明..." oninput="window.app.markDirty(); window.app.autoGrow(this)"></textarea>
            </div>
            <div id="editor-questions" class="space-y-4 mb-24"></div>
            <div id="editor-toolbar" class="fixed bottom-0 left-0 w-full bg-white border-t border-gray-200 p-3 flex justify-between items-center z-40 safe-pb shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.1)]">
                 <div class="flex gap-2">
                    <button onclick="window.app.addQuestion('text')" class="flex flex-col items-center justify-center w-12 h-12 bg-gray-50 hover:bg-blue-50 text-gray-600 hover:text-blue-600 rounded-lg transition"><i class="fa-solid fa-plus"></i><span class="text-[10px]">題目</span></button>
                    <button onclick="window.app.addQuestion('section')" class="flex flex-col items-center justify-center w-12 h-12 bg-gray-50 hover:bg-orange-50 text-gray-600 hover:text-orange-600 rounded-lg transition"><i class="fa-solid fa-align-left"></i><span class="text-[10px]">段落</span></button>
                 </div>
                 <button onclick="window.app.saveSurvey()" class="bg-blue-600 text-white px-8 py-3 rounded-xl font-bold shadow-lg shadow-blue-200 hover:bg-blue-700 transition flex items-center gap-2"><i class="fa-solid fa-save"></i> 儲存</button>
            </div>
        </div>

        <!-- Public View -->
        <div id="view-public" class="hidden w-full max-w-2xl mx-auto fade-in pb-24">
            <div class="bg-white rounded-xl shadow-lg overflow-hidden border border-gray-200">
                <div class="bg-blue-600 h-2"></div>
                <div class="p-6 md:p-8">
                    <h1 id="public-title" class="text-2xl md:text-3xl font-bold text-gray-900 mb-3">載入中...</h1>
                    <div id="public-desc" class="text-gray-600 whitespace-pre-wrap text-sm md:text-base leading-relaxed"></div>
                </div>
            </div>
            <form id="public-form" class="mt-6 space-y-4"></form>
            <div class="mt-8"><button id="public-submit-btn" type="button" onclick="window.app.submitResponse()" class="w-full bg-blue-600 text-white font-bold py-4 rounded-xl shadow-lg hover:bg-blue-700 transition active:scale-[0.98] text-lg">送出問卷</button></div>
        </div>

        <!-- Thank You -->
        <div id="view-thankyou" class="hidden flex flex-col items-center justify-center min-h-[60vh] text-center fade-in px-4">
            <div class="w-20 h-20 bg-green-100 text-green-500 rounded-full flex items-center justify-center mb-6"><i class="fa-solid fa-check text-4xl"></i></div>
            <h2 class="text-2xl font-bold text-gray-800 mb-2">感謝您的填寫！</h2>
            <button onclick="location.reload()" class="mt-8 text-blue-600 underline">重新整理</button>
        </div>
    </main>

    <!-- Modals (Preview, Batch, Results, Share) - Hidden by default -->
    <div id="modal-overlay" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4 fade-in">
        <div id="modal-content" class="bg-white rounded-xl shadow-2xl w-full max-w-lg max-h-[90vh] flex flex-col overflow-hidden relative">
            <!-- Content Injected by JS -->
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken, signOut, createUserWithEmailAndPassword, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, getDoc, getDocs, deleteDoc, addDoc, serverTimestamp, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
          apiKey: "AIzaSyAexk_JbIOQWV1Jw7hqfiZDDZYY9YF-Sdk",
          authDomain: "survey-49e8d.firebaseapp.com",
          projectId: "survey-49e8d",
          storageBucket: "survey-49e8d.firebasestorage.app",
          messagingSenderId: "547257703502",
          appId: "1:547257703502:web:85e147bed62333b11c771f"
        };

        // State
        const state = { db: null, auth: null, user: null, currentSurveyId: null, surveysCache: {}, isDirty: false, mode: 'admin' };
        const urlParams = new URLSearchParams(window.location.search);
        const sId = urlParams.get('s');
        const uId = urlParams.get('u');
        if (sId && uId) state.mode = 'public';

        if (window.location.protocol === 'file:') safeGet('file-protocol-warning').classList.remove('hidden');

        try {
            const app = initializeApp(firebaseConfig);
            state.auth = getAuth(app);
            state.db = getFirestore(app);
        } catch (e) { console.error(e); throw new Error("Firebase Init Failed"); }

        setTimeout(() => {
            const loading = document.getElementById('loading-view');
            if (loading && !loading.classList.contains('hidden')) document.getElementById('loading-timeout').classList.remove('hidden');
        }, 8000);

        // --- APP LOGIC (ATTACHED TO WINDOW.APP) ---
        window.app = {
            // Auth
            login: async () => { try { await signInWithEmailAndPassword(state.auth, safeGet('login-email').value, safeGet('login-password').value); } catch(e) { showToast(e.code, 'error'); } },
            register: async () => { try { await createUserWithEmailAndPassword(state.auth, safeGet('login-email').value, safeGet('login-password').value); } catch(e) { showToast(e.code, 'error'); } },
            logout: async () => { if(state.isDirty && !confirm("未儲存變更將遺失")) return; await signOut(state.auth); location.reload(); },

            // Nav
            backToDashboard: () => { if(state.isDirty && !confirm("未儲存變更將遺失")) return; switchView('view-dashboard'); renderSurveyList(); },
            
            // Editor
            createSurvey: () => {
                state.currentSurveyId = crypto.randomUUID();
                safeGet('edit-title').value = ''; safeGet('edit-desc').value = ''; safeGet('editor-questions').innerHTML = '';
                updateLockState(false);
                window.app.addQuestion(); // Default question
                state.isDirty = false; updateDirtyUI();
                switchView('view-editor');
            },
            
            // Load Editor
            loadEditor: (id) => {
                const data = state.surveysCache[id];
                if (!data) return;
                state.currentSurveyId = id;
                safeGet('edit-title').value = data.title || '';
                safeGet('edit-desc').value = data.description || '';
                window.app.autoGrow(safeGet('edit-desc'));
                updateLockState(data.status === 'published');
                const container = safeGet('editor-questions');
                container.innerHTML = '';
                (data.questions || []).forEach(q => window.app.addQuestion(q.type, q));
                switchView('view-editor');
            },

            addQuestion: (type = 'text', data = null) => {
                const container = safeGet('editor-questions');
                const qId = `q-${Date.now()}-${Math.random().toString(36).substr(2,4)}`;
                const div = document.createElement('div');
                const qText = data ? data.text : '';
                const qDesc = data ? data.description : '';
                const qOpts = data ? (data.options || []).join('\n') : '';
                const qType = data ? data.type : type;
                const qReq = data ? data.required : true;

                if (qType === 'section') {
                    div.innerHTML = `<div class="question-item bg-orange-50 p-4 rounded-xl border border-orange-200 relative group" id="${qId}" data-type="section"><div class="flex justify-between mb-2"><span class="text-xs font-bold text-orange-600 uppercase"><i class="fa-solid fa-align-left"></i> 段落說明</span><div class="controls flex gap-2"><button onclick="this.closest('.question-item').remove(); window.app.markDirty()" class="text-gray-400 hover:text-red-500"><i class="fa-solid fa-trash"></i></button></div></div><input type="text" class="q-input w-full bg-white border border-orange-300 rounded p-2 mb-2 font-bold text-sm" placeholder="段落標題" value="${escapeHtml(qText)}" oninput="window.app.markDirty()"><textarea class="q-desc w-full bg-white border border-orange-300 rounded p-2 text-sm" rows="2" placeholder="說明內容..." oninput="window.app.markDirty()">${escapeHtml(qDesc)}</textarea></div>`;
                } else {
                    div.innerHTML = `<div class="question-item bg-white p-4 rounded-xl border border-gray-200 relative group shadow-sm" id="${qId}" data-type="${qType}"><div class="flex justify-between mb-3"><span class="text-xs font-bold text-blue-600 bg-blue-50 px-2 py-1 rounded">問題</span><div class="controls flex items-center gap-3"><label class="flex items-center cursor-pointer text-xs text-gray-500"><input type="checkbox" class="q-req mr-1" ${qReq ? 'checked' : ''} onchange="window.app.markDirty()"> 必填</label><button onclick="this.closest('.question-item').remove(); window.app.markDirty()" class="text-gray-400 hover:text-red-500"><i class="fa-solid fa-trash"></i></button></div></div><div class="space-y-3"><input type="text" class="q-input w-full border-gray-300 rounded-lg p-2.5 border focus:border-blue-500 outline-none" placeholder="題目內容" value="${escapeHtml(qText)}" oninput="window.app.markDirty()"><select class="q-type-select w-full border-gray-300 rounded-lg p-2 text-sm bg-gray-50" onchange="window.app.toggleOpts(this)"><option value="text" ${qType==='text'?'selected':''}>簡答題</option><option value="radio" ${qType==='radio'?'selected':''}>單選題</option><option value="checkbox" ${qType==='checkbox'?'selected':''}>多選題</option></select><div class="opts-area ${qType==='text'?'hidden':''}"><textarea class="q-opts w-full border-gray-300 rounded-lg p-2 text-sm border h-24 font-mono" placeholder="選項1&#10;選項2&#10;選項3" oninput="window.app.markDirty()">${escapeHtml(qOpts)}</textarea></div></div></div>`;
                }
                container.appendChild(div);
                window.app.markDirty();
            },
            toggleOpts: (el) => {
                const area = el.closest('.question-item').querySelector('.opts-area');
                if(area) { if (el.value === 'text') area.classList.add('hidden'); else area.classList.remove('hidden'); }
                window.app.markDirty();
            },
            saveSurvey: async () => {
                if (!state.user) return;
                const btn = document.querySelector('#editor-toolbar button:last-child');
                const oldText = btn.innerHTML;
                btn.disabled = true; btn.innerHTML = '儲存中...';
                try {
                    const title = safeGet('edit-title').value.trim();
                    const desc = safeGet('edit-desc').value.trim();
                    if (!title) throw new Error("請輸入標題");
                    const questions = [];
                    document.querySelectorAll('.question-item').forEach(item => {
                        const type = item.dataset.type || item.querySelector('.q-type-select')?.value;
                        const text = item.querySelector('.q-input').value.trim();
                        if (!text) return;
                        if (type === 'section') {
                            questions.push({ type, text, description: item.querySelector('.q-desc').value.trim() });
                        } else {
                            const req = item.querySelector('.q-req').checked;
                            const typeSelect = item.querySelector('.q-type-select').value;
                            let opts = [];
                            if (typeSelect !== 'text') opts = item.querySelector('.q-opts').value.split('\n').map(x=>x.trim()).filter(x=>x);
                            questions.push({ type: typeSelect, text, required: req, options: opts });
                        }
                    });
                    const data = { title, description: desc, questions, updatedAt: serverTimestamp(), status: state.surveysCache[state.currentSurveyId]?.status || 'draft' };
                    await setDoc(doc(state.db, 'artifacts', appId, 'users', state.user.uid, 'surveys', state.currentSurveyId), data, {merge: true});
                    state.isDirty = false; updateDirtyUI(); showToast('儲存成功');
                    state.surveysCache[state.currentSurveyId] = { ...data, id: state.currentSurveyId };
                } catch (e) { showToast(e.message, 'error'); } finally { btn.disabled = false; btn.innerHTML = oldText; }
            },
            duplicateCurrent: async () => {
                 const survey = state.surveysCache[state.currentSurveyId];
                 if(!survey) return;
                 if(!confirm("確定複製此問卷？")) return;
                 try {
                     const newId = crypto.randomUUID();
                     const newData = { ...survey, title: `${survey.title} (副本)`, updatedAt: serverTimestamp(), status: 'draft' };
                     delete newData.id;
                     await setDoc(doc(state.db, 'artifacts', appId, 'users', state.user.uid, 'surveys', newId), newData);
                     showToast("複製成功");
                     // Reload list and go back
                     loadSurveys();
                     switchView('view-dashboard');
                 } catch(e) { showToast("複製失敗", 'error'); }
            },

            // --- Public Methods ---
            updateProgressBar: () => {
                 const form = safeGet('public-form');
                 const total = document.querySelectorAll('.public-q-wrapper[data-type!="section"]').length; 
                 if(total === 0) return;
                 const formData = new FormData(form);
                 const answered = new Set();
                 for(let [key, val] of formData.entries()) { if(val) answered.add(key); }
                 const percent = Math.round((answered.size / total) * 100);
                 safeGet('progress-fill').style.width = `${percent}%`;
            },
            
            submitResponse: async () => {
                const form = safeGet('public-form');
                const items = form.querySelectorAll('.public-q-wrapper');
                let firstInvalid = null;
                items.forEach(item => {
                    item.classList.remove('error-shake');
                    if (item.dataset.required === 'true') {
                        const name = item.dataset.name;
                        const type = item.dataset.type;
                        let valid = false;
                        if (type === 'text') { if(form.querySelector(`[name="${name}"]`).value.trim()) valid = true; }
                        else { if(form.querySelector(`[name="${name}"]:checked`)) valid = true; }
                        
                        if (!valid) {
                            item.classList.add('error-shake');
                            if(!firstInvalid) firstInvalid = item;
                        }
                    }
                });

                if (firstInvalid) {
                    showToast("還有必填題目未完成", 'error');
                    firstInvalid.scrollIntoView({behavior:'smooth', block:'center'});
                    return;
                }

                const btn = safeGet('public-submit-btn');
                btn.disabled = true; btn.innerText = "提交中...";
                try {
                    const formData = new FormData(form);
                    const answers = {};
                    items.forEach(div => {
                        const type = div.dataset.type;
                        if (type === 'section') return;
                        const name = div.dataset.name;
                        if (type === 'checkbox') answers[name] = formData.getAll(name);
                        else answers[name] = formData.get(name);
                    });
                    await addDoc(collection(state.db, 'artifacts', appId, 'users', uId, 'surveys', sId, 'responses'), { answers, submittedAt: serverTimestamp() });
                    switchView('view-thankyou');
                } catch(e) { console.error(e); showToast("提交失敗", 'error'); btn.disabled = false; btn.innerText = "送出問卷"; }
            },

            // Helpers
            markDirty: () => { state.isDirty = true; updateDirtyUI(); },
            autoGrow: (el) => { el.style.height = 'auto'; el.style.height = el.scrollHeight + 'px'; },
            
            // --- Modal Logic (Imports, Preview) ---
            openImport: () => {
                const modal = safeGet('modal-content');
                safeGet('modal-overlay').classList.remove('hidden');
                modal.innerHTML = `
                    <div class="p-6">
                        <h3 class="text-lg font-bold mb-4">批量匯入</h3>
                        <textarea id="batch-text" rows="6" class="w-full border rounded p-2 text-sm" placeholder="一行一題"></textarea>
                        <div class="mt-4 flex justify-end gap-2">
                             <button onclick="safeGet('modal-overlay').classList.add('hidden')" class="px-4 py-2 text-gray-500">取消</button>
                             <button onclick="window.SurveyApp.doImport()" class="px-4 py-2 bg-blue-600 text-white rounded">匯入</button>
                        </div>
                    </div>`;
            },
            doImport: () => {
                const lines = safeGet('batch-text').value.split('\n').filter(l=>l.trim());
                lines.forEach(l => window.SurveyApp.addQuestion('radio', {text: l, type: 'radio', required: true, options: ['非常滿意','滿意','普通','不滿意','非常不滿意']}));
                safeGet('modal-overlay').classList.add('hidden');
            },
            openPreview: () => {
                 // Simplified preview just shows alert or simple logic, for full mobile preview see previous versions
                 // Integrating full mobile preview here would make code too long, assuming basic functionality first
                 alert("預覽功能：請先儲存後，使用分享連結查看實際效果。");
            }
        };

        // --- Helpers ---
        function updateLockState(isLocked) {
            const inputs = document.querySelectorAll('#view-editor input, #view-editor textarea, #view-editor select');
            inputs.forEach(el => el.disabled = isLocked);
            safeGet('locked-banner').classList.toggle('hidden', !isLocked);
            safeGet('editor-toolbar').classList.toggle('hidden', isLocked);
        }
        function updateDirtyUI() { safeGet('unsaved-badge').classList.toggle('hidden', !state.isDirty); }
        
        function switchView(id) {
            ['view-login','view-dashboard','view-editor','view-public','view-thankyou'].forEach(v => safeGet(v).classList.add('hidden'));
            safeGet(id).classList.remove('hidden');
            window.scrollTo(0,0);
        }

        async function loadSurveys() {
            try {
                const q = collection(state.db, 'artifacts', appId, 'users', state.user.uid, 'surveys');
                const snap = await getDocs(q);
                state.surveysCache = {};
                const container = safeGet('survey-list-container');
                container.innerHTML = '';
                
                if (snap.empty) { safeGet('empty-state').classList.remove('hidden'); return; }
                safeGet('empty-state').classList.add('hidden');

                snap.forEach(doc => {
                    const s = { id: doc.id, ...doc.data() };
                    state.surveysCache[s.id] = s;
                    container.innerHTML += `
                    <div class="bg-white p-5 rounded-xl shadow-sm border border-gray-200 hover:shadow-md transition cursor-pointer" onclick="window.SurveyApp.loadEditor('${s.id}')">
                        <div class="flex justify-between mb-2"><h3 class="font-bold text-lg truncate">${escapeHtml(s.title)}</h3>${s.status==='published'?'<span class="text-xs bg-green-100 text-green-700 px-2 py-1 rounded">已發布</span>':'<span class="text-xs bg-gray-100 px-2 py-1 rounded">草稿</span>'}</div>
                        <p class="text-sm text-gray-500 line-clamp-2">${escapeHtml(s.description)}</p>
                    </div>`;
                });
            } catch(e) { showToast('讀取失敗', 'error'); }
        }

        // Public Loader
        async function loadPublicData() {
            try {
                const snap = await getDoc(doc(state.db, 'artifacts', appId, 'users', uId, 'surveys', sId));
                if(!snap.exists()) throw new Error("問卷不存在");
                const data = snap.data();
                safeGet('public-title').textContent = data.title;
                safeGet('public-desc').textContent = data.description;
                
                const form = safeGet('public-form');
                form.innerHTML = (data.questions || []).map((q, idx) => {
                    if (q.type === 'section') return `<div class="border-b pb-2 mb-6 mt-8"><h3 class="text-xl font-bold text-blue-800">${escapeHtml(q.text)}</h3><p class="text-gray-600">${escapeHtml(q.description)}</p></div>`;
                    
                    const name = `q_${idx}`;
                    let inputHtml = '';
                    if (q.type === 'text') inputHtml = `<input type="text" name="${name}" class="w-full border rounded p-3 bg-gray-50 focus:bg-white transition" oninput="window.app.updateProgressBar()">`;
                    else if (q.type === 'radio') {
                        const cols = q.options.length <= 4 ? 2 : (q.options.length >= 7 ? 4 : 3);
                        inputHtml = `<div class="grid grid-cols-${cols} gap-2">` + q.options.map(opt => `
                            <label class="cursor-pointer">
                                <input type="radio" name="${name}" value="${escapeHtml(opt)}" class="peer sr-only" onchange="window.app.updateProgressBar()">
                                <div class="option-card p-3 rounded-lg text-center text-sm font-bold bg-white h-full flex items-center justify-center">${escapeHtml(opt)}</div>
                            </label>`).join('') + `</div>`;
                    }
                    return `<div class="public-q-wrapper space-y-3 mb-8 p-4 rounded-xl transition duration-300" data-required="${q.required}" data-type="${q.type}" data-name="${name}"><h4 class="font-bold text-lg text-gray-800">${idx+1}. ${escapeHtml(q.text)} ${q.required?'<span class="text-red-500">*</span>':''}</h4>${inputHtml}</div>`;
                }).join('');
                switchView('view-public');
            } catch(e) { safeGet('main-container').innerHTML = `<div class="text-center mt-20"><h2 class="text-xl font-bold">無法讀取問卷</h2></div>`; }
        }

        // Main Entry
        onAuthStateChanged(state.auth, (user) => {
            state.user = user;
            safeGet('loading-view').classList.add('hidden');
            if (state.mode === 'public') {
                if (!user) signInAnonymously(state.auth).catch(console.error);
                else loadPublicData();
            } else {
                if (user) {
                    safeGet('admin-nav').classList.remove('hidden');
                    safeGet('user-info').textContent = user.isAnonymous ? '訪客' : user.email;
                    safeGet('guest-warning').classList.toggle('hidden', !user.isAnonymous);
                    switchView('view-dashboard');
                    loadSurveys();
                } else {
                    switchView('view-login');
                }
            }
        });
    </script>
</body>
</html>
