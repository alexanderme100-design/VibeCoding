<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Firebase å•å·ç³»çµ±</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">

    <style>
        html, body { overflow-x: hidden; min-height: 100vh; background-color: #f3f4f6; font-family: 'Noto Sans TC', sans-serif; -webkit-tap-highlight-color: transparent; }
        body { display: flex; flex-direction: column; }
        .fade-in { animation: fadeIn 0.4s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        input:checked + div { transform: scale(0.98); box-shadow: inset 0 0 0 2px currentColor; font-weight: bold; background-color: #eff6ff; }
        .tap-target { min-height: 48px; }
        .progress-transition { transition: width 0.3s ease-out; }
        .safe-pb { padding-bottom: env(safe-area-inset-bottom, 20px); }
        .question-card.dragging { opacity: 0.5; border: 2px dashed #3b82f6; background-color: #eff6ff; }
        .drag-handle { cursor: grab; touch-action: none; }
        .drag-handle:active { cursor: grabbing; }
        .locked-input { background-color: #f9fafb; border-color: #e5e7eb; color: #6b7280; cursor: not-allowed; }
        
        .likert-opt-1 { color: #ef4444; border-color: #fca5a5; background-color: #fef2f2; } 
        .likert-opt-2 { color: #f97316; border-color: #fdba74; background-color: #fff7ed; } 
        .likert-opt-3 { color: #eab308; border-color: #fde047; background-color: #fefce8; } 
        .likert-opt-4 { color: #84cc16; border-color: #bef264; background-color: #f7fee7; } 
        .likert-opt-5 { color: #22c55e; border-color: #86efac; background-color: #f0fdf4; } 
        .opt-default { color: #374151; border-color: #e5e7eb; background-color: white; }
        input:checked + div.opt-default { border-color: #2563eb; background-color: #eff6ff; color: #1d4ed8; }
    </style>

    <script>
        window.app = {}; 
        
        window.showToast = function(msg, type = 'success') {
            const toast = document.getElementById('toast');
            const icon = document.getElementById('toast-icon');
            const msgSpan = document.getElementById('toast-msg');
            if(!toast) return;
            msgSpan.textContent = msg;
            icon.className = type === 'error' ? 'fa-solid fa-circle-exclamation text-red-400' : 'fa-solid fa-check-circle text-green-400';
            toast.className = `fixed top-20 right-5 z-[100] bg-gray-800 text-white px-6 py-3 rounded-lg shadow-lg flex items-center gap-3 transition-transform duration-300 border-l-4 ${type === 'error' ? 'border-red-500' : 'border-green-500'}`;
            toast.classList.remove('translate-x-full');
            setTimeout(() => toast.classList.add('translate-x-full'), 4000);
        };

        window.safeGet = function(id) {
            const el = document.getElementById(id);
            return el || { classList: { remove:()=>{}, add:()=>{}, toggle:()=>{} }, style: {}, value: '', disabled: false, innerHTML: '', addEventListener: ()=>{} }; 
        };

        window.escapeHtml = function(text) {
            if (text === null || text === undefined) return '';
            return String(text).replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
        };
        
        window.onerror = function(msg, url, line, col, error) {
            console.error("Global Error:", msg, error);
            const errorDiv = document.getElementById('global-error');
            const errorMsg = document.getElementById('global-error-msg');
            if(errorDiv && errorMsg) {
                errorDiv.classList.remove('hidden');
                errorMsg.innerText = `${msg} (Line: ${line})`;
            }
            const loading = document.getElementById('loading-view');
            if(loading) loading.classList.add('hidden');
        };

        window.scrollToNext = function(currentElement) {
            const currentCard = currentElement.closest('.public-q-item');
            if (!currentCard) return;
            const nextElement = currentCard.nextElementSibling;
            if (nextElement) {
                setTimeout(() => nextElement.scrollIntoView({ behavior: 'smooth', block: 'center' }), 300);
            } else {
                setTimeout(() => {
                    const submitBtn = document.getElementById('public-submit-btn');
                    if (submitBtn) submitBtn.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }, 300);
            }
        };
    </script>
</head>
<body class="text-gray-800">

    <!-- å…¨åŸŸéŒ¯èª¤æç¤º -->
    <div id="global-error" class="hidden fixed inset-0 bg-red-50 z-[200] flex flex-col items-center justify-center p-6 text-center">
        <i class="fa-solid fa-bug text-5xl text-red-500 mb-4"></i>
        <h2 class="text-xl font-bold text-gray-800">ç³»çµ±ç™¼ç”ŸéŒ¯èª¤</h2>
        <p id="global-error-msg" class="text-sm text-gray-600 mt-2 font-mono bg-white p-2 rounded border break-all">Unknown Error</p>
        <button onclick="location.reload()" class="mt-6 bg-red-600 text-white px-6 py-2 rounded-lg shadow hover:bg-red-700">é‡æ–°æ•´ç†</button>
    </div>

    <div id="public-progress-bar" class="fixed top-0 left-0 w-full h-1.5 bg-gray-200 z-[60] hidden">
        <div id="progress-fill" class="h-full bg-green-500 transition-all duration-300" style="width: 0%"></div>
    </div>

    <nav id="admin-nav" class="bg-blue-600 text-white shadow-lg sticky top-0 z-50 hidden">
        <div class="max-w-6xl mx-auto px-4 py-3 flex justify-between items-center">
            <div class="flex items-center gap-3">
                <i class="fa-solid fa-clipboard-list text-2xl"></i>
                <h1 class="text-lg font-bold tracking-wide">å•å·å¤§å¸« <span class="text-xs bg-blue-700 px-2 py-0.5 rounded ml-1 opacity-80">Pro</span></h1>
            </div>
            <div class="flex items-center gap-3">
                <div id="user-info" class="text-xs bg-blue-800 px-2 py-1 rounded opacity-80 hidden md:block">è¨ªå®¢</div>
                <button onclick="window.app.logout()" class="hover:bg-blue-700 p-2 rounded-lg transition"><i class="fa-solid fa-right-from-bracket"></i></button>
            </div>
        </div>
    </nav>

    <main class="flex-1 w-full max-w-5xl mx-auto p-4 pb-20 safe-pb">
        <div id="loading-view" class="fixed inset-0 flex flex-col items-center justify-center bg-gray-100 z-[150]">
            <i class="fa-solid fa-circle-notch fa-spin text-4xl text-blue-500"></i>
            <p class="mt-4 text-gray-500 font-medium">ç³»çµ±è¼‰å…¥ä¸­...</p>
            <div id="loading-timeout" class="hidden mt-4 text-center"><p class="text-xs text-red-400 mb-2">é€£ç·šå›æ‡‰è¼ƒæ…¢</p><button onclick="location.reload()" class="text-xs border border-gray-300 px-3 py-1 rounded bg-white">é‡æ–°è¼‰å…¥</button></div>
        </div>
        <div id="toast" class="fixed top-20 right-5 z-[100] bg-gray-800 text-white px-6 py-3 rounded-lg shadow-lg flex items-center gap-3 transition-transform duration-300 translate-x-full border-l-4 border-green-500"><i id="toast-icon"></i><span id="toast-msg"></span></div>

        <!-- Login -->
        <div id="view-login" class="hidden flex flex-col items-center justify-center min-h-[60vh] fade-in">
            <div class="bg-white p-8 rounded-2xl shadow-xl w-full max-w-sm border border-gray-100 text-center">
                <h2 class="text-2xl font-bold text-gray-800 mb-6">ç®¡ç†å“¡ç™»å…¥</h2>
                <div id="file-protocol-warning" class="hidden mb-4 p-3 bg-yellow-50 text-yellow-800 text-xs rounded-lg text-left"><i class="fa-solid fa-triangle-exclamation mr-1"></i> è­¦å‘Šï¼šè«‹ä½¿ç”¨ç¶²é ä¼ºæœå™¨é–‹å•Ÿã€‚</div>
                <div class="space-y-3 text-left">
                    <div><label class="text-xs font-bold text-gray-500 ml-1">é›»å­éƒµä»¶</label><input type="email" id="login-email" class="w-full bg-gray-50 border border-gray-300 rounded-lg p-3" placeholder="email@example.com"></div>
                    <div><label class="text-xs font-bold text-gray-500 ml-1">å¯†ç¢¼</label><input type="password" id="login-password" class="w-full bg-gray-50 border border-gray-300 rounded-lg p-3" placeholder="******"></div>
                </div>
                <div class="grid grid-cols-2 gap-3 mt-6">
                    <button onclick="window.app.login()" class="bg-blue-600 text-white py-3 rounded-xl font-bold shadow tap-target">ç™»å…¥</button>
                    <button onclick="window.app.register()" class="bg-white text-gray-700 border border-gray-300 py-3 rounded-xl font-bold tap-target">è¨»å†Š</button>
                </div>
            </div>
        </div>

        <!-- Dashboard -->
        <div id="view-dashboard" class="hidden fade-in">
            <div id="guest-warning" class="hidden bg-orange-50 border-l-4 border-orange-400 p-4 mb-6 rounded-r shadow-sm flex gap-3 items-start">
                <i class="fa-solid fa-triangle-exclamation text-orange-500 mt-1"></i>
                <div class="text-sm text-orange-800"><strong>è¨ªå®¢æ¨¡å¼ï¼š</strong> è³‡æ–™åƒ…æš«å­˜ã€‚å»ºè­°<button onclick="window.app.logout()" class="underline font-bold">ç™»å‡ºä¸¦è¨»å†Š</button>ä»¥æ°¸ä¹…ä¿å­˜ã€‚</div>
            </div>
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-gray-800">æˆ‘çš„å•å·</h2>
                <button onclick="window.app.createSurvey()" class="bg-blue-600 text-white px-4 py-2 rounded-lg shadow hover:bg-blue-700 transition flex items-center gap-2 tap-target">
                    <i class="fa-solid fa-plus"></i> æ–°å»ºå•å·
                </button>
            </div>
            <div id="survey-list-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
            <div id="empty-state" class="hidden flex flex-col items-center justify-center py-20 text-gray-400 border-2 border-dashed border-gray-300 rounded-xl">
                <p>ç›®å‰æ²’æœ‰å•å·</p>
            </div>
        </div>

        <!-- Editor -->
        <div id="view-editor" class="hidden fade-in">
            <div class="sticky top-0 z-30 bg-[#f3f4f6] py-2 flex justify-between items-center mb-2">
                <button onclick="window.app.backToDashboard()" class="text-gray-600 bg-white border px-3 py-1.5 rounded-lg text-sm shadow-sm"><i class="fa-solid fa-arrow-left mr-1"></i> è¿”å›</button>
                <div class="flex gap-2">
                    <span id="unsaved-badge" class="hidden px-2 py-1 bg-orange-100 text-orange-600 text-xs rounded border border-orange-200 flex items-center">æœªå„²å­˜</span>
                    <button id="btn-import" onclick="window.app.openBatchModal()" class="bg-white text-blue-600 border border-blue-200 px-3 py-1.5 rounded-lg text-sm shadow-sm"><i class="fa-solid fa-bolt mr-1"></i> åŒ¯å…¥</button>
                </div>
            </div>
            <div id="locked-banner" class="hidden bg-yellow-50 border-l-4 border-yellow-400 p-3 mb-4 rounded shadow-sm text-sm text-yellow-800 flex justify-between items-center">
                <span><i class="fa-solid fa-lock mr-1"></i> å•å·å·²ç™¼å¸ƒé–å®š</span>
                <button onclick="window.app.duplicateCurrent()" class="underline">è¤‡è£½ä»¥ç·¨è¼¯</button>
            </div>
            <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-200 mb-6">
                <input type="text" id="edit-title" class="w-full text-xl font-bold border-b p-2 outline-none" placeholder="å•å·æ¨™é¡Œ" oninput="window.app.markDirty()">
                <textarea id="edit-desc" class="w-full text-gray-600 mt-2 border-b p-2 outline-none resize-none" rows="1" placeholder="å•å·èªªæ˜..." oninput="window.app.markDirty(); window.app.autoGrow(this)"></textarea>
            </div>
            <div id="editor-questions" class="space-y-4 mb-24"></div>
            <div id="editor-toolbar" class="fixed bottom-0 left-0 w-full bg-white border-t p-3 flex justify-between items-center z-40 safe-pb shadow-lg">
                 <div class="flex gap-2">
                    <button onclick="window.app.addQuestion('text')" class="flex flex-col items-center justify-center w-12 h-12 bg-gray-50 text-gray-600 rounded-lg"><i class="fa-solid fa-plus"></i><span class="text-[10px]">é¡Œç›®</span></button>
                    <button onclick="window.app.addQuestion('section')" class="flex flex-col items-center justify-center w-12 h-12 bg-orange-50 text-orange-600 rounded-lg"><i class="fa-solid fa-align-left"></i><span class="text-[10px]">æ®µè½</span></button>
                 </div>
                 <button onclick="window.app.saveSurvey()" class="bg-blue-600 text-white px-6 py-2 rounded-xl font-bold shadow-lg">å„²å­˜</button>
            </div>
        </div>

        <!-- Public View -->
        <div id="view-public" class="hidden w-full max-w-2xl mx-auto fade-in pb-24">
            <div class="bg-white rounded-xl shadow-lg overflow-hidden border border-gray-200">
                <div class="bg-blue-600 h-2"></div>
                <div class="p-6">
                    <h1 id="public-title" class="text-2xl font-bold text-gray-900 mb-3">è¼‰å…¥ä¸­...</h1>
                    <div id="public-desc" class="text-gray-600 whitespace-pre-wrap text-sm leading-relaxed"></div>
                </div>
            </div>
            <form id="public-form" class="mt-6 space-y-4"></form>
            <div class="mt-8">
                <button id="public-submit-btn" type="button" onclick="window.app.submitResponse()" class="w-full bg-blue-600 text-white font-bold py-4 rounded-xl shadow-lg active:scale-[0.98] text-lg">é€å‡ºå•å·</button>
            </div>
        </div>

        <!-- Thank You -->
        <div id="view-thankyou" class="hidden flex flex-col items-center justify-center min-h-[60vh] text-center fade-in px-4">
            <div class="w-20 h-20 bg-green-100 text-green-500 rounded-full flex items-center justify-center mb-6"><i class="fa-solid fa-check text-4xl"></i></div>
            <h2 class="text-2xl font-bold text-gray-800 mb-2">æ„Ÿè¬æ‚¨çš„å¡«å¯«ï¼</h2>
            <button onclick="location.reload()" class="mt-8 text-blue-600 underline">å¡«å¯«å¦ä¸€ä»½</button>
        </div>
    </main>

    <!-- Modals -->
    <div id="modal-overlay" class="hidden fixed inset-0 bg-black bg-opacity-50 z-[60] flex items-center justify-center p-4 fade-in">
        <div id="modal-content" class="bg-white rounded-xl shadow-2xl w-full max-w-lg max-h-[90vh] flex flex-col overflow-hidden relative"></div>
    </div>

    <!-- Delete Confirmation Modal (Fixed) -->
    <div id="delete-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-[70] flex items-center justify-center p-4 fade-in">
        <div class="bg-white rounded-xl shadow-2xl p-6 max-w-sm w-full text-center">
            <div class="w-16 h-16 bg-red-100 text-red-500 rounded-full flex items-center justify-center mx-auto mb-4"><i class="fa-solid fa-trash-can text-2xl"></i></div>
            <h3 class="text-lg font-bold text-gray-800">ç¢ºå®šè¦åˆªé™¤æ­¤å•å·ï¼Ÿ</h3>
            <p class="text-sm text-gray-500 mt-2">åˆªé™¤å¾Œç„¡æ³•å¾©åŸï¼Œæ‰€æœ‰çµ±è¨ˆè³‡æ–™å°‡ä¸€ä½µæ¶ˆå¤±ã€‚</p>
            <div class="flex gap-3 mt-6">
                <button onclick="safeGet('delete-modal').classList.add('hidden')" class="flex-1 py-2 border border-gray-300 rounded-lg tap-target text-gray-600">å–æ¶ˆ</button>
                <button id="confirm-delete-btn" class="flex-1 py-2 bg-red-500 text-white rounded-lg tap-target shadow-md">ç¢ºèªåˆªé™¤</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken, signOut, createUserWithEmailAndPassword, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, getDoc, getDocs, deleteDoc, addDoc, serverTimestamp, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
          apiKey: "AIzaSyAexk_JbIOQWV1Jw7hqfiZDDZYY9YF-Sdk",
          authDomain: "survey-49e8d.firebaseapp.com",
          projectId: "survey-49e8d",
          storageBucket: "survey-49e8d.firebasestorage.app",
          messagingSenderId: "547257703502",
          appId: "1:547257703502:web:85e147bed62333b11c771f"
        };
        
        const APP_ID = 'survey-app';
        const state = { db: null, auth: null, user: null, currentSurveyId: null, surveysCache: {}, isDirty: false, mode: 'admin' };
        const urlParams = new URLSearchParams(window.location.search);
        const sId = urlParams.get('s');
        const uId = urlParams.get('u');
        if (sId && uId) state.mode = 'public';

        try {
            const app = initializeApp(firebaseConfig);
            state.auth = getAuth(app);
            state.db = getFirestore(app);
            if (state.mode === 'public') signInAnonymously(state.auth).catch(console.error);
        } catch (e) { console.error(e); alert("Firebase Init Error"); }

        const getEmoji = (idx, total) => {
            const emojis = ['ğŸ˜¡', 'ğŸ™', 'ğŸ˜', 'ğŸ˜Š', 'ğŸ¤©'];
            if (total <= 5) return idx < 5 ? emojis[idx] : '';
            if (total <= 7) return idx < 7 ? ['ğŸ˜¡', 'ğŸ˜ ', 'ğŸ™', 'ğŸ˜', 'ğŸ™‚', 'ğŸ˜Š', 'ğŸ¤©'][idx] : '';
            return '';
        };
        const getColor = (idx, total) => {
             if(total <= 7) {
                 const n = idx + 1;
                 if(n <= 2) return 'likert-opt-1'; 
                 if(n <= 3 && total > 3) return 'likert-opt-2'; 
                 if(n == Math.ceil(total/2)) return 'likert-opt-3'; 
                 if(n >= total-1) return 'likert-opt-5'; 
                 return 'likert-opt-4';
             }
             return 'opt-default';
        };

        window.app.login = async () => { try { await signInWithEmailAndPassword(state.auth, safeGet('login-email').value, safeGet('login-password').value); } catch(e) { showToast(e.code, 'error'); } };
        window.app.register = async () => { try { await createUserWithEmailAndPassword(state.auth, safeGet('login-email').value, safeGet('login-password').value); showToast("è¨»å†ŠæˆåŠŸ"); } catch(e) { showToast(e.code, 'error'); } };
        window.app.logout = async () => { await signOut(state.auth); location.reload(); };

        window.app.backToDashboard = () => { if(state.isDirty && !confirm("æœªå„²å­˜è®Šæ›´å°‡éºå¤±")) return; switchView('view-dashboard'); renderList(); };

        window.app.createSurvey = () => {
            state.currentSurveyId = crypto.randomUUID();
            safeGet('edit-title').value = ''; safeGet('edit-desc').value = ''; safeGet('editor-questions').innerHTML = '';
            updateLock(false);
            window.app.addQuestion(); 
            state.isDirty = false; updateDirtyUI();
            switchView('view-editor');
        };

        window.app.editSurvey = async (surveyId) => {
            let survey = state.surveysCache[surveyId];
            if (!survey) {
                try {
                    showToast("è³‡æ–™ä¸‹è¼‰ä¸­...", "info");
                    const docRef = doc(state.db, 'artifacts', APP_ID, 'users', state.user.uid, 'surveys', surveyId);
                    const snap = await getDoc(docRef);
                    if (snap.exists()) {
                        survey = { id: snap.id, ...snap.data() };
                        state.surveysCache[surveyId] = survey;
                    } else {
                        return showToast("å•å·ä¸å­˜åœ¨æˆ–å·²åˆªé™¤", "error");
                    }
                } catch (e) {
                    console.error(e);
                    return showToast("è³‡æ–™è®€å–å¤±æ•—", "error");
                }
            }
            state.currentSurveyId = surveyId;
            safeGet('edit-title').value = survey.title || '';
            safeGet('edit-desc').value = survey.description || '';
            window.app.autoGrow(safeGet('edit-desc'));
            updateLock(survey.status === 'published');
            const container = safeGet('editor-questions');
            container.innerHTML = '';
            (survey.questions || []).forEach(q => window.app.addQuestion(q.type, q));
            switchView('view-editor');
        };
        
        window.app.loadEditor = window.app.editSurvey;

        window.app.addQuestion = (type = 'text', data = null) => {
            const container = safeGet('editor-questions');
            const id = `q-${Date.now()}-${Math.random().toString(36).substr(2,4)}`;
            const div = document.createElement('div');
            
            const qText = data ? data.text : '';
            const qType = data ? data.type : type;
            const qReq = data ? data.required : true;
            const qOpts = data ? (data.options || []).join('\n') : '';

            if (qType === 'section') {
                div.className = "question-item bg-orange-50 p-4 rounded-xl border border-orange-200 mb-4 relative group";
                div.dataset.type = "section";
                div.innerHTML = `<div class="flex justify-between mb-2"><span class="text-xs font-bold text-orange-600">æ®µè½èªªæ˜</span><button onclick="this.closest('.question-item').remove(); window.app.markDirty()" class="text-gray-400"><i class="fa-solid fa-trash"></i></button></div><input type="text" class="q-input w-full bg-white border border-orange-300 rounded p-2 mb-2 font-bold" placeholder="æ®µè½æ¨™é¡Œ" value="${escapeHtml(qText)}" oninput="window.app.markDirty()"><textarea class="q-desc w-full bg-white border border-orange-300 rounded p-2" rows="2" placeholder="èªªæ˜å…§å®¹..." oninput="window.app.markDirty()">${escapeHtml(data ? data.description : '')}</textarea>`;
            } else {
                div.className = "question-item bg-white p-4 rounded-xl border border-gray-200 mb-4 shadow-sm relative group";
                div.dataset.type = qType;
                div.innerHTML = `<div class="flex justify-between mb-3"><span class="text-xs font-bold text-blue-600 bg-blue-50 px-2 py-1 rounded">å•é¡Œ</span><div class="flex items-center gap-2"><label class="text-xs"><input type="checkbox" class="q-req mr-1" ${qReq ? 'checked' : ''} onchange="window.app.markDirty()">å¿…å¡«</label><button onclick="this.closest('.question-item').remove(); window.app.markDirty()" class="text-gray-400"><i class="fa-solid fa-trash"></i></button></div></div><input type="text" class="q-input w-full border rounded p-2 mb-2" placeholder="é¡Œç›®å…§å®¹" value="${escapeHtml(qText)}" oninput="window.app.markDirty()"><select class="q-type w-full border rounded p-2 mb-2 bg-gray-50" onchange="window.app.toggleOpts(this)"><option value="text" ${qType==='text'?'selected':''}>ç°¡ç­”é¡Œ</option><option value="radio" ${qType==='radio'?'selected':''}>å–®é¸é¡Œ</option><option value="checkbox" ${qType==='checkbox'?'selected':''}>å¤šé¸é¡Œ</option></select><textarea class="q-opts w-full border rounded p-2 h-24 font-mono ${qType==='text'?'hidden':''}" placeholder="é¸é …1&#10;é¸é …2&#10;é¸é …3" oninput="window.app.markDirty()">${escapeHtml(qOpts)}</textarea>`;
            }
            container.appendChild(div);
            window.app.markDirty();
        };

        window.app.toggleOpts = (el) => {
            const item = el.closest('.question-item');
            item.dataset.type = el.value;
            const area = item.querySelector('.q-opts');
            if(area) {
                if (el.value === 'text') area.classList.add('hidden');
                else area.classList.remove('hidden');
            }
            window.app.markDirty();
        };

        window.app.saveSurvey = async () => {
            if (!state.user) return;
            const btn = document.querySelector('#editor-toolbar button:last-child');
            btn.disabled = true; btn.innerText = 'å„²å­˜ä¸­...';
            try {
                const title = safeGet('edit-title').value.trim();
                const desc = safeGet('edit-desc').value.trim();
                if (!title) throw new Error("è«‹è¼¸å…¥æ¨™é¡Œ");
                
                const questions = [];
                document.querySelectorAll('.question-item').forEach(item => {
                    const type = item.dataset.type || 'text';
                    const text = item.querySelector('.q-input').value.trim();
                    if (!text) return;
                    if (type === 'section') {
                        questions.push({ type, text, description: item.querySelector('.q-desc').value.trim() });
                    } else {
                        const req = item.querySelector('.q-req').checked;
                        let opts = [];
                        const optsArea = item.querySelector('.q-opts');
                        if (type !== 'text' && optsArea) opts = optsArea.value.split('\n').map(x=>x.trim()).filter(x=>x);
                        questions.push({ type: type, text, required: req, options: opts });
                    }
                });
                const data = { title, description: desc, questions, updatedAt: serverTimestamp(), status: state.surveysCache[state.currentSurveyId]?.status || 'draft' };
                await setDoc(doc(state.db, 'artifacts', APP_ID, 'users', state.user.uid, 'surveys', state.currentSurveyId), data, {merge: true});
                state.isDirty = false; updateDirtyUI(); showToast('å„²å­˜æˆåŠŸ');
                state.surveysCache[state.currentSurveyId] = { ...data, id: state.currentSurveyId };
            } catch (e) { console.error(e); showToast(e.message, 'error'); } finally { btn.disabled = false; btn.innerText = 'å„²å­˜'; }
        };

        window.app.openBatchModal = () => { safeGet('modal-overlay').classList.remove('hidden'); safeGet('modal-content').innerHTML = `<div class="p-6"><h3 class="text-lg font-bold mb-4">æ‰¹é‡åŒ¯å…¥</h3><textarea id="batch-text" class="w-full border rounded p-2 h-40" placeholder="é¡Œç›®1\né¡Œç›®2"></textarea><div class="mt-4 flex justify-end gap-2"><button onclick="safeGet('modal-overlay').classList.add('hidden')" class="px-4 py-2 bg-gray-200 rounded">å–æ¶ˆ</button><button onclick="window.app.doImport()" class="px-4 py-2 bg-blue-600 text-white rounded">åŒ¯å…¥</button></div></div>`; };
        window.app.doImport = () => { const lines = safeGet('batch-text').value.split('\n').filter(l=>l.trim()); lines.forEach(l => window.app.addQuestion('radio', {text: l, type: 'radio', required: true, options: ['éå¸¸æ»¿æ„','æ»¿æ„','æ™®é€š','ä¸æ»¿æ„','éå¸¸ä¸æ»¿æ„']})); safeGet('modal-overlay').classList.add('hidden'); };
        window.app.openShare = (id) => { const link = `${window.location.origin}${window.location.pathname}?s=${id}&u=${state.user.uid}`; safeGet('modal-overlay').classList.remove('hidden'); safeGet('modal-content').innerHTML = `<div class="p-6 text-center"><h3 class="font-bold mb-4">é€£çµ</h3><input class="w-full border p-2 rounded mb-4" value="${link}" readonly><button onclick="navigator.clipboard.writeText('${link}');showToast('å·²è¤‡è£½')" class="bg-blue-600 text-white px-4 py-2 rounded">è¤‡è£½é€£çµ</button><div class="mt-4"><img src="https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=${encodeURIComponent(link)}" class="mx-auto"></div><button onclick="safeGet('modal-overlay').classList.add('hidden')" class="mt-4 text-gray-500 underline">é—œé–‰</button></div>`; const s = state.surveysCache[id]; if(s && s.status!=='published') updateDoc(doc(state.db, 'artifacts', APP_ID, 'users', state.user.uid, 'surveys', id), {status:'published'}); };
        window.app.viewStats = async (id) => { 
            safeGet('modal-overlay').classList.remove('hidden'); 
            safeGet('modal-content').innerHTML = '<div class="p-10 text-center">è¼‰å…¥ä¸­...</div>';
            const snap = await getDocs(collection(state.db, 'artifacts', APP_ID, 'users', state.user.uid, 'surveys', id, 'responses'));
            safeGet('modal-content').innerHTML = `<div class="p-6"><h3 class="font-bold mb-4">å…± ${snap.size} ç­†å›è¦†</h3><p class="text-gray-500">è«‹ä½¿ç”¨åŒ¯å‡ºåŠŸèƒ½åˆ†æã€‚</p><button class="mt-4 bg-green-600 text-white px-4 py-2 rounded" onclick="window.app.exportToCSV('${id}')">åŒ¯å‡º Excel</button><button onclick="safeGet('modal-overlay').classList.add('hidden')" class="block mt-4 w-full text-gray-500">é—œé–‰</button></div>`;
        };
        window.app.exportToCSV = async (id) => {
             try {
                const survey = state.surveysCache[id];
                const snap = await getDocs(collection(state.db, 'artifacts', APP_ID, 'users', state.user.uid, 'surveys', id, 'responses'));
                let csv = "\uFEFFæ™‚é–“,";
                survey.questions.forEach((q, i) => csv += `"${q.text.replace(/"/g,'""')}",`);
                csv += "\n";
                snap.forEach(doc => {
                    const d = doc.data();
                    csv += `"${new Date(d.submittedAt.seconds*1000).toLocaleString()}",`;
                    survey.questions.forEach((q, i) => {
                        if(q.type==='section') csv += ",";
                        else {
                            let a = d.answers[`q_${i}`];
                            if(Array.isArray(a)) a = a.join(';');
                            csv += `"${(a||'').toString().replace(/"/g,'""')}",`;
                        }
                    });
                    csv += "\n";
                });
                const url = URL.createObjectURL(new Blob([csv], {type: 'text/csv'}));
                const a = document.createElement('a'); a.href = url; a.download = `${survey.title}.csv`; a.click();
            } catch(e) { console.error(e); alert("åŒ¯å‡ºå¤±æ•—"); }
        };
        window.app.duplicateCurrent = async () => { if(!confirm("è¤‡è£½å•å·ï¼Ÿ")) return; const s = state.surveysCache[state.currentSurveyId]; const newId = crypto.randomUUID(); await setDoc(doc(state.db, 'artifacts', APP_ID, 'users', state.user.uid, 'surveys', newId), { ...s, title: s.title+"(å‰¯æœ¬)", status: 'draft', updatedAt: serverTimestamp() }); showToast("è¤‡è£½æˆåŠŸ"); loadSurveys(); switchView('view-dashboard'); };

        // --- RE-IMPLEMENTED REQUEST DELETE ---
        window.app.requestDelete = (id) => {
            const modal = safeGet('delete-modal');
            const confirmBtn = safeGet('confirm-delete-btn');
            modal.classList.remove('hidden');
            
            // Use cloneNode to prevent multiple event listeners
            const newBtn = confirmBtn.cloneNode(true);
            confirmBtn.parentNode.replaceChild(newBtn, confirmBtn);
            
            newBtn.addEventListener('click', async () => {
                modal.classList.add('hidden');
                try {
                    await deleteDoc(doc(state.db, 'artifacts', APP_ID, 'users', state.user.uid, 'surveys', id));
                    showToast("åˆªé™¤æˆåŠŸ");
                    loadSurveys();
                } catch (e) {
                    console.error(e);
                    showToast("åˆªé™¤å¤±æ•—: " + e.message, "error");
                }
            });
        };

        window.app.updateProgressBar = () => {
            const form = safeGet('public-form');
            const total = form.querySelectorAll('.public-q-item:not([data-type="section"])').length; 
            if(total === 0) return;
            const answered = new Set();
            new FormData(form).forEach((v, k) => { if(v) answered.add(k); });
            safeGet('progress-fill').style.width = Math.round((answered.size / total) * 100) + '%';
        };

        window.app.submitResponse = async () => {
             const form = safeGet('public-form');
             let firstInvalid = null;
             form.querySelectorAll('.public-q-item').forEach(item => {
                 item.classList.remove('error-shake', 'ring-2', 'ring-red-500', 'bg-red-50');
                 if (item.dataset.req === 'true') {
                     const name = item.dataset.name;
                     const type = item.dataset.type;
                     let valid = false;
                     if (type === 'text') { if(form.querySelector(`[name="${name}"]`).value.trim()) valid = true; }
                     else { if(form.querySelector(`[name="${name}"]:checked`)) valid = true; }
                     
                     if (!valid) {
                         item.classList.add('error-shake', 'ring-2', 'ring-red-500', 'bg-red-50', 'rounded-lg');
                         if(!firstInvalid) firstInvalid = item;
                     }
                 }
             });

             if (firstInvalid) {
                 showToast("é‚„æœ‰å¿…å¡«æœªå®Œæˆ", 'error');
                 firstInvalid.scrollIntoView({behavior:'smooth', block:'center'});
                 return;
             }
             const btn = safeGet('public-submit-btn');
             btn.disabled = true; btn.innerText = "æäº¤ä¸­...";
             try {
                 const formData = new FormData(form);
                 const answers = {};
                 form.querySelectorAll('.public-q-item').forEach(div => {
                     const type = div.dataset.type;
                     if (type === 'section') return; 
                     const name = div.dataset.name;
                     if (type === 'checkbox') answers[name] = formData.getAll(name);
                     else answers[name] = formData.get(name);
                 });
                 await addDoc(collection(state.db, 'artifacts', APP_ID, 'users', uId, 'surveys', sId, 'responses'), { answers, submittedAt: serverTimestamp() });
                 switchView('view-thankyou');
             } catch(e) { console.error(e); showToast("æäº¤å¤±æ•—", 'error'); btn.disabled = false; }
        };

        window.app.markDirty = () => { state.isDirty = true; updateDirtyUI(); };
        window.app.autoGrow = (el) => { el.style.height = 'auto'; el.style.height = el.scrollHeight + 'px'; };

        function switchView(id) {
            ['view-login','view-dashboard','view-editor','view-public','view-thankyou'].forEach(v => safeGet(v).classList.add('hidden'));
            safeGet(id).classList.remove('hidden');
            window.scrollTo(0,0);
        }
        function updateLock(isLocked) {
            const inputs = document.querySelectorAll('#view-editor input, #view-editor textarea, #view-editor select');
            inputs.forEach(el => el.disabled = isLocked);
            safeGet('locked-banner').classList.toggle('hidden', !isLocked);
            safeGet('editor-toolbar').classList.toggle('hidden', isLocked);
        }
        function updateDirtyUI() { safeGet('unsaved-badge').classList.toggle('hidden', !state.isDirty); }
        
        function renderList() {
            const container = safeGet('survey-list-container');
            container.innerHTML = '';
            const surveys = Object.values(state.surveysCache).sort((a, b) => (b.updatedAt?.seconds || 0) - (a.updatedAt?.seconds || 0));
            if (surveys.length === 0) return safeGet('empty-state').classList.remove('hidden');
            safeGet('empty-state').classList.add('hidden');
            surveys.forEach(s => {
                container.innerHTML += `<div class="bg-white p-5 rounded-xl shadow-sm border border-gray-200 cursor-pointer hover:shadow-md transition" onclick="window.app.editSurvey('${s.id}')"><h3 class="font-bold text-lg truncate">${escapeHtml(s.title) || 'æœªå‘½å'}</h3><p class="text-sm text-gray-500 mb-4 line-clamp-2">${escapeHtml(s.description)}</p><div class="flex justify-end gap-2 pt-4 border-t" onclick="event.stopPropagation()"><button onclick="window.app.viewStats('${s.id}')" class="text-gray-500 text-xs bg-gray-100 px-2 py-1 rounded">çµ±è¨ˆ</button><button onclick="window.app.openShare('${s.id}')" class="text-green-600 text-xs bg-green-50 px-2 py-1 rounded">ç™¼å¸ƒ</button><button onclick="window.app.requestDelete('${s.id}')" class="text-red-500 text-xs bg-red-50 px-2 py-1 rounded">åˆªé™¤</button></div></div>`;
            });
        }

        async function loadSurveys() {
            try {
                const snap = await getDocs(collection(state.db, 'artifacts', APP_ID, 'users', state.user.uid, 'surveys'));
                state.surveysCache = {};
                snap.forEach(doc => { state.surveysCache[doc.id] = { id: doc.id, ...doc.data() }; });
                renderList();
            } catch(e) { console.error(e); showToast('è®€å–å¤±æ•—', 'error'); }
        }

        async function loadPublic() {
            try {
                const snap = await getDoc(doc(state.db, 'artifacts', APP_ID, 'users', uId, 'surveys', sId));
                if(!snap.exists()) throw new Error("å•å·ä¸å­˜åœ¨");
                const data = snap.data();
                safeGet('public-title').textContent = data.title;
                safeGet('public-desc').textContent = data.description;
                
                const form = safeGet('public-form');
                form.innerHTML = (data.questions || []).map((q, idx) => {
                    if (q.type === 'section') return `<div class="public-q-item border-b pb-2 mb-6 mt-8" data-type="section"><h3 class="text-xl font-bold text-blue-800">${escapeHtml(q.text)}</h3><p class="text-gray-600">${escapeHtml(q.description)}</p></div>`;
                    
                    const name = `q_${idx}`;
                    const reqAttr = q.required ? 'data-req="true"' : '';
                    const reqMark = q.required ? '<span class="text-red-500">*</span>' : '';
                    const qId = `pq-${idx}`;
                    
                    let inputHtml = '';
                    if (q.type === 'text') {
                        inputHtml = `<input type="text" name="${name}" class="w-full border rounded p-3 bg-gray-50 focus:bg-white transition" oninput="window.app.updateProgressBar()">`;
                    } else if (q.type === 'radio') {
                        const count = q.options.length;
                        let grid = 'w-[48%]'; if(count >= 7) grid = 'w-[23%]'; else if(count===5) grid = 'w-[31%]'; else if(count===3) grid = 'w-[31%]';
                        inputHtml = `<div class="flex flex-wrap justify-center gap-2">` + q.options.map((opt, i) => {
                             const emoji = getEmoji(i, count);
                             const col = getColor(i, count);
                             return `<label class="${grid} flex-grow-0 flex-shrink-0 cursor-pointer group"><input type="radio" name="${name}" value="${escapeHtml(opt)}" class="peer sr-only" onchange="window.app.updateProgressBar(); window.scrollToNext(this)"><div class="h-full p-2 border rounded text-center text-sm font-bold bg-white flex flex-col items-center justify-center min-h-[60px] group-hover:border-blue-300 transition ${col} opacity-90"><div class="text-2xl mb-1">${emoji}</div><div class="leading-tight">${escapeHtml(opt)}</div></div></label>`;
                        }).join('') + `</div>`;
                    } else {
                        inputHtml = `<div class="space-y-2">` + q.options.map(opt => `<label class="flex items-center gap-2 p-2 border rounded bg-white"><input type="checkbox" name="${name}" value="${escapeHtml(opt)}" class="w-5 h-5 text-blue-600" onchange="window.app.updateProgressBar()"><span>${escapeHtml(opt)}</span></label>`).join('') + `</div>`;
                    }

                    return `<div id="${qId}" class="public-q-item public-q-wrapper space-y-3 mb-8 p-4 rounded-xl transition duration-300 bg-white shadow-sm" ${reqAttr} data-type="${q.type}" data-name="${name}"><h4 class="font-bold text-lg text-gray-800">${idx+1}. ${escapeHtml(q.text)} ${reqMark}</h4>${inputHtml}</div>`;
                }).join('');
                switchView('view-public');
            } catch(e) { safeGet('loading-view').innerHTML = `<div class="text-red-500 p-10 text-center">${e.message}</div>`; }
        }

        onAuthStateChanged(state.auth, (user) => {
            safeGet('loading-view').classList.add('hidden');
            state.user = user;
            if (state.mode === 'public') {
                if (!user) signInAnonymously(state.auth).catch(console.error); else loadPublic();
            } else {
                if (user) {
                    safeGet('admin-nav').classList.remove('hidden');
                    safeGet('user-info').textContent = user.isAnonymous ? 'è¨ªå®¢' : user.email;
                    safeGet('guest-warning').classList.toggle('hidden', !user.isAnonymous);
                    switchView('view-dashboard');
                    loadSurveys();
                } else switchView('view-login');
            }
        });
    </script>
</body>
</html>
