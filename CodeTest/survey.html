<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>å•å·ã®æ£®</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <!-- å¼•å…¥åœ“æ½¤å­—é«” -->
    <link href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@400;500;700&display=swap" rel="stylesheet">

    <style>
        /* å‰åœåŠ›é¢¨æ ¼åŸºç¤è¨­å®š */
        :root {
            --ghibli-cream: #FAF7F0;
            --ghibli-sky: #D8E9F0;
            --ghibli-green: #568A66;
            --ghibli-green-dark: #3E664B;
            --ghibli-brown: #8B5E3C;
            --ghibli-red: #E67F65;
            --ghibli-text: #4A4A4A;
        }

        html, body { 
            overflow-x: hidden; 
            min-height: 100dvh; 
            background-color: var(--ghibli-cream); 
            /* åŠ ä¸Šæ·¡æ·¡çš„ç´™å¼µç´‹ç†èƒŒæ™¯ */
            background-image: radial-gradient(#E5E0D0 1px, transparent 1px);
            background-size: 20px 20px;
            font-family: 'Zen Maru Gothic', 'Noto Sans TC', sans-serif; 
            color: var(--ghibli-text);
            -webkit-tap-highlight-color: transparent; 
        }
        
        body { display: flex; flex-direction: column; }
        
        /* æŸ”å’Œçš„æµ®ç¾å‹•ç•« */
        .fade-in { animation: fadeIn 0.6s cubic-bezier(0.22, 1, 0.36, 1) forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px) scale(0.98); } to { opacity: 1; transform: translateY(0) scale(1); } }
        
        /* å‰åœåŠ›é¢¨æ ¼å¡ç‰‡ */
        .ghibli-card {
            background: white;
            border-radius: 20px;
            box-shadow: 
                0 4px 6px -1px rgba(0, 0, 0, 0.05), 
                0 10px 15px -3px rgba(86, 138, 102, 0.1); /* æ·¡æ·¡çš„ç¶ è‰²é™°å½± */
            border: 1px solid rgba(255, 255, 255, 0.5);
            transition: all 0.3s ease;
        }
        
        /* é¸é …äº’å‹• */
        input:checked + div { 
            transform: scale(0.98) translateY(2px); 
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.1); 
            font-weight: bold; 
            background-color: #F0F7F4; /* æ¥µæ·¡çš„ç¶  */
            border-color: var(--ghibli-green);
            color: var(--ghibli-green-dark);
        }

        /* æŒ‰éˆ•é¢¨æ ¼ï¼šåƒæœå¯¦æˆ–å¯¶çŸ³ */
        .btn-ghibli-primary {
            background-color: var(--ghibli-green);
            color: white;
            border-radius: 16px;
            box-shadow: 0 4px 0 var(--ghibli-green-dark);
            transition: all 0.1s;
        }
        .btn-ghibli-primary:active:not(:disabled) {
            transform: translateY(4px);
            box-shadow: 0 0 0 var(--ghibli-green-dark);
        }
        .btn-ghibli-primary:disabled {
            background-color: #ccc;
            box-shadow: none;
            cursor: not-allowed;
            transform: none;
        }

        /* éŒ¯èª¤éœ‡å‹• */
        .error-shake { animation: shake 0.4s cubic-bezier(.36,.07,.19,.97) both; border-color: var(--ghibli-red) !important; background-color: #FFF5F5 !important; }
        @keyframes shake { 10%, 90% { transform: translate3d(-1px, 0, 0); } 20%, 80% { transform: translate3d(2px, 0, 0); } 30%, 50%, 70% { transform: translate3d(-4px, 0, 0); } 40%, 60% { transform: translate3d(4px, 0, 0); } }

        /* é›²æœµè£é£¾ (ç´” CSS) */
        .cloud {
            position: absolute;
            background: white;
            border-radius: 100px;
            box-shadow: 0 8px 5px rgba(0,0,0,0.05);
            z-index: -1;
        }
        .cloud::after, .cloud::before {
            content: ''; position: absolute; background: white; z-index: -1;
        }
        .cloud-1 { width: 100px; height: 40px; top: 20px; left: -10px; opacity: 0.8; animation: float 20s infinite linear; }
        .cloud-2 { width: 160px; height: 60px; top: 50px; right: -30px; opacity: 0.6; animation: float 35s infinite linear reverse; }
        @keyframes float { 0% { transform: translateX(0); } 50% { transform: translateX(20px); } 100% { transform: translateX(0); } }

        .tap-target { min-height: 48px; cursor: pointer; }
        .safe-pb { padding-bottom: env(safe-area-inset-bottom, 20px); }
        .question-card.dragging { opacity: 0.6; transform: rotate(2deg); border: 2px dashed var(--ghibli-green); background-color: #F0F7F4; }
        .drag-handle { cursor: grab; touch-action: none; }
        .drag-handle:active { cursor: grabbing; }
        .locked-input { background-color: #f3f3f3; border-color: #ddd; color: #999; cursor: not-allowed; }
        
        /* é‡è¡¨é¡è‰²ï¼šæŸ”å’Œç‰ˆ */
        .likert-opt-1 { color: #C05555; border-color: #EECBCB; background-color: #FFF5F5; } 
        .likert-opt-2 { color: #D98C5F; border-color: #F5DDC9; background-color: #FFFBF7; } 
        .likert-opt-3 { color: #C4A83C; border-color: #F2EBC3; background-color: #FFFFF0; } 
        .likert-opt-4 { color: #88B04B; border-color: #D8E8C3; background-color: #F4FDF0; } 
        .likert-opt-5 { color: #568A66; border-color: #C3DEC9; background-color: #F0F9F4; } 
        .opt-default { color: var(--ghibli-text); border-color: #E0E0E0; background-color: white; }
    </style>

    <!-- é å…ˆè¼‰å…¥æ ¸å¿ƒå·¥å…· -->
    <script>
        window.app = {}; 
        
        window.showToast = function(msg, type = 'success') {
            const toast = document.getElementById('toast');
            const icon = document.getElementById('toast-icon');
            const msgSpan = document.getElementById('toast-msg');
            if(!toast) return;
            
            msgSpan.textContent = msg;
            const colorClass = type === 'error' ? 'text-red-500' : 'text-green-700';
            const bgClass = type === 'error' ? 'bg-red-50 border-red-200' : 'bg-green-50 border-green-200';
            
            // é‡ç½®ä¸¦å¥—ç”¨æ–°æ¨£å¼
            icon.className = type === 'error' ? 'fa-solid fa-circle-exclamation ' + colorClass : 'fa-solid fa-leaf ' + colorClass; // ç”¨è‘‰å­ä»£æ›¿å‹¾å‹¾
            toast.className = `fixed top-20 right-5 z-[100] px-6 py-3 rounded-2xl shadow-lg flex items-center gap-3 transition-transform duration-300 border-2 ${bgClass}`;
            
            toast.style.transform = 'translateX(0) rotate(-2deg)'; // å¾®å¾®å‚¾æ–œå¢åŠ ç«¥è¶£
            setTimeout(() => { toast.style.transform = 'translateX(150%) rotate(0)'; }, 3000);
        };

        window.safeGet = function(id) {
            const el = document.getElementById(id);
            return el || { classList: { remove:()=>{}, add:()=>{}, toggle:()=>{}, contains:()=>false }, style: {}, value: '', disabled: false, innerHTML: '', addEventListener: ()=>{} }; 
        };

        window.escapeHtml = function(text) {
            if (text === null || text === undefined) return '';
            return String(text).replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
        };

        window.onerror = function(msg, url, line) {
            console.error("Global Error:", msg);
            const errorDiv = document.getElementById('global-error');
            if(errorDiv) {
                errorDiv.classList.remove('hidden');
                document.getElementById('global-error-msg').innerText = `${msg} (Line: ${line})`;
            }
            const loading = document.getElementById('loading-view');
            if(loading) loading.classList.add('hidden');
        };

        window.scrollToNext = function(currentElement) {
            const currentCard = currentElement.closest('.public-q-item');
            if (!currentCard) return;
            const nextElement = currentCard.nextElementSibling;
            if (nextElement) {
                setTimeout(() => nextElement.scrollIntoView({ behavior: 'smooth', block: 'center' }), 300);
            } else {
                setTimeout(() => {
                    const submitBtn = document.getElementById('public-submit-btn');
                    if (submitBtn) submitBtn.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }, 300);
            }
        };
        
        window.closeWindow = function() {
            try { window.close(); } catch(e) { console.log("Script cannot close window"); }
        }
    </script>
</head>
<body class="text-gray-800">

    <!-- è£é£¾é›²æœµ -->
    <div class="cloud cloud-1"></div>
    <div class="cloud cloud-2"></div>

    <!-- å…¨åŸŸéŒ¯èª¤æç¤º -->
    <div id="global-error" class="hidden fixed inset-0 bg-red-50/90 z-[200] flex flex-col items-center justify-center p-6 text-center backdrop-blur-sm">
        <div class="text-red-500 text-6xl mb-4"><i class="fa-solid fa-robot"></i></div>
        <h2 class="text-2xl font-bold text-gray-800 mb-2">å“å‘€ï¼Œå‡ºäº†ä¸€é»å°å•é¡Œ</h2>
        <p id="global-error-msg" class="text-sm text-gray-600 mt-2 font-mono bg-white p-4 rounded-xl border-2 border-red-100 shadow-sm break-all">Unknown Error</p>
        <button onclick="location.reload()" class="mt-6 btn-ghibli-primary px-6 py-3">é‡æ–°æ•´ç†æ£®æ—</button>
    </div>

    <!-- é€²åº¦æ¢ (åƒæ¤ç‰©ç”Ÿé•·) -->
    <div id="public-progress-bar" class="fixed top-0 left-0 w-full h-2 bg-gray-200 z-[60] hidden">
        <div id="progress-fill" class="h-full bg-[#568A66] transition-all duration-500 ease-out rounded-r-full" style="width: 0%"></div>
    </div>

    <!-- å°è¦½åˆ— -->
    <nav id="admin-nav" class="bg-[#568A66] text-white shadow-lg sticky top-0 z-50 hidden">
        <div class="max-w-6xl mx-auto px-4 py-3 flex justify-between items-center">
            <div class="flex items-center gap-3">
                <i class="fa-solid fa-leaf text-2xl text-[#E8D5B5]"></i>
                <h1 class="text-lg font-bold tracking-wide">å•å·ã®æ£® <span class="text-xs bg-[#3E664B] px-2 py-0.5 rounded-full ml-1 opacity-90">Admin</span></h1>
            </div>
            <div class="flex items-center gap-3">
                <div id="user-info" class="text-xs bg-[#3E664B] px-3 py-1.5 rounded-full opacity-90 hidden md:block">è¨ªå®¢</div>
                <button onclick="window.app.logout()" class="hover:bg-[#3E664B] p-2 rounded-full transition"><i class="fa-solid fa-right-from-bracket"></i></button>
            </div>
        </div>
    </nav>

    <main class="flex-1 w-full max-w-5xl mx-auto p-4 pb-20 safe-pb relative z-10">
        
        <!-- è¼‰å…¥ä¸­ -->
        <div id="loading-view" class="fixed inset-0 flex flex-col items-center justify-center bg-[#FAF7F0] z-[150]">
            <i class="fa-solid fa-seedling fa-bounce text-5xl text-[#568A66] mb-4"></i>
            <p class="text-[#8B5E3C] font-bold tracking-widest">è®€å–ä¸­...</p>
            <div id="loading-timeout" class="hidden mt-4 text-center">
                <p class="text-xs text-red-400 mb-2">ä¼¼ä¹æœ‰é»æ…¢...</p>
                <button onclick="location.reload()" class="text-xs border border-[#8B5E3C] text-[#8B5E3C] px-3 py-1 rounded-full hover:bg-[#E8D5B5] transition">é‡æ–°æ•´ç†</button>
            </div>
        </div>

        <!-- Toast å®¹å™¨ -->
        <div id="toast" class="fixed top-20 right-5 z-[100] bg-gray-800 text-white px-6 py-3 rounded-lg shadow-lg flex items-center gap-3 transition-transform duration-300 translate-x-full border-l-4 border-green-500">
            <i id="toast-icon"></i><span id="toast-msg"></span>
        </div>

        <!-- 1. ç™»å…¥ç•«é¢ -->
        <div id="view-login" class="hidden flex flex-col items-center justify-center min-h-[60vh] fade-in">
            <div class="ghibli-card p-10 w-full max-w-sm text-center relative overflow-hidden">
                <div class="absolute top-0 left-0 w-full h-2 bg-[#568A66]"></div>
                <div class="w-20 h-20 bg-[#E8D5B5] text-[#8B5E3C] rounded-full flex items-center justify-center mx-auto mb-6 shadow-inner">
                    <i class="fa-solid fa-tree text-3xl"></i>
                </div>
                <h2 class="text-2xl font-bold text-[#5B6C78] mb-6">ç®¡ç†å“¡ç™»å…¥</h2>
                <div id="file-protocol-warning" class="hidden mb-4 p-3 bg-yellow-50 text-yellow-800 text-xs rounded-lg text-left"><i class="fa-solid fa-triangle-exclamation mr-1"></i> è­¦å‘Šï¼šè«‹ä½¿ç”¨ç¶²é ä¼ºæœå™¨é–‹å•Ÿã€‚</div>
                <div class="space-y-4 text-left">
                    <div><label class="text-xs font-bold text-gray-500 ml-1">é›»å­éƒµä»¶</label><input type="email" id="login-email" class="w-full bg-[#f9f9f9] border-2 border-[#eee] rounded-xl p-3 focus:border-[#568A66] focus:outline-none transition text-sm" placeholder="email@example.com"></div>
                    <div><label class="text-xs font-bold text-gray-500 ml-1">å¯†ç¢¼</label><input type="password" id="login-password" class="w-full bg-[#f9f9f9] border-2 border-[#eee] rounded-xl p-3 focus:border-[#568A66] focus:outline-none transition text-sm" placeholder="******"></div>
                </div>
                <div class="grid grid-cols-2 gap-3 mt-8">
                    <button onclick="window.app.login()" class="btn-ghibli-primary py-3 font-bold">ç™»å…¥</button>
                    <button onclick="window.app.register()" class="bg-white text-[#568A66] border-2 border-[#568A66] py-3 rounded-2xl font-bold hover:bg-[#F0F9F4] transition">è¨»å†Š</button>
                </div>
            </div>
        </div>

        <!-- 2. å„€è¡¨æ¿ -->
        <div id="view-dashboard" class="hidden fade-in">
            <div id="guest-warning" class="hidden bg-[#FFF8E1] border-l-4 border-[#FFB74D] p-4 mb-8 rounded-r-xl shadow-sm flex gap-3 items-start">
                <i class="fa-solid fa-triangle-exclamation text-[#FF9800] mt-1"></i>
                <div class="text-sm text-[#5D4037]"><strong>è¨ªå®¢æ¨¡å¼ï¼š</strong> è³‡æ–™åƒ…æš«å­˜ã€‚å»ºè­°<button onclick="window.app.logout()" class="underline font-bold">ç™»å‡ºä¸¦è¨»å†Š</button>ä»¥æ°¸ä¹…ä¿å­˜ã€‚</div>
            </div>
            <div class="flex justify-between items-center mb-8">
                <h2 class="text-3xl font-bold text-[#5B6C78] tracking-tight">æˆ‘çš„å•å·</h2>
                <button onclick="window.app.createSurvey()" class="btn-ghibli-primary px-6 py-3 flex items-center gap-2 font-bold">
                    <i class="fa-solid fa-plus"></i> æ–°å»ºå•å·
                </button>
            </div>
            <div id="survey-list-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
            <div id="empty-state" class="hidden flex flex-col items-center justify-center py-32 text-gray-400 border-4 border-dashed border-[#E0E0E0] rounded-3xl bg-white/50">
                <i class="fa-solid fa-wind text-5xl mb-4 text-[#ccc]"></i>
                <p>é€™è£¡ç©ºç©ºçš„ï¼Œåƒé¢¨ä¸€æ¨£...</p>
            </div>
        </div>

        <!-- 3. ç·¨è¼¯å™¨ -->
        <div id="view-editor" class="hidden fade-in">
            <div class="sticky top-0 z-30 bg-[rgba(250,247,240,0.9)] backdrop-blur-sm py-3 flex justify-between items-center mb-4 -mx-4 px-4 border-b border-[#eee]">
                <button onclick="window.app.backToDashboard()" class="text-[#5B6C78] bg-white border border-[#ddd] px-4 py-2 rounded-xl text-sm shadow-sm hover:bg-[#eee] transition"><i class="fa-solid fa-arrow-left mr-1"></i> è¿”å›</button>
                <div class="flex gap-2">
                    <span id="unsaved-badge" class="hidden px-3 py-1 bg-[#FFF5F5] text-[#E67F65] text-xs rounded-full border border-[#FED7D7] flex items-center font-bold">æœªå„²å­˜</span>
                    <button id="btn-import" onclick="window.app.openBatchModal()" class="bg-white text-[#568A66] border border-[#568A66] px-4 py-2 rounded-xl text-sm font-bold hover:bg-[#F0F9F4] transition"><i class="fa-solid fa-bolt mr-1"></i> åŒ¯å…¥</button>
                </div>
            </div>
            <div id="locked-banner" class="hidden bg-[#FFF8E1] border-l-4 border-[#FFB74D] p-3 mb-6 rounded-r-xl shadow-sm text-sm text-[#5D4037] flex justify-between items-center">
                <span><i class="fa-solid fa-lock mr-1"></i> æ­¤å•å·å·²ç™¼å¸ƒé–å®š</span>
                <button onclick="window.app.duplicateCurrent()" class="underline font-bold">è¤‡è£½ä»¥ç·¨è¼¯</button>
            </div>
            
            <!-- å•å·æ¨™é¡Œå€å¡Š -->
            <div class="ghibli-card p-6 md:p-8 mb-8 relative overflow-hidden">
                <div class="absolute top-0 left-0 w-2 h-full bg-[#568A66]"></div>
                <input type="text" id="edit-title" class="w-full text-2xl font-bold border-b-2 border-transparent hover:border-[#ddd] focus:border-[#568A66] outline-none py-2 transition bg-transparent text-[#2D3748] placeholder-gray-300" placeholder="è«‹è¼¸å…¥å•å·æ¨™é¡Œ" oninput="window.app.markDirty()">
                <textarea id="edit-desc" class="w-full text-gray-600 mt-4 border-b-2 border-transparent hover:border-[#ddd] focus:border-[#568A66] outline-none py-2 transition bg-transparent resize-none leading-relaxed" rows="1" placeholder="è«‹è¼¸å…¥å•å·èªªæ˜ï¼Œåƒåœ¨èªªæ•…äº‹ä¸€æ¨£..." oninput="window.app.markDirty(); window.app.autoGrow(this)"></textarea>
            </div>

            <div id="editor-questions" class="space-y-6 mb-32"></div>
            
            <div id="editor-toolbar" class="fixed bottom-6 left-1/2 transform -translate-x-1/2 bg-white border border-gray-200 px-6 py-3 rounded-full shadow-2xl flex items-center gap-4 z-40 safe-pb hover:-translate-y-1 transition duration-300">
                 <div class="flex gap-2 pr-4 border-r border-gray-200">
                    <button onclick="window.app.addQuestion('text')" class="flex flex-col items-center justify-center w-10 h-10 text-gray-500 hover:text-[#568A66] transition" title="æ–°å¢é¡Œç›®"><i class="fa-solid fa-plus text-xl"></i></button>
                    <button onclick="window.app.addQuestion('section')" class="flex flex-col items-center justify-center w-10 h-10 text-gray-500 hover:text-[#E9967A] transition" title="æ–°å¢æ®µè½"><i class="fa-solid fa-align-left text-xl"></i></button>
                 </div>
                 <button onclick="window.app.saveSurvey()" class="bg-[#568A66] text-white px-6 py-2 rounded-full font-bold shadow-md hover:bg-[#3E664B] transition flex items-center gap-2">
                    <i class="fa-solid fa-cloud-arrow-up"></i> å„²å­˜
                 </button>
            </div>
        </div>

        <!-- 4. å…¬é–‹å¡«å¯« (Public View) -->
        <div id="view-public" class="hidden w-full max-w-2xl mx-auto fade-in pb-24 pt-4">
            <div class="ghibli-card overflow-hidden mb-8">
                <div class="bg-[#D8E9F0] h-32 relative">
                    <!-- è£é£¾æ€§å¤©ç©º -->
                    <div class="cloud cloud-1" style="top: 10px; left: 10px; opacity: 0.9; transform: scale(0.6);"></div>
                    <div class="cloud cloud-2" style="top: 40px; right: 20px; opacity: 0.8; transform: scale(0.8);"></div>
                </div>
                <div class="p-8 -mt-6 relative z-10">
                    <div class="bg-white p-4 rounded-2xl shadow-sm border border-gray-100">
                        <h1 id="public-title" class="text-3xl font-bold text-[#2D3748] mb-4 leading-tight text-center">è¼‰å…¥ä¸­...</h1>
                        <div id="public-desc" class="text-gray-600 whitespace-pre-wrap text-base leading-relaxed text-justify"></div>
                    </div>
                </div>
            </div>

            <form id="public-form" class="space-y-6"></form>
            
            <div class="mt-12 text-center">
                <button id="public-submit-btn" type="button" onclick="window.app.submitResponse()" class="w-full max-w-xs btn-ghibli-primary py-4 text-xl font-bold shadow-xl hover:shadow-2xl transform hover:-translate-y-1 transition">
                    é€å‡ºå•å· <i class="fa-solid fa-paper-plane ml-2"></i>
                </button>
            </div>
        </div>

        <!-- 5. æ„Ÿè¬é  -->
        <div id="view-thankyou" class="hidden flex flex-col items-center justify-center min-h-[80vh] text-center fade-in px-4 relative">
            <div class="ghibli-card p-12 w-full max-w-md relative overflow-hidden">
                <!-- å…‰æšˆèƒŒæ™¯ -->
                <div class="absolute -top-10 -left-10 w-40 h-40 bg-[#D8E9F0] rounded-full blur-3xl opacity-50"></div>
                <div class="absolute -bottom-10 -right-10 w-40 h-40 bg-[#F4FDF0] rounded-full blur-3xl opacity-50"></div>
                
                <div class="w-24 h-24 bg-[#F0F9F4] text-[#568A66] rounded-full flex items-center justify-center mx-auto mb-6 animate-success-pop border-4 border-white shadow-inner">
                    <i class="fa-solid fa-check text-5xl"></i>
                </div>
                <h2 class="text-3xl font-bold text-[#5B6C78] mb-3">æ„Ÿè¬æ‚¨çš„å¡«å¯«ï¼</h2>
                <p class="text-gray-500 mb-8">æ‚¨çš„å¿ƒè²æˆ‘å€‘å·²ç¶“æ”¶åˆ°äº†ã€‚</p>
                
                <div class="border-t border-gray-100 pt-6">
                    <div class="bg-[#F9FAFB] p-4 rounded-xl border border-[#EDF2F7]">
                        <p class="text-gray-800 font-bold mb-1 text-sm">æ‚¨ç¾åœ¨å¯ä»¥å®‰å…¨åœ°é›¢é–‹</p>
                        <p class="text-xs text-gray-400">è«‹ç›´æ¥é—œé–‰ç€è¦½å™¨åˆ†é å³å¯ã€‚</p>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Modals -->
    <div id="modal-overlay" class="hidden fixed inset-0 bg-[#5B6C78]/50 z-[60] flex items-center justify-center p-4 fade-in backdrop-blur-sm">
        <div id="modal-content" class="bg-white rounded-3xl shadow-2xl w-full max-w-lg max-h-[90vh] flex flex-col overflow-hidden relative border-4 border-white"></div>
    </div>

    <!-- Delete Modal -->
    <div id="delete-modal" class="hidden fixed inset-0 bg-[#5B6C78]/50 z-[70] flex items-center justify-center p-4 fade-in backdrop-blur-sm">
        <div class="bg-white rounded-3xl shadow-2xl p-8 max-w-sm w-full text-center border-4 border-white">
            <div class="w-16 h-16 bg-red-100 text-red-500 rounded-full flex items-center justify-center mx-auto mb-4"><i class="fa-solid fa-trash-can text-2xl"></i></div>
            <h3 class="text-lg font-bold text-gray-800">ç¢ºå®šåˆªé™¤ï¼Ÿ</h3>
            <p class="text-sm text-gray-500 mt-2 mb-8">åˆªé™¤å¾Œå°±åƒè½è‘‰ä¸€æ¨£ï¼Œå›ä¸ä¾†äº†å–”ã€‚</p>
            <div class="flex gap-3">
                <button onclick="safeGet('delete-modal').classList.add('hidden')" class="flex-1 py-3 border-2 border-gray-200 rounded-2xl font-bold text-gray-600 hover:bg-gray-50 transition">å–æ¶ˆ</button>
                <button onclick="window.app.confirmDelete()" class="flex-1 py-3 bg-red-500 text-white rounded-2xl font-bold shadow-md hover:bg-red-600 transition">ç¢ºèªåˆªé™¤</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken, signOut, createUserWithEmailAndPassword, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, getDoc, getDocs, deleteDoc, addDoc, serverTimestamp, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
          apiKey: "AIzaSyAexk_JbIOQWV1Jw7hqfiZDDZYY9YF-Sdk",
          authDomain: "survey-49e8d.firebaseapp.com",
          projectId: "survey-49e8d",
          storageBucket: "survey-49e8d.firebasestorage.app",
          messagingSenderId: "547257703502",
          appId: "1:547257703502:web:85e147bed62333b11c771f"
        };
        
        const APP_ID = 'survey-app';
        const state = { db: null, auth: null, user: null, currentSurveyId: null, surveysCache: {}, isDirty: false, mode: 'admin' };
        let surveyIdToDelete = null;

        const urlParams = new URLSearchParams(window.location.search);
        const sId = urlParams.get('s');
        const uId = urlParams.get('u');
        if (sId && uId) state.mode = 'public';

        try {
            const app = initializeApp(firebaseConfig);
            state.auth = getAuth(app);
            state.db = getFirestore(app);
            if (state.mode === 'public') signInAnonymously(state.auth).catch(console.error);
        } catch (e) { console.error(e); alert("Firebase Init Error"); }

        const getEmoji = (idx, total) => {
            const emojis = ['ğŸ˜¡', 'ğŸ™', 'ğŸ˜', 'ğŸ˜Š', 'ğŸ¤©'];
            if (total <= 5) return idx < 5 ? emojis[idx] : '';
            if (total <= 7) return idx < 7 ? ['ğŸ˜¡', 'ğŸ˜ ', 'ğŸ™', 'ğŸ˜', 'ğŸ™‚', 'ğŸ˜Š', 'ğŸ¤©'][idx] : '';
            return '';
        };
        const getColor = (idx, total) => {
             if(total <= 7) {
                 const n = idx + 1;
                 if(n <= 2) return 'likert-opt-1'; 
                 if(n <= 3 && total > 3) return 'likert-opt-2'; 
                 if(n == Math.ceil(total/2)) return 'likert-opt-3'; 
                 if(n >= total-1) return 'likert-opt-5'; 
                 return 'likert-opt-4';
             }
             return 'opt-default';
        };

        window.app.login = async () => { try { await signInWithEmailAndPassword(state.auth, safeGet('login-email').value, safeGet('login-password').value); } catch(e) { showToast(e.code, 'error'); } };
        window.app.register = async () => { try { await createUserWithEmailAndPassword(state.auth, safeGet('login-email').value, safeGet('login-password').value); showToast("è¨»å†ŠæˆåŠŸ"); } catch(e) { showToast(e.code, 'error'); } };
        window.app.logout = async () => { await signOut(state.auth); location.reload(); };

        window.app.backToDashboard = () => { if(state.isDirty && !confirm("æœªå„²å­˜è®Šæ›´å°‡éºå¤±")) return; switchView('view-dashboard'); renderList(); };

        window.app.createSurvey = () => {
            state.currentSurveyId = crypto.randomUUID();
            safeGet('edit-title').value = ''; safeGet('edit-desc').value = ''; safeGet('editor-questions').innerHTML = '';
            window.app.addQuestion(); 
            state.isDirty = false; updateDirtyUI();
            switchView('view-editor');
        };

        window.app.editSurvey = async (surveyId) => {
            let survey = state.surveysCache[surveyId];
            if (!survey) {
                try {
                    showToast("è®€å–è³‡æ–™ä¸­...", "info");
                    const snap = await getDoc(doc(state.db, 'artifacts', APP_ID, 'users', state.user.uid, 'surveys', surveyId));
                    if(snap.exists()) {
                        survey = { id: snap.id, ...snap.data() };
                        state.surveysCache[surveyId] = survey;
                    } else {
                        return showToast("å•å·ä¸å­˜åœ¨", "error");
                    }
                } catch (e) { return showToast("è³‡æ–™è®€å–å¤±æ•—", "error"); }
            }
            state.currentSurveyId = surveyId;
            safeGet('edit-title').value = survey.title || '';
            safeGet('edit-desc').value = survey.description || '';
            window.app.autoGrow(safeGet('edit-desc'));
            updateLock(survey.status === 'published');
            const container = safeGet('editor-questions');
            container.innerHTML = '';
            (survey.questions || []).forEach(q => window.app.addQuestion(q.type, q));
            switchView('view-editor');
        };
        
        window.app.loadEditor = window.app.editSurvey;

        window.app.addQuestion = (type = 'text', data = null) => {
            const container = safeGet('editor-questions');
            const id = `q-${Date.now()}-${Math.random().toString(36).substr(2,4)}`;
            const div = document.createElement('div');
            
            const qText = data ? data.text : '';
            const qDesc = data ? data.description : '';
            const qOpts = data ? (data.options || []).join('\n') : '';
            const qType = data ? data.type : type;
            const qReq = (data && data.required !== undefined) ? data.required : true;

            div.className = `question-item ghibli-card p-6 mb-6 relative group ${qType === 'section' ? 'border-l-8 border-[#E9967A]' : ''}`;
            div.dataset.qtype = qType;
            div.draggable = true; div.id = id; 
            div.addEventListener('dragstart', () => { div.classList.add('dragging'); });
            div.addEventListener('dragend', () => { div.classList.remove('dragging'); window.app.markDirty(); });

            if (qType === 'section') {
                div.innerHTML = `
                    <div class="flex justify-between mb-4 cursor-grab active:cursor-grabbing drag-handle border-b pb-2">
                        <span class="text-xs font-bold text-[#E9967A] flex items-center gap-1"><i class="fa-solid fa-grip-vertical opacity-50"></i> æ®µè½èªªæ˜</span>
                        <button onclick="this.closest('.question-item').remove(); window.app.markDirty()" class="text-gray-300 hover:text-red-500 transition"><i class="fa-solid fa-trash"></i></button>
                    </div>
                    <input type="text" class="q-input w-full bg-transparent border-b-2 border-[#eee] focus:border-[#E9967A] p-2 mb-3 font-bold text-lg placeholder-gray-300 transition outline-none" placeholder="æ®µè½æ¨™é¡Œ" value="${escapeHtml(qText)}" oninput="window.app.markDirty()">
                    <textarea class="q-desc w-full bg-[#FAF7F0] border-0 rounded-lg p-3 text-sm text-gray-600 resize-none" rows="2" placeholder="åœ¨æ­¤è¼¸å…¥æ®µè½çš„è©³ç´°èªªæ˜..." oninput="window.app.markDirty()">${escapeHtml(qDesc)}</textarea>
                `;
            } else {
                div.innerHTML = `
                    <div class="flex justify-between mb-4 cursor-grab active:cursor-grabbing drag-handle">
                        <span class="text-xs font-bold text-[#568A66] bg-[#F0F9F4] px-3 py-1 rounded-full flex items-center gap-1"><i class="fa-solid fa-grip-vertical opacity-50"></i> å•é¡Œ</span>
                        <div class="flex items-center gap-3">
                            <label class="text-xs cursor-pointer flex items-center text-gray-500 hover:text-[#568A66]"><input type="checkbox" class="q-req mr-1 accent-[#568A66]" ${qReq ? 'checked' : ''} onchange="window.app.markDirty()">å¿…å¡«</label>
                            <button onclick="this.closest('.question-item').remove(); window.app.markDirty()" class="text-gray-300 hover:text-red-500 transition"><i class="fa-solid fa-trash"></i></button>
                        </div>
                    </div>
                    <input type="text" class="q-input w-full border-2 border-[#eee] rounded-xl p-3 mb-3 focus:border-[#568A66] outline-none transition" placeholder="è«‹è¼¸å…¥é¡Œç›®å…§å®¹" value="${escapeHtml(qText)}" oninput="window.app.markDirty()">
                    <div class="flex gap-3 mb-3">
                        <select class="q-type w-1/3 border-2 border-[#eee] rounded-xl p-2 bg-white text-sm focus:border-[#568A66] outline-none" onchange="window.app.toggleOpts(this)">
                            <option value="text" ${qType==='text'?'selected':''}>ç°¡ç­”é¡Œ</option>
                            <option value="radio" ${qType==='radio'?'selected':''}>å–®é¸é¡Œ</option>
                            <option value="checkbox" ${qType==='checkbox'?'selected':''}>å¤šé¸é¡Œ</option>
                        </select>
                    </div>
                    <textarea class="q-opts w-full border-2 border-[#eee] rounded-xl p-3 h-24 font-mono text-sm bg-[#FAF7F0] focus:border-[#568A66] outline-none transition ${qType==='text'?'hidden':''}" placeholder="é¸é …1&#10;é¸é …2&#10;é¸é …3" oninput="window.app.markDirty()">${escapeHtml(qOpts)}</textarea>
                `;
            }
            container.appendChild(div);
            window.app.markDirty();
        };

        window.app.toggleOpts = (el) => {
            const item = el.closest('.question-item');
            item.dataset.qtype = el.value;
            const area = item.querySelector('.q-opts');
            if(area) {
                if (el.value === 'text') area.classList.add('hidden');
                else area.classList.remove('hidden');
            }
            window.app.markDirty();
        };

        window.app.saveSurvey = async () => {
            if (!state.user) return;
            const btn = document.querySelector('#editor-toolbar button:last-child');
            btn.disabled = true; btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> å„²å­˜ä¸­';
            try {
                const title = safeGet('edit-title').value.trim();
                const desc = safeGet('edit-desc').value.trim();
                if (!title) throw new Error("è«‹è¼¸å…¥æ¨™é¡Œ");
                
                const questions = [];
                document.querySelectorAll('.question-item').forEach(item => {
                    const type = item.dataset.qtype || 'text';
                    const text = item.querySelector('.q-input').value.trim();
                    if (!text) return;
                    if (type === 'section') {
                        questions.push({ type, text, description: item.querySelector('.q-desc').value.trim() });
                    } else {
                        const req = item.querySelector('.q-req').checked;
                        let opts = [];
                        const optsArea = item.querySelector('.q-opts');
                        if (type !== 'text' && optsArea) opts = optsArea.value.split('\n').map(x=>x.trim()).filter(x=>x);
                        questions.push({ type: type, text, required: req, options: opts });
                    }
                });
                const data = { title, description: desc, questions, updatedAt: serverTimestamp(), status: state.surveysCache[state.currentSurveyId]?.status || 'draft' };
                await setDoc(doc(state.db, 'artifacts', APP_ID, 'users', state.user.uid, 'surveys', state.currentSurveyId), data, {merge: true});
                state.isDirty = false; updateDirtyUI(); showToast('å„²å­˜æˆåŠŸ');
                state.surveysCache[state.currentSurveyId] = { ...data, id: state.currentSurveyId };
            } catch (e) { console.error(e); showToast(e.message, 'error'); } finally { btn.disabled = false; btn.innerHTML = '<i class="fa-solid fa-cloud-arrow-up"></i> å„²å­˜'; }
        };

        window.app.openBatchModal = () => { safeGet('modal-overlay').classList.remove('hidden'); safeGet('modal-content').innerHTML = `<div class="p-8"><h3 class="text-xl font-bold mb-4 text-[#5B6C78]">æ‰¹é‡åŒ¯å…¥é¡Œç›®</h3><p class="text-sm text-gray-500 mb-2">è«‹å°‡é¡Œç›®è²¼åœ¨ä¸‹æ–¹ï¼Œä¸€è¡Œä¸€é¡Œã€‚</p><textarea id="batch-text" class="w-full border-2 border-[#eee] rounded-xl p-4 h-60 text-sm focus:border-[#568A66] outline-none resize-none" placeholder="é¡Œç›®1\né¡Œç›®2..."></textarea><div class="mt-6 flex justify-end gap-3"><button onclick="safeGet('modal-overlay').classList.add('hidden')" class="px-6 py-2 rounded-xl font-bold text-gray-500 hover:bg-gray-100 transition">å–æ¶ˆ</button><button onclick="window.app.doImport()" class="btn-ghibli-primary px-6 py-2 font-bold">é–‹å§‹åŒ¯å…¥</button></div></div>`; };
        window.app.doImport = () => { const lines = safeGet('batch-text').value.split('\n').filter(l=>l.trim()); lines.forEach(l => window.app.addQuestion('radio', {text: l, type: 'radio', required: true, options: ['éå¸¸æ»¿æ„','æ»¿æ„','æ™®é€š','ä¸æ»¿æ„','éå¸¸ä¸æ»¿æ„']})); safeGet('modal-overlay').classList.add('hidden'); window.app.markDirty(); };
        window.app.openShare = (id) => { const link = `${window.location.origin}${window.location.pathname}?s=${id}&u=${state.user.uid}`; safeGet('modal-overlay').classList.remove('hidden'); safeGet('modal-content').innerHTML = `<div class="p-8 text-center"><h3 class="text-xl font-bold mb-6 text-[#5B6C78]">ç™¼å¸ƒå•å·</h3><div class="bg-[#F0F9F4] p-4 rounded-2xl mb-6 border border-[#C3DEC9]"><p class="text-xs text-[#3E664B] mb-2 font-bold uppercase tracking-widest">å•å·é€£çµ</p><input class="w-full bg-white border border-[#C3DEC9] p-3 rounded-xl text-sm text-[#3E664B] mb-3 font-mono" value="${link}" readonly><button onclick="navigator.clipboard.writeText('${link}');showToast('å·²è¤‡è£½')" class="btn-ghibli-primary w-full py-2 font-bold text-sm">è¤‡è£½é€£çµ</button></div><div class="text-center"><p class="text-xs text-gray-400 mb-2">æ‰‹æ©Ÿæƒæ QR Code</p><img src="https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=${encodeURIComponent(link)}" class="mx-auto rounded-xl border-4 border-white shadow-lg"></div><button onclick="safeGet('modal-overlay').classList.add('hidden')" class="mt-8 text-gray-400 hover:text-gray-600 underline text-sm">é—œé–‰è¦–çª—</button></div>`; const s = state.surveysCache[id]; if(s && s.status!=='published') updateDoc(doc(state.db, 'artifacts', APP_ID, 'users', state.user.uid, 'surveys', id), {status:'published'}); };
        window.app.viewStats = async (id) => { 
            safeGet('modal-overlay').classList.remove('hidden'); 
            safeGet('modal-content').innerHTML = '<div class="p-10 text-center"><i class="fa-solid fa-circle-notch fa-spin text-3xl text-[#568A66]"></i></div>';
            const snap = await getDocs(collection(state.db, 'artifacts', APP_ID, 'users', state.user.uid, 'surveys', id, 'responses'));
            safeGet('modal-content').innerHTML = `<div class="p-8"><div class="flex justify-between items-center mb-6"><h3 class="text-xl font-bold text-[#5B6C78]">çµ±è¨ˆæ¦‚è¦½</h3><span class="bg-[#F0F9F4] text-[#3E664B] px-3 py-1 rounded-full text-sm font-bold">å…± ${snap.size} ä»½å›è¦†</span></div><div class="bg-yellow-50 border-l-4 border-yellow-400 p-4 mb-6 rounded-r"><p class="text-sm text-yellow-800">è©³ç´°æ•¸æ“šè«‹åŒ¯å‡º Excel é€²è¡Œåˆ†æã€‚</p></div><div class="flex justify-end gap-3"><button onclick="safeGet('modal-overlay').classList.add('hidden')" class="px-4 py-2 text-gray-500 hover:bg-gray-100 rounded-xl font-bold">é—œé–‰</button><button class="btn-ghibli-primary px-6 py-2 font-bold" id="export-btn" onclick="window.app.exportToCSV('${id}')"><i class="fa-solid fa-file-csv mr-2"></i>åŒ¯å‡º Excel</button></div></div>`;
        };
        window.app.exportToCSV = async (id) => {
             const btn = document.getElementById('export-btn'); btn.innerText = "è™•ç†ä¸­..."; btn.disabled = true;
             try {
                const survey = state.surveysCache[id];
                const snap = await getDocs(collection(state.db, 'artifacts', APP_ID, 'users', state.user.uid, 'surveys', id, 'responses'));
                let csv = "\uFEFFæ™‚é–“,";
                survey.questions.forEach((q, i) => csv += `"${q.text.replace(/"/g,'""')}",`);
                csv += "\n";
                snap.forEach(doc => {
                    const d = doc.data();
                    csv += `"${new Date(d.submittedAt.seconds*1000).toLocaleString()}",`;
                    survey.questions.forEach((q, i) => {
                        if(q.type==='section') csv += ",";
                        else {
                            let a = d.answers[`q_${i}`];
                            if(Array.isArray(a)) a = a.join(';');
                            csv += `"${(a||'').toString().replace(/"/g,'""')}",`;
                        }
                    });
                    csv += "\n";
                });
                const url = URL.createObjectURL(new Blob([csv], {type: 'text/csv'}));
                const a = document.createElement('a'); a.href = url; a.download = `${survey.title}.csv`; a.click();
            } catch(e) { console.error(e); alert("åŒ¯å‡ºå¤±æ•—"); } finally { btn.innerText = "åŒ¯å‡º Excel"; btn.disabled = false; }
        };
        
        window.app.requestDelete = (id) => {
            surveyIdToDelete = id;
            safeGet('delete-modal').classList.remove('hidden');
        };
        window.app.confirmDelete = async () => {
             if(!surveyIdToDelete) return;
             safeGet('delete-modal').classList.add('hidden');
             try { await deleteDoc(doc(state.db, 'artifacts', APP_ID, 'users', state.user.uid, 'surveys', surveyIdToDelete)); showToast("åˆªé™¤æˆåŠŸ"); loadSurveys(); } 
             catch(e) { showToast("åˆªé™¤å¤±æ•—", "error"); }
        };
        
        window.app.markDirty = () => { state.isDirty = true; updateDirtyUI(); };
        window.app.autoGrow = (el) => { el.style.height = 'auto'; el.style.height = el.scrollHeight + 'px'; };

        // --- Public Logic ---
        window.app.updateProgressBar = () => {
            const form = safeGet('public-form');
            const total = form.querySelectorAll('.public-q-item:not([data-type="section"])').length; 
            if(total === 0) return;
            const answered = new Set();
            new FormData(form).forEach((v, k) => { if(v) answered.add(k); });
            safeGet('progress-fill').style.width = Math.round((answered.size / total) * 100) + '%';
        };

        window.app.submitResponse = async () => {
             const form = safeGet('public-form');
             let firstInvalid = null;
             form.querySelectorAll('.public-q-item:not([data-type="section"])').forEach(item => {
                 item.classList.remove('error-shake', 'ring-2', 'ring-red-500');
                 if (item.dataset.req === 'true') {
                     const name = item.dataset.name;
                     const type = item.dataset.type;
                     let valid = false;
                     if (type === 'text') { if(form.querySelector(`[name="${name}"]`).value.trim()) valid = true; }
                     else { if(form.querySelector(`[name="${name}"]:checked`)) valid = true; }
                     
                     if (!valid) {
                         item.classList.add('error-shake', 'ring-2', 'ring-red-500', 'rounded-xl');
                         if(!firstInvalid) firstInvalid = item;
                     }
                 }
             });

             if (firstInvalid) {
                 showToast("é‚„æœ‰å¿…å¡«æœªå®Œæˆ", 'error');
                 firstInvalid.scrollIntoView({behavior:'smooth', block:'center'});
                 return;
             }
             const btn = safeGet('public-submit-btn');
             btn.disabled = true; btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin mr-2"></i> å‚³é€ä¸­...';
             try {
                 const formData = new FormData(form);
                 const answers = {};
                 form.querySelectorAll('.public-q-item').forEach(div => {
                     const type = div.dataset.type;
                     if (type === 'section') return; 
                     const name = div.dataset.name;
                     if (type === 'checkbox') answers[name] = formData.getAll(name);
                     else answers[name] = formData.get(name);
                 });
                 await addDoc(collection(state.db, 'artifacts', APP_ID, 'users', uId, 'surveys', sId, 'responses'), { answers, submittedAt: serverTimestamp() });
                 switchView('view-thankyou');
             } catch(e) { console.error(e); showToast("æäº¤å¤±æ•—", 'error'); btn.disabled = false; btn.innerText = "é€å‡ºå•å·"; }
        };

        function switchView(id) {
            ['view-login','view-dashboard','view-editor','view-public','view-thankyou'].forEach(v => safeGet(v).classList.add('hidden'));
            safeGet(id).classList.remove('hidden');
            window.scrollTo(0,0);
        }
        function updateLock(isLocked) {
             // Logic Removed
        }
        function updateDirtyUI() { safeGet('unsaved-badge').classList.toggle('hidden', !state.isDirty); }
        
        function renderList() {
            const container = safeGet('survey-list-container');
            container.innerHTML = '';
            const surveys = Object.values(state.surveysCache).sort((a, b) => (b.updatedAt?.seconds || 0) - (a.updatedAt?.seconds || 0));
            if (surveys.length === 0) return safeGet('empty-state').classList.remove('hidden');
            safeGet('empty-state').classList.add('hidden');
            surveys.forEach(s => {
                container.innerHTML += `
                <div class="ghibli-card p-6 cursor-pointer hover:-translate-y-1" onclick="window.app.editSurvey('${s.id}')">
                    <div class="flex justify-between mb-2">
                        <h3 class="font-bold text-xl text-[#5B6C78] truncate">${escapeHtml(s.title) || 'æœªå‘½å'}</h3>
                        ${s.status==='published'?'<span class="text-xs bg-[#F0F9F4] text-[#3E664B] px-2 py-1 rounded-full border border-[#C3DEC9]">å·²ç™¼å¸ƒ</span>':'<span class="text-xs bg-gray-100 text-gray-500 px-2 py-1 rounded-full">è‰ç¨¿</span>'}
                    </div>
                    <p class="text-sm text-gray-500 mb-6 line-clamp-2 h-10 leading-relaxed">${escapeHtml(s.description)}</p>
                    <div class="flex justify-end gap-2 pt-4 border-t border-gray-100" onclick="event.stopPropagation()">
                        <button onclick="window.app.viewStats('${s.id}')" class="text-gray-500 text-xs bg-gray-50 hover:bg-gray-100 px-3 py-1.5 rounded-lg font-bold">çµ±è¨ˆ</button>
                        <button onclick="window.app.openShare('${s.id}')" class="text-[#568A66] text-xs bg-[#F0F9F4] hover:bg-[#C3DEC9] px-3 py-1.5 rounded-lg font-bold">åˆ†äº«</button>
                        <button onclick="window.app.requestDelete('${s.id}')" class="text-red-400 text-xs bg-red-50 hover:bg-red-100 px-3 py-1.5 rounded-lg font-bold">åˆªé™¤</button>
                    </div>
                </div>`;
            });
        }

        async function loadSurveys() {
            try {
                const snap = await getDocs(collection(state.db, 'artifacts', APP_ID, 'users', state.user.uid, 'surveys'));
                state.surveysCache = {};
                snap.forEach(doc => { state.surveysCache[doc.id] = { id: doc.id, ...doc.data() }; });
                renderList();
            } catch(e) { console.error(e); showToast('è®€å–å¤±æ•—', 'error'); }
        }

        async function loadPublic() {
            try {
                const snap = await getDoc(doc(state.db, 'artifacts', APP_ID, 'users', uId, 'surveys', sId));
                if(!snap.exists()) throw new Error("å•å·ä¸å­˜åœ¨");
                const data = snap.data();
                safeGet('public-title').textContent = data.title;
                safeGet('public-desc').textContent = data.description;
                
                const form = safeGet('public-form');
                form.innerHTML = (data.questions || []).map((q, idx) => {
                    if (q.type === 'section') return `
                    <div class="public-q-item mt-10 mb-6 relative pl-4" data-type="section">
                        <div class="absolute left-0 top-1 bottom-1 w-1.5 bg-[#E9967A] rounded-full"></div>
                        <h3 class="text-2xl font-bold text-[#5B6C78] mb-2">${escapeHtml(q.text)}</h3>
                        <p class="text-gray-600 whitespace-pre-wrap text-base leading-relaxed">${escapeHtml(q.description)}</p>
                    </div>`;
                    
                    const name = `q_${idx}`;
                    const reqAttr = q.required ? 'data-req="true"' : '';
                    const reqMark = q.required ? '<span class="text-red-400 ml-1 text-lg">*</span>' : '';
                    const qId = `pq-${idx}`;
                    
                    let inputHtml = '';
                    if (q.type === 'text') {
                        inputHtml = `<input type="text" name="${name}" class="w-full border-2 border-[#eee] rounded-xl p-4 bg-[#FAFAFA] focus:border-[#568A66] focus:bg-white transition outline-none text-lg" placeholder="è«‹è¼¸å…¥æ‚¨çš„ç­”æ¡ˆ..." oninput="window.app.updateProgressBar()">`;
                    } else if (q.type === 'radio') {
                        const count = q.options.length;
                        // Balanced Grid Logic
                        let grid = 'w-[48%]'; 
                        if (count >= 7) grid = 'w-[23%]'; 
                        else if (count === 5) grid = 'w-[31%]'; 
                        else if (count === 3) grid = 'w-[31%]';

                        inputHtml = `<div class="flex flex-wrap justify-center gap-2">` + q.options.map((opt, i) => {
                             const emoji = getEmoji(i, count);
                             const col = getColor(i, count);
                             return `<label class="${grid} flex-grow-0 flex-shrink-0 cursor-pointer group"><input type="radio" name="${name}" value="${escapeHtml(opt)}" class="peer sr-only" onchange="window.app.updateProgressBar(); window.scrollToNext(this)"><div class="h-full p-3 border-2 border-[#eee] rounded-xl text-center text-sm font-bold bg-white flex flex-col items-center justify-center min-h-[70px] group-hover:border-[#568A66]/50 transition ${col} opacity-90 shadow-sm"><div class="text-2xl mb-1">${emoji}</div><div class="leading-tight text-gray-700">${escapeHtml(opt)}</div></div></label>`;
                        }).join('') + `</div>`;
                    } else {
                        inputHtml = `<div class="space-y-3">` + q.options.map(opt => `<label class="flex items-center gap-3 p-4 border-2 border-[#eee] rounded-xl bg-white hover:border-[#568A66]/30 cursor-pointer transition"><input type="checkbox" name="${name}" value="${escapeHtml(opt)}" class="w-5 h-5 text-[#568A66] accent-[#568A66]" onchange="window.app.updateProgressBar()"><span class="text-gray-700 font-medium">${escapeHtml(opt)}</span></label>`).join('') + `</div>`;
                    }

                    return `<div id="${qId}" class="public-q-item ghibli-card p-6 mb-6 relative" ${reqAttr} data-type="${q.type}" data-name="${name}"><h4 class="font-bold text-xl text-[#2D3748] mb-4 leading-snug">${escapeHtml(q.text)} ${reqMark}</h4>${inputHtml}</div>`;
                }).join('');
                switchView('view-public');
            } catch(e) { safeGet('loading-view').innerHTML = `<div class="text-red-500 p-10 text-center">${e.message}</div>`; }
        }

        onAuthStateChanged(state.auth, (user) => {
            safeGet('loading-view').classList.add('hidden');
            state.user = user;
            if (state.mode === 'public') {
                if (!user) signInAnonymously(state.auth).catch(console.error); else loadPublic();
            } else {
                if (user) {
                    safeGet('admin-nav').classList.remove('hidden');
                    if (user.isAnonymous) { signOut(state.auth); return; }
                    safeGet('user-info').textContent = user.email;
                    safeGet('guest-warning').classList.toggle('hidden', !user.isAnonymous);
                    switchView('view-dashboard');
                    loadSurveys();
                } else switchView('view-login');
            }
        });
    </script>
</body>
</html>
