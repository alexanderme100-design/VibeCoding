<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <!-- Viewport è¨­å®šï¼šviewport-fit=cover ç¢ºä¿å¡«æ»¿ç€æµ·æ©Ÿå‹ -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Firebase å•å·ç³»çµ±</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Icons -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">

    <style>
        /* åŸºç¤è¨­å®š */
        html, body {
            overflow-x: hidden;
            min-height: 100vh;
            background-color: #f3f4f6;
            font-family: 'Noto Sans TC', sans-serif;
            /* ä¿®æ­£ iOS é»æ“Šé«˜äº®é¡è‰² */
            -webkit-tap-highlight-color: transparent;
        }
        
        body { 
            display: flex;
            flex-direction: column;
        }
        
        .fade-in { animation: fadeIn 0.4s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* é¸é …å¡ç‰‡è¢«é¸ä¸­æ™‚çš„å‹•ç•« */
        input:checked + div { 
            transform: scale(0.98); 
            box-shadow: inset 0 0 0 2px currentColor; 
            font-weight: bold;
        }

        /* æ‰‹æ©Ÿå„ªåŒ–ï¼šç¢ºä¿é»æ“Šå€åŸŸå¤ å¤§ (48px) */
        .tap-target {
            min-height: 48px;
        }

        /* é€²åº¦æ¢å‹•ç•« */
        .progress-transition {
            transition: width 0.3s ease-out;
        }

        /* é‡å° iPhone åº•éƒ¨å®‰å…¨å€åŸŸçš„ä¿®æ­£ */
        .safe-pb {
            padding-bottom: env(safe-area-inset-bottom, 20px);
        }

        /* æ‹–æ›³æ¨£å¼ */
        .question-card.dragging {
            opacity: 0.5;
            border: 2px dashed #3b82f6;
            background-color: #eff6ff;
        }
        
        .drag-handle {
            cursor: grab;
            touch-action: none; /* é˜²æ­¢è§¸æ§æ²å‹•å¹²æ“¾æ‹–æ›³ */
        }
        .drag-handle:active {
            cursor: grabbing;
        }

        /* å”¯è®€æ¨¡å¼æ¨£å¼ */
        .locked-input {
            background-color: #f9fafb; /* gray-50 */
            border-color: #e5e7eb; /* gray-200 */
            color: #6b7280; /* gray-500 */
            cursor: not-allowed;
        }

        /* é‡è¡¨é¡è‰²é‚è¼¯ */
        .likert-opt-1 { color: #ef4444; border-color: #fca5a5; background-color: #fef2f2; } 
        .likert-opt-2 { color: #f97316; border-color: #fdba74; background-color: #fff7ed; } 
        .likert-opt-3 { color: #eab308; border-color: #fde047; background-color: #fefce8; } 
        .likert-opt-4 { color: #84cc16; border-color: #bef264; background-color: #f7fee7; } 
        .likert-opt-5 { color: #22c55e; border-color: #86efac; background-color: #f0fdf4; } 
        .opt-default { color: #374151; border-color: #e5e7eb; background-color: white; }
        input:checked + div.opt-default { border-color: #2563eb; background-color: #eff6ff; color: #1d4ed8; }
    </style>
</head>
<body class="text-gray-800">

    <!-- å…¨åŸŸéŒ¯èª¤æç¤º (é˜²ç™½ç•«é¢æ©Ÿåˆ¶) -->
    <div id="global-error" class="hidden fixed top-0 left-0 w-full bg-red-600 text-white p-4 z-[100] text-center shadow-lg">
        <div class="flex items-center justify-center gap-2 mb-2">
            <i class="fa-solid fa-bug"></i>
            <span class="font-bold">ç³»çµ±ç™¼ç”ŸéŒ¯èª¤</span>
        </div>
        <p id="global-error-msg" class="text-xs text-red-100 mb-2">ç„¡æ³•é¡¯ç¤ºç•«é¢</p>
        <button onclick="location.reload()" class="text-xs bg-white text-red-600 px-3 py-1 rounded border border-red-200 hover:bg-red-50 transition">
            é‡æ–°æ•´ç†é é¢
        </button>
    </div>

    <!-- é€²åº¦æ¢ (åªåœ¨ Public View é¡¯ç¤º) -->
    <div id="public-progress-bar" class="fixed top-0 left-0 w-full h-1.5 bg-gray-200 z-[60] hidden">
        <div id="progress-fill" class="h-full bg-green-500 progress-transition" style="width: 0%"></div>
    </div>

    <!-- Navbar (Admin Only) -->
    <nav id="admin-nav" class="bg-blue-600 text-white shadow-lg sticky top-0 z-50 hidden">
        <div class="max-w-6xl mx-auto px-4 py-3 flex justify-between items-center">
            <div class="flex items-center gap-3">
                <i class="fa-solid fa-clipboard-list text-2xl"></i>
                <h1 class="text-xl font-bold tracking-wide hidden md:block">å•å·å¤§å¸« <span class="text-xs font-normal opacity-80 ml-2">ç®¡ç†å¾Œå°</span></h1>
                <h1 class="text-lg font-bold tracking-wide md:hidden">å•å·å¾Œå°</h1>
            </div>
            <div class="flex items-center gap-4">
                <div id="user-info" class="text-sm bg-blue-700 px-3 py-1 rounded-full opacity-0 transition-opacity duration-300 hidden md:block">
                    è¼‰å…¥ä¸­...
                </div>
                <button onclick="app.logout()" class="text-white hover:text-blue-200 transition text-sm flex items-center gap-1">
                    <i class="fa-solid fa-right-from-bracket"></i> <span class="hidden md:inline">ç™»å‡º</span>
                </button>
            </div>
        </div>
    </nav>

    <!-- Main Content Area -->
    <main class="flex-1 w-full max-w-6xl mx-auto p-4 md:p-8 relative min-h-[80vh]" id="main-container">
        
        <!-- Loading State -->
        <div id="loading-view" class="fixed inset-0 flex flex-col items-center justify-center bg-gray-100 z-50 p-4">
            <div class="text-center">
                <i class="fa-solid fa-circle-notch fa-spin text-5xl text-blue-500 mb-6"></i>
                <p class="text-gray-600 text-lg font-medium animate-pulse">æ­£åœ¨è¼‰å…¥å•å·...</p>
                <div id="loading-error" class="hidden mt-6 bg-red-50 p-4 rounded-xl border border-red-100 max-w-xs mx-auto text-left">
                    <p class="text-red-700 font-bold mb-2"><i class="fa-solid fa-triangle-exclamation mr-1"></i> é€£ç·šç™¼ç”Ÿå•é¡Œ</p>
                    <p class="text-red-600 text-sm mb-3">ç„¡æ³•é€£æ¥åˆ°è³‡æ–™åº«ã€‚é€™å¯èƒ½æ˜¯å› ç‚ºç¶²åŸŸæ¬Šé™æœªè¨­å®šæˆ–ç¶²è·¯ä¸ç©©ã€‚</p>
                    <button onclick="location.reload()" class="bg-white border border-red-200 text-red-600 px-4 py-2 rounded-lg text-sm hover:bg-red-50 transition w-full shadow-sm">
                        é‡æ–°æ•´ç†é é¢
                    </button>
                    <div id="debug-info" class="mt-3 pt-3 border-t border-red-100 text-[10px] text-gray-400 font-mono break-all"></div>
                </div>
            </div>
        </div>

        <!-- Login View -->
        <div id="login-view" class="hidden fixed inset-0 flex items-center justify-center bg-gray-100 z-40 fade-in p-4 overflow-y-auto">
            <div class="bg-white p-6 md:p-8 rounded-2xl shadow-xl max-w-md w-full text-center my-auto">
                <div class="w-16 h-16 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="fa-solid fa-user-shield text-3xl"></i>
                </div>
                <h2 class="text-2xl font-bold text-gray-800 mb-2">å•å·å¤§å¸«ç™»å…¥</h2>
                <div id="file-protocol-warning" class="hidden mb-4 p-3 bg-yellow-50 text-yellow-800 text-xs rounded-lg text-left">
                    <i class="fa-solid fa-triangle-exclamation mr-1"></i> è­¦å‘Šï¼šæ‚¨ä¼¼ä¹æ˜¯ç›´æ¥é–‹å•Ÿæª”æ¡ˆ (file://)ã€‚Firebase é©—è­‰åŠŸèƒ½å¯èƒ½ç„¡æ³•é‹ä½œã€‚è«‹å°‡æ­¤æª”æ¡ˆä¸Šå‚³è‡³ç¶²ç«™ä¼ºæœå™¨ã€‚
                </div>
                
                <div class="space-y-4 text-left">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">é›»å­éƒµä»¶</label>
                        <input type="email" id="auth-email" class="w-full border-gray-300 rounded-lg p-3 border focus:ring-2 focus:ring-blue-500 focus:outline-none text-base" placeholder="name@example.com">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">å¯†ç¢¼</label>
                        <input type="password" id="auth-password" class="w-full border-gray-300 rounded-lg p-3 border focus:ring-2 focus:ring-blue-500 focus:outline-none text-base" placeholder="******">
                    </div>
                </div>

                <div class="flex gap-3 mt-6">
                    <button onclick="app.loginWithEmail()" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-xl shadow-md transition tap-target">
                        ç™»å…¥
                    </button>
                    <button onclick="app.registerWithEmail()" class="flex-1 bg-white border border-gray-300 hover:bg-gray-50 text-gray-700 font-bold py-3 rounded-xl transition tap-target">
                        è¨»å†Š
                    </button>
                </div>
            </div>
        </div>

        <!-- ================= ADMIN VIEWS ================= -->

        <!-- Dashboard View (Survey List) -->
        <div id="dashboard-view" class="hidden fade-in pb-20">
            <!-- è¨ªå®¢è­¦å‘Š Banner -->
            <div id="guest-warning" class="hidden bg-orange-100 border-l-4 border-orange-500 text-orange-700 p-4 mb-6 rounded shadow-sm" role="alert">
                <div class="flex items-start">
                    <div class="py-1"><i class="fa-solid fa-triangle-exclamation mr-3"></i></div>
                    <div>
                        <p class="font-bold">æ‚¨ç›®å‰æ˜¯è¨ªå®¢èº«åˆ†</p>
                        <p class="text-sm">åœ¨æ­¤æ¨¡å¼ä¸‹å»ºç«‹çš„å•å·è³‡æ–™ä¸æœƒæ°¸ä¹…ä¿å­˜ã€‚å»ºè­°æ‚¨ç™»å‡ºä¸¦è¨»å†Šæ­£å¼å¸³è™Ÿï¼Œä»¥å…å¿ƒè¡€éºå¤±ã€‚</p>
                    </div>
                </div>
            </div>

            <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 md:mb-8 gap-4">
                <div>
                    <h2 class="text-2xl font-bold text-gray-800">æˆ‘çš„å•å·</h2>
                    <p class="text-gray-500 text-sm mt-1">ç®¡ç†èˆ‡ç™¼å¸ƒæ‚¨çš„èª¿æŸ¥å•å·</p>
                </div>
                <button onclick="app.createNewSurvey()" class="w-full md:w-auto bg-blue-600 hover:bg-blue-700 text-white px-5 py-3 rounded-lg shadow transition flex items-center justify-center gap-2 tap-target">
                    <i class="fa-solid fa-plus"></i> å»ºç«‹æ–°å•å·
                </button>
            </div>

            <div id="survey-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 md:gap-6">
                <!-- Survey Cards injected here -->
            </div>
            
            <div id="empty-state" class="hidden text-center py-20 bg-white rounded-xl border border-dashed border-gray-300 mx-auto max-w-lg">
                <i class="fa-regular fa-folder-open text-5xl text-gray-300 mb-4"></i>
                <p class="text-gray-500">ç›®å‰æ²’æœ‰å•å·ï¼Œé»æ“Šä¸Šæ–¹æŒ‰éˆ•å»ºç«‹ç¬¬ä¸€å€‹å•å·ï¼</p>
            </div>
        </div>

        <!-- Editor View -->
        <div id="editor-view" class="hidden fade-in pb-32 max-w-4xl mx-auto">
            <!-- Locked Banner -->
            <div id="locked-banner" class="hidden bg-yellow-50 border-l-4 border-yellow-400 text-yellow-800 p-4 mb-4 sticky top-[60px] z-30 shadow-md">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-2">
                        <i class="fa-solid fa-lock text-yellow-600"></i>
                        <span class="font-bold text-sm">æ­¤å•å·å·²ç™¼å¸ƒä¸¦é–å®š</span>
                    </div>
                    <button onclick="app.duplicateSurvey(window.app.getCurrentSurveyId())" class="text-xs bg-white border border-yellow-300 px-3 py-1 rounded hover:bg-yellow-100 transition">
                        è¤‡è£½ä»¥ç·¨è¼¯
                    </button>
                </div>
                <p class="text-xs mt-1 text-yellow-700">ç‚ºç¢ºä¿è³‡æ–™å®Œæ•´æ€§ï¼Œå·²ç™¼å¸ƒçš„å•å·ç„¡æ³•ä¿®æ”¹çµæ§‹ã€‚è«‹è¤‡è£½ä¸€ä»½æ–°ç‰ˆæœ¬é€²è¡Œä¿®æ”¹ã€‚</p>
            </div>

            <div class="flex flex-wrap justify-between items-center mb-4 sticky top-[60px] z-20 bg-[#f3f4f6] py-2 px-1 gap-2" id="editor-toolbar">
                <div class="flex gap-2">
                    <button onclick="app.showDashboard()" class="text-gray-500 hover:text-blue-600 flex items-center gap-2 transition px-2 py-1 bg-white rounded-lg shadow-sm border border-gray-100">
                        <i class="fa-solid fa-arrow-left"></i> <span class="hidden md:inline">è¿”å›</span>
                    </button>
                    <span id="unsaved-indicator" class="hidden flex items-center text-xs text-orange-500 bg-orange-50 px-2 rounded-full border border-orange-200">
                        <i class="fa-solid fa-circle text-[8px] mr-1"></i> æœªå„²å­˜
                    </span>
                </div>
                
                <div class="flex gap-2">
                    <button onclick="app.openPreviewModal()" class="text-gray-600 hover:bg-gray-100 px-3 py-1.5 rounded-lg text-sm font-medium border border-gray-300 transition bg-white shadow-sm flex items-center gap-1">
                        <i class="fa-solid fa-eye"></i> <span class="hidden sm:inline">é è¦½</span>
                    </button>
                    <!-- æ‰¹é‡åŒ¯å…¥ (é–å®šæ™‚éš±è—) -->
                    <button id="btn-batch-import" onclick="app.openBatchModal()" class="text-blue-600 hover:bg-blue-50 px-3 py-1.5 rounded-lg text-sm font-medium border border-blue-200 transition bg-white shadow-sm flex items-center gap-1">
                        <i class="fa-solid fa-bolt"></i> <span class="hidden sm:inline">åŒ¯å…¥</span>
                    </button>
                </div>
            </div>

            <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                <div class="border-b border-gray-100 p-4 md:p-6 bg-gray-50">
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">å•å·æ¨™é¡Œ</label>
                            <input type="text" id="survey-title" class="w-full text-lg md:text-xl font-bold border-gray-300 rounded-lg shadow-sm focus:border-blue-500 focus:ring-blue-500 border p-2 text-base" placeholder="è«‹è¼¸å…¥å•å·æ¨™é¡Œ" oninput="app.markDirty()">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">å•å·èªªæ˜</label>
                            <textarea id="survey-desc" rows="2" class="w-full text-gray-600 border-gray-300 rounded-lg shadow-sm focus:border-blue-500 focus:ring-blue-500 border p-2 auto-grow text-base" placeholder="è«‹è¼¸å…¥å•å·çš„ç°¡çŸ­èªªæ˜..." oninput="app.markDirty(); app.autoGrow(this)"></textarea>
                        </div>
                    </div>
                </div>

                <div id="questions-container" class="p-4 md:p-6 space-y-6 bg-gray-50/50 min-h-[300px]"></div>

                <!-- åº•éƒ¨æ“ä½œå€ (é–å®šæ™‚éš±è—) -->
                <div id="editor-actions" class="p-4 md:p-6 border-t border-gray-200 bg-white flex flex-col md:flex-row justify-center gap-3">
                    <button onclick="app.addQuestionUI(); app.markDirty()" class="group flex flex-col items-center gap-2 p-4 border-2 border-dashed border-gray-300 rounded-xl hover:border-blue-400 hover:bg-blue-50 transition w-full max-w-[200px] tap-target">
                        <div class="w-10 h-10 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center group-hover:scale-110 transition">
                            <i class="fa-solid fa-plus"></i>
                        </div>
                        <span class="text-gray-500 font-medium group-hover:text-blue-600">æ–°å¢é¡Œç›®</span>
                    </button>
                    <button onclick="app.addQuestionUI({type:'section'}); app.markDirty()" class="group flex flex-col items-center gap-2 p-4 border-2 border-dashed border-orange-200 rounded-xl hover:border-orange-400 hover:bg-orange-50 transition w-full max-w-[200px] tap-target">
                        <div class="w-10 h-10 rounded-full bg-orange-100 text-orange-600 flex items-center justify-center group-hover:scale-110 transition">
                            <i class="fa-solid fa-align-left"></i>
                        </div>
                        <span class="text-gray-500 font-medium group-hover:text-orange-600">æ–°å¢æ®µè½èªªæ˜</span>
                    </button>
                </div>
            </div>
            
            <!-- å„²å­˜æŒ‰éˆ• (é–å®šæ™‚éš±è—) -->
            <div id="save-bar" class="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 p-4 z-30 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.1)] safe-pb">
                <div class="max-w-4xl mx-auto flex justify-end gap-3">
                    <button onclick="app.showDashboard()" class="px-6 py-2 text-gray-600 hover:bg-gray-100 rounded-lg font-medium transition tap-target">å–æ¶ˆ</button>
                    <button onclick="app.saveSurvey()" id="save-btn" class="px-8 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-medium shadow-lg shadow-blue-200 transition flex items-center gap-2 tap-target">
                        <i class="fa-solid fa-save"></i> å„²å­˜
                    </button>
                </div>
            </div>
        </div>

        <!-- ================= PUBLIC VIEW (RESPONDENT) ================= -->
        <div id="public-view" class="hidden w-full max-w-3xl mx-auto fade-in pb-32">
            <!-- Survey Header -->
            <div class="bg-blue-600 text-white p-6 md:p-8 rounded-b-2xl md:rounded-t-2xl shadow-lg relative overflow-hidden">
                <div class="absolute top-0 right-0 p-8 opacity-10 pointer-events-none"><i class="fa-solid fa-clipboard-question text-9xl"></i></div>
                <h1 id="public-title" class="text-2xl md:text-3xl font-bold relative z-10 mb-2 break-words">è¼‰å…¥ä¸­...</h1>
                <p id="public-desc" class="text-blue-100 relative z-10 text-sm md:text-base break-words whitespace-pre-wrap">è«‹ç¨å€™</p>
            </div>

            <!-- Survey Form -->
            <form id="public-form" class="bg-white shadow-lg md:rounded-b-2xl p-5 md:p-8 space-y-8 mt-4 md:mt-0 rounded-xl md:rounded-none">
                <div id="public-questions" class="space-y-10">
                    <!-- Questions injected here -->
                </div>

                <div class="pt-8 border-t border-gray-100">
                    <button type="button" onclick="app.submitResponse()" id="submit-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 rounded-xl shadow-lg shadow-blue-200 transition transform active:scale-[0.98] text-lg tap-target">
                        é€å‡ºå•å·
                    </button>
                </div>
            </form>

            <div id="thank-you-view" class="hidden bg-white shadow-lg rounded-2xl p-8 md:p-12 text-center mt-4 mx-4 md:mx-0">
                <div class="w-20 h-20 bg-green-100 text-green-500 rounded-full flex items-center justify-center mx-auto mb-6">
                    <i class="fa-solid fa-check text-4xl"></i>
                </div>
                <h2 class="text-2xl font-bold text-gray-800 mb-2">æ„Ÿè¬æ‚¨çš„å¡«å¯«ï¼</h2>
                <p class="text-gray-500 mb-8">æ‚¨çš„æ„è¦‹å°æˆ‘å€‘éå¸¸é‡è¦ã€‚</p>
                <button onclick="location.reload()" class="text-blue-600 hover:underline tap-target">å¡«å¯«å¦ä¸€ä»½</button>
            </div>
        </div>
    </main>

    <!-- Modal (Preview) -->
    <div id="preview-modal" class="hidden fixed inset-0 bg-black bg-opacity-70 z-[60] flex items-center justify-center fade-in p-0 md:p-4">
        <div class="bg-gray-100 w-full h-full md:max-w-[400px] md:h-[80vh] md:rounded-3xl shadow-2xl flex flex-col overflow-hidden relative border-8 border-gray-800">
            <!-- Mock Phone Header -->
            <div class="bg-gray-800 text-white px-4 py-2 flex justify-between items-center text-xs">
                <span>9:41</span>
                <div class="flex gap-1"><i class="fa-solid fa-signal"></i> <i class="fa-solid fa-wifi"></i> <i class="fa-solid fa-battery-full"></i></div>
            </div>
            <!-- Preview Content Frame -->
            <div class="flex-1 overflow-y-auto bg-f3f4f6 scrollbar-hide relative" id="preview-container"></div>
            <!-- Close Button -->
            <button onclick="document.getElementById('preview-modal').classList.add('hidden')" class="absolute bottom-4 left-1/2 transform -translate-x-1/2 bg-gray-800 text-white rounded-full p-3 shadow-lg hover:bg-gray-700 transition z-50 tap-target flex items-center justify-center w-12 h-12">
                <i class="fa-solid fa-xmark text-xl"></i>
            </button>
        </div>
    </div>

    <!-- Modal (Batch Import) -->
    <div id="batch-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center fade-in p-4">
        <div class="bg-white rounded-xl shadow-2xl p-6 max-w-lg w-full flex flex-col max-h-[90vh]">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-bold text-gray-800"><i class="fa-solid fa-bolt text-yellow-500 mr-2"></i>æ‰¹é‡æ–°å¢</h3>
                <button onclick="document.getElementById('batch-modal').classList.add('hidden')" class="text-gray-400 hover:text-gray-600 p-2"><i class="fa-solid fa-xmark text-xl"></i></button>
            </div>
            
            <div class="overflow-y-auto flex-1 pr-2">
                <div class="mb-4">
                    <label class="block text-sm font-bold text-gray-700 mb-1">é¡Œç›®åˆ—è¡¨ (ä¸€è¡Œä¸€é¡Œï¼Œå¯è‡ªå‹•ç·¨è™Ÿ)</label>
                    <textarea id="batch-text" rows="6" class="w-full border-gray-300 rounded-lg p-3 border focus:ring-2 focus:ring-blue-500 text-sm text-base" placeholder="ä¾‹å¦‚ï¼š
1. æ‚¨å°ç’°å¢ƒæ»¿æ„å—ï¼Ÿ
2. æœå‹™äººå“¡æ…‹åº¦å¦‚ä½•ï¼Ÿ"></textarea>
                </div>

                <div class="mb-4">
                    <label class="block text-sm font-bold text-gray-700 mb-1">é¡å‹</label>
                    <select id="batch-type" onchange="app.toggleBatchSettings()" class="w-full border-gray-300 rounded-lg p-2.5 border bg-white text-sm text-base">
                        <option value="text">ç°¡ç­”é¡Œ</option>
                        <option value="likert">æ»¿æ„åº¦é‡è¡¨ (Likert)</option>
                        <option value="radio">å–®é¸é¡Œ</option>
                    </select>
                </div>

                <!-- Likert Settings -->
                <div id="batch-likert-settings" class="hidden bg-blue-50 p-4 rounded-lg border border-blue-100 mb-4">
                    <div class="flex gap-4 items-center">
                        <div class="flex-1">
                            <span class="text-sm text-gray-600 block mb-1">ç­‰ç´šæ•¸</span>
                            <select id="likert-scale" class="w-full border border-blue-200 rounded p-1.5 text-sm text-base">
                                <option value="3">3 (1-3)</option>
                                <option value="5" selected>5 (1-5)</option>
                                <option value="7">7 (1-7)</option>
                                <option value="10">10 (1-10)</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pt-4 border-t border-gray-100 flex justify-end gap-2">
                <button onclick="document.getElementById('batch-modal').classList.add('hidden')" class="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-lg tap-target">å–æ¶ˆ</button>
                <button onclick="app.processBatchImport(); app.markDirty()" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-medium shadow tap-target">åŒ¯å…¥</button>
            </div>
        </div>
    </div>

    <!-- Modal (View Results) -->
    <div id="results-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center fade-in p-4">
        <div class="bg-white rounded-xl shadow-2xl p-4 md:p-6 max-w-4xl w-full flex flex-col max-h-[90vh]">
            <div class="flex justify-between items-center mb-4 pb-2 border-b border-gray-100">
                <h3 class="text-lg md:text-xl font-bold text-gray-800"><i class="fa-solid fa-chart-bar text-blue-500 mr-2"></i>çµ±è¨ˆçµæœ</h3>
                <div class="flex gap-2">
                    <button id="export-btn" class="text-xs md:text-sm bg-green-600 hover:bg-green-700 text-white px-3 py-1.5 rounded-lg flex items-center gap-2 transition shadow whitespace-nowrap tap-target">
                        <i class="fa-solid fa-file-csv"></i> <span class="hidden md:inline">åŒ¯å‡º Excel</span><span class="md:hidden">åŒ¯å‡º</span>
                    </button>
                    <button onclick="document.getElementById('results-modal').classList.add('hidden')" class="text-gray-400 hover:text-gray-600 ml-2 p-2"><i class="fa-solid fa-xmark text-xl"></i></button>
                </div>
            </div>
            
            <div id="results-content" class="overflow-y-auto flex-1 space-y-6 p-2">
                <div class="text-center text-gray-500 py-10">è¼‰å…¥ä¸­...</div>
            </div>
        </div>
    </div>

    <!-- Modal (Share Link) -->
    <div id="share-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center fade-in p-4">
        <div class="bg-white rounded-xl shadow-2xl p-6 max-w-md w-full">
            <h3 class="text-lg font-bold text-gray-800 mb-2">ç™¼å¸ƒå•å·</h3>
            <p class="text-sm text-gray-500 mb-4">ç™¼å¸ƒå¾Œå•å·å°‡é–å®šã€‚å°‡æ­¤é€£çµå‚³é€çµ¦å¡«ç­”è€…ã€‚</p>
            <div class="flex gap-2 mb-6">
                <input type="text" id="share-link-input" readonly class="w-full bg-gray-50 border border-gray-300 text-gray-600 text-sm rounded-lg p-2.5 text-base">
                <button onclick="app.copyLink()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 rounded-lg text-sm font-medium whitespace-nowrap tap-target">è¤‡è£½</button>
            </div>
            
            <!-- QR Code Area -->
            <div class="text-center bg-gray-50 p-4 rounded-lg border border-gray-200">
                <div class="text-xs text-gray-500 mb-2 uppercase font-bold tracking-wider">æ‰‹æ©Ÿæƒæå¡«å¯«</div>
                <img id="share-qr-img" src="" alt="QR Code" class="mx-auto w-40 h-40 bg-gray-200 rounded">
            </div>

            <button onclick="document.getElementById('share-modal').classList.add('hidden')" class="w-full mt-4 py-2 text-gray-500 hover:bg-gray-50 rounded-lg tap-target">é—œé–‰</button>
        </div>
    </div>

    <!-- Modal (Confirm Delete) -->
    <div id="delete-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center fade-in p-4">
        <div class="bg-white rounded-xl shadow-2xl p-6 max-w-sm w-full text-center">
            <div class="w-16 h-16 bg-red-100 text-red-500 rounded-full flex items-center justify-center mx-auto mb-4"><i class="fa-solid fa-trash-can text-2xl"></i></div>
            <h3 class="text-lg font-bold text-gray-800">ç¢ºå®šåˆªé™¤ï¼Ÿ</h3>
            <div class="flex gap-3 mt-6">
                <button onclick="document.getElementById('delete-modal').classList.add('hidden')" class="flex-1 py-2 border border-gray-300 rounded-lg tap-target">å–æ¶ˆ</button>
                <button id="confirm-delete-btn" class="flex-1 py-2 bg-red-500 text-white rounded-lg tap-target">ç¢ºèªåˆªé™¤</button>
            </div>
        </div>
    </div>

    <!-- Toast -->
    <div id="toast" class="fixed top-20 right-5 transform translate-x-full transition-transform duration-300 z-[70] bg-gray-800 text-white px-6 py-3 rounded-lg shadow-lg flex items-center gap-3">
        <i id="toast-icon" class="fa-solid fa-check-circle text-green-400"></i>
        <span id="toast-msg">æ“ä½œæˆåŠŸ</span>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken, GoogleAuthProvider, signInWithPopup, signOut, createUserWithEmailAndPassword, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, getDoc, getDocs, deleteDoc, addDoc, serverTimestamp, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Configuration
        const firebaseConfig = {
          apiKey: "AIzaSyAexk_JbIOQWV1Jw7hqfiZDDZYY9YF-Sdk",
          authDomain: "survey-49e8d.firebaseapp.com",
          projectId: "survey-49e8d",
          storageBucket: "survey-49e8d.firebasestorage.app",
          messagingSenderId: "547257703502",
          appId: "1:547257703502:web:85e147bed62333b11c771f"
        };
        const appId = 'survey-app';
        
        let db, auth, user;
        let currentSurveyId = null;
        let publicSurveyOwnerId = null;
        let surveysCache = {};
        let isDirty = false;

        const urlParams = new URLSearchParams(window.location.search);
        const publicModeSurveyId = urlParams.get('s');
        const publicModeOwnerId = urlParams.get('u');
        const isPublicMode = publicModeSurveyId && publicModeOwnerId;

        // Global Error Handler (é˜²æ­¢ç™½ç•«é¢)
        window.onerror = function(msg, url, line, col, error) {
            const errorDiv = document.getElementById('global-error');
            const errorMsg = document.getElementById('global-error-msg');
            if(errorDiv && errorMsg) {
                errorDiv.classList.remove('hidden');
                errorMsg.innerText = `${msg} (Line: ${line})`;
            }
            console.error("Global Error:", msg, error);
        };

        function escapeHtml(text) {
            if (text === null || text === undefined) return '';
            return String(text)
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        if (window.location.protocol === 'file:') {
            document.getElementById('file-protocol-warning').classList.remove('hidden');
        }

        try {
            const app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
            
            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                signInWithCustomToken(auth, __initial_auth_token);
            } else if (isPublicMode) {
                signInAnonymously(auth).catch(e => {
                    console.error("Auth Failed", e);
                    setTimeout(() => {
                        document.getElementById('loading-error').classList.remove('hidden');
                        document.getElementById('debug-info').textContent = "Auth: " + e.code;
                    }, 2000);
                });
            }
        } catch (e) { 
            console.error("Init failed", e); 
            document.getElementById('loading-error').classList.remove('hidden');
            document.getElementById('debug-info').textContent = "Init: " + e.message;
        }

        // Timeout Check
        setTimeout(() => {
            const loading = document.getElementById('loading-view');
            if (!loading.classList.contains('hidden') && document.getElementById('loading-error').classList.contains('hidden')) {
                document.getElementById('loading-error').classList.remove('hidden');
                document.getElementById('debug-info').textContent = "Timeout: é€£ç·šå›æ‡‰é€¾æ™‚";
            }
        }, 8000);

        // Drag & Drop logic (Defensive)
        const initSortable = () => {
            const container = document.getElementById('questions-container');
            if(!container) return; // Safety Check
            
            container.addEventListener('dragover', e => {
                e.preventDefault();
                const afterElement = getDragAfterElement(container, e.clientY);
                const draggable = document.querySelector('.dragging');
                if (draggable) {
                    if (afterElement == null) container.appendChild(draggable);
                    else container.insertBefore(draggable, afterElement);
                }
            });
        };

        const getDragAfterElement = (container, y) => {
            const draggableElements = [...container.querySelectorAll('.question-card:not(.dragging)')];
            return draggableElements.reduce((closest, child) => {
                const box = child.getBoundingClientRect();
                const offset = y - box.top - box.height / 2;
                if (offset < 0 && offset > closest.offset) return { offset: offset, element: child };
                else return closest;
            }, { offset: Number.NEGATIVE_INFINITY }).element;
        };

        window.addEventListener('DOMContentLoaded', () => { initSortable(); });
        window.addEventListener('beforeunload', (e) => { if (isDirty) { e.preventDefault(); e.returnValue = ''; } });

        onAuthStateChanged(auth, (currentUser) => {
            document.getElementById('loading-view').classList.add('hidden');
            
            try {
                if (currentUser) {
                    user = currentUser;
                    document.getElementById('login-view').classList.add('hidden');
                    
                    if (isPublicMode) {
                        loadPublicSurvey(publicModeSurveyId, publicModeOwnerId);
                    } else {
                        document.getElementById('admin-nav').classList.remove('hidden');
                        const displayName = user.isAnonymous ? 'è¨ªå®¢ (æœªç¶å®š)' : (user.email || 'User');
                        document.getElementById('user-info').textContent = `Hi, ${displayName}`;
                        document.getElementById('user-info').classList.remove('opacity-0');
                        
                        const guestWarn = document.getElementById('guest-warning');
                        if(guestWarn) {
                            if (user.isAnonymous) guestWarn.classList.remove('hidden');
                            else guestWarn.classList.add('hidden');
                        }
                        
                        loadSurveys(); // Async but non-blocking for UI
                        document.getElementById('dashboard-view').classList.remove('hidden');
                    }
                } else {
                    if (!isPublicMode) {
                        document.getElementById('admin-nav').classList.add('hidden');
                        document.getElementById('dashboard-view').classList.add('hidden');
                        document.getElementById('editor-view').classList.add('hidden');
                        document.getElementById('login-view').classList.remove('hidden');
                    } else {
                        const main = document.getElementById('main-container');
                        main.innerHTML = `<div class="flex flex-col items-center justify-center min-h-[60vh] text-center px-4 fade-in"><div class="w-20 h-20 bg-red-100 rounded-full flex items-center justify-center mb-6"><i class="fa-solid fa-user-lock text-4xl text-red-500"></i></div><h2 class="text-xl font-bold text-gray-800 mb-2">ç„¡æ³•è¼‰å…¥å•å·</h2><p class="text-gray-500 mb-6 max-w-md">ç³»çµ±ç„¡æ³•é©—è­‰æ‚¨çš„èº«ä»½ã€‚</p></div>`;
                    }
                }
            } catch (e) {
                console.error("State Change Error", e);
                document.getElementById('global-error').classList.remove('hidden');
            }
        });

        // ... (Helpers: getEmojiForScale, getColorClassForScale - SAME AS BEFORE)
        function getEmojiForScale(text, index, total) { const match = text.match(/^[\(]?(\d+)[\)\.]?/); if (match) { let num = parseInt(match[1]); if (total <= 5) { const map = ['ğŸ˜¡', 'ğŸ™', 'ğŸ˜', 'ğŸ˜Š', 'ğŸ¤©']; if(num>=1 && num<=5) return map[num-1]; } else if (total <= 7) { const map = ['ğŸ˜¡', 'ğŸ˜ ', 'ğŸ™', 'ğŸ˜', 'ğŸ™‚', 'ğŸ˜Š', 'ğŸ¤©']; if(num>=1 && num<=7) return map[num-1]; } } if (text.includes('éå¸¸ä¸') || text.includes('æ¥µä¸')) return 'ğŸ˜¡'; if (text.includes('ä¸æ»¿') || text.includes('ä¸åŒæ„')) return 'ğŸ™'; if (text.includes('æ™®é€š') || text.includes('æ²’æ„è¦‹')) return 'ğŸ˜'; if (text.includes('éå¸¸') || text.includes('æ¥µ')) return 'ğŸ¤©'; if (text.includes('æ»¿æ„') || text.includes('åŒæ„')) return 'ğŸ˜Š'; return null; }
        function getColorClassForScale(text, total) { const match = text.match(/^[\(]?(\d+)[\)\.]?/); if (match && total <= 7) { let num = parseInt(match[1]); if(num>=1) return `likert-opt-${Math.min(num, 5)}`; } return 'opt-default'; }

        // APP Logic
        window.app = {
            // ... (Helpers: markDirty, clearDirty, autoGrow, auth functions - SAME AS BEFORE)
            getCurrentSurveyId: () => currentSurveyId,
            markDirty: () => { isDirty = true; document.getElementById('unsaved-indicator').classList.remove('hidden'); },
            clearDirty: () => { isDirty = false; document.getElementById('unsaved-indicator').classList.add('hidden'); },
            autoGrow: (element) => { element.style.height = "auto"; element.style.height = (element.scrollHeight) + "px"; },
            loginWithEmail: async () => { const email = document.getElementById('auth-email').value; const password = document.getElementById('auth-password').value; try { await signInWithEmailAndPassword(auth, email, password); } catch(e){ showToast("éŒ¯èª¤: "+e.code, "error"); } },
            registerWithEmail: async () => { const email = document.getElementById('auth-email').value; const password = document.getElementById('auth-password').value; try { await createUserWithEmailAndPassword(auth, email, password); showToast("è¨»å†ŠæˆåŠŸ"); } catch(e){ showToast("éŒ¯èª¤: "+e.code, "error"); } },
            logout: async () => { await signOut(auth); location.reload(); },

            // Navigation with Safety
            showDashboard: () => {
                if (isDirty && !confirm("è®Šæ›´æœªå„²å­˜ï¼Œç¢ºå®šè¦é›¢é–‹å—ï¼Ÿ")) return;
                app.clearDirty();
                document.getElementById('editor-view').classList.add('hidden');
                document.getElementById('dashboard-view').classList.remove('hidden');
                loadSurveys(); // Reload list
                currentSurveyId = null;
                window.scrollTo(0, 0);
            },
            
            createNewSurvey: () => { /* ... SAME ... */
                currentSurveyId = crypto.randomUUID();
                document.getElementById('survey-title').value = '';
                document.getElementById('survey-desc').value = '';
                document.getElementById('survey-title').disabled = false;
                document.getElementById('survey-desc').disabled = false;
                document.getElementById('survey-title').classList.remove('locked-input');
                document.getElementById('survey-desc').classList.remove('locked-input');
                document.getElementById('locked-banner').classList.add('hidden');
                document.getElementById('editor-actions').classList.remove('hidden');
                document.getElementById('save-bar').classList.remove('hidden');
                document.getElementById('btn-batch-import').classList.remove('hidden');
                document.getElementById('questions-container').innerHTML = '';
                window.app.addQuestionUI();
                document.getElementById('dashboard-view').classList.add('hidden');
                document.getElementById('editor-view').classList.remove('hidden');
                window.scrollTo(0, 0);
                app.clearDirty();
            },
            
            editSurvey: (surveyId) => { /* ... SAME ... */
                const survey = surveysCache[surveyId];
                if (!survey) return showToast("è®€å–å¤±æ•—", "error");
                try {
                    currentSurveyId = surveyId;
                    document.getElementById('survey-title').value = survey.title || '';
                    const descArea = document.getElementById('survey-desc');
                    descArea.value = survey.description || '';
                    app.autoGrow(descArea);
                    const isLocked = (survey.status === 'published');
                    document.getElementById('survey-title').disabled = isLocked;
                    document.getElementById('survey-desc').disabled = isLocked;
                    if(isLocked) {
                        document.getElementById('locked-banner').classList.remove('hidden');
                        document.getElementById('editor-actions').classList.add('hidden');
                        document.getElementById('save-bar').classList.add('hidden');
                        document.getElementById('btn-batch-import').classList.add('hidden');
                        document.getElementById('survey-title').classList.add('locked-input');
                        document.getElementById('survey-desc').classList.add('locked-input');
                    } else {
                        document.getElementById('locked-banner').classList.add('hidden');
                        document.getElementById('editor-actions').classList.remove('hidden');
                        document.getElementById('save-bar').classList.remove('hidden');
                        document.getElementById('btn-batch-import').classList.remove('hidden');
                        document.getElementById('survey-title').classList.remove('locked-input');
                        document.getElementById('survey-desc').classList.remove('locked-input');
                    }
                    const container = document.getElementById('questions-container');
                    container.innerHTML = '';
                    (survey.questions || []).forEach(q => window.app.addQuestionUI(q, isLocked));
                    document.getElementById('dashboard-view').classList.add('hidden');
                    document.getElementById('editor-view').classList.remove('hidden');
                    window.scrollTo(0, 0);
                    app.clearDirty();
                } catch (e) { console.error(e); showToast("è³‡æ–™éŒ¯èª¤", "error"); }
            },

            // ... (addQuestionUI, moveQuestion, toggleOptions, etc. - SAME AS BEFORE)
            // Just including the main ones for brevity, they are identical logic
            addQuestionUI: (data = null, isLocked = false) => {
                // ... (Standard Add UI logic, ensuring IDs exist)
                const container = document.getElementById('questions-container');
                if(!container) return;
                const id = Date.now().toString() + Math.random().toString(36).substr(2, 5);
                const type = data ? data.type : 'text';
                const text = data ? data.text : '';
                const description = data && data.description ? data.description : '';
                const options = data && data.options ? data.options.join('\n') : '';
                const isRequired = (data && data.required !== undefined) ? data.required : true; 
                const card = document.createElement('div');
                card.id = `q-${id}`;
                if(!isLocked) {
                    card.draggable = true; 
                    card.addEventListener('dragstart', () => { card.classList.add('dragging'); });
                    card.addEventListener('dragend', () => { card.classList.remove('dragging'); app.markDirty(); });
                }
                const disabledAttr = isLocked ? 'disabled' : '';
                const inputClass = isLocked ? 'locked-input' : 'bg-white';
                const hideIfLocked = isLocked ? 'hidden' : '';
                const dragClass = isLocked ? '' : 'cursor-grab active:cursor-grabbing drag-handle';

                // (HTML construction same as previous version for brevity)
                if (type === 'section') {
                    card.className = `question-card bg-orange-50 p-4 md:p-6 rounded-xl border-2 border-orange-200 shadow-sm relative group transition duration-200`;
                    card.innerHTML = `<input type="hidden" class="question-type" value="section"><div class="flex justify-between items-start mb-4"><div class="bg-orange-200 text-orange-800 text-xs font-bold px-2 py-1 rounded uppercase tracking-wider flex items-center gap-1 ${dragClass}"><i class="fa-solid fa-align-left"></i> æ®µè½èªªæ˜</div><div class="flex items-center gap-2 ${hideIfLocked}"><button onclick="window.app.moveQuestion('${id}', -1)" class="text-gray-400 hover:text-orange-600 p-1 transition tap-target w-8 h-8 flex items-center justify-center"><i class="fa-solid fa-arrow-up"></i></button><button onclick="window.app.moveQuestion('${id}', 1)" class="text-gray-400 hover:text-orange-600 p-1 transition tap-target w-8 h-8 flex items-center justify-center"><i class="fa-solid fa-arrow-down"></i></button><div class="h-4 w-px bg-orange-300 mx-1"></div><button onclick="document.getElementById('q-${id}').remove(); app.markDirty()" class="text-gray-400 hover:text-red-500 p-1 transition tap-target w-8 h-8 flex items-center justify-center"><i class="fa-solid fa-trash"></i></button></div></div><div class="space-y-4"><div><label class="block text-xs font-bold text-orange-800 uppercase mb-1">æ®µè½æ¨™é¡Œ</label><input type="text" class="question-input w-full border-orange-300 rounded-lg p-2.5 focus:ring-2 focus:ring-orange-500 border ${inputClass} transition font-bold text-base" placeholder="ä¾‹å¦‚ï¼šç¬¬ä¸€éƒ¨åˆ† - åŸºæœ¬è³‡æ–™" value="${escapeHtml(text)}" ${disabledAttr} oninput="app.markDirty()"></div><div><label class="block text-xs font-bold text-orange-800 uppercase mb-1">è©³ç´°èªªæ˜å…§å®¹</label><textarea class="question-desc-input w-full border-orange-300 rounded-lg p-2.5 focus:ring-2 focus:ring-orange-500 border ${inputClass} transition auto-grow text-base" rows="3" ${disabledAttr} oninput="app.markDirty(); app.autoGrow(this)">${escapeHtml(description)}</textarea></div></div>`;
                } else {
                    card.className = `question-card bg-white p-4 md:p-6 rounded-xl border border-gray-200 shadow-sm relative group hover:shadow-md transition duration-200`;
                    card.innerHTML = `<div class="flex justify-between items-start mb-4"><div class="bg-blue-100 text-blue-700 text-xs font-bold px-2 py-1 rounded uppercase tracking-wider ${dragClass}">å•é¡Œ</div><div class="flex items-center gap-2 ${hideIfLocked}"><label class="flex items-center cursor-pointer select-none"><div class="relative"><input type="checkbox" class="sr-only peer question-required" ${isRequired ? 'checked' : ''} onchange="app.markDirty()"><div class="w-9 h-5 bg-gray-200 peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-blue-600"></div></div><span class="ml-2 text-xs font-medium text-gray-500">å¿…å¡«</span></label><div class="h-4 w-px bg-gray-300 mx-1"></div><button onclick="window.app.moveQuestion('${id}', -1)" class="text-gray-400 hover:text-blue-500 p-1 transition tap-target w-8 h-8 flex items-center justify-center"><i class="fa-solid fa-arrow-up"></i></button><button onclick="window.app.moveQuestion('${id}', 1)" class="text-gray-400 hover:text-blue-500 p-1 transition tap-target w-8 h-8 flex items-center justify-center"><i class="fa-solid fa-arrow-down"></i></button><div class="h-4 w-px bg-gray-300 mx-1"></div><button onclick="document.getElementById('q-${id}').remove(); app.markDirty()" class="text-gray-400 hover:text-red-500 p-1 transition tap-target w-8 h-8 flex items-center justify-center"><i class="fa-solid fa-trash"></i></button></div></div><div class="grid grid-cols-1 md:grid-cols-12 gap-4"><div class="md:col-span-8"><label class="block text-xs font-bold text-gray-500 uppercase mb-1">é¡Œç›®å…§å®¹</label><input type="text" class="question-input w-full border-gray-300 rounded-lg p-2.5 focus:ring-2 focus:ring-blue-500 border ${inputClass} transition text-base" value="${escapeHtml(text)}" ${disabledAttr} oninput="app.markDirty()"></div><div class="md:col-span-4"><label class="block text-xs font-bold text-gray-500 uppercase mb-1">é¡Œå‹</label><select class="question-type w-full border-gray-300 rounded-lg p-2.5 focus:ring-2 focus:ring-blue-500 border ${inputClass} text-base" ${disabledAttr} onchange="window.app.toggleOptions(this); app.markDirty()"><option value="text" ${type === 'text' ? 'selected' : ''}>ç°¡ç­”é¡Œ</option><option value="radio" ${type === 'radio' ? 'selected' : ''}>å–®é¸é¡Œ</option><option value="checkbox" ${type === 'checkbox' ? 'selected' : ''}>å¤šé¸é¡Œ</option></select></div></div><div class="options-area mt-4 ${type === 'text' ? 'hidden' : ''}"><label class="block text-xs font-bold text-gray-500 uppercase mb-1">é¸é … (æ¯è¡Œä¸€å€‹)</label><textarea class="question-options w-full border-gray-300 rounded-lg p-2 focus:ring-2 focus:ring-blue-500 border bg-yellow-50 font-mono text-sm auto-grow text-base ${inputClass}" rows="3" ${disabledAttr} oninput="app.markDirty(); app.autoGrow(this)">${escapeHtml(options)}</textarea></div>`;
                }
                container.appendChild(card);
                card.querySelectorAll('.auto-grow').forEach(el => app.autoGrow(el));
            },
            moveQuestion: (id, direction) => { const card = document.getElementById(`q-${id}`); const container = document.getElementById('questions-container'); if (direction === -1 && card.previousElementSibling) container.insertBefore(card, card.previousElementSibling); else if (direction === 1 && card.nextElementSibling) container.insertBefore(card.nextElementSibling, card); app.markDirty(); },
            toggleOptions: (selectEl) => { const card = selectEl.closest('.question-card'); const optionsArea = card.querySelector('.options-area'); if (selectEl.value === 'text') optionsArea.classList.add('hidden'); else optionsArea.classList.remove('hidden'); },
            openShareModal: (id) => { /* ... SAME ... */ 
                const survey = surveysCache[id];
                if(!survey) return;
                if (survey.status !== 'published') {
                    if (confirm("ã€é‡è¦ã€‘ç™¼å¸ƒå¾Œå•å·å°‡æœƒã€Œé–å®šã€ç„¡æ³•å†ä¿®æ”¹ã€‚\n\nç¢ºå®šè¦ç™¼å¸ƒä¸¦é–å®šå—ï¼Ÿ")) {
                        const surveyRef = doc(db, 'artifacts', appId, 'users', user.uid, 'surveys', id);
                        updateDoc(surveyRef, { status: 'published' }).then(() => { showToast("å·²ç™¼å¸ƒä¸¦é–å®š"); loadSurveys(); }).catch(err => showToast("ç™¼å¸ƒå¤±æ•—", "error"));
                    } else return;
                }
                const link = `${window.location.origin}${window.location.pathname}?s=${id}&u=${user.uid}`;
                document.getElementById('share-link-input').value = link;
                document.getElementById('share-qr-img').src = `https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=${encodeURIComponent(link)}`;
                document.getElementById('share-modal').classList.remove('hidden');
            },
            copyLink: () => { const input = document.getElementById('share-link-input'); input.select(); document.execCommand('copy'); showToast("é€£çµå·²è¤‡è£½"); },
            openBatchModal: () => { document.getElementById('batch-modal').classList.remove('hidden'); document.getElementById('batch-text').value = ''; window.app.toggleBatchSettings(); },
            toggleBatchSettings: () => { const type = document.getElementById('batch-type').value; if(type === 'likert') document.getElementById('batch-likert-settings').classList.remove('hidden'); else document.getElementById('batch-likert-settings').classList.add('hidden'); },
            processBatchImport: () => { /* ... SAME ... */ 
                const text = document.getElementById('batch-text').value;
                const type = document.getElementById('batch-type').value;
                const scale = parseInt(document.getElementById('likert-scale').value);
                if(!text.trim()) return showToast("è«‹è¼¸å…¥é¡Œç›®", "error");
                const lines = text.split('\n').map(l => l.trim()).filter(l => l);
                lines.forEach(line => {
                    let qData = { text: line, type: 'text', options: [], required: true };
                    if(type === 'radio') { qData.type = 'radio'; qData.options = ['é¸é …1', 'é¸é …2']; }
                    else if(type === 'likert') { qData.type = 'radio'; qData.options = []; for(let i=1; i<=scale; i++) { let label = `(${i})`; if(i===1) label += " éå¸¸ä¸æ»¿æ„"; else if(i===scale) label += " éå¸¸æ»¿æ„"; qData.options.push(label); } }
                    window.app.addQuestionUI(qData);
                });
                document.getElementById('batch-modal').classList.add('hidden');
                showToast(`å·²æ–°å¢ ${lines.length} å€‹é¡Œç›®`);
                app.markDirty();
            },
            duplicateSurvey: async (surveyId) => { /* ... SAME ... */
                const survey = surveysCache[surveyId];
                if(!survey) return;
                if(!confirm(`ç¢ºå®šè¦è¤‡è£½å•å·ã€Œ${survey.title}ã€å—ï¼Ÿ`)) return;
                try {
                    const newId = crypto.randomUUID();
                    const newData = { ...survey, title: `${survey.title} (å‰¯æœ¬)`, updatedAt: serverTimestamp(), status: 'draft' }; 
                    delete newData.id; 
                    await setDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'surveys', newId), newData);
                    showToast("è¤‡è£½æˆåŠŸï¼"); loadSurveys();
                } catch(e) { console.error(e); showToast("è¤‡è£½å¤±æ•—", "error"); }
            },
            exportToCSV: async (surveyId) => { /* ... SAME ... */
                const btn = document.getElementById('export-btn');
                const originalText = btn.innerHTML;
                btn.innerText = "è™•ç†ä¸­..."; btn.disabled = true;
                try {
                    const survey = surveysCache[surveyId];
                    const resRef = collection(db, 'artifacts', appId, 'users', user.uid, 'surveys', surveyId, 'responses');
                    const snapshot = await getDocs(resRef);
                    if(snapshot.empty) { alert("ç›®å‰æ²’æœ‰è³‡æ–™å¯ä»¥åŒ¯å‡ºã€‚"); return; }
                    let csvContent = "\uFEFF"; 
                    let headers = ["æäº¤æ™‚é–“"];
                    survey.questions.forEach((q, idx) => {
                        if(q.type === 'section') headers.push(`"SECTION: ${q.text.replace(/"/g, '""')}"`);
                        else headers.push(`"Q${idx+1}: ${q.text.replace(/"/g, '""')}"`);
                    });
                    csvContent += headers.join(",") + "\n";
                    snapshot.forEach(doc => {
                        const data = doc.data();
                        const time = data.submittedAt ? new Date(data.submittedAt.seconds * 1000).toLocaleString('zh-TW') : "æœªçŸ¥æ™‚é–“";
                        let row = [`"${time}"`];
                        survey.questions.forEach((q, idx) => {
                            if(q.type === 'section') row.push('""');
                            else {
                                let ans = data.answers && data.answers[idx];
                                if(!ans) ans = "";
                                if(Array.isArray(ans)) ans = ans.join("; "); 
                                row.push(`"${String(ans).replace(/"/g, '""')}"`);
                            }
                        });
                        csvContent += row.join(",") + "\n";
                    });
                    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                    const url = URL.createObjectURL(blob);
                    const link = document.createElement("a");
                    link.setAttribute("href", url);
                    link.setAttribute("download", `å•å·åŒ¯å‡º_${survey.title}.csv`);
                    document.body.appendChild(link); link.click(); document.body.removeChild(link);
                } catch(e) { console.error(e); showToast("åŒ¯å‡ºå¤±æ•—", "error"); } finally { btn.innerHTML = originalText; btn.disabled = false; }
            },
            viewResults: async (surveyId) => { /* ... SAME ... */
                const survey = surveysCache[surveyId];
                const modal = document.getElementById('results-modal');
                const content = document.getElementById('results-content');
                modal.classList.remove('hidden');
                document.getElementById('export-btn').onclick = () => app.exportToCSV(surveyId);
                content.innerHTML = '<div class="text-center py-10"><i class="fa-solid fa-circle-notch fa-spin text-3xl text-blue-500"></i></div>';
                try {
                    const resRef = collection(db, 'artifacts', appId, 'users', user.uid, 'surveys', surveyId, 'responses');
                    const snapshot = await getDocs(resRef);
                    if(snapshot.empty) { content.innerHTML = '<div class="text-center py-10 text-gray-500">ç›®å‰é‚„æ²’æœ‰äººå¡«å¯«é€™ä»½å•å·ã€‚</div>'; return; }
                    let totalResponses = snapshot.size;
                    let stats = {}; 
                    (survey.questions || []).forEach((q, idx) => {
                        if (q.type === 'section') return; 
                        stats[idx] = { type: q.type, question: q.text, counts: {}, answers: [] };
                        if(q.options) q.options.forEach(opt => stats[idx].counts[opt] = 0);
                    });
                    snapshot.forEach(doc => {
                        const data = doc.data();
                        const answers = data.answers || {};
                        Object.keys(answers).forEach(qIdx => {
                            const val = answers[qIdx];
                            if(!stats[qIdx]) return;
                            if(stats[qIdx].type === 'text') { if(val) stats[qIdx].answers.push(val); }
                            else if (Array.isArray(val)) { val.forEach(v => { if(stats[qIdx].counts[v] !== undefined) stats[qIdx].counts[v]++; }); }
                            else { if(stats[qIdx].counts[val] !== undefined) stats[qIdx].counts[val]++; }
                        });
                    });
                    let html = `<div class="mb-6 bg-blue-50 p-4 rounded-lg text-center font-bold text-blue-800">ç¸½å¡«ç­”äººæ•¸ï¼š${totalResponses} äºº</div>`;
                    Object.keys(stats).sort((a,b) => parseInt(a)-parseInt(b)).forEach(idx => {
                        const item = stats[idx];
                        html += `<div class="bg-gray-50 p-4 rounded-xl border border-gray-200"><h4 class="font-bold text-gray-800 mb-3"><span class="bg-blue-200 text-blue-800 text-xs px-2 py-0.5 rounded mr-2">Q${parseInt(idx)+1}</span> ${escapeHtml(item.question)}</h4>`;
                        if(item.type === 'text') {
                            html += `<div class="max-h-40 overflow-y-auto space-y-2">`;
                            item.answers.forEach(ans => { html += `<div class="text-sm bg-white p-2 rounded border border-gray-100 text-gray-600">${escapeHtml(ans)}</div>`; });
                            html += `</div>`;
                        } else {
                            html += `<div class="space-y-3">`;
                            Object.keys(item.counts).forEach(opt => {
                                const count = item.counts[opt];
                                const percent = totalResponses > 0 ? Math.round((count / totalResponses) * 100) : 0;
                                html += `<div><div class="flex justify-between text-xs text-gray-600 mb-1"><span>${escapeHtml(opt)}</span><span>${count} ç¥¨ (${percent}%)</span></div><div class="w-full bg-gray-200 rounded-full h-2.5"><div class="bg-blue-600 h-2.5 rounded-full" style="width: ${percent}%"></div></div></div>`;
                            });
                            html += `</div>`;
                        }
                        html += `</div>`;
                    });
                    content.innerHTML = html;
                } catch (e) { console.error(e); content.innerHTML = '<div class="text-red-500 text-center">è¼‰å…¥çµ±è¨ˆå¤±æ•—</div>'; }
            },
            saveSurvey: async () => { /* ... SAME ... */ 
                if (!user) return;
                const saveBtn = document.getElementById('save-btn');
                const originalBtnText = saveBtn.innerHTML;
                saveBtn.disabled = true; saveBtn.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin"></i> å„²å­˜ä¸­...';
                try {
                    const title = document.getElementById('survey-title').value.trim();
                    const description = document.getElementById('survey-desc').value.trim();
                    if (!title) { showToast("è«‹è¼¸å…¥å•å·æ¨™é¡Œ", "error"); throw new Error("Title required"); }
                    const cards = document.querySelectorAll('.question-card');
                    const questions = Array.from(cards).map(card => {
                        const typeInput = card.querySelector('.question-type');
                        const type = typeInput ? typeInput.value : card.querySelector('select.question-type').value;
                        const text = card.querySelector('.question-input').value.trim();
                        if (type === 'section') {
                            const desc = card.querySelector('.question-desc-input').value.trim();
                            return { type, text, description: desc };
                        } else {
                            const required = card.querySelector('.question-required').checked;
                            let options = [];
                            if (type !== 'text') options = card.querySelector('.question-options').value.split('\n').map(o => o.trim()).filter(o => o);
                            return { type, text, options, required };
                        }
                    });
                    const surveyData = { title, description, questions, updatedAt: serverTimestamp() };
                    const surveyRef = doc(db, 'artifacts', appId, 'users', user.uid, 'surveys', currentSurveyId);
                    await setDoc(surveyRef, surveyData, { merge: true });
                    app.clearDirty();
                    showToast("å„²å­˜æˆåŠŸ");
                    setTimeout(() => window.app.showDashboard(), 1000);
                } catch (e) { if (e.message !== "Title required") showToast("å„²å­˜å¤±æ•—", "error"); } finally { saveBtn.disabled = false; saveBtn.innerHTML = originalBtnText; }
            },
            deleteSurvey: async (id) => { try { await deleteDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'surveys', id)); showToast("åˆªé™¤æˆåŠŸ"); loadSurveys(); } catch (e) { showToast("åˆªé™¤å¤±æ•—", "error"); } },
            requestDelete: (id) => {
                const modal = document.getElementById('delete-modal');
                const confirmBtn = document.getElementById('confirm-delete-btn');
                modal.classList.remove('hidden');
                const newBtn = confirmBtn.cloneNode(true);
                confirmBtn.parentNode.replaceChild(newBtn, confirmBtn);
                newBtn.addEventListener('click', async () => { modal.classList.add('hidden'); await window.app.deleteSurvey(id); });
            },
            
            // Public Submission (Manual check for mobile compatibility)
            submitResponse: async () => {
                const form = document.getElementById('public-form');
                if (!form.checkValidity()) {
                    const invalidElement = form.querySelector(':invalid');
                    if (invalidElement) {
                        const card = invalidElement.closest('.public-q-item');
                        if (card) {
                            card.scrollIntoView({ behavior: 'smooth', block: 'center' });
                            card.classList.add('ring-2', 'ring-red-400', 'bg-red-50', 'rounded-lg');
                            setTimeout(() => { card.classList.remove('ring-2', 'ring-red-400', 'bg-red-50', 'rounded-lg'); }, 2500);
                        }
                    }
                    showToast("é‚„æœ‰é¡Œç›®æœªå®Œæˆå–”ï¼", "error"); return;
                }
                const submitBtn = document.getElementById('submit-btn');
                submitBtn.disabled = true; submitBtn.innerText = "æäº¤ä¸­...";
                try {
                    const formData = new FormData(form);
                    const answers = {};
                    document.querySelectorAll('.public-q-item').forEach((div, idx) => {
                        const type = div.dataset.type;
                        if (type === 'section') return; 
                        const name = `q_${idx}`;
                        if (type === 'checkbox') answers[idx] = formData.getAll(name);
                        else answers[idx] = formData.get(name);
                    });
                    await addDoc(collection(db, 'artifacts', appId, 'users', publicModeOwnerId, 'surveys', publicModeSurveyId, 'responses'), { answers: answers, submittedAt: serverTimestamp() });
                    document.getElementById('public-form').classList.add('hidden');
                    document.getElementById('public-progress-bar').classList.add('hidden'); 
                    document.getElementById('thank-you-view').classList.remove('hidden');
                    window.scrollTo(0, 0);
                } catch (e) { console.error(e); showToast("æäº¤å¤±æ•—", "error"); submitBtn.disabled = false; submitBtn.innerText = "é€å‡ºå•å·"; }
            },
            updateProgressBar: () => {
                const form = document.getElementById('public-form');
                const total = document.querySelectorAll('.public-q-item[data-type!="section"]').length; 
                if(total === 0) return;
                const answered = new Set();
                const formData = new FormData(form);
                for(let [key, val] of formData.entries()) { if(val) answered.add(key); }
                const count = answered.size;
                const percent = Math.round((count / total) * 100);
                document.getElementById('progress-fill').style.width = `${percent}%`;
            }
        };

        // Robust loadSurveys
        async function loadSurveys() {
            if (!user) return;
            const listContainer = document.getElementById('survey-list');
            const emptyState = document.getElementById('empty-state');
            
            try {
                const q = collection(db, 'artifacts', appId, 'users', user.uid, 'surveys');
                const snapshot = await getDocs(q);
                
                listContainer.innerHTML = '';
                surveysCache = {};

                if (snapshot.empty) {
                    emptyState.classList.remove('hidden');
                } else {
                    emptyState.classList.add('hidden');
                    let surveys = [];
                    snapshot.forEach(doc => { 
                        // Defensive coding: Handle malformed data
                        try {
                            const data = { id: doc.id, ...doc.data() }; 
                            surveys.push(data); 
                            surveysCache[doc.id] = data; 
                        } catch(err) {
                            console.error("Skipping corrupted survey:", doc.id, err);
                        }
                    });
                    
                    surveys.sort((a, b) => (b.updatedAt?.seconds || 0) - (a.updatedAt?.seconds || 0));
                    
                    surveys.forEach(survey => {
                        const qCount = survey.questions ? survey.questions.filter(q => q.type !== 'section').length : 0;
                        const date = survey.updatedAt ? new Date(survey.updatedAt.seconds * 1000).toLocaleDateString('zh-TW') : 'å‰›å‰›';
                        // Safe html injection
                        const card = `
                        <div class="bg-white rounded-xl shadow-sm hover:shadow-lg transition p-5 border border-gray-200 flex flex-col h-full">
                            <div class="flex-1">
                                <h3 class="font-bold text-lg text-gray-800 mb-2 line-clamp-1">${escapeHtml(survey.title) || 'æœªå‘½å'}</h3>
                                <p class="text-gray-500 text-sm line-clamp-2 mb-4 h-10">${escapeHtml(survey.description) || 'ç„¡æè¿°'}</p>
                                <div class="flex items-center gap-4 text-xs text-gray-400">
                                    <span class="bg-gray-100 px-2 py-1 rounded"><i class="fa-solid fa-list-ol mr-1"></i> ${qCount} é¡Œ</span>
                                    <span><i class="fa-regular fa-clock mr-1"></i> ${date}</span>
                                </div>
                            </div>
                            <div class="mt-5 pt-4 border-t border-gray-100 flex flex-wrap justify-between gap-y-2 gap-x-1 items-center">
                                <button onclick="window.app.viewResults('${survey.id}')" class="text-gray-600 hover:bg-gray-100 px-2 py-1.5 rounded-lg text-xs font-medium transition tap-target" title="æŸ¥çœ‹çµæœ">
                                    <i class="fa-solid fa-chart-simple text-blue-500"></i> <span class="hidden md:inline">çµ±è¨ˆ</span>
                                </button>
                                <div class="flex gap-1 flex-wrap">
                                    <button onclick="window.app.duplicateSurvey('${survey.id}')" class="text-gray-500 hover:bg-gray-100 px-2 py-1.5 rounded-lg text-xs font-medium transition tap-target w-8 h-8 flex items-center justify-center" title="è¤‡è£½"><i class="fa-regular fa-copy"></i></button>
                                    <button onclick="window.app.openShareModal('${survey.id}')" class="text-green-600 hover:bg-green-50 px-2 py-1.5 rounded-lg text-xs font-medium transition tap-target w-8 h-8 flex items-center justify-center" title="ç™¼å¸ƒ"><i class="fa-solid fa-share-nodes"></i></button>
                                    <button onclick="window.app.editSurvey('${survey.id}')" class="text-blue-600 hover:bg-blue-50 px-2 py-1.5 rounded-lg text-xs font-medium transition tap-target w-8 h-8 flex items-center justify-center" title="ç·¨è¼¯"><i class="fa-solid fa-pen"></i></button>
                                    <button onclick="window.app.requestDelete('${survey.id}')" class="text-red-500 hover:bg-red-50 px-2 py-1.5 rounded-lg text-xs font-medium transition tap-target w-8 h-8 flex items-center justify-center" title="åˆªé™¤"><i class="fa-solid fa-trash"></i></button>
                                </div>
                            </div>
                        </div>`;
                        listContainer.innerHTML += card;
                    });
                }
            } catch (e) {
                console.error("Load Surveys Error", e);
                // Show error in list instead of blank
                listContainer.innerHTML = `<div class="col-span-3 text-center text-red-500 p-4 border border-red-200 rounded-lg bg-red-50">
                    <i class="fa-solid fa-circle-exclamation mb-2"></i><br>
                    è®€å–åˆ—è¡¨å¤±æ•—<br>
                    <button onclick="loadSurveys()" class="mt-2 text-xs bg-white border border-red-300 px-3 py-1 rounded text-red-600">é‡è©¦</button>
                </div>`;
                document.getElementById('empty-state').classList.add('hidden');
            }
        }

        async function loadPublicSurvey(surveyId, ownerId) {
            // ... (Previous logic, no major changes needed, just ensure try-catch wraps everything)
            try {
                const docRef = doc(db, 'artifacts', appId, 'users', ownerId, 'surveys', surveyId);
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) {
                    // ... (Rendering logic same as before)
                    const data = docSnap.data();
                    document.getElementById('public-title').textContent = data.title;
                    document.getElementById('public-desc').textContent = data.description || "è«‹å›ç­”ä»¥ä¸‹å•é¡Œ";
                    const container = document.getElementById('public-questions');
                    container.innerHTML = '';
                    (data.questions || []).forEach((q, idx) => {
                        // ... (Question rendering same as before)
                        // Including Section logic
                         if (q.type === 'section') {
                            const sectionHTML = `
                            <div class="public-q-item pt-4 pb-2 border-b border-gray-200 mb-6" data-type="section">
                                <h3 class="text-2xl font-bold text-gray-800 mb-2 border-l-4 border-orange-400 pl-3">${escapeHtml(q.text)}</h3>
                                ${q.description ? `<div class="text-gray-600 leading-relaxed whitespace-pre-wrap text-base">${escapeHtml(q.description)}</div>` : ''}
                            </div>`;
                            container.insertAdjacentHTML('beforeend', sectionHTML);
                            return;
                        }
                        // ... (Normal question rendering same as before)
                        // For brevity, assuming the rendering logic is preserved from previous turn 
                        let inputHtml = '';
                        const name = `q_${idx}`;
                        const isReq = (q.required !== undefined) ? q.required : true;
                        const reqAttr = isReq ? 'required' : '';
                        const reqMark = isReq ? '<span class="text-red-500 ml-1">*</span>' : '';
                        const questionId = `pq-${idx}`;
                        if (q.type === 'text') {
                            inputHtml = `<input type="text" name="${name}" ${reqAttr} class="w-full border-gray-300 rounded-lg p-3 border focus:ring-2 focus:ring-blue-500 focus:outline-none text-base" placeholder="è«‹è¼¸å…¥æ‚¨çš„ç­”æ¡ˆ..." oninput="app.updateProgressBar()">`;
                        } else if (q.type === 'radio') {
                            const optionsCount = q.options.length;
                            let gridClass = `grid grid-cols-3 sm:grid-cols-4 lg:grid-cols-${Math.min(optionsCount, 7)} gap-2`;
                            inputHtml = `<div class="${gridClass}">` + q.options.map(opt => {
                                    const emoji = getEmojiForScale(opt, idx, optionsCount);
                                    const colorClass = getColorClassForScale(opt, optionsCount);
                                    const emojiHtml = emoji ? `<div class="text-xl md:text-3xl mb-1">${emoji}</div>` : '';
                                    return `<label class="cursor-pointer relative group"><input type="radio" name="${name}" value="${opt}" ${reqAttr} class="peer sr-only" onchange="app.updateProgressBar(); setTimeout(() => { const next = document.getElementById('pq-${idx+1}'); if(next) next.scrollIntoView({behavior: 'smooth', block: 'center'}); }, 300)"><div class="h-full p-2 md:p-4 border-2 rounded-lg hover:border-blue-300 transition flex flex-col items-center justify-center text-center min-h-[60px] ${colorClass}">${emojiHtml}<div class="text-xs md:text-sm font-bold text-gray-700 break-words leading-tight">${escapeHtml(opt)}</div></div></label>`;
                                }).join('') + `</div>`;
                        } else if (q.type === 'checkbox') {
                             inputHtml = `<div class="space-y-2">` + q.options.map(opt => `<label class="flex items-center gap-3 p-3 border border-gray-200 rounded-lg hover:bg-gray-50 cursor-pointer"><input type="checkbox" name="${name}" value="${opt}" class="w-5 h-5 text-blue-600 focus:ring-blue-500 rounded" onchange="app.updateProgressBar()"><span class="text-gray-700 text-base">${escapeHtml(opt)}</span></label>`).join('') + `</div>`;
                        }
                        const qHtml = `<div id="${questionId}" class="public-q-item space-y-3 scroll-mt-20" data-type="${q.type}"><h3 class="font-bold text-lg md:text-xl text-gray-800 break-words leading-relaxed"><span class="text-blue-600 mr-2"></span> ${escapeHtml(q.text)} ${reqMark}</h3>${inputHtml}</div>`;
                        container.insertAdjacentHTML('beforeend', qHtml);
                    });

                    document.getElementById('public-view').classList.remove('hidden');
                    document.getElementById('public-progress-bar').classList.remove('hidden'); 
                } else {
                    document.getElementById('public-title').textContent = "æ‰¾ä¸åˆ°å•å·";
                    document.getElementById('public-view').classList.remove('hidden');
                    document.getElementById('public-form').classList.add('hidden');
                }
            } catch (e) {
                console.error("Public Load Error", e);
                showToast("è¼‰å…¥å¤±æ•—", "error");
                document.getElementById('public-title').textContent = "è¼‰å…¥éŒ¯èª¤";
                document.getElementById('public-desc').textContent = "ç„¡æ³•è®€å–å•å·è³‡æ–™ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚";
                document.getElementById('public-view').classList.remove('hidden');
            }
        }

        function showToast(msg, type = 'success') {
            const toast = document.getElementById('toast');
            const icon = document.getElementById('toast-icon');
            const msgSpan = document.getElementById('toast-msg');
            msgSpan.textContent = msg;
            icon.className = type === 'error' ? 'fa-solid fa-circle-exclamation text-red-400' : 'fa-solid fa-check-circle text-green-400';
            toast.classList.remove('translate-x-full');
            setTimeout(() => toast.classList.add('translate-x-full'), 3000);
        }
    </script>
</body>
</html>
