<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Firebase å•å·ç³»çµ±</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <!-- å­—é«” -->
    <link href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@400;700&family=Noto+Serif+TC:wght@400;700&family=DotGothic16&family=Space+Mono:wght@700&family=Noto+Sans+TC:wght@300;400;500;700&family=Comic+Neue:wght@700&family=Kosugi+Maru&family=Press+Start+2P&display=swap" rel="stylesheet">

    <style>
        /* --- æ ¸å¿ƒè®Šæ•¸ç³»çµ± --- */
        :root {
            --bg-color: #FAF7F0;
            --bg-image: none;
            --text-color: #4A4A4A;
            --card-bg: #ffffff;
            --card-border: 1px solid rgba(0,0,0,0.05);
            --card-radius: 20px;
            --card-shadow: 0 10px 15px -3px rgba(86, 138, 102, 0.1);
            --primary-color: #568A66;
            --primary-text: #ffffff;
            --secondary-color: #E67F65;
            --input-bg: #ffffff;
            --input-border: 2px solid #eeeeee;
            --select-bg: #eff6ff;
            --select-border: #2563eb;
            --select-text: #1e3a8a;
            --font-family: 'Zen Maru Gothic', 'Noto Sans TC', sans-serif;
            --letter-spacing: 0px;
            --btn-shadow: 0 4px 0 var(--ghibli-green-dark);
            --btn-hover-filter: brightness(110%);
            --text-glow: none;
            --progress-radius: 9999px; /* é€²åº¦æ¢åœ“è§’ */
            --pixel-scale: 1; /* åƒç´ é¢¨æ ¼ç¸®æ”¾ */
        }

        html, body { 
            overflow-x: hidden; 
            min-height: 100dvh; 
            background-color: var(--bg-color); 
            background-image: var(--bg-image);
            background-attachment: fixed;
            background-size: cover;
            background-position: center;
            font-family: var(--font-family);
            letter-spacing: var(--letter-spacing);
            color: var(--text-color);
            -webkit-tap-highlight-color: transparent; 
            transition: background-color 0.5s ease, color 0.3s ease;
        }
        
        body { display: flex; flex-direction: column; }
        h1, h2, h3, h4 { text-shadow: var(--text-glow); }

        .theme-card {
            background-color: var(--card-bg);
            border-radius: var(--card-radius);
            border: var(--card-border);
            box-shadow: var(--card-shadow);
            transition: all 0.3s ease;
            backdrop-filter: blur(0px);
        }

        .theme-btn {
            background-color: var(--primary-color);
            color: var(--primary-text);
            border-radius: var(--card-radius);
            box-shadow: var(--btn-shadow);
            border: none;
            transition: all 0.1s;
            filter: var(--btn-hover-filter);
            position: relative;
            overflow: hidden;
        }
        .theme-btn:active { transform: translateY(2px); box-shadow: none !important; }
        
        .theme-input {
            background-color: var(--input-bg);
            border: var(--input-border);
            color: var(--text-color);
            border-radius: calc(var(--card-radius) / 2);
            transition: all 0.2s;
        }
        .theme-input:focus {
            border-color: var(--primary-color);
            outline: none;
            box-shadow: 0 0 0 3px rgba(var(--primary-color), 0.2);
        }

        input:checked + div { 
            transform: scale(0.98); 
            background-color: var(--select-bg) !important;
            border-color: var(--select-border) !important;
            color: var(--select-text) !important;
            box-shadow: inset 0 0 0 2px var(--select-border);
            font-weight: bold;
        }

        /* ç‰¹æ®Šé¢¨æ ¼è¦†è“‹ */
        [data-theme="blackboard"] input:checked + div { box-shadow: inset 0 0 0 2px var(--primary-color), 0 0 5px var(--primary-color); background-color: rgba(255,255,255,0.1) !important; }
        [data-theme="comic"] .theme-card, [data-theme="comic"] .theme-input, [data-theme="comic"] .theme-btn { border: 2px solid black; }
        [data-theme="comic"] input:checked + div { border: 3px solid black !important; box-shadow: 4px 4px 0 black; transform: translate(-2px, -2px); }
        [data-theme="pixel"] * { image-rendering: pixelated; } /* åƒç´ æ¸…æ™°åŒ– */

        /* è£é£¾å±¤ */
        .noise-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: -1; opacity: 0.05; background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.65' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)'/%3E%3C/svg%3E"); display: none; }
        
        /* é›²æœµèˆ‡å…¶ä»–è£é£¾ (é è¨­éš±è—) */
        .decor-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: -1; display: none; overflow: hidden; }
        .cloud { position: absolute; background: white; border-radius: 100px; opacity: 0.8; } 
        .cloud-1 { width: 120px; height: 40px; top: 10%; left: -10%; animation: float 25s infinite linear; }
        .cloud-2 { width: 180px; height: 60px; top: 20%; right: -20%; animation: float 35s infinite linear reverse; }
        @keyframes float { 0% { transform: translateX(0); } 50% { transform: translateX(20px); } 100% { transform: translateX(0); } }

        /* é¾è²“é€²åº¦æ¢å‹•ç•« */
        .totoro-progress {
            position: absolute; right: -20px; top: -25px; width: 40px; height: 40px;
            background-image: url('https://cdn-icons-png.flaticon.com/512/3063/3063176.png'); /* é¾è²“ icon */
            background-size: contain; background-repeat: no-repeat;
            transition: left 0.5s ease-out;
            display: none;
        }

        .fade-in { animation: fadeIn 0.4s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .error-shake { animation: shake 0.4s cubic-bezier(.36,.07,.19,.97) both; border-color: #ef4444 !important; background-color: #fef2f2 !important; }
        @keyframes shake { 10%, 90% { transform: translate3d(-1px, 0, 0); } 20%, 80% { transform: translate3d(2px, 0, 0); } 30%, 50%, 70% { transform: translate3d(-4px, 0, 0); } 40%, 60% { transform: translate3d(4px, 0, 0); } }
        .tap-target { min-height: 48px; cursor: pointer; }
        .safe-pb { padding-bottom: env(safe-area-inset-bottom, 20px); }
        .drag-handle { cursor: grab; touch-action: none; }
        .question-card.dragging { opacity: 0.5; border: 2px dashed var(--primary-color); background-color: var(--select-bg); }
        
        .likert-opt-1 { color: #ef4444; } .likert-opt-2 { color: #f97316; } .likert-opt-3 { color: #eab308; } .likert-opt-4 { color: #84cc16; } .likert-opt-5 { color: #22c55e; } 
        .opt-default { border: 1px solid #e5e7eb; background-color: white; }
    </style>

    <script>
        window.app = {}; 

        // --- 22 ç¨®æ¥µè‡´é¢¨æ ¼å®šç¾© ---
        const THEMES = {
            'ghibli': { 
                name: '1. å‰åœåŠ›é¢¨ (Ghibli)', 
                bg: '#FAF7F0', 
                image: 'radial-gradient(#E5E0D0 1px, transparent 1px)', 
                bgSize: '20px 20px',
                text: '#4A4A4A', card: '#ffffff', primary: '#568A66', radius: '20px', 
                shadow: '0 10px 15px -3px rgba(86, 138, 102, 0.15)', 
                font: "'Zen Maru Gothic', sans-serif",
                btnShadow: '0 4px 0 #3E664B',
                decor: 'ghibli' // Enable clouds
            },
            'miyazaki': {
                name: '21. å®®å´é§¿å¤©ç©º (Miyazaki Sky)',
                bg: '#87CEEB', // Sky Blue
                image: 'linear-gradient(180deg, #87CEEB 0%, #B0E0E6 60%, #66BB6A 60%)', // Sky to Grass
                text: '#2F4F4F',
                card: 'rgba(255, 255, 255, 0.9)',
                primary: '#FF7F50', // Coral
                radius: '25px',
                shadow: '0 8px 20px rgba(0,0,0,0.1)',
                font: "'Zen Maru Gothic', sans-serif",
                btnShadow: '0 4px 0 #CD5C5C',
                btnText: 'ä¹˜è‘—é¢¨å‡ºç™¼', // Custom button text
                decor: 'ghibli' // Enable clouds & Totoro
            },
            'pixel': {
                name: '22. å¾©å¤åƒç´ é¢¨ (8-bit)',
                bg: '#222034', // Dark purple/black
                image: 'linear-gradient(transparent 95%, #33ff00 95%), linear-gradient(90deg, transparent 95%, #33ff00 95%)', // Green grid
                bgSize: '20px 20px',
                text: '#33ff00', // Retro Green
                card: '#000000',
                primary: '#33ff00',
                radius: '0px',
                border: '4px solid #33ff00',
                shadow: '8px 8px 0 #004400',
                font: "'Press Start 2P', cursive", // Pixel font
                btnShadow: '4px 4px 0 #004400',
                selectBg: '#004400', selectBorder: '#33ff00', selectText: '#33ff00',
                inputBg: '#000', inputBorder: '2px solid #33ff00',
                btnText: 'START GAME', // Custom button text
                progressBar: 'hp-bar' // Special HP bar style
            },
            'muji': { name: '2. éŸ“ç³»æ–‡é’ (MUJI)', bg: '#F3F2ED', text: '#595750', card: '#FCFAF7', primary: '#8C8376', radius: '2px', shadow: 'none', border: '1px solid #E6E4E0', font: "'Noto Serif TC', serif", btnShadow: 'none', selectBg: '#EAE8E4', selectBorder: '#8C8376', selectText: '#595750', spacing: '1px' },
            'taiwan': { name: '3. å°ç£æ’ç•«é¢¨', bg: '#FFF8E1', image: 'repeating-linear-gradient(45deg, #FFECB3 0, #FFECB3 1px, transparent 1px, transparent 10px)', bgSize: '20px 20px', text: '#5D4037', card: '#FFFFFF', primary: '#FF7043', radius: '16px', shadow: '4px 4px 0px #FFCCBC', border: '2px solid #5D4037', font: "'Zen Maru Gothic', sans-serif'"},
            'pixar': { name: '4. è¿ªå£«å°¼/çš®å…‹æ–¯', bg: '#CAF0F8', image: 'radial-gradient(circle at 50% 0%, #ffffff 0%, #CAF0F8 80%)', text: '#023E8A', card: '#FFFFFF', primary: '#0077B6', radius: '24px', shadow: '0 10px 25px rgba(0,119,182,0.25)', font: "sans-serif", btnShadow: '0 6px 0 #023E8A' },
            'watercolor': { name: '5. æ‰‹ç¹ªæ°´å½©é¢¨', bg: '#F0F8FF', image: 'url("data:image/svg+xml,%3Csvg viewBox=\'0 0 200 200\' xmlns=\'http://www.w3.org/2000/svg\'%3E%3Cfilter id=\'noise\'%3E%3CfeTurbulence type=\'fractalNoise\' baseFrequency=\'0.8\' numOctaves=\'3\' stitchTiles=\'stitch\'/%3E%3C/filter%3E%3Crect width=\'100%25\' height=\'100%25\' filter=\'url(%23noise)\' opacity=\'0.15\'/%3E%3C/svg%3E")', text: '#5D6D7E', card: 'rgba(255,255,255,0.85)', primary: '#7FB3D5', radius: '30px', shadow: '0 8px 32px rgba(31, 38, 135, 0.1)', font: "serif", border: '1px solid rgba(255,255,255,0.6)' },
            'blackboard': { name: '6. æ–‡é’é»‘æ¿é¢¨', bg: '#2F3E46', text: '#F0F0F0', card: '#354F52', primary: '#F4D35E', radius: '6px', border: '2px dashed rgba(255,255,255,0.2)', shadow: 'inset 0 0 30px rgba(0,0,0,0.5)', font: "'DotGothic16', monospace", selectBg: '#52796F', selectBorder: '#F4D35E', selectText: '#F4D35E', inputBg: '#2F3E46', inputBorder: '1px dashed #84A98C', inputStyle: 'dashed' },
            'flat': { name: '7. æ‰å¹³åŒ–æ’ç•«', bg: '#ECF0F1', text: '#2C3E50', card: '#FFFFFF', primary: '#3498DB', radius: '4px', shadow: '0 2px 5px rgba(0,0,0,0.05)', border: '1px solid #BDC3C7', font: "'Roboto', sans-serif", btnShadow: 'none' },
            'cute': { name: '8. å¯æ„› Q ç‰ˆ', bg: '#FFF0F5', image: 'radial-gradient(#FFB6C1 3px, transparent 3px)', bgSize: '30px 30px', text: '#8B4513', card: '#FFFFFF', primary: '#FF80AB', radius: '30px', shadow: '0 8px 0 #FFC1E3', border: '3px solid #FF80AB', font: "'Kosugi Maru', sans-serif", btnShadow: '0 6px 0 #C51162' },
            'cyberpunk': { name: '9. æœªä¾†æ„Ÿéœ“è™¹', bg: '#050505', image: 'linear-gradient(rgba(0, 255, 255, 0.05) 1px, transparent 1px), linear-gradient(90deg, rgba(0, 255, 255, 0.05) 1px, transparent 1px)', bgSize: '30px 30px', text: '#00FFFF', card: '#0A0A0A', primary: '#FF00FF', radius: '0px', border: '1px solid #00FFFF', shadow: '0 0 15px rgba(0, 255, 255, 0.3)', font: "'Space Mono', monospace", selectBg: '#111', selectBorder: '#FF00FF', selectText: '#FF00FF', inputBg: '#000', inputBorder: '1px solid #00FFFF', textGlow: '0 0 5px #00FFFF' },
            'fresh': { name: '10. å°ç´…æ›¸é¢¨', bg: '#FAFAFA', text: '#333333', card: '#FFFFFF', primary: '#FF5252', radius: '16px', shadow: '0 10px 40px -10px rgba(0,0,0,0.08)', font: "sans-serif", border: '1px solid #f0f0f0' },
            'map': { name: '11. æ—…éŠåœ°åœ–é¢¨', bg: '#F4EBD0', image: 'repeating-linear-gradient(90deg, #E6D5B8 0, #E6D5B8 1px, transparent 1px, transparent 40px)', text: '#5D4037', card: '#FFF8E1', primary: '#D84315', radius: '10px', shadow: '5px 5px 0 rgba(93, 64, 55, 0.2)', font: "serif", border: '2px dashed #8D6E63' },
            'japanese': { name: '12. æ—¥ç³»æ¥µç°¡é¢¨', bg: '#FFFFFF', text: '#222222', card: '#FFFFFF', primary: '#000000', radius: '0px', border: '1px solid #E5E5E5', shadow: 'none', font: "'Noto Serif TC', serif", selectBg: '#F5F5F5', selectBorder: '#333', selectText: '#000', spacing: '1px' },
            'comic': { name: '13. æ¼«ç•«é¢¨', bg: '#FFFFFF', image: 'radial-gradient(#000 10%, transparent 11%)', bgSize: '5px 5px', text: '#000000', card: '#FFFFFF', primary: '#FFE600', radius: '0px', border: '3px solid #000000', shadow: '6px 6px 0px #000000', font: "sans-serif", btnShadow: '4px 4px 0 #000', selectBg: '#000', selectBorder: '#000', selectText: '#FFF' },
            'animal': { name: '14. å‹•ç‰©æ£®å‹æœƒ', bg: '#B8E994', image: 'repeating-linear-gradient(45deg, #78E08F 0, #78E08F 20px, #B8E994 20px, #B8E994 40px)', text: '#3C6382', card: '#F8F3D4', primary: '#FA983A', radius: '24px', border: '4px solid #FFFFFF', shadow: '0 8px 0 rgba(0,0,0,0.1)', font: "'Zen Maru Gothic', sans-serif" },
            'forest': { name: '15. è‡ªç„¶æ£®æ—é¢¨', bg: '#2D6A4F', text: '#D8F3DC', card: '#1B4332', primary: '#52B788', radius: '16px', border: 'none', shadow: '0 20px 25px -5px rgba(0, 0, 0, 0.3)', font: "sans-serif", selectBg: '#40916C', selectBorder: '#74C69D', selectText: '#fff', inputBg: '#081C15', inputBorder: '1px solid #52B788' },
            'geometric': { name: '16. æ¥µç°¡å¹¾ä½•é¢¨', bg: '#F3F4F6', image: 'linear-gradient(135deg, #E5E7EB 25%, transparent 25%) -50px 0', bgSize: '100px 100px', text: '#111827', card: '#FFFFFF', primary: '#4F46E5', radius: '0px', shadow: '0 20px 25px -5px rgba(0, 0, 0, 0.1)', font: "sans-serif", selectBg: '#EEF2FF', selectBorder: '#4F46E5', selectText: '#4338CA' },
            'vogue': { name: '17. æ­ç³»é«˜ç´šé›œèªŒ', bg: '#F0F0F0', text: '#000000', card: '#FFFFFF', primary: '#000000', radius: '0px', border: '1px solid #000000', shadow: 'none', font: "'Noto Serif TC', serif", btnShadow: 'none' },
            'corporate': { name: '18. ä¼æ¥­ç°¡å ±é¢¨', bg: '#F0F2F5', text: '#1C1E21', card: '#FFFFFF', primary: '#1877F2', radius: '8px', border: '1px solid #E5E7EB', shadow: '0 1px 2px rgba(0, 0, 0, 0.05)', font: "sans-serif" },
            'edtech': { name: '19. ç¾ä»£æ•™è‚²ç§‘æŠ€', bg: '#F0FDF4', image: 'linear-gradient(#E5E7EB 1px, transparent 1px), linear-gradient(90deg, #E5E7EB 1px, transparent 1px)', bgSize: '20px 20px', text: '#064E3B', card: '#FFFFFF', primary: '#10B981', radius: '12px', border: '1px solid #D1FAE5', shadow: '0 4px 6px -1px rgba(16, 185, 129, 0.1)', font: "sans-serif" },
            'paper': { name: '20. é«˜ç´šç´™å¼µè³ªæ„Ÿ', bg: '#FDFBF7', text: '#2C2825', card: '#FFFCF5', primary: '#A67C00', radius: '2px', shadow: '0 2px 10px rgba(0,0,0,0.03)', font: "'Noto Serif TC', serif", noise: true, border: '1px solid #E6E2D8' },
            'harrypotter': { name: '23. å“ˆåˆ©æ³¢ç‰¹é­”æ³•æ‰‹ç¹ª', bg: '#F8F4E3', image: 'radial-gradient(circle at 50% 30%, #FFFBE6 0%, #F8F4E3 60%, #EFE6D5 100%)', text: '#5D4037', card: '#FFFEF7', primary: '#A0522D', radius: '20px', border: '3px solid #A0522D', shadow: '5px 5px 0px #D4AF37', font: "'Zen Maru Gothic', sans-serif", btnShadow: '3px 3px 0px #5D4037', noise: true, selectBg: '#FFF3E0', selectBorder: '#A0522D', selectText: '#A0522D' }
        };

        window.applyTheme = function(themeKey) {
            const theme = THEMES[themeKey] || THEMES['ghibli'];
            const r = document.documentElement;
            
            document.body.setAttribute('data-theme', themeKey);

            r.style.setProperty('--bg-color', theme.bg);
            r.style.setProperty('--bg-image', theme.image || 'none');
            r.style.setProperty('--bg-size', theme.bgSize || 'auto');
            r.style.setProperty('--bg-pos', theme.bgPos || '0 0');
            r.style.setProperty('--text-color', theme.text);
            r.style.setProperty('--card-bg', theme.card);
            r.style.setProperty('--primary-color', theme.primary);
            r.style.setProperty('--card-radius', theme.radius);
            r.style.setProperty('--font-family', theme.font);
            r.style.setProperty('--letter-spacing', theme.spacing || '0px');
            r.style.setProperty('--text-glow', theme.textGlow || 'none');

            r.style.setProperty('--card-border', theme.border || '1px solid rgba(0,0,0,0.05)');
            r.style.setProperty('--card-shadow', theme.shadow || '0 4px 6px -1px rgba(0,0,0,0.05)');
            r.style.setProperty('--btn-shadow', theme.btnShadow || '0 2px 4px rgba(0,0,0,0.1)');
            
            r.style.setProperty('--select-bg', theme.selectBg || '#eff6ff');
            r.style.setProperty('--select-border', theme.selectBorder || theme.primary);
            r.style.setProperty('--select-text', theme.selectText || theme.primary);
            
            r.style.setProperty('--input-bg', theme.inputBg || '#ffffff');
            r.style.setProperty('--input-border', theme.inputBorder || '2px solid #eeeeee');
            r.style.setProperty('--input-style', theme.inputStyle || 'solid');
            
            // é€²åº¦æ¢åœ“è§’
            r.style.setProperty('--progress-radius', themeKey === 'pixel' ? '0px' : '9999px');

            const noise = document.querySelector('.noise-overlay');
            if(noise) noise.style.display = theme.noise ? 'block' : 'none';
            
            const decor = document.querySelector('.decor-layer');
            if(decor) {
                decor.style.display = (themeKey === 'ghibli' || themeKey === 'miyazaki') ? 'block' : 'none';
            }

            // æ›´æ–°æŒ‰éˆ•æ–‡å­—
            const submitBtn = document.getElementById('public-submit-btn');
            if(submitBtn) submitBtn.innerHTML = (theme.btnText || 'é€å‡ºå•å·') + (themeKey === 'pixel' ? '' : ' <i class="fa-solid fa-paper-plane ml-2"></i>');
        };

        window.showToast = function(msg, type = 'success') {
            const toast = document.getElementById('toast');
            const icon = document.getElementById('toast-icon');
            const msgSpan = document.getElementById('toast-msg');
            if(!toast) return;
            
            msgSpan.textContent = msg;
            const colorClass = type === 'error' ? 'text-red-500' : 'text-green-700';
            const bgClass = type === 'error' ? 'bg-red-50 border-red-200' : 'bg-green-50 border-green-200';
            
            icon.className = type === 'error' ? 'fa-solid fa-circle-exclamation ' + colorClass : 'fa-solid fa-leaf ' + colorClass;
            toast.className = `fixed top-20 right-5 z-[100] px-6 py-3 rounded-2xl shadow-lg flex items-center gap-3 transition-transform duration-300 border-2 ${bgClass}`;
            
            toast.style.transform = 'translateX(0) rotate(-2deg)';
            setTimeout(() => { toast.style.transform = 'translateX(150%) rotate(0)'; }, 3000);
        };

        window.safeGet = function(id) {
            const el = document.getElementById(id);
            return el || { classList: { remove:()=>{}, add:()=>{}, toggle:()=>{}, contains:()=>false }, style: {}, value: '', disabled: false, innerHTML: '', addEventListener: ()=>{} }; 
        };

        window.escapeHtml = function(text) {
            if (text === null || text === undefined) return '';
            return String(text).replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
        };

        window.onerror = function(msg, url, line) {
            console.error("Global Error:", msg);
            const errorDiv = document.getElementById('global-error');
            if(errorDiv) {
                errorDiv.classList.remove('hidden');
                document.getElementById('global-error-msg').innerText = `${msg} (Line: ${line})`;
            }
            const loading = document.getElementById('loading-view');
            if(loading) loading.classList.add('hidden');
        };

        window.scrollToNext = function(currentElement) {
            const currentCard = currentElement.closest('.public-q-item');
            if (!currentCard) return;
            const nextElement = currentCard.nextElementSibling;
            if (nextElement) {
                setTimeout(() => nextElement.scrollIntoView({ behavior: 'smooth', block: 'center' }), 300);
            } else {
                setTimeout(() => {
                    const submitBtn = document.getElementById('public-submit-btn');
                    if (submitBtn) submitBtn.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }, 300);
            }
        };
        
        window.closeWindow = function() { try { window.close(); } catch(e) {} }
    </script>
</head>
<body class="text-gray-800">

    <div class="noise-overlay"></div>
    
    <!-- è£é£¾å±¤ï¼šé›²æœµ -->
    <div class="decor-layer">
        <div class="cloud cloud-1"></div>
        <div class="cloud cloud-2"></div>
        <!-- å¯åœ¨æ­¤åŠ å…¥é¾è²“ç­‰å…ƒç´  -->
        <!-- <div class="totoro-progress"></div> -->
    </div>

    <div id="global-error" class="hidden fixed inset-0 bg-red-50/90 z-[200] flex flex-col items-center justify-center p-6 text-center backdrop-blur-sm">
        <h2 class="text-xl font-bold text-red-600 mb-2">ç³»çµ±ç™¼ç”ŸéŒ¯èª¤</h2>
        <p id="global-error-msg" class="text-sm text-gray-600 mb-4 break-all">Unknown</p>
        <button onclick="location.reload()" class="bg-red-600 text-white px-4 py-2 rounded">é‡æ–°æ•´ç†</button>
    </div>

    <div id="public-progress-bar" class="fixed top-0 left-0 w-full h-2 bg-gray-200 z-[60] hidden">
        <div id="progress-fill" class="h-full bg-[var(--primary-color)] transition-all duration-500 ease-out" style="width: 0%; border-top-right-radius: var(--progress-radius); border-bottom-right-radius: var(--progress-radius);"></div>
    </div>

    <nav id="admin-nav" class="bg-[var(--primary-color)] text-white shadow-lg sticky top-0 z-50 hidden transition-colors duration-500">
        <div class="max-w-6xl mx-auto px-4 py-3 flex justify-between items-center">
            <div class="flex items-center gap-3">
                <i class="fa-solid fa-leaf text-xl"></i>
                <h1 class="text-lg font-bold tracking-wide">å•å·å¤§å¸« <span class="text-xs bg-white/20 px-2 py-0.5 rounded ml-1">Pro</span></h1>
            </div>
            <div class="flex items-center gap-3">
                <div id="user-info" class="text-xs bg-black/20 px-3 py-1.5 rounded-full opacity-90 hidden md:block">è¨ªå®¢</div>
                <button onclick="window.app.logout()" class="hover:bg-black/20 p-2 rounded-full transition"><i class="fa-solid fa-right-from-bracket"></i></button>
            </div>
        </div>
    </nav>

    <main class="flex-1 w-full max-w-5xl mx-auto p-4 pb-20 safe-pb relative z-10">
        
        <div id="loading-view" class="fixed inset-0 flex flex-col items-center justify-center bg-[var(--bg-color)] z-[150]">
            <i class="fa-solid fa-circle-notch fa-spin text-4xl text-[var(--primary-color)]"></i>
        </div>
        <div id="toast" class="fixed top-20 right-5 z-[100] bg-white px-6 py-3 rounded-lg shadow-lg flex items-center gap-3 transition-transform duration-300 translate-x-full border-l-4">
            <i id="toast-icon"></i><span id="toast-msg"></span>
        </div>

        <!-- 1. Login -->
        <div id="view-login" class="hidden flex flex-col items-center justify-center min-h-[60vh] fade-in">
            <div class="theme-card p-10 w-full max-w-sm text-center">
                <h2 class="text-2xl font-bold mb-6" style="color: var(--primary-color)">ç®¡ç†å“¡ç™»å…¥</h2>
                <div id="file-protocol-warning" class="hidden mb-4 p-3 bg-yellow-50 text-yellow-800 text-xs rounded-lg text-left">è­¦å‘Šï¼šè«‹ä½¿ç”¨ç¶²é ä¼ºæœå™¨é–‹å•Ÿã€‚</div>
                <div class="space-y-4 text-left">
                    <div><label class="text-xs font-bold opacity-70">é›»å­éƒµä»¶</label><input type="email" id="login-email" class="w-full theme-input p-3 text-sm" placeholder="email@example.com"></div>
                    <div><label class="text-xs font-bold opacity-70">å¯†ç¢¼</label><input type="password" id="login-password" class="w-full theme-input p-3 text-sm" placeholder="******"></div>
                </div>
                <div class="mt-8 space-y-3">
                    <button onclick="window.app.login()" class="theme-btn w-full py-3 font-bold">ç™»å…¥</button>
                    <button onclick="window.app.resetPassword()" class="text-xs opacity-60 hover:opacity-100 block w-full text-center">å¿˜è¨˜å¯†ç¢¼ï¼Ÿ</button>
                </div>
            </div>
        </div>

        <!-- 2. Dashboard -->
        <div id="view-dashboard" class="hidden fade-in">
            <div class="flex justify-between items-center mb-8">
                <h2 class="text-3xl font-bold tracking-tight">æˆ‘çš„å•å·</h2>
                <button onclick="window.app.createSurvey()" class="theme-btn px-6 py-3 flex items-center gap-2 font-bold">
                    <i class="fa-solid fa-plus"></i> æ–°å»ºå•å·
                </button>
            </div>
            <div id="survey-list-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
            <div id="empty-state" class="hidden flex flex-col items-center justify-center py-32 opacity-50 border-4 border-dashed border-gray-300 rounded-3xl">
                <i class="fa-solid fa-wind text-5xl mb-4"></i>
                <p>é€™è£¡ç©ºç©ºçš„...</p>
            </div>
        </div>

        <!-- 3. Editor -->
        <div id="view-editor" class="hidden fade-in">
            <div class="sticky top-0 z-30 bg-[var(--bg-color)]/90 backdrop-blur-sm py-3 flex justify-between items-center mb-4 -mx-4 px-4 border-b border-[var(--card-border)]">
                <button onclick="window.app.backToDashboard()" class="theme-card px-4 py-2 text-sm font-bold"><i class="fa-solid fa-arrow-left mr-1"></i> è¿”å›</button>
                <div class="flex gap-2">
                    <span id="unsaved-badge" class="hidden px-3 py-1 bg-orange-100 text-orange-600 text-xs rounded-full border border-orange-200 flex items-center font-bold">æœªå„²å­˜</span>
                    <button onclick="window.app.openBatchModal()" class="theme-card px-4 py-2 text-sm font-bold text-[var(--primary-color)]"><i class="fa-solid fa-bolt mr-1"></i> åŒ¯å…¥</button>
                </div>
            </div>
            
            <div class="theme-card p-6 md:p-8 mb-8 relative overflow-hidden">
                <div class="absolute top-0 left-0 w-2 h-full bg-[var(--primary-color)]"></div>
                <div class="mb-4">
                    <label class="text-xs font-bold opacity-60 uppercase">å•å·æ¨™é¡Œ</label>
                    <input type="text" id="edit-title" class="w-full text-2xl font-bold bg-transparent border-b-2 border-transparent hover:border-gray-200 focus:border-[var(--primary-color)] outline-none py-2 transition" placeholder="è«‹è¼¸å…¥æ¨™é¡Œ" oninput="window.app.markDirty()">
                </div>
                <div class="mb-4">
                    <label class="text-xs font-bold opacity-60 uppercase">å•å·èªªæ˜</label>
                    <textarea id="edit-desc" class="w-full mt-1 bg-transparent border-b-2 border-transparent hover:border-gray-200 focus:border-[var(--primary-color)] outline-none py-2 transition resize-none leading-relaxed" rows="1" placeholder="è«‹è¼¸å…¥èªªæ˜..." oninput="window.app.markDirty(); window.app.autoGrow(this)"></textarea>
                </div>
                <div>
                    <label class="text-xs font-bold opacity-60 uppercase"><i class="fa-solid fa-palette mr-1"></i> è¦–è¦ºé¢¨æ ¼</label>
                    <select id="edit-theme" class="w-full mt-1 p-2 rounded-lg border-2 border-gray-200 focus:border-[var(--primary-color)] outline-none bg-white/50" onchange="window.app.changeTheme(this.value); window.app.markDirty()">
                        <!-- JS Populated -->
                    </select>
                </div>
            </div>

            <div id="editor-questions" class="space-y-6 mb-32"></div>
            
            <div id="editor-toolbar" class="fixed bottom-6 left-1/2 transform -translate-x-1/2 bg-white border border-gray-200 px-6 py-3 rounded-full shadow-2xl flex items-center gap-4 z-40 safe-pb hover:-translate-y-1 transition duration-300">
                 <div class="flex gap-2 pr-4 border-r border-gray-200">
                    <button onclick="window.app.addQuestion('text')" class="flex flex-col items-center justify-center w-10 h-10 text-gray-500 hover:text-[var(--primary-color)] transition" title="æ–°å¢é¡Œç›®"><i class="fa-solid fa-plus text-xl"></i></button>
                    <button onclick="window.app.addQuestion('section')" class="flex flex-col items-center justify-center w-10 h-10 text-gray-500 hover:text-orange-500 transition" title="æ–°å¢æ®µè½"><i class="fa-solid fa-align-left text-xl"></i></button>
                 </div>
                 <button onclick="window.app.saveSurvey()" class="theme-btn px-6 py-2 font-bold shadow-md flex items-center gap-2"><i class="fa-solid fa-cloud-arrow-up"></i> å„²å­˜</button>
            </div>
        </div>

        <!-- 4. Public View -->
        <div id="view-public" class="hidden w-full max-w-2xl mx-auto fade-in pb-24 pt-4">
            <div class="theme-card overflow-hidden mb-8">
                <div class="bg-[var(--primary-color)] h-4 opacity-80"></div>
                <div class="p-8">
                    <h1 id="public-title" class="text-3xl font-bold mb-4 leading-tight text-center">è¼‰å…¥ä¸­...</h1>
                    <div id="public-desc" class="whitespace-pre-wrap text-base leading-relaxed text-justify opacity-80"></div>
                </div>
            </div>

            <form id="public-form" class="space-y-6"></form>
            
            <div class="mt-12 text-center">
                <button id="public-submit-btn" type="button" onclick="window.app.submitResponse()" class="w-full max-w-xs theme-btn py-4 text-xl font-bold shadow-xl hover:shadow-2xl transform hover:-translate-y-1 transition">
                    é€å‡ºå•å·
                </button>
            </div>
        </div>

        <!-- 5. Thank You -->
        <div id="view-thankyou" class="hidden flex flex-col items-center justify-center min-h-[80vh] text-center fade-in px-4 relative">
            <div class="theme-card p-12 w-full max-w-md relative overflow-hidden">
                <div class="w-24 h-24 bg-green-100 text-green-600 rounded-full flex items-center justify-center mx-auto mb-6 border-4 border-white shadow-inner"><i class="fa-solid fa-check text-5xl"></i></div>
                <h2 class="text-3xl font-bold mb-3">æ„Ÿè¬æ‚¨çš„å¡«å¯«ï¼</h2>
                <p class="opacity-60 mb-8">æ‚¨çš„å›è¦†å·²æˆåŠŸé€å‡ºã€‚</p>
                <div class="border-t border-gray-100 pt-6">
                    <div class="bg-gray-50 p-4 rounded-xl">
                        <p class="font-bold mb-1 text-sm">æ‚¨ç¾åœ¨å¯ä»¥å®‰å…¨åœ°é›¢é–‹</p>
                        <p class="text-xs opacity-50">è«‹ç›´æ¥é—œé–‰ç€è¦½å™¨åˆ†é å³å¯ã€‚</p>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <div id="modal-overlay" class="hidden fixed inset-0 bg-black/50 z-[60] flex items-center justify-center p-4 fade-in backdrop-blur-sm">
        <div id="modal-content" class="bg-white rounded-3xl shadow-2xl w-full max-w-lg max-h-[90vh] flex flex-col overflow-hidden relative border-4 border-white"></div>
    </div>

    <div id="delete-modal" class="hidden fixed inset-0 bg-black/50 z-[70] flex items-center justify-center p-4 fade-in backdrop-blur-sm">
        <div class="bg-white rounded-3xl shadow-2xl p-8 max-w-sm w-full text-center border-4 border-white">
            <div class="w-16 h-16 bg-red-100 text-red-500 rounded-full flex items-center justify-center mx-auto mb-4"><i class="fa-solid fa-trash-can text-2xl"></i></div>
            <h3 class="text-lg font-bold">ç¢ºå®šåˆªé™¤ï¼Ÿ</h3>
            <p class="text-sm opacity-60 mt-2 mb-8">åˆªé™¤å¾Œç„¡æ³•å¾©åŸã€‚</p>
            <div class="flex gap-3">
                <button onclick="safeGet('delete-modal').classList.add('hidden')" class="flex-1 py-3 border-2 border-gray-200 rounded-2xl font-bold text-gray-600 hover:bg-gray-50 transition">å–æ¶ˆ</button>
                <button onclick="window.app.confirmDelete()" class="flex-1 py-3 bg-red-500 text-white rounded-2xl font-bold shadow-md hover:bg-red-600 transition">ç¢ºèªåˆªé™¤</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken, signOut, createUserWithEmailAndPassword, signInWithEmailAndPassword, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, getDoc, getDocs, deleteDoc, addDoc, serverTimestamp, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
          apiKey: "AIzaSyAexk_JbIOQWV1Jw7hqfiZDDZYY9YF-Sdk",
          authDomain: "survey-49e8d.firebaseapp.com",
          projectId: "survey-49e8d",
          storageBucket: "survey-49e8d.firebasestorage.app",
          messagingSenderId: "547257703502",
          appId: "1:547257703502:web:85e147bed62333b11c771f"
        };
        
        const APP_ID = 'survey-app';
        const ADMIN_EMAIL = 'alexanderme100@gmail.com'; 

        const state = { db: null, auth: null, user: null, currentSurveyId: null, surveysCache: {}, isDirty: false, mode: 'admin' };
        let surveyIdToDelete = null;

        const urlParams = new URLSearchParams(window.location.search);
        const sId = urlParams.get('s');
        const uId = urlParams.get('u');
        if (sId && uId) state.mode = 'public';

        try {
            const app = initializeApp(firebaseConfig);
            state.auth = getAuth(app);
            state.db = getFirestore(app);
            if (state.mode === 'public') signInAnonymously(state.auth).catch(console.error);
        } catch (e) { console.error(e); alert("Firebase Init Error"); }

        const getEmoji = (idx, total) => {
            const emojis = ['ğŸ˜¡', 'ğŸ™', 'ğŸ˜', 'ğŸ˜Š', 'ğŸ¤©'];
            if (total <= 5) return idx < 5 ? emojis[idx] : '';
            if (total <= 7) return idx < 7 ? ['ğŸ˜¡', 'ğŸ˜ ', 'ğŸ™', 'ğŸ˜', 'ğŸ™‚', 'ğŸ˜Š', 'ğŸ¤©'][idx] : '';
            return '';
        };
        const getColor = (idx, total) => {
             if(total <= 7) {
                 const n = idx + 1;
                 if(n <= 2) return 'likert-opt-1'; 
                 if(n <= 3 && total > 3) return 'likert-opt-2'; 
                 if(n == Math.ceil(total/2)) return 'likert-opt-3'; 
                 if(n >= total-1) return 'likert-opt-5'; 
                 return 'likert-opt-4';
             }
             return 'opt-default';
        };

        window.app.login = async () => { 
            const email = safeGet('login-email').value.trim();
            const pass = safeGet('login-password').value;
            if (email !== ADMIN_EMAIL) return showToast('éç®¡ç†å“¡å¸³è™Ÿ', 'error');
            try { await signInWithEmailAndPassword(state.auth, email, pass); } catch(e) { showToast('ç™»å…¥å¤±æ•—', 'error'); } 
        };
        
        window.app.resetPassword = async () => {
            const email = safeGet('login-email').value.trim();
            if (!email) return showToast('è«‹è¼¸å…¥Email', 'error');
            try { await sendPasswordResetEmail(state.auth, email); showToast('é‡è¨­ä¿¡å·²å¯„å‡º'); } catch(e) { showToast('ç™¼é€å¤±æ•—', 'error'); }
        };

        window.app.logout = async () => { await signOut(state.auth); location.reload(); };
        window.app.backToDashboard = () => { if(state.isDirty && !confirm("æœªå„²å­˜è®Šæ›´å°‡éºå¤±")) return; switchView('view-dashboard'); renderList(); };

        window.app.createSurvey = () => {
            state.currentSurveyId = crypto.randomUUID();
            safeGet('edit-title').value = ''; safeGet('edit-desc').value = ''; safeGet('editor-questions').innerHTML = '';
            window.app.addQuestion(); 
            window.app.changeTheme('ghibli'); 
            state.isDirty = false; updateDirtyUI();
            switchView('view-editor');
        };

        window.app.editSurvey = async (surveyId) => {
            let survey = state.surveysCache[surveyId];
            if (!survey) {
                try {
                    showToast("è®€å–ä¸­...", "info");
                    const snap = await getDoc(doc(state.db, 'artifacts', APP_ID, 'users', state.user.uid, 'surveys', surveyId));
                    if(snap.exists()) {
                        survey = { id: snap.id, ...snap.data() };
                        state.surveysCache[surveyId] = survey;
                    } else { return showToast("å•å·ä¸å­˜åœ¨", "error"); }
                } catch (e) { return showToast("è®€å–å¤±æ•—", "error"); }
            }
            state.currentSurveyId = surveyId;
            safeGet('edit-title').value = survey.title || '';
            safeGet('edit-desc').value = survey.description || '';
            window.app.autoGrow(safeGet('edit-desc'));
            
            const themeSelect = safeGet('edit-theme');
            themeSelect.value = survey.theme || 'ghibli';
            window.app.changeTheme(survey.theme || 'ghibli');

            const container = safeGet('editor-questions');
            container.innerHTML = '';
            (survey.questions || []).forEach(q => window.app.addQuestion(q.type, q));
            switchView('view-editor');
        };
        
        window.app.changeTheme = (key) => window.applyTheme(key);

        window.app.addQuestion = (type = 'text', data = null) => {
            const container = safeGet('editor-questions');
            const id = `q-${Date.now()}-${Math.random().toString(36).substr(2,4)}`;
            const div = document.createElement('div');
            const qText = data ? data.text : '';
            const qDesc = data ? data.description : '';
            const qOpts = data ? (data.options || []).join('\n') : '';
            const qType = data ? data.type : type;
            const qReq = (data && data.required !== undefined) ? data.required : true;

            div.className = `question-item theme-card p-6 mb-6 relative group ${qType === 'section' ? 'border-l-8 border-orange-300' : ''}`;
            div.dataset.qtype = qType;
            div.draggable = true; div.id = id; 
            div.addEventListener('dragstart', () => { div.classList.add('dragging'); });
            div.addEventListener('dragend', () => { div.classList.remove('dragging'); window.app.markDirty(); });

            if (qType === 'section') {
                div.innerHTML = `<div class="flex justify-between mb-4 cursor-grab active:cursor-grabbing drag-handle border-b pb-2"><span class="text-xs font-bold opacity-60 flex items-center gap-1"><i class="fa-solid fa-grip-vertical"></i> æ®µè½èªªæ˜</span><button onclick="this.closest('.question-item').remove(); window.app.markDirty()" class="text-gray-300 hover:text-red-500 transition"><i class="fa-solid fa-trash"></i></button></div><input type="text" class="q-input w-full bg-transparent border-b-2 border-transparent focus:border-[var(--primary-color)] p-2 mb-3 font-bold text-lg transition outline-none" placeholder="æ®µè½æ¨™é¡Œ" value="${escapeHtml(qText)}" oninput="window.app.markDirty()"><textarea class="q-desc w-full theme-input border-0 rounded-lg p-3 text-sm opacity-80 resize-none" rows="2" placeholder="èªªæ˜..." oninput="window.app.markDirty()">${escapeHtml(qDesc)}</textarea>`;
            } else {
                div.innerHTML = `<div class="flex justify-between mb-4 cursor-grab active:cursor-grabbing drag-handle"><span class="text-xs font-bold px-3 py-1 rounded-full bg-gray-100 flex items-center gap-1"><i class="fa-solid fa-grip-vertical"></i> å•é¡Œ</span><div class="flex items-center gap-3"><label class="text-xs cursor-pointer flex items-center opacity-70 hover:opacity-100"><input type="checkbox" class="q-req mr-1" ${qReq ? 'checked' : ''} onchange="window.app.markDirty()">å¿…å¡«</label><button onclick="this.closest('.question-item').remove(); window.app.markDirty()" class="text-gray-300 hover:text-red-500 transition"><i class="fa-solid fa-trash"></i></button></div></div><input type="text" class="q-input w-full theme-input p-3 mb-3" placeholder="é¡Œç›®å…§å®¹" value="${escapeHtml(qText)}" oninput="window.app.markDirty()"><div class="flex gap-3 mb-3"><select class="q-type w-1/3 theme-input p-2 text-sm" onchange="window.app.toggleOpts(this)"><option value="text" ${qType==='text'?'selected':''}>ç°¡ç­”é¡Œ</option><option value="radio" ${qType==='radio'?'selected':''}>å–®é¸é¡Œ</option><option value="checkbox" ${qType==='checkbox'?'selected':''}>å¤šé¸é¡Œ</option></select></div><textarea class="q-opts w-full theme-input p-3 h-24 font-mono text-sm ${qType==='text'?'hidden':''}" placeholder="é¸é …1&#10;é¸é …2&#10;é¸é …3" oninput="window.app.markDirty()">${escapeHtml(qOpts)}</textarea>`;
            }
            container.appendChild(div);
            window.app.markDirty();
        };

        window.app.toggleOpts = (el) => { const item = el.closest('.question-item'); item.dataset.qtype = el.value; const area = item.querySelector('.q-opts'); if(area) { if (el.value === 'text') area.classList.add('hidden'); else area.classList.remove('hidden'); } window.app.markDirty(); };

        window.app.saveSurvey = async () => {
            if (!state.user) return;
            const btn = document.querySelector('#editor-toolbar button:last-child');
            btn.disabled = true; btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> å„²å­˜ä¸­';
            try {
                const title = safeGet('edit-title').value.trim();
                const desc = safeGet('edit-desc').value.trim();
                const theme = safeGet('edit-theme').value;
                if (!title) throw new Error("è«‹è¼¸å…¥æ¨™é¡Œ");
                
                const questions = [];
                document.querySelectorAll('.question-item').forEach(item => {
                    const type = item.dataset.qtype || 'text';
                    const text = item.querySelector('.q-input').value.trim();
                    if (!text) return;
                    if (type === 'section') { questions.push({ type, text, description: item.querySelector('.q-desc').value.trim() }); } 
                    else {
                        const req = item.querySelector('.q-req').checked;
                        let opts = [];
                        const optsArea = item.querySelector('.q-opts');
                        if (type !== 'text' && optsArea) opts = optsArea.value.split('\n').map(x=>x.trim()).filter(x=>x);
                        questions.push({ type: type, text, required: req, options: opts });
                    }
                });
                const data = { title, description: desc, theme, questions, updatedAt: serverTimestamp(), status: state.surveysCache[state.currentSurveyId]?.status || 'draft' };
                await setDoc(doc(state.db, 'artifacts', APP_ID, 'users', state.user.uid, 'surveys', state.currentSurveyId), data, {merge: true});
                state.isDirty = false; updateDirtyUI(); showToast('å„²å­˜æˆåŠŸ');
                state.surveysCache[state.currentSurveyId] = { ...data, id: state.currentSurveyId };
            } catch (e) { console.error(e); showToast(e.message, 'error'); } finally { btn.disabled = false; btn.innerHTML = '<i class="fa-solid fa-cloud-arrow-up"></i> å„²å­˜'; }
        };

        // ... Import/Export/Share (Same) ...
        window.app.openBatchModal = () => { safeGet('modal-overlay').classList.remove('hidden'); safeGet('modal-content').innerHTML = `<div class="p-8"><h3 class="text-xl font-bold mb-4 text-[#5B6C78]">æ‰¹é‡åŒ¯å…¥é¡Œç›®</h3><p class="text-sm text-gray-500 mb-2">è«‹å°‡é¡Œç›®è²¼åœ¨ä¸‹æ–¹ï¼Œä¸€è¡Œä¸€é¡Œã€‚</p><textarea id="batch-text" class="w-full theme-input p-4 h-60 text-sm resize-none" placeholder="é¡Œç›®1\né¡Œç›®2..."></textarea><div class="mt-6 flex justify-end gap-3"><button onclick="safeGet('modal-overlay').classList.add('hidden')" class="px-6 py-2 rounded-xl font-bold text-gray-500 hover:bg-gray-100 transition">å–æ¶ˆ</button><button onclick="window.app.doImport()" class="btn-ghibli-primary px-6 py-2 font-bold">é–‹å§‹åŒ¯å…¥</button></div></div>`; };
        window.app.doImport = () => { const lines = safeGet('batch-text').value.split('\n').filter(l=>l.trim()); lines.forEach(l => window.app.addQuestion('radio', {text: l, type: 'radio', required: true, options: ['éå¸¸æ»¿æ„','æ»¿æ„','æ™®é€š','ä¸æ»¿æ„','éå¸¸ä¸æ»¿æ„']})); safeGet('modal-overlay').classList.add('hidden'); window.app.markDirty(); };
        window.app.openShare = (id) => { const link = `${window.location.origin}${window.location.pathname}?s=${id}&u=${state.user.uid}`; safeGet('modal-overlay').classList.remove('hidden'); safeGet('modal-content').innerHTML = `<div class="p-8 text-center"><h3 class="text-xl font-bold mb-6 text-[#5B6C78]">ç™¼å¸ƒå•å·</h3><div class="bg-[#F0F9F4] p-4 rounded-2xl mb-6 border border-[#C3DEC9]"><p class="text-xs text-[#3E664B] mb-2 font-bold uppercase tracking-widest">å•å·é€£çµ</p><input class="w-full bg-white border border-[#C3DEC9] p-3 rounded-xl text-sm text-[#3E664B] mb-3 font-mono" value="${link}" readonly><button onclick="navigator.clipboard.writeText('${link}');showToast('å·²è¤‡è£½')" class="btn-ghibli-primary w-full py-2 font-bold text-sm">è¤‡è£½é€£çµ</button></div><div class="text-center"><p class="text-xs text-gray-400 mb-2">æ‰‹æ©Ÿæƒæ QR Code</p><img src="https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=${encodeURIComponent(link)}" class="mx-auto rounded-xl border-4 border-white shadow-lg"></div><button onclick="safeGet('modal-overlay').classList.add('hidden')" class="mt-8 text-gray-400 hover:text-gray-600 underline text-sm">é—œé–‰è¦–çª—</button></div>`; const s = state.surveysCache[id]; if(s && s.status!=='published') updateDoc(doc(state.db, 'artifacts', APP_ID, 'users', state.user.uid, 'surveys', id), {status:'published'}); };
        window.app.viewStats = async (id) => { 
            safeGet('modal-overlay').classList.remove('hidden'); 
            safeGet('modal-content').innerHTML = '<div class="p-10 text-center"><i class="fa-solid fa-circle-notch fa-spin text-3xl text-[#568A66]"></i></div>';
            const snap = await getDocs(collection(state.db, 'artifacts', APP_ID, 'users', state.user.uid, 'surveys', id, 'responses'));
            safeGet('modal-content').innerHTML = `<div class="p-8"><div class="flex justify-between items-center mb-6"><h3 class="text-xl font-bold text-[#5B6C78]">çµ±è¨ˆæ¦‚è¦½</h3><span class="bg-[#F0F9F4] text-[#3E664B] px-3 py-1 rounded-full text-sm font-bold">å…± ${snap.size} ä»½å›è¦†</span></div><div class="bg-yellow-50 border-l-4 border-yellow-400 p-4 mb-6 rounded-r"><p class="text-sm text-yellow-800">è©³ç´°æ•¸æ“šè«‹åŒ¯å‡º Excel é€²è¡Œåˆ†æã€‚</p></div><div class="flex justify-end gap-3"><button onclick="safeGet('modal-overlay').classList.add('hidden')" class="px-4 py-2 text-gray-500 hover:bg-gray-100 rounded-xl font-bold">é—œé–‰</button><button class="btn-ghibli-primary px-6 py-2 font-bold" id="export-btn" onclick="window.app.exportToCSV('${id}')"><i class="fa-solid fa-file-csv mr-2"></i>åŒ¯å‡º Excel</button></div></div>`;
        };
        window.app.exportToCSV = async (id) => { const btn = document.getElementById('export-btn'); btn.innerText = "è™•ç†ä¸­..."; btn.disabled = true; try { const survey = state.surveysCache[id]; const snap = await getDocs(collection(state.db, 'artifacts', APP_ID, 'users', state.user.uid, 'surveys', id, 'responses')); let csv = "\uFEFFæ™‚é–“,"; survey.questions.forEach((q, i) => csv += `"${q.text.replace(/"/g,'""')}",`); csv += "\n"; snap.forEach(doc => { const d = doc.data(); csv += `"${new Date(d.submittedAt.seconds*1000).toLocaleString()}",`; survey.questions.forEach((q, i) => { if(q.type==='section') csv += ","; else { let a = d.answers[`q_${i}`]; if(Array.isArray(a)) a = a.join(';'); csv += `"${(a||'').toString().replace(/"/g,'""')}",`; } }); csv += "\n"; }); const url = URL.createObjectURL(new Blob([csv], {type: 'text/csv'})); const a = document.createElement('a'); a.href = url; a.download = `${survey.title}.csv`; a.click(); } catch(e) { alert("åŒ¯å‡ºå¤±æ•—"); } finally { btn.innerText = "åŒ¯å‡º Excel"; btn.disabled = false; } };
        window.app.requestDelete = (id) => { surveyIdToDelete = id; safeGet('delete-modal').classList.remove('hidden'); };
        window.app.confirmDelete = async () => { if(!surveyIdToDelete) return; safeGet('delete-modal').classList.add('hidden'); try { await deleteDoc(doc(state.db, 'artifacts', APP_ID, 'users', state.user.uid, 'surveys', surveyIdToDelete)); showToast("åˆªé™¤æˆåŠŸ"); loadSurveys(); } catch(e) { showToast("åˆªé™¤å¤±æ•—", "error"); } };
        window.app.duplicateCurrent = async () => { if(!confirm("è¤‡è£½å•å·ï¼Ÿ")) return; const s = state.surveysCache[state.currentSurveyId]; const newId = crypto.randomUUID(); await setDoc(doc(state.db, 'artifacts', APP_ID, 'users', state.user.uid, 'surveys', newId), { ...s, title: s.title+"(å‰¯æœ¬)", status: 'draft', updatedAt: serverTimestamp() }); showToast("è¤‡è£½æˆåŠŸ"); loadSurveys(); switchView('view-dashboard'); };
        window.app.markDirty = () => { state.isDirty = true; updateDirtyUI(); };
        window.app.autoGrow = (el) => { el.style.height = 'auto'; el.style.height = el.scrollHeight + 'px'; };
        window.app.updateProgressBar = () => { const form = safeGet('public-form'); const total = form.querySelectorAll('.public-q-item:not([data-type="section"])').length; if(total === 0) return; const answered = new Set(); new FormData(form).forEach((v, k) => { if(v) answered.add(k); }); safeGet('progress-fill').style.width = Math.round((answered.size / total) * 100) + '%'; };

        window.app.submitResponse = async () => {
             const form = safeGet('public-form');
             let firstInvalid = null;
             form.querySelectorAll('.public-q-item:not([data-type="section"])').forEach(item => {
                 item.classList.remove('error-shake', 'ring-2', 'ring-red-500');
                 if (item.dataset.req === 'true') {
                     const name = item.dataset.name;
                     const type = item.dataset.type;
                     let valid = false;
                     if (type === 'text') { if(form.querySelector(`[name="${name}"]`).value.trim()) valid = true; }
                     else { if(form.querySelector(`[name="${name}"]:checked`)) valid = true; }
                     
                     if (!valid) { item.classList.add('error-shake', 'ring-2', 'ring-red-500', 'rounded-xl'); if(!firstInvalid) firstInvalid = item; }
                 }
             });
             if (firstInvalid) { showToast("é‚„æœ‰å¿…å¡«æœªå®Œæˆ", 'error'); firstInvalid.scrollIntoView({behavior:'smooth', block:'center'}); return; }
             const btn = safeGet('public-submit-btn'); btn.disabled = true; btn.innerText = "æäº¤ä¸­...";
             try {
                 const formData = new FormData(form);
                 const answers = {};
                 form.querySelectorAll('.public-q-item').forEach(div => {
                     const type = div.dataset.type;
                     if (type === 'section') return; 
                     const name = div.dataset.name;
                     if (type === 'checkbox') answers[name] = formData.getAll(name);
                     else answers[name] = formData.get(name);
                 });
                 await addDoc(collection(state.db, 'artifacts', APP_ID, 'users', uId, 'surveys', sId, 'responses'), { answers, submittedAt: serverTimestamp() });
                 switchView('view-thankyou');
             } catch(e) { showToast("æäº¤å¤±æ•—", 'error'); btn.disabled = false; btn.innerText = "é€å‡ºå•å·"; }
        };

        function switchView(id) { ['view-login','view-dashboard','view-editor','view-public','view-thankyou'].forEach(v => safeGet(v).classList.add('hidden')); safeGet(id).classList.remove('hidden'); window.scrollTo(0,0); }
        function updateDirtyUI() { safeGet('unsaved-badge').classList.toggle('hidden', !state.isDirty); }
        function renderList() {
            const container = safeGet('survey-list-container'); container.innerHTML = '';
            const surveys = Object.values(state.surveysCache).sort((a, b) => (b.updatedAt?.seconds || 0) - (a.updatedAt?.seconds || 0));
            if (surveys.length === 0) return safeGet('empty-state').classList.remove('hidden');
            safeGet('empty-state').classList.add('hidden');
            surveys.forEach(s => {
                container.innerHTML += `<div class="theme-card p-6 cursor-pointer hover:-translate-y-1" onclick="window.app.editSurvey('${s.id}')"><div class="flex justify-between mb-2"><h3 class="font-bold text-xl truncate">${escapeHtml(s.title) || 'æœªå‘½å'}</h3>${s.status==='published'?'<span class="text-xs bg-[#F0F9F4] text-[#3E664B] px-2 py-1 rounded-full border border-[#C3DEC9]">å·²ç™¼å¸ƒ</span>':'<span class="text-xs bg-gray-100 text-gray-500 px-2 py-1 rounded-full">è‰ç¨¿</span>'}</div><p class="text-sm opacity-60 mb-6 line-clamp-2 h-10">${escapeHtml(s.description)}</p><div class="flex justify-end gap-2 pt-4 border-t border-gray-100" onclick="event.stopPropagation()"><button onclick="window.app.viewStats('${s.id}')" class="text-gray-500 text-xs bg-gray-50 hover:bg-gray-100 px-3 py-1.5 rounded-lg font-bold">çµ±è¨ˆ</button><button onclick="window.app.openShare('${s.id}')" class="text-[#568A66] text-xs bg-[#F0F9F4] hover:bg-[#C3DEC9] px-3 py-1.5 rounded-lg font-bold">åˆ†äº«</button><button onclick="window.app.requestDelete('${s.id}')" class="text-red-400 text-xs bg-red-50 hover:bg-red-100 px-3 py-1.5 rounded-lg font-bold">åˆªé™¤</button></div></div>`;
            });
        }

        async function loadSurveys() { try { const snap = await getDocs(collection(state.db, 'artifacts', APP_ID, 'users', state.user.uid, 'surveys')); state.surveysCache = {}; snap.forEach(doc => { state.surveysCache[doc.id] = { id: doc.id, ...doc.data() }; }); renderList(); } catch(e) { showToast('è®€å–å¤±æ•—', 'error'); } }

        async function loadPublic() {
            try {
                const snap = await getDoc(doc(state.db, 'artifacts', APP_ID, 'users', uId, 'surveys', sId));
                if(!snap.exists()) throw new Error("å•å·ä¸å­˜åœ¨");
                const data = snap.data();
                window.applyTheme(data.theme || 'ghibli'); // Apply Theme
                safeGet('public-title').textContent = data.title;
                safeGet('public-desc').textContent = data.description;
                const form = safeGet('public-form');
                form.innerHTML = (data.questions || []).map((q, idx) => {
                    if (q.type === 'section') return `<div class="public-q-item mt-10 mb-6 relative pl-4" data-type="section"><div class="absolute left-0 top-1 bottom-1 w-1.5 bg-[var(--secondary-color)] rounded-full"></div><h3 class="text-2xl font-bold text-[var(--text-color)] mb-2">${escapeHtml(q.text)}</h3><p class="opacity-80 whitespace-pre-wrap text-base">${escapeHtml(q.description)}</p></div>`;
                    const name = `q_${idx}`; const reqAttr = q.required ? 'data-req="true"' : ''; const reqMark = q.required ? '<span class="text-red-400 ml-1">*</span>' : ''; const qId = `pq-${idx}`;
                    let inputHtml = '';
                    if (q.type === 'text') { inputHtml = `<input type="text" name="${name}" class="w-full theme-input p-4 text-lg" placeholder="è«‹è¼¸å…¥..." oninput="window.app.updateProgressBar()">`; } 
                    else if (q.type === 'radio') {
                        const count = q.options.length; let grid = 'w-[48%]'; if(count >= 7) grid = 'w-[23%]'; else if(count===5) grid = 'w-[31%]'; else if(count===3) grid = 'w-[31%]';
                        inputHtml = `<div class="flex flex-wrap justify-center gap-2">` + q.options.map((opt, i) => { const emoji = getEmoji(i, count); const col = getColor(i, count); return `<label class="${grid} flex-grow-0 flex-shrink-0 cursor-pointer group"><input type="radio" name="${name}" value="${escapeHtml(opt)}" class="peer sr-only" onchange="window.app.updateProgressBar(); window.scrollToNext(this)"><div class="h-full p-3 theme-card text-center text-sm font-bold flex flex-col items-center justify-center min-h-[70px] group-hover:border-[var(--primary-color)] opacity-90 ${col}"><div class="text-2xl mb-1">${emoji}</div><div class="leading-tight">${escapeHtml(opt)}</div></div></label>`; }).join('') + `</div>`;
                    } else { inputHtml = `<div class="space-y-3">` + q.options.map(opt => `<label class="flex items-center gap-3 p-4 theme-card cursor-pointer"><input type="checkbox" name="${name}" value="${escapeHtml(opt)}" class="w-5 h-5 accent-[var(--primary-color)]" onchange="window.app.updateProgressBar()"><span class="font-medium">${escapeHtml(opt)}</span></label>`).join('') + `</div>`; }
                    return `<div id="${qId}" class="public-q-item theme-card p-6 mb-6 relative" ${reqAttr} data-type="${q.type}" data-name="${name}"><h4 class="font-bold text-xl mb-4 leading-snug">${escapeHtml(q.text)} ${reqMark}</h4>${inputHtml}</div>`;
                }).join('');
                switchView('view-public');
            } catch(e) { safeGet('loading-view').innerHTML = `<div class="text-red-500 p-10 text-center">${e.message}</div>`; }
        }

        // Init
        const select = safeGet('edit-theme');
        Object.keys(THEMES).forEach(k => { const opt = document.createElement('option'); opt.value = k; opt.innerText = THEMES[k].name; select.appendChild(opt); });

        onAuthStateChanged(state.auth, (user) => {
            safeGet('loading-view').classList.add('hidden');
            state.user = user;
            if (state.mode === 'public') { if (!user) signInAnonymously(state.auth).catch(console.error); else loadPublic(); } 
            else {
                if (user) {
                    safeGet('admin-nav').classList.remove('hidden');
                    if (user.isAnonymous) { signOut(state.auth); return; }
                    safeGet('user-info').textContent = user.email;
                    switchView('view-dashboard'); loadSurveys();
                } else switchView('view-login');
            }
        });
    </script>
</body>
</html>
