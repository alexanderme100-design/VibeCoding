<!DOCTYPE html>
<html lang="zh-TW">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>校園訪客視覺化管理系統 (Firebase版)</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
      /* 自定義動畫與捲軸 */
      .animate-fade-in { animation: fadeIn 0.5s ease-in-out; }
      @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
      
      /* 優化捲軸樣式 */
      ::-webkit-scrollbar { width: 8px; height: 8px; }
      ::-webkit-scrollbar-track { background: #f1f5f9; }
      ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
      ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
    </style>
  </head>
  <body class="bg-slate-50">
    <div id="root"></div>

    <!-- 我們使用 module 類型來支援 Firebase v9+ 的 import -->
    <script type="text/babel" data-type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
      import { 
        getFirestore, 
        collection, 
        addDoc, 
        updateDoc, 
        doc, 
        onSnapshot, 
        query, 
        orderBy, 
        serverTimestamp 
      } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";
      import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";

      // =================================================================
      // ⚠️ 使用您提供的 Firebase Config (已替換)
      // =================================================================
      const firebaseConfig = {
        apiKey: "AIzaSyB3lmeAgcQ2cJfUDaJwmkzd3K8wzjt64Rs",
        authDomain: "school-visitor-system-efe35.firebaseapp.com",
        projectId: "school-visitor-system-efe35",
        storageBucket: "school-visitor-system-efe35.firebasestorage.app",
        messagingSenderId: "1027279524616",
        appId: "1:1027279524616:web:5b316a71e193138ff812bd"
      };

      // 初始化 Firebase
      const app = initializeApp(firebaseConfig);
      const db = getFirestore(app);
      const auth = getAuth(app);

      // React Hooks
      const { useState, useEffect, useMemo } = React;

      // --- SVG Icons ---
      const Icons = {
        Users: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>,
        MapPin: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z"/><circle cx="12" cy="10" r="3"/></svg>,
        LogIn: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"/><polyline points="10 17 15 12 10 7"/><line x1="15" x2="3" y1="12" y2="12"/></svg>,
        LogOut: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" x2="9" y1="12" y2="12"/></svg>,
        Search: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>,
        Clock: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>,
        ShieldCheck: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10"/><path d="m9 12 2 2 4-4"/></svg>,
        Building2: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M6 22V4a2 2 0 0 1 2-2h8a2 2 0 0 1 2 2v18Z"/><path d="M6 12H4a2 2 0 0 0-2 2v6a2 2 0 0 0 2 2h2"/><path d="M18 9h2a2 2 0 0 1 2 2v9a2 2 0 0 1-2 2h-2"/><path d="M10 6h4"/><path d="M10 10h4"/><path d="M10 14h4"/><path d="M10 18h4"/></svg>,
        Library: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m16 6 4 14"/><path d="M12 6v14"/><path d="M8 8v12"/><path d="M4 4v16"/></svg>,
        GraduationCap: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M22 10v6M2 10l10-5 10 5-10 5z"/><path d="M6 12v5c3 3 9 3 12 0v-5"/></svg>,
        Loading: () => <svg className="animate-spin" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 12a9 9 0 1 1-6.219-8.56"/></svg>,
        Microscope: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M6 18h8"/><path d="M3 22h18"/><path d="M14 22a7 7 0 1 0 0-14h-1"/><path d="M9 14h2"/><path d="M9 12a2 2 0 0 1-2-2V6h6v4a2 2 0 0 1-2 2Z"/><path d="M12 6V3a1 1 0 0 0-1-1H9a1 1 0 0 0-1 1v3"/></svg>
      };

      // --- 設定檔 ---
      const LOCATIONS = [
        { id: 'lujiang', name: '鷺江樓', icon: Icons.Building2, color: 'bg-indigo-100 border-indigo-300' },
        { id: 'yunai', name: '耘愛樓', icon: Icons.Library, color: 'bg-rose-100 border-rose-300' },
        { id: 'zhongxiao', name: '忠孝樓', icon: Icons.GraduationCap, color: 'bg-green-100 border-green-300' },
        { id: 'research', name: '研究大樓', icon: Icons.Microscope, color: 'bg-cyan-100 border-cyan-300' },
        { id: 'heping', name: '和平樓', icon: Icons.Users, color: 'bg-teal-100 border-teal-300' },
        { id: 'siwei', name: '四維樓', icon: Icons.Building2, color: 'bg-orange-100 border-orange-300' },
        { id: 'bade', name: '八德樓', icon: Icons.GraduationCap, color: 'bg-purple-100 border-purple-300' },
      ];

      const DEPARTMENTS = [
        '教務處', '學務處', '總務處', '輔導室', 
        '校長室', '人事/會計', '健康中心', '各班教室'
      ];

      const VISIT_REASONS = [
        '洽公開會', '廠商維修', '物流送貨', 
        '家長訪談', '志工服務', '貴賓參訪'
      ];

      // --- 輔助函式：取得目前時間 ---
      const getCurrentTimeString = () => {
        const now = new Date();
        return now.toLocaleTimeString('zh-TW', { hour: '2-digit', minute: '2-digit', hour12: false });
      };

      // --- 主程式 App ---
      function App() {
        const [activeTab, setActiveTab] = useState('dashboard');
        const [visitors, setVisitors] = useState([]);
        const [loading, setLoading] = useState(true);
        const [searchTerm, setSearchTerm] = useState('');
        const [submitting, setSubmitting] = useState(false);
        const [user, setUser] = useState(null);
        
        const [formData, setFormData] = useState({
          name: '',
          phone: '',
          location: 'lujiang',
          reason: '',
          host: ''
        });

        // ⚠️ 使用您自己的資料庫，直接存取根目錄集合，不使用 artifacts 路徑
        const visitorsCollectionRef = collection(db, 'visitors');

        // 1. 處理 Firebase 登入 (改回純匿名登入)
        useEffect(() => {
          const unsubscribeAuth = onAuthStateChanged(auth, (currentUser) => {
            if (currentUser) {
              setUser(currentUser);
            } else {
              signInAnonymously(auth).catch((error) => {
                console.error("登入失敗:", error);
                alert("系統連線失敗，請檢查 Firebase Console > Authentication 是否已開啟匿名登入");
              });
            }
          });
          return () => unsubscribeAuth();
        }, []);

        // 2. 監聽 Firestore 資料變化 (即時更新)
        useEffect(() => {
          if (!user) return; // 等待登入後才監聽

          // 查詢 visitors 集合，依入校時間排序 (desc = 最新在最上面)
          const q = query(visitorsCollectionRef, orderBy("checkInTimestamp", "desc"));
          
          const unsubscribeSnapshot = onSnapshot(q, (snapshot) => {
            const visitorsData = snapshot.docs.map(doc => ({
              id: doc.id,
              ...doc.data()
            }));
            setVisitors(visitorsData);
            setLoading(false);
          }, (error) => {
            console.error("讀取資料失敗:", error);
            // 如果是因為索引問題失敗，嘗試不排序讀取
            if (error.code === 'failed-precondition') {
               const simpleQ = query(visitorsCollectionRef);
               onSnapshot(simpleQ, (snap) => {
                 const data = snap.docs.map(d => ({id: d.id, ...d.data()}));
                 // 在前端排序
                 data.sort((a,b) => (b.checkInTimestamp?.seconds || 0) - (a.checkInTimestamp?.seconds || 0));
                 setVisitors(data);
                 setLoading(false);
               });
            } else {
               setLoading(false);
            }
          });

          return () => unsubscribeSnapshot();
        }, [user]);

        // 3. 處理訪客登記 (寫入 Firestore)
        const handleCheckIn = async (e) => {
          e.preventDefault();

          if (!formData.name || !formData.host || !formData.reason) {
            alert('請填寫完整資訊 (姓名、受訪對象、事由)');
            return;
          }

          setSubmitting(true);
          
          try {
            await addDoc(visitorsCollectionRef, {
              name: formData.name,
              phone: formData.phone,
              location: formData.location,
              reason: formData.reason,
              host: formData.host,
              checkInTime: getCurrentTimeString(),
              checkInTimestamp: serverTimestamp(), // 用於排序
              checkOutTime: '',
              status: 'IN'
            });

            // 成功後重置表單並跳轉
            setFormData({ name: '', phone: '', location: 'lujiang', reason: '', host: '' });
            setSubmitting(false);
            setActiveTab('map');

          } catch (error) {
            console.error("寫入失敗:", error);
            alert('登記失敗: ' + error.message);
            setSubmitting(false);
          }
        };

        // 4. 處理訪客簽離 (更新 Firestore)
        const handleCheckOut = async (visitorId) => {
          if(!confirm('確定要將此訪客簽離嗎？')) return;
          
          // 在 UI 上先做一個假更新讓反應更即時
          const tempVisitors = visitors.map(v => v.id === visitorId ? {...v, status: 'PROCESSING'} : v);
          setVisitors(tempVisitors);

          try {
            // ⚠️ 直接存取根目錄的 visitors 集合文件
            const visitorRef = doc(db, 'visitors', visitorId);
            await updateDoc(visitorRef, {
              status: 'OUT',
              checkOutTime: getCurrentTimeString()
            });
            // 成功後，Snapshot 會自動更新列表，不需要手動重整
          } catch (error) {
            console.error("簽離失敗:", error);
            alert('簽離失敗: ' + error.message);
          }
        };

        // 計算數據
        const stats = useMemo(() => {
          const currentIn = visitors.filter(v => v.status === 'IN').length;
          const totalToday = visitors.length; 
          const locStats = LOCATIONS.map(loc => ({
            ...loc,
            count: visitors.filter(v => v.status === 'IN' && v.location === loc.id).length
          }));
          return { currentIn, totalToday, locStats };
        }, [visitors]);

        const filteredVisitors = visitors.filter(v => 
          v.name.includes(searchTerm) || v.host.includes(searchTerm) || (v.reason && v.reason.includes(searchTerm))
        );

        return (
          <div className="min-h-screen font-sans text-slate-800 flex flex-col md:flex-row">
            
            {/* 側邊導航欄 */}
            <nav className="w-full md:w-64 bg-slate-800 text-white flex flex-col shadow-xl z-20 sticky top-0 md:h-screen">
              <div className="p-6 border-b border-slate-700">
                <h1 className="text-xl font-bold flex items-center gap-2">
                  <div className="text-yellow-400"><Icons.ShieldCheck /></div>
                  校園訪客系統
                </h1>
                <p className="text-xs text-slate-400 mt-1">Firebase 雲端即時版</p>
              </div>

              <div className="flex-1 py-4 flex flex-row md:flex-col overflow-x-auto md:overflow-visible">
                <NavButton active={activeTab === 'dashboard'} onClick={() => setActiveTab('dashboard')} icon={Icons.Users} label="總覽儀表板" />
                <NavButton active={activeTab === 'map'} onClick={() => setActiveTab('map')} icon={Icons.MapPin} label="校園地圖監控" />
                <NavButton active={activeTab === 'checkin'} onClick={() => setActiveTab('checkin')} icon={Icons.LogIn} label="訪客登記" />
                <NavButton active={activeTab === 'list'} onClick={() => setActiveTab('list')} icon={Icons.LogOut} label="簽離與紀錄" />
              </div>

              <div className="p-4 border-t border-slate-700 bg-slate-900">
                <div className="flex justify-between items-center">
                  <div className="text-xs text-slate-400">目前校內人數</div>
                  {loading && <div className="text-white animate-spin"><Icons.Loading /></div>}
                </div>
                <div className="text-3xl font-bold text-green-400">{stats.currentIn} <span className="text-sm text-white">人</span></div>
              </div>
            </nav>

            {/* 主內容區 */}
            <main className="flex-1 overflow-y-auto p-4 md:p-8 h-screen">
              
              {/* 1. 總覽儀表板 */}
              {activeTab === 'dashboard' && (
                <div className="space-y-6 animate-fade-in">
                  <h2 className="text-2xl font-bold text-slate-700">今日即時概況</h2>
                  <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <StatCard title="目前在校訪客" value={stats.currentIn} icon={<div className="text-blue-500"><Icons.Users /></div>} color="border-l-4 border-blue-500" />
                    <StatCard title="今日累計訪客" value={stats.totalToday} icon={<div className="text-purple-500"><Icons.Clock /></div>} color="border-l-4 border-purple-500" />
                    <StatCard title="最熱門區域" value={stats.locStats.sort((a,b) => b.count - a.count)[0]?.name || '無'} subValue={`${stats.locStats.sort((a,b) => b.count - a.count)[0]?.count || 0} 人`} icon={<div className="text-red-500"><Icons.MapPin /></div>} color="border-l-4 border-red-500" />
                  </div>
                </div>
              )}

              {/* 2. 校園地圖監控 */}
              {activeTab === 'map' && (
                <div className="h-full flex flex-col animate-fade-in">
                  <div className="flex justify-between items-center mb-6">
                    <h2 className="text-2xl font-bold text-slate-700">校園區域即時監控</h2>
                    <div className="flex gap-2 text-sm">
                      <span className="flex items-center gap-1"><div className="w-3 h-3 bg-green-500 rounded-full"></div> 有訪客</span>
                      <span className="flex items-center gap-1"><div className="w-3 h-3 bg-slate-300 rounded-full"></div> 淨空</span>
                    </div>
                  </div>

                  <div className="flex-1 bg-white rounded-2xl shadow-sm border border-slate-200 p-6 relative overflow-hidden min-h-[600px]">
                    {loading && <div className="absolute inset-0 bg-white/80 z-50 flex items-center justify-center"><span className="text-xl font-bold text-slate-500 flex items-center gap-2"><Icons.Loading /> 連線同步中...</span></div>}
                    <div className="grid grid-cols-1 md:grid-cols-12 md:grid-rows-6 gap-4 h-full">
                      <div className="hidden md:flex md:col-span-12 md:row-start-5 md:row-span-2 pointer-events-none items-center justify-start z-0 opacity-10"><div className="w-full h-12 bg-slate-900 rounded-r-full"></div></div>
                      
                      {/* 第一排 4 個 */}
                      <MapBlock data={LOCATIONS.find(l => l.id === 'lujiang')} visitors={visitors.filter(v => v.status === 'IN' && v.location === 'lujiang')} className="md:col-span-3 md:row-span-2 md:row-start-1" />
                      <MapBlock data={LOCATIONS.find(l => l.id === 'yunai')} visitors={visitors.filter(v => v.status === 'IN' && v.location === 'yunai')} className="md:col-span-3 md:row-span-2 md:row-start-1" />
                      <MapBlock data={LOCATIONS.find(l => l.id === 'zhongxiao')} visitors={visitors.filter(v => v.status === 'IN' && v.location === 'zhongxiao')} className="md:col-span-3 md:row-span-2 md:row-start-1" />
                      <MapBlock data={LOCATIONS.find(l => l.id === 'research')} visitors={visitors.filter(v => v.status === 'IN' && v.location === 'research')} className="md:col-span-3 md:row-span-2 md:row-start-1" />
                      
                      {/* 第二排 3 個 */}
                      <MapBlock data={LOCATIONS.find(l => l.id === 'heping')} visitors={visitors.filter(v => v.status === 'IN' && v.location === 'heping')} className="md:col-span-4 md:row-span-2 md:row-start-3" />
                      <MapBlock data={LOCATIONS.find(l => l.id === 'siwei')} visitors={visitors.filter(v => v.status === 'IN' && v.location === 'siwei')} className="md:col-span-4 md:row-span-2 md:row-start-3" />
                      <MapBlock data={LOCATIONS.find(l => l.id === 'bade')} visitors={visitors.filter(v => v.status === 'IN' && v.location === 'bade')} className="md:col-span-4 md:row-span-2 md:row-start-3" />
                    </div>
                  </div>
                </div>
              )}

              {/* 3. 訪客登記 */}
              {activeTab === 'checkin' && (
                <div className="max-w-4xl mx-auto animate-fade-in">
                  <h2 className="text-2xl font-bold text-slate-700 mb-6 flex items-center gap-2">
                    <div className="text-blue-600"><Icons.LogIn /></div> 訪客換證登記
                  </h2>
                  
                  <form onSubmit={handleCheckIn} className="bg-white p-8 rounded-xl shadow-lg border border-slate-200">
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8 border-b border-slate-100 pb-6">
                      <div>
                        <label className="block text-sm font-bold text-slate-700 mb-2">訪客姓名 <span className="text-red-500">*</span></label>
                        <input required type="text" className="w-full p-3 bg-slate-50 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none transition text-lg" placeholder="請輸入姓名" value={formData.name} onChange={e => setFormData({...formData, name: e.target.value})} />
                      </div>
                      <div>
                        <label className="block text-sm font-bold text-slate-700 mb-2">聯絡電話</label>
                        <input type="tel" className="w-full p-3 bg-slate-50 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none transition text-lg" placeholder="09xx-xxx-xxx" value={formData.phone} onChange={e => setFormData({...formData, phone: e.target.value})} />
                      </div>
                    </div>

                    <div className="mb-8">
                      <label className="block text-sm font-bold text-slate-700 mb-3">前往大樓 (請點選) <span className="text-red-500">*</span></label>
                      <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3">
                        {LOCATIONS.map(loc => (
                          <button key={loc.id} type="button" onClick={() => setFormData({...formData, location: loc.id})} className={`p-3 rounded-lg border flex flex-col items-center gap-2 transition hover:scale-105 active:scale-95 ${formData.location === loc.id ? 'bg-blue-600 text-white border-blue-600 shadow-md ring-2 ring-offset-1 ring-blue-300' : 'bg-slate-50 text-slate-600 border-slate-200 hover:bg-white hover:shadow-sm'}`}>
                            <div><loc.icon /></div>
                            <span className="font-bold text-sm">{loc.name}</span>
                          </button>
                        ))}
                      </div>
                    </div>

                    <div className="mb-8">
                      <label className="block text-sm font-bold text-slate-700 mb-3">受訪對象/單位 (快速點選) <span className="text-red-500">*</span></label>
                      <div className="grid grid-cols-2 md:grid-cols-4 gap-3 mb-3">
                        {DEPARTMENTS.map(dept => (
                          <button key={dept} type="button" onClick={() => setFormData({...formData, host: dept})} className={`p-4 rounded-lg border flex items-center justify-center gap-2 transition hover:shadow-md ${formData.host === dept ? 'bg-indigo-600 text-white border-indigo-600 font-bold shadow-md' : 'bg-white text-slate-600 border-slate-200 hover:bg-indigo-50'}`}>
                            {dept}
                          </button>
                        ))}
                      </div>
                      <input type="text" className="w-full p-3 bg-slate-50 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none transition" placeholder="或在此手動輸入其他單位/人名..." value={formData.host} onChange={e => setFormData({...formData, host: e.target.value})} />
                    </div>

                    <div className="mb-10">
                      <label className="block text-sm font-bold text-slate-700 mb-3">來訪事由 (快速點選) <span className="text-red-500">*</span></label>
                      <div className="grid grid-cols-2 md:grid-cols-3 gap-3 mb-3">
                        {VISIT_REASONS.map(reason => (
                          <button key={reason} type="button" onClick={() => setFormData({...formData, reason: reason})} className={`p-4 rounded-lg border flex items-center justify-center gap-2 transition hover:shadow-md ${formData.reason === reason ? 'bg-rose-600 text-white border-rose-600 font-bold shadow-md' : 'bg-white text-slate-600 border-slate-200 hover:bg-rose-50'}`}>
                            {reason}
                          </button>
                        ))}
                      </div>
                      <input type="text" className="w-full p-3 bg-slate-50 border border-slate-300 rounded-lg focus:ring-2 focus:ring-rose-500 outline-none transition" placeholder="或在此手動輸入其他事由..." value={formData.reason} onChange={e => setFormData({...formData, reason: e.target.value})} />
                    </div>

                    <button disabled={submitting} type="submit" className={`w-full text-white font-bold py-4 rounded-xl shadow-lg transition-all flex items-center justify-center gap-2 text-xl ${submitting ? 'bg-slate-400 cursor-not-allowed' : 'bg-slate-800 hover:bg-slate-900 transform hover:scale-[1.01] active:scale-[0.99]'}`}>
                      {submitting ? '處理中...' : <><Icons.LogIn /> 完成登記並進入校園</>}
                    </button>
                  </form>
                </div>
              )}

              {/* 4. 簽離與紀錄列表 */}
              {activeTab === 'list' && (
                <div className="animate-fade-in">
                   <div className="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
                    <h2 className="text-2xl font-bold text-slate-700">訪客紀錄管理</h2>
                    <div className="relative w-full md:w-64">
                      <div className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400"><Icons.Search /></div>
                      <input type="text" placeholder="搜尋姓名、單位..." className="w-full pl-10 pr-4 py-2 border border-slate-300 rounded-full focus:ring-2 focus:ring-blue-500 outline-none" value={searchTerm} onChange={e => setSearchTerm(e.target.value)} />
                    </div>
                  </div>

                  <div className="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                    <div className="overflow-x-auto">
                      <table className="w-full text-left">
                        <thead className="bg-slate-50 border-b border-slate-200">
                          <tr>
                            <th className="p-4 font-bold text-slate-600">狀態</th>
                            <th className="p-4 font-bold text-slate-600">姓名</th>
                            <th className="p-4 font-bold text-slate-600">地點/受訪者</th>
                            <th className="p-4 font-bold text-slate-600">事由</th>
                            <th className="p-4 font-bold text-slate-600">時間</th>
                            <th className="p-4 font-bold text-slate-600">操作</th>
                          </tr>
                        </thead>
                        <tbody className="divide-y divide-slate-100">
                          {loading ? <tr><td colSpan="6" className="p-8 text-center text-slate-400">資料讀取中...</td></tr> : filteredVisitors.map(visitor => (
                            <tr key={visitor.id} className="hover:bg-slate-50 transition">
                              <td className="p-4">
                                <span className={`px-3 py-1 rounded-full text-xs font-bold ${visitor.status === 'IN' ? 'bg-green-100 text-green-700' : 'bg-slate-100 text-slate-500'}`}>
                                  {visitor.status === 'IN' ? '在校中' : '已離校'}
                                </span>
                              </td>
                              <td className="p-4 font-medium text-slate-800">{visitor.name}<div className="text-xs text-slate-400">{visitor.phone}</div></td>
                              <td className="p-4">
                                <div className="flex items-center gap-1 text-slate-700"><Icons.MapPin /> {LOCATIONS.find(l => l.id === visitor.location)?.name || '未知區域'}</div>
                                <div className="text-xs text-slate-500 mt-1">找: {visitor.host}</div>
                              </td>
                              <td className="p-4 text-slate-600">{visitor.reason}</td>
                              <td className="p-4 text-sm font-mono text-slate-500">
                                <div>進: {visitor.checkInTime}</div>
                                {visitor.checkOutTime && <div>出: {visitor.checkOutTime}</div>}
                              </td>
                              <td className="p-4">
                                {visitor.status === 'IN' ? (
                                  <button onClick={() => handleCheckOut(visitor.id)} className="px-4 py-2 bg-red-50 text-red-600 hover:bg-red-100 rounded-lg text-sm font-bold transition flex items-center gap-1">
                                    <Icons.LogOut /> 簽離
                                  </button>
                                ) : (
                                  <span className="text-slate-300 text-sm">已完成</span>
                                )}
                              </td>
                            </tr>
                          ))}
                        </tbody>
                      </table>
                    </div>
                  </div>
                </div>
              )}

            </main>
          </div>
        );
      }

      // --- 輔助組件 ---
      function MapBlock({ data, visitors, className }) {
        if (!data) return null; // 避免資料錯誤
        const isOccupied = visitors && visitors.length > 0;
        return (
          <div className={`relative rounded-2xl border-2 transition-all duration-300 group ${isOccupied ? `${data.color} shadow-lg scale-[1.01]` : 'bg-slate-50 border-slate-200 hover:border-slate-300'} ${className} flex flex-col p-4`}>
            <div className="flex justify-between items-start mb-2">
              <div className={`p-2 rounded-lg ${isOccupied ? 'bg-white/50' : 'bg-slate-100'}`}>
                <div className={isOccupied ? 'text-slate-800' : 'text-slate-400'}><data.icon /></div>
              </div>
              {isOccupied && <span className="bg-red-500 text-white text-xs font-bold px-2 py-1 rounded-full animate-pulse">{visitors.length} 人</span>}
            </div>
            <h3 className={`text-lg font-bold mt-auto ${isOccupied ? 'text-slate-800' : 'text-slate-400'}`}>{data.name}</h3>
            {isOccupied && (
              <div className="absolute inset-0 bg-white/95 backdrop-blur-sm opacity-0 group-hover:opacity-100 transition-opacity rounded-xl p-4 flex flex-col z-10 border border-slate-200 shadow-xl overflow-y-auto">
                <div className="font-bold text-slate-700 text-sm mb-2 border-b pb-2">{data.name} - 訪客名單</div>
                <div className="space-y-2">
                  {visitors.map(v => (
                    <div key={v.id} className="text-sm flex justify-between items-center text-slate-600"><span>{v.name}</span><span className="text-xs bg-slate-100 px-1 rounded">找: {v.host}</span></div>
                  ))}
                </div>
              </div>
            )}
          </div>
        );
      }

      function NavButton({ active, onClick, icon: Icon, label }) {
        return (
          <button onClick={onClick} className={`flex items-center gap-3 px-6 py-4 transition-colors w-full md:w-auto whitespace-nowrap ${active ? 'bg-blue-600 text-white border-r-4 border-yellow-400' : 'text-slate-300 hover:bg-slate-700 hover:text-white'}`}>
            <Icon /> <span className="font-medium">{label}</span>
          </button>
        );
      }

      function StatCard({ title, value, subValue, icon, color }) {
        return (
          <div className={`bg-white p-6 rounded-xl shadow-sm border border-slate-200 ${color} flex items-center justify-between`}>
            <div><p className="text-slate-500 text-sm font-medium mb-1">{title}</p><div className="flex items-baseline gap-2"><h3 className="text-3xl font-bold text-slate-800">{value}</h3>{subValue && <span className="text-sm text-slate-400">{subValue}</span>}</div></div>
            <div className="p-3 bg-slate-50 rounded-full">{icon}</div>
          </div>
        );
      }

      const root = ReactDOM.createRoot(document.getElementById('root'));
      root.render(<App />);
    </script>
  </body>
</html>
