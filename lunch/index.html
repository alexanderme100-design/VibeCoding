<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>午餐退費申請系統</title>
  <!-- 引入 Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- 引入 FontAwesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  
  <style>
    /* iOS/macOS 風格字體設定 */
    @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap');
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans TC", sans-serif;
      background-color: #F2F2F7;
      color: #1C1C1E;
      -webkit-tap-highlight-color: transparent;
    }

    /* macOS 風格卡片 */
    .ios-card {
      background-color: white;
      border-radius: 1.25rem;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.03);
      border: 1px solid rgba(0, 0, 0, 0.03);
    }

    /* macOS 風格輸入框 */
    .ios-input {
      background-color: #F2F2F7;
      border: 1px solid transparent;
      border-radius: 10px;
      transition: all 0.2s ease;
    }
    .ios-input:focus {
      background-color: white;
      border-color: #007AFF;
      box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.15);
      outline: none;
    }
    .ios-input.error {
      background-color: #FFF2F2;
      border-color: #FF3B30;
    }

    /* macOS 風格按鈕 */
    .ios-btn-primary {
      background-color: #007AFF;
      color: white;
      border-radius: 12px;
      font-weight: 600;
      transition: all 0.2s;
    }
    .ios-btn-primary:active {
      transform: scale(0.98);
      opacity: 0.8;
    }
    .ios-btn-primary:disabled {
      background-color: #C7C7CC;
      cursor: not-allowed;
      transform: none;
    }

    /* 自訂 Checkbox/Radio */
    input[type="radio"], input[type="checkbox"] {
      appearance: none;
      -webkit-appearance: none;
      width: 1.35rem;
      height: 1.35rem;
      border: 2px solid #D1D1D6;
      border-radius: 50%;
      vertical-align: middle;
      position: relative;
      transition: all 0.2s;
      background-color: white;
    }
    input[type="checkbox"] {
      border-radius: 6px;
    }
    input[type="radio"]:checked, input[type="checkbox"]:checked {
      border-color: #007AFF;
      background-color: #007AFF;
    }
    input[type="radio"]:checked::after {
      content: '';
      position: absolute;
      top: 50%; left: 50%;
      transform: translate(-50%, -50%);
      width: 0.5rem; height: 0.5rem;
      background-color: white;
      border-radius: 50%;
    }
    input[type="checkbox"]:checked::after {
      content: '\f00c';
      font-family: 'Font Awesome 6 Free';
      font-weight: 900;
      color: white;
      font-size: 0.8rem;
      position: absolute;
      top: 50%; left: 50%;
      transform: translate(-50%, -50%);
    }

    /* 日曆樣式 */
    .calendar-day {
      border-radius: 50%;
      font-weight: 500;
      position: relative;
    }
    .calendar-day.selected {
      background-color: #007AFF;
      color: white;
      font-weight: 600;
      box-shadow: 0 2px 8px rgba(0, 122, 255, 0.3);
    }
    .calendar-day.today {
      color: #007AFF;
      font-weight: 700;
    }
    .calendar-day.today::after {
      content: '';
      position: absolute;
      bottom: 4px;
      left: 50%;
      transform: translateX(-50%);
      width: 4px; height: 4px;
      background-color: #007AFF;
      border-radius: 50%;
    }
    .calendar-day.today.selected {
      color: white;
    }
    .calendar-day.today.selected::after {
      background-color: white;
    }
    .calendar-day:disabled {
      color: #C7C7CC;
      text-decoration: none;
      opacity: 0.5;
    }

    .required::after {
      content: " *";
      color: #FF3B30;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: scale(0.95); }
      to { opacity: 1; transform: scale(1); }
    }
    .modal-content {
      animation: fadeIn 0.25s cubic-bezier(0.16, 1, 0.3, 1) forwards;
    }
  </style>
</head>
<body class="antialiased pb-10">

  <div class="max-w-2xl mx-auto my-6 px-3 sm:px-6">
    
    <!-- Header -->
    <div class="mb-6 text-center sm:text-left">
      <h1 class="text-3xl font-bold text-gray-900 tracking-tight flex items-center justify-center sm:justify-start">
        <div class="w-10 h-10 bg-blue-500 rounded-xl flex items-center justify-center text-white mr-3 shadow-md">
           <i class="fa-solid fa-utensils text-lg"></i>
        </div>
        午餐退費申請
      </h1>
      <p class="text-gray-500 mt-1 ml-1 font-medium">每餐退費標準 $60</p>
    </div>

    <!-- 規則說明 -->
    <div class="ios-card p-4 sm:p-5 mb-6 bg-blue-50/50 border-blue-100">
      <h3 class="font-bold text-blue-600 mb-3 flex items-center text-sm uppercase tracking-wide">
        <i class="fa-solid fa-circle-info mr-2"></i> 申請規則與須知
      </h3>
      
      <div id="rule-display" class="mb-4 bg-white p-3 rounded-xl border border-blue-100 shadow-sm">
         <p class="text-xs text-gray-400 mb-1">系統自動計算截算日...</p>
      </div>

      <ul class="space-y-3 text-sm text-gray-700">
        <li class="flex items-start">
          <span class="text-blue-500 mr-3 flex-shrink-0 text-lg leading-none mt-0.5">•</span>
          <span class="flex-1 leading-relaxed text-justify">
            請於停餐日往前<strong class="text-gray-900 mx-0.5">第 2 個工作日下午 1:00 前</strong>提出。
          </span>
        </li>
        <li class="flex items-start">
          <span class="text-blue-500 mr-3 flex-shrink-0 text-lg leading-none mt-0.5">•</span>
          <span class="flex-1 leading-relaxed text-justify">
            已申請補助或未在校用餐者免填。全班停餐由導師代表。
          </span>
        </li>
        <li class="flex items-start">
          <span class="text-blue-500 mr-3 flex-shrink-0 text-lg leading-none mt-0.5">•</span>
          <span class="flex-1 leading-relaxed text-justify">
            逾時申請因食材已訂購，<span class="text-red-500 font-bold">無法退費</span>。資料錯誤亦同。
          </span>
        </li>
        <li class="flex items-start">
          <span class="text-blue-500 mr-3 flex-shrink-0 text-lg leading-none mt-0.5">•</span>
          <span class="flex-1 leading-relaxed">
            洽詢：<a href="tel:0222819980" target="_top" class="text-blue-600 font-bold decoration-blue-300 underline-offset-2 hover:underline">02-22819980 分機 9353</a> (呂小姐)
          </span>
        </li>
      </ul>
    </div>

    <!-- Form -->
    <form id="refundForm" class="space-y-6" onsubmit="handleFormSubmit(event)">

      <!-- Section 1: 基本資料 -->
      <div class="ios-card p-5 sm:p-6">
        <h2 class="text-lg font-bold text-gray-900 mb-5 flex items-center">
          <span class="bg-gray-100 text-gray-500 w-7 h-7 rounded-full flex items-center justify-center text-xs mr-2">1</span>
          基本資料
        </h2>

        <div class="space-y-6">
          <!-- 停餐事由 -->
          <div>
            <label class="block text-sm font-semibold text-gray-700 mb-3 required">停餐事由</label>
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
              <label class="flex items-center p-3 rounded-xl border border-gray-100 bg-gray-50 hover:bg-blue-50 cursor-pointer transition-colors">
                <input type="radio" name="reason" value="法定請假(腸病毒、水痘)" required>
                <span class="ml-3 text-sm font-medium">法定請假 (腸病毒等)</span>
              </label>
              <label class="flex items-center p-3 rounded-xl border border-gray-100 bg-gray-50 hover:bg-blue-50 cursor-pointer transition-colors">
                <input type="radio" name="reason" value="病假">
                <span class="ml-3 text-sm font-medium">病假</span>
              </label>
              <label class="flex items-center p-3 rounded-xl border border-gray-100 bg-gray-50 hover:bg-blue-50 cursor-pointer transition-colors">
                <input type="radio" name="reason" value="事假">
                <span class="ml-3 text-sm font-medium">事假</span>
              </label>
              <label class="flex items-center p-3 rounded-xl border border-gray-100 bg-gray-50 hover:bg-blue-50 cursor-pointer transition-colors">
                <input type="radio" name="reason" value="其他">
                <span class="ml-3 text-sm font-medium">其他</span>
              </label>
            </div>
            <input type="text" id="reasonOtherInput" class="ios-input hidden mt-3 w-full text-sm" placeholder="請輸入具體事由...">
          </div>

          <!-- 申請類別 -->
          <div>
            <label class="block text-sm font-semibold text-gray-700 mb-3 required">申請類別</label>
            <div class="bg-gray-50 p-1 rounded-xl flex">
              <label class="flex-1 text-center cursor-pointer">
                <input type="radio" name="applyType" value="individual" class="hidden peer" checked onchange="toggleStudentCount(false)">
                <div class="py-2 rounded-lg text-sm font-medium text-gray-500 peer-checked:bg-white peer-checked:text-blue-600 peer-checked:shadow-sm transition-all">
                  個人申請
                </div>
              </label>
              <label class="flex-1 text-center cursor-pointer">
                <input type="radio" name="applyType" value="class" class="hidden peer" onchange="toggleStudentCount(true)">
                <div class="py-2 rounded-lg text-sm font-medium text-gray-500 peer-checked:bg-white peer-checked:text-blue-600 peer-checked:shadow-sm transition-all">
                  全班/多人
                </div>
              </label>
            </div>
            
            <div id="studentCountContainer" class="hidden mt-4 animate-fade-in">
              <label class="text-sm text-gray-600 mb-1 block">退費人數</label>
              <div class="flex items-center">
                <input type="number" id="studentCount" name="studentCount" value="1" min="1" class="ios-input w-24 text-center font-bold text-lg" oninput="updateSummary()">
                <span class="ml-3 text-gray-500 text-sm">人</span>
              </div>
            </div>
          </div>

          <!-- 班級與姓名 -->
          <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-semibold text-gray-700 mb-2 required">班級座號 / 職稱</label>
              <input type="text" id="classSeat" name="classSeat" placeholder="例：60123 或 601全班" class="ios-input w-full" required>
            </div>
            <div>
              <label class="block text-sm font-semibold text-gray-700 mb-2 required">停餐學生</label>
              <input type="text" id="name" name="name" class="ios-input w-full" required>
            </div>
          </div>
          
          <!-- 葷素 -->
          <div>
            <label class="block text-sm font-semibold text-gray-700 mb-2 required">用餐葷素</label>
            <div class="flex space-x-6 mt-2">
              <label class="flex items-center cursor-pointer">
                <input type="radio" name="diet" value="葷" required>
                <span class="ml-2 font-medium">葷食</span>
              </label>
              <label class="flex items-center cursor-pointer">
                <input type="radio" name="diet" value="素">
                <span class="ml-2 font-medium">素食</span>
              </label>
            </div>
          </div>
        </div>
      </div>

      <!-- Section 2: 日期與計算 -->
      <div class="ios-card p-5 sm:p-6">
        <h2 class="text-lg font-bold text-gray-900 mb-5 flex items-center">
          <span class="bg-gray-100 text-gray-500 w-7 h-7 rounded-full flex items-center justify-center text-xs mr-2">2</span>
          選擇日期
        </h2>

        <div class="bg-gray-50 rounded-2xl p-4 mb-4">
          <div class="flex items-center justify-between mb-4">
            <span class="text-sm font-bold text-gray-700">停餐日曆</span>
            <div class="flex items-center text-xs text-gray-400 space-x-3">
              <span class="flex items-center"><span class="w-2 h-2 rounded-full bg-blue-500 mr-1"></span>選取</span>
              <span class="flex items-center"><span class="w-2 h-2 rounded-full border border-gray-300 mr-1"></span>可選</span>
              <span class="flex items-center"><span class="w-2 h-2 rounded-full bg-gray-200 mr-1"></span>不可</span>
            </div>
          </div>
          <div id="calendar-wrapper" class="space-y-6 select-none">
            <!-- JS 生成日曆 -->
          </div>
        </div>

        <!-- 統計 Widget -->
        <div class="bg-gray-900 rounded-2xl p-5 text-white shadow-lg">
          <div class="grid grid-cols-3 gap-4 text-center divide-x divide-gray-700">
            <div>
              <div class="text-xs text-gray-400 mb-1">人數</div>
              <input type="text" id="displayStudentCount" readonly class="bg-transparent text-center text-xl font-bold w-full text-white outline-none" value="1">
            </div>
            <div>
              <div class="text-xs text-gray-400 mb-1">天數</div>
              <input type="number" id="totalDays" name="totalDays" readonly class="bg-transparent text-center text-xl font-bold w-full text-white outline-none" value="0">
            </div>
            <div>
              <div class="text-xs text-gray-400 mb-1">總金額</div>
              <div class="text-xl font-bold text-blue-400">$<span id="totalAmount">0</span></div>
            </div>
          </div>
          
          <div id="selected-dates-display" class="mt-4 pt-4 border-t border-gray-700 text-xs text-gray-300 min-h-[30px] flex flex-wrap gap-2">
            <span class="italic opacity-50">請選擇上方日期...</span>
          </div>
          <input type="hidden" id="dateInput" name="dateInput" required>
        </div>
      </div>

      <!-- Section 3: 社團 -->
      <div class="ios-card p-5 sm:p-6">
        <h2 class="text-lg font-bold text-gray-900 mb-4 flex items-center">
          <span class="bg-gray-100 text-gray-500 w-7 h-7 rounded-full flex items-center justify-center text-xs mr-2">3</span>
          社團調查
        </h2>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-3" id="club-container">
          <!-- JS 選項 -->
        </div>
      </div>

      <!-- Submit Button -->
      <div class="pb-6">
        <button type="submit" id="submitBtn" class="ios-btn-primary w-full py-4 text-lg shadow-lg hover:shadow-xl shadow-blue-500/20 disabled:shadow-none">
          提交申請
        </button>
      </div>

    </form>
    
    <!-- Loading & Modals -->
    <div id="loadingOverlay" class="hidden fixed inset-0 bg-white/80 backdrop-blur-sm flex items-center justify-center z-50">
      <div class="bg-white p-6 rounded-2xl shadow-2xl border border-gray-100 text-center w-64">
        <div class="animate-spin rounded-full h-10 w-10 border-[3px] border-blue-100 border-t-blue-500 mx-auto mb-4"></div>
        <p class="text-gray-600 font-medium">處理中...</p>
      </div>
    </div>
    
    <div id="successModal" class="hidden fixed inset-0 bg-black/40 backdrop-blur-md flex items-center justify-center z-50 p-4">
      <div class="modal-content bg-white p-8 rounded-3xl shadow-2xl text-center max-w-sm w-full">
        <div class="w-16 h-16 bg-green-100 text-green-500 rounded-full flex items-center justify-center mx-auto mb-4 text-3xl">
          <i class="fa-solid fa-check"></i>
        </div>
        <h3 class="text-2xl font-bold text-gray-900 mb-2">申請成功</h3>
        <p class="text-gray-500 mb-8">系統已收到您的資料，<br>請留意退費通知。</p>
        <button type="button" onclick="closeSuccessModal()" class="ios-btn-primary w-full py-3.5">
          完成
        </button>
      </div>
    </div>

  </div>

  <script>
    // --- 這裡請填入您部署 Web App 後取得的網址 ---
    const GAS_API_URL = "https://script.google.com/macros/s/AKfycbz64y8GNkn-ayo6pDgoENgaOA7PbG2dm3O9dwOD-yGv4cAKdoCWj-PWATArXIKgRTwW/exec"; 

    // --- Configuration ---
    const COST_PER_MEAL = 60;
    
    // 假日設定
    const HOLIDAYS = [
        "2025/1/1", "2025/2/28", "2025/4/3", "2025/4/4", "2026/1/1"
    ];

    const CLUB_OPTIONS = [
      "全部未參加",
      "1.2年級課後班(一.四.五)", "3.4年級課後班(五)",
      "1.2年級羽球隊(一. 四.五)", "3.4年級羽球隊(五)", "週三(羽球隊)",
      "週三籃球班A", "週三籃球班B", "週三籃球班C",
      "週三才藝班(流行mv舞蹈班)", "週三才藝班(英語初階自然發音班P4-P6)班",
      "週三才藝班(英語社團基礎字彙班V1-V3)", "週三才藝班(幸福捏一下A)",
      "週三才藝班(創意DIY-禮品＆點心小鋪)", "週三才藝班(兒童創意美術)",
      "週三才藝班(數學桌遊社寶可夢)", "週三才藝班(思丁(STEAM)創客好小子)",
      "週三才藝班(動漫平板繪圖與手作創作營)", "週三才藝班(黑鷹足球社團課)",
      "週五籃球班A", "週五籃球班B", "週五籃球班C",
      "其他"
    ];

    let earliestValidDateObj = null;
    let earliestValidDateStr = "";
    let selectedDatesSet = new Set();
    let currentStudentCount = 1;

    // --- Initialization ---
    document.addEventListener('DOMContentLoaded', () => {
      renderClubs();
      calculateDeadlineRule();
      initCalendar();
      updateSummary();
      initReasonToggle();
    });

    // Toggle Student Count Input
    function toggleStudentCount(isClass) {
      const container = document.getElementById('studentCountContainer');
      const input = document.getElementById('studentCount');
      
      if (isClass) {
        container.classList.remove('hidden');
        input.value = ""; 
        input.focus();
        input.classList.add('error');
        currentStudentCount = 0; 
      } else {
        container.classList.add('hidden');
        input.value = "1";
        input.classList.remove('error');
        currentStudentCount = 1;
      }
      updateSummary();
    }

    function initReasonToggle() {
      const radios = document.querySelectorAll('input[name="reason"]');
      const otherInput = document.getElementById('reasonOtherInput');
      
      radios.forEach(radio => {
        radio.addEventListener('change', (e) => {
          if (e.target.value === '其他') {
            otherInput.classList.remove('hidden');
            otherInput.required = true;
            otherInput.focus();
          } else {
            otherInput.classList.add('hidden');
            otherInput.required = false;
            otherInput.value = '';
          }
        });
      });
    }

    // --- Calendar Logic ---
    function initCalendar() {
      const now = new Date();
      renderMonth(now.getFullYear(), now.getMonth());
      const nextMonth = new Date(now.getFullYear(), now.getMonth() + 1, 1);
      renderMonth(nextMonth.getFullYear(), nextMonth.getMonth());
    }

    function renderMonth(year, month) {
      const wrapper = document.getElementById('calendar-wrapper');
      const monthContainer = document.createElement('div');
      
      const rocYear = year - 1911;
      const title = document.createElement('div');
      title.className = "text-center font-bold text-gray-800 mb-3 text-base";
      title.innerText = `民國${rocYear}年 ${month + 1}月`;
      monthContainer.appendChild(title);
      
      const weekHeader = document.createElement('div');
      weekHeader.className = "grid grid-cols-7 gap-1 mb-2 text-center text-[10px] font-semibold text-gray-400 uppercase tracking-wider";
      ['日', '一', '二', '三', '四', '五', '六'].forEach(d => {
        const span = document.createElement('span');
        span.innerText = d;
        weekHeader.appendChild(span);
      });
      monthContainer.appendChild(weekHeader);
      
      const grid = document.createElement('div');
      grid.className = "grid grid-cols-7 gap-1 sm:gap-2";
      
      const firstDay = new Date(year, month, 1);
      const daysInMonth = new Date(year, month + 1, 0).getDate();
      const startDayOfWeek = firstDay.getDay(); 
      
      const today = new Date();
      
      for (let i = 0; i < startDayOfWeek; i++) {
        grid.appendChild(document.createElement('div'));
      }
      
      for (let d = 1; d <= daysInMonth; d++) {
        const dateObj = new Date(year, month, d);
        const dateStr = formatDateKey(dateObj); 
        
        const btn = document.createElement('button');
        btn.type = "button"; 
        btn.innerText = d;
        btn.className = "calendar-day h-10 w-full flex items-center justify-center text-sm transition-transform active:scale-90";
        
        const dayOfWeek = dateObj.getDay();
        const isWeekend = (dayOfWeek === 0 || dayOfWeek === 6);
        const isHoliday = HOLIDAYS.includes(dateStr);
        
        if (dateObj.toDateString() === today.toDateString()) {
          btn.classList.add('today');
        }

        if (isWeekend || isHoliday) {
          btn.style.color = "#FF3B30"; // iOS Red for holidays
        }
        
        const compareDate = new Date(dateObj);
        compareDate.setHours(0,0,0,0);
        
        const thresholdDate = new Date(earliestValidDateObj);
        thresholdDate.setHours(0,0,0,0);
        
        if (compareDate < thresholdDate) {
          btn.disabled = true;
        } else if (isWeekend || isHoliday) {
          btn.disabled = true;
          btn.style.opacity = "0.3"; 
        } else {
          btn.onclick = () => toggleDateSelection(dateStr, btn);
          if (selectedDatesSet.has(dateStr)) {
            btn.classList.add('selected');
          }
        }
        
        grid.appendChild(btn);
      }
      
      monthContainer.appendChild(grid);
      wrapper.appendChild(monthContainer);
    }

    function formatDateKey(date) {
      return `${date.getFullYear()}/${date.getMonth() + 1}/${date.getDate()}`;
    }

    function toggleDateSelection(dateStr, btnElement) {
      if (selectedDatesSet.has(dateStr)) {
        selectedDatesSet.delete(dateStr);
        btnElement.classList.remove('selected');
      } else {
        selectedDatesSet.add(dateStr);
        btnElement.classList.add('selected');
      }
      updateSummary();
    }

    function updateSummary() {
      const input = document.getElementById('studentCount');
      const inputVal = input.value;
      currentStudentCount = parseInt(inputVal) || 0;
      
      if (currentStudentCount <= 0 && !document.getElementById('studentCountContainer').classList.contains('hidden')) {
        input.classList.add('error');
      } else {
        input.classList.remove('error');
      }
      
      document.getElementById('displayStudentCount').value = currentStudentCount;

      const sortedDates = Array.from(selectedDatesSet).sort((a, b) => new Date(a) - new Date(b));
      
      const displayEl = document.getElementById('selected-dates-display');
      if (sortedDates.length === 0) {
        displayEl.innerHTML = '<span class="italic opacity-50">請選擇上方日期...</span>';
      } else {
        const tags = sortedDates.map(d => `<span class="bg-blue-500 text-white px-2 py-0.5 rounded-md">${d}</span>`).join('');
        displayEl.innerHTML = tags;
      }
      
      document.getElementById('dateInput').value = sortedDates.join(', ');
      
      const daysCount = sortedDates.length;
      document.getElementById('totalDays').value = daysCount;
      
      const totalAmount = daysCount * currentStudentCount * COST_PER_MEAL;
      document.getElementById('totalAmount').innerText = totalAmount.toLocaleString();
      
      const submitBtn = document.getElementById('submitBtn');
      if (daysCount === 0 || currentStudentCount <= 0) {
        submitBtn.disabled = true;
        if (daysCount === 0) submitBtn.innerText = "請選擇停餐日期";
        else if (currentStudentCount <= 0) submitBtn.innerText = "請輸入正確人數";
      } else {
        submitBtn.disabled = false;
        submitBtn.innerText = "提交申請";
      }
    }

    function renderClubs() {
      const container = document.getElementById('club-container');
      CLUB_OPTIONS.forEach((club, index) => {
        const div = document.createElement('div');
        div.innerHTML = `
          <label class="flex items-start p-3 rounded-xl border border-gray-100 bg-gray-50 hover:bg-white hover:shadow-sm cursor-pointer transition-all">
             <input type="checkbox" name="clubs" value="${club}" id="club_${index}" class="mt-0.5 flex-shrink-0">
             <span class="ml-3 text-sm text-gray-700 leading-tight select-none">${club}</span>
          </label>
        `;
        container.appendChild(div.firstElementChild);
      });
      
      const noneCheckbox = document.getElementById('club_0');
      const otherCheckboxes = Array.from(document.querySelectorAll('input[name="clubs"]:not(#club_0)'));
      
      noneCheckbox.addEventListener('change', (e) => {
        if(e.target.checked) {
          otherCheckboxes.forEach(cb => { cb.checked = false; cb.disabled = true; 
             cb.parentElement.classList.add('opacity-50', 'bg-gray-100');
          });
        } else {
          otherCheckboxes.forEach(cb => { cb.disabled = false; 
             cb.parentElement.classList.remove('opacity-50', 'bg-gray-100');
          });
        }
      });
    }

    // --- Deadline Calculation ---
    function calculateDeadlineRule() {
      const now = new Date();
      const currentHour = now.getHours();
      let baseDate = new Date(now);
      let note = "";
      
      let daysToAdd = 0;
      if (currentHour >= 13) {
        note = `已過 13:00`;
        daysToAdd = 3;
      } else {
        note = `13:00 前`;
        daysToAdd = 2;
      }
      
      earliestValidDateObj = addWorkDays(baseDate, daysToAdd);
      earliestValidDateStr = formatDateFull(earliestValidDateObj);
      
      const displayEl = document.getElementById('rule-display');
      displayEl.innerHTML = `
        <div class="flex items-center justify-between">
           <span class="text-xs text-gray-500 font-medium">現在時刻：${formatDateFull(now)} (${note})</span>
        </div>
        <div class="text-lg font-bold text-blue-600 mt-1">
          <span class="text-xs text-gray-400 font-normal mr-1">最早可退費日</span>
          ${earliestValidDateStr}
        </div>
      `;
    }

    function addDays(date, days) {
      const result = new Date(date);
      result.setDate(result.getDate() + days);
      return result;
    }

    function isWorkDay(date) {
      const day = date.getDay();
      if (day === 0 || day === 6) return false;
      const dateStr = formatDateKey(date);
      if (HOLIDAYS.includes(dateStr)) return false;
      return true;
    }

    function addWorkDays(startDate, days) {
      let currentDate = new Date(startDate);
      let added = 0;
      while (added < days) {
        currentDate.setDate(currentDate.getDate() + 1);
        if (isWorkDay(currentDate)) {
          added++;
        }
      }
      return currentDate;
    }

    function formatDateSimple(date) {
      return `${date.getMonth() + 1}/${date.getDate()}`;
    }

    function formatDateFull(date) {
      const yyyy = date.getFullYear();
      const mm = String(date.getMonth() + 1).padStart(2, '0');
      const dd = String(date.getDate()).padStart(2, '0');
      const dayName = ['日','一','二','三','四','五','六'][date.getDay()];
      return `${yyyy}/${mm}/${dd} (${dayName})`;
    }

    // --- Form Submission (GitHub Version) ---
    function handleFormSubmit(e) {
      e.preventDefault();
      
      // 檢查是否設定了 API URL
      if (!GAS_API_URL || GAS_API_URL.includes("在此處貼上")) {
        alert("請先設定 GAS_API_URL！");
        return;
      }

      const form = document.getElementById('refundForm');
      const formData = new FormData(form);
      const data = {};
      
      const clubs = [];
      document.querySelectorAll('input[name="clubs"]:checked').forEach(cb => {
        clubs.push(cb.value);
      });
      
      formData.forEach((value, key) => {
        if (key !== 'clubs') data[key] = value;
      });
      
      if (data['reason'] === '其他') {
        const otherText = document.getElementById('reasonOtherInput').value.trim();
        if (otherText) {
          data['reason'] = `其他：${otherText}`;
        }
      }

      data['clubs'] = clubs.join(', ');
      
      if (data['applyType'] === 'individual') {
        data['studentCount'] = 1;
      }
      
      document.getElementById('loadingOverlay').classList.remove('hidden');

      // 使用 fetch 發送請求到 GAS
      // 使用 text/plain 避免 OPTIONS preflight 請求
      fetch(GAS_API_URL, {
        method: "POST",
        body: JSON.stringify(data),
        headers: {
            "Content-Type": "text/plain;charset=utf-8",
        },
      })
      .then(response => {
        if (response.ok) {
           return response.json();
        } else {
           throw new Error("Network response was not ok.");
        }
      })
      .then(result => {
         if (result.result === "success") {
             onSuccess();
         } else {
             onFailure(new Error(result.error || "Unknown error"));
         }
      })
      .catch(error => {
         // GAS Web App 跨域有時會因為 Redirect 導致 fetch 認為失敗
         // 但若我們確定後端寫入成功，可以在這裡做寬容處理
         // 這裡建議嚴格處理，若失敗就報錯
         onFailure(error);
      });
    }

    function onSuccess() {
      document.getElementById('loadingOverlay').classList.add('hidden');
      
      document.getElementById('refundForm').reset();
      selectedDatesSet.clear();
      document.getElementById('calendar-wrapper').innerHTML = '';
      toggleStudentCount(false);
      initCalendar();
      updateSummary();
      const otherCheckboxes = Array.from(document.querySelectorAll('input[name="clubs"]:not(#club_0)'));
      otherCheckboxes.forEach(cb => { 
        cb.disabled = false; 
        cb.parentElement.classList.remove('opacity-50', 'bg-gray-100');
      });
      calculateDeadlineRule();

      document.getElementById('successModal').classList.remove('hidden');
    }

    function closeSuccessModal() {
      document.getElementById('successModal').classList.add('hidden');
    }

    function onFailure(error) {
      document.getElementById('loadingOverlay').classList.add('hidden');
      alert('發生錯誤，請稍後再試或聯繫管理員：' + error.message);
    }
  </script>
</body>

</html>

