<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>é·ºæ±Ÿåœ‹å°åˆé¤åœé¤é€€è²»ç”³è«‹</title>
  
  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸ±</text></svg>">
  <meta property="og:title" content="é·ºæ±Ÿåœ‹å°åˆé¤åœé¤é€€è²»ç”³è«‹">
  <meta property="og:description" content="ç·šä¸Šè¾¦ç†åˆé¤é€€è²»ç”³è«‹ï¼Œè«‹ç•™æ„ç”³è«‹æˆªæ­¢æ™‚é–“ã€‚">
  <meta property="og:type" content="website">

  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap');
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans TC", sans-serif;
      /* å‰åœåŠ›é¢¨æ ¼æ¼¸å±¤èƒŒæ™¯ï¼šå¤©ç©ºè—åˆ°è‰åœ°ç¶  */
      background: linear-gradient(180deg, #E0F2FE 0%, #F0FDFA 50%, #DCFCE7 100%);
      background-attachment: fixed;
      color: #334155;
      -webkit-tap-highlight-color: transparent;
      min-height: 100vh;
    }

    /* å¢åŠ å¾®å°çš„æ°´å½©ç´‹ç†æ„Ÿ */
    body::before {
      content: "";
      position: fixed;
      top: 0; left: 0; width: 100%; height: 100%;
      opacity: 0.03;
      pointer-events: none;
      background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.65' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)'/%3E%3C/svg%3E");
      z-index: -1;
    }

    /* å¼·åŒ–å¡ç‰‡å°æ¯”ï¼šåŠ æ·±é‚Šæ¡†èˆ‡é™°å½± */
    .ios-card { 
      background: rgba(255, 255, 255, 0.95); 
      border-radius: 1.5rem; 
      box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.05), 0 8px 10px -6px rgba(0, 0, 0, 0.05); 
      border: 1px solid rgba(203, 213, 225, 0.6); /* æ›´æ˜é¡¯çš„ç°è‰²é‚Šæ¡† */
      backdrop-filter: blur(8px);
    }

    .ios-input { 
      background: #F8FAFC; 
      border: 1px solid #E2E8F0; 
      border-radius: 12px; 
      transition: all 0.2s; 
      padding: 0.75rem; 
      width: 100%; 
      color: #1E293B;
    }
    .ios-input:focus { background: white; border-color: #0EA5E9; box-shadow: 0 0 0 3px rgba(14, 165, 233, 0.15); outline: none; }
    .ios-input.error { border-color: #EF4444; background-color: #FEF2F2; }

    /* å‰åœåŠ›å¤©ç©ºè—æŒ‰éˆ• */
    .ios-btn-primary { 
      background: linear-gradient(135deg, #0EA5E9 0%, #0284C7 100%); 
      color: white; 
      border-radius: 14px; 
      font-weight: 600; 
      transition: all 0.3s; 
      box-shadow: 0 4px 14px 0 rgba(14, 165, 233, 0.3);
    }
    .ios-btn-primary:active { transform: scale(0.97); opacity: 0.9; }
    .ios-btn-primary:disabled { background: #CBD5E1; cursor: not-allowed; transform: none; box-shadow: none !important; }
    
    input[type="radio"], input[type="checkbox"] { appearance: none; width: 1.35rem; height: 1.35rem; border: 2px solid #CBD5E1; border-radius: 50%; vertical-align: middle; position: relative; transition: all 0.2s; background: white; cursor: pointer; }
    input[type="checkbox"] { border-radius: 6px; }
    input[type="radio"]:checked, input[type="checkbox"]:checked { border-color: #0EA5E9; background: #0EA5E9; }
    input[type="radio"]:checked::after { content: ''; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 0.5rem; height: 0.5rem; background: white; border-radius: 50%; }
    input[type="checkbox"]:checked::after { content: '\f00c'; font-family: 'Font Awesome 6 Free'; font-weight: 900; color: white; font-size: 0.8rem; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); }

    /* æ—¥æ›†å–®é …ï¼šæå‡å¯è®€æ€§ */
    .calendar-day { 
      border-radius: 12px; 
      font-weight: 600; 
      position: relative; 
      transition: all 0.2s; 
      border: 1px solid #F1F5F9; 
      background-color: #FFFFFF; 
      color: #475569;
    }
    
    .calendar-day.selected { 
      background: linear-gradient(135deg, #0EA5E9 0%, #2563EB 100%) !important; 
      color: white !important; 
      transform: scale(1.08); 
      z-index: 10; 
      box-shadow: 0 8px 15px -3px rgba(37, 99, 235, 0.4); 
      border-color: transparent;
    }
    
    .calendar-day.today { 
      color: #0EA5E9; 
      background-color: #F0F9FF; 
      border: 2px solid #BAE6FD; 
    }
    
    /* éæœŸæ—¥æœŸï¼šå°æ¯”åº¦æ‹‰é–‹ï¼Œä½¿ç”¨éœ§ç°è‰² */
    .calendar-day.is-disabled { 
      color: #94A3B8 !important; 
      opacity: 0.6; 
      cursor: not-allowed !important; 
      background-color: #F1F5F9 !important; 
      border-color: #E2E8F0;
      box-shadow: none;
    }
    
    /* å­¸æ ¡åœé¤ï¼šé†’ç›®çš„ç´…ç£šè‰²èˆ‡åˆªé™¤ç·š */
    .calendar-day.holiday-locked { 
      color: #B91C1C !important; 
      background-color: #FEE2E2 !important; 
      text-decoration: line-through; 
      text-decoration-thickness: 2px; 
      border: 1px dashed #FCA5A5; 
      box-shadow: none;
    }
    
    .calendar-day.makeup-day { 
      background-color: #FEF3C7; 
      color: #D97706; 
      border: 1px solid #FDE68A; 
    }

    @keyframes slideIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }
    .calendar-anim-enter { animation: slideIn 0.3s ease-out forwards; }
    .required::after { content: " *"; color: #EF4444; }
    
    /* å„ªåŒ–æ²è»¸é¡è‰² */
    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: #CBD5E1; border-radius: 10px; }
  </style>
</head>
<body class="antialiased pb-10">

  <div class="max-w-2xl mx-auto my-6 px-4 sm:px-6 pt-4">
    <!-- Header -->
    <div class="mb-8 text-center sm:text-left">
      <h1 class="text-3xl font-bold text-slate-800 tracking-tight flex items-center justify-center sm:justify-start">
        <div class="w-12 h-12 bg-sky-500 rounded-2xl flex items-center justify-center text-white mr-4 shadow-lg bg-gradient-to-br from-sky-400 to-sky-600">
           <i class="fa-solid fa-cloud-sun text-xl"></i>
        </div>
        é·ºæ±Ÿåœ‹å°åˆé¤é€€è²»ç”³è«‹
      </h1>
      <p class="text-slate-500 mt-2 ml-1 font-medium flex items-center justify-center sm:justify-start">
        <span class="bg-white/60 px-3 py-1 rounded-full border border-slate-200">æ¯é¤é€€è²»æ¨™æº– <span class="text-sky-600 font-bold">$60</span></span>
      </p>
    </div>

    <!-- è¦å‰‡èªªæ˜ -->
    <div class="ios-card p-6 mb-8 border-sky-100">
      <h3 class="font-bold text-sky-700 mb-4 flex items-center text-sm uppercase tracking-wider">
        <i class="fa-solid fa-paper-plane mr-2"></i> ç”³è«‹è¦å‰‡èˆ‡é ˆçŸ¥
      </h3>
      <div id="rule-display" class="mb-5 bg-sky-50/50 p-4 rounded-2xl border border-sky-100">
         <p class="text-xs text-slate-400 animate-pulse">ç³»çµ±æ­£åœ¨è¨ˆç®—æˆªç®—æ™‚é–“...</p>
      </div>
      <ul class="space-y-3 text-sm text-slate-600">
        <li class="flex items-start"><span class="text-sky-400 mr-2"><i class="fa-solid fa-leaf"></i></span><span>è«‹æ–¼åœé¤æ—¥å¾€å‰<strong class="text-slate-900 mx-1">ç¬¬ 2 å€‹å·¥ä½œæ—¥ä¸‹åˆ 1:00 å‰</strong>æå‡ºã€‚</span></li>
        <li class="flex items-start"><span class="text-sky-400 mr-2"><i class="fa-solid fa-leaf"></i></span><span>é€¾æ™‚ç”³è«‹å› é£Ÿæå·²è¨‚è³¼ï¼Œ<span class="text-rose-500 font-bold">ç„¡æ³•å—ç†é€€è²»</span>ã€‚</span></li>
        <li class="flex items-start"><span class="text-sky-400 mr-2"><i class="fa-solid fa-leaf"></i></span><span>æ´½è©¢ï¼š<a href="tel:0222819980" class="text-sky-600 font-bold hover:underline">åˆ†æ©Ÿ 9353</a></span></li>
      </ul>
    </div>

    <form id="refundForm" class="space-y-8" onsubmit="handleFormSubmit(event)">
      <!-- æ­¥é©Ÿ 1: åŸºæœ¬è³‡æ–™ -->
      <div class="ios-card p-6 sm:p-8">
        <h2 class="text-xl font-bold text-slate-800 mb-6 flex items-center">
            <span class="bg-sky-100 text-sky-600 w-8 h-8 rounded-full flex items-center justify-center text-sm mr-3 font-bold">1</span>
            åŸºæœ¬è³‡æ–™
        </h2>
        
        <div id="autoFillHint" class="hidden mb-6 bg-emerald-50 text-emerald-700 text-xs px-4 py-3 rounded-xl border border-emerald-100 flex items-center shadow-sm">
            <i class="fa-solid fa-wand-magic-sparkles mr-2 text-emerald-500"></i> å·²è‡ªå‹•ç‚ºæ‚¨è¼‰å…¥ä¸Šæ¬¡çš„ç”³è«‹è³‡æ–™
        </div>

        <div class="space-y-8">
          <div>
            <label class="block text-sm font-bold text-slate-700 mb-4 required">åœé¤äº‹ç”±</label>
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
              <label class="flex items-center p-4 rounded-2xl border border-slate-100 bg-slate-50/50 hover:bg-sky-50 cursor-pointer transition-all group">
                <input type="radio" name="reason" value="æ³•å®šè«‹å‡(è…¸ç—…æ¯’ã€æ°´ç—˜)" required>
                <div class="ml-4">
                    <span class="text-sm font-bold block text-slate-700 group-hover:text-sky-700">æ³•å®šè«‹å‡</span>
                    <span class="text-[10px] text-slate-500 block">è…¸ç—…æ¯’ã€æ°´ç—˜ç­‰</span>
                </div>
              </label>
              <label class="flex items-center p-4 rounded-2xl border border-slate-100 bg-slate-50/50 hover:bg-sky-50 cursor-pointer transition-all group"><input type="radio" name="reason" value="ç—…å‡"><span class="ml-4 text-sm font-bold text-slate-700 group-hover:text-sky-700">ç—…å‡</span></label>
              <label class="flex items-center p-4 rounded-2xl border border-slate-100 bg-slate-50/50 hover:bg-sky-50 cursor-pointer transition-all group"><input type="radio" name="reason" value="äº‹å‡"><span class="ml-4 text-sm font-bold text-slate-700 group-hover:text-sky-700">äº‹å‡</span></label>
              <label class="flex items-center p-4 rounded-2xl border border-slate-100 bg-slate-50/50 hover:bg-sky-50 cursor-pointer transition-all group"><input type="radio" name="reason" value="å…¶ä»–"><span class="ml-4 text-sm font-bold text-slate-700 group-hover:text-sky-700">å…¶ä»– (å…¬å‡ç­‰)</span></label>
            </div>
            <input type="text" id="reasonOtherInput" class="ios-input mt-4 hidden" placeholder="è«‹è©³ç´°è¨»æ˜åœé¤äº‹ç”±...">
          </div>

          <div>
            <label class="block text-sm font-bold text-slate-700 mb-4 required">ç”³è«‹é¡åˆ¥</label>
            <div class="bg-slate-100/80 p-1.5 rounded-2xl flex">
              <label class="flex-1 text-center cursor-pointer"><input type="radio" name="applyType" value="individual" class="hidden peer" checked onchange="toggleStudentCount(false)"><div class="py-2.5 rounded-xl text-sm font-bold text-slate-500 peer-checked:bg-white peer-checked:text-sky-600 peer-checked:shadow-md transition-all">å€‹äººç”³è«‹</div></label>
              <label class="flex-1 text-center cursor-pointer"><input type="radio" name="applyType" value="class" class="hidden peer" onchange="toggleStudentCount(true)"><div class="py-2.5 rounded-xl text-sm font-bold text-slate-500 peer-checked:bg-white peer-checked:text-sky-600 peer-checked:shadow-md transition-all">å…¨ç­ / å¤šäºº</div></label>
            </div>
            <div id="studentCountContainer" class="hidden mt-6 animate-fade-in">
              <div class="flex items-center bg-slate-50 p-4 rounded-2xl border border-slate-100">
                <label class="text-sm font-bold text-slate-600 mr-4">åœé¤ç¸½äººæ•¸ï¼š</label>
                <input type="number" id="studentCount" name="studentCount" value="1" min="1" class="ios-input w-28 text-center font-bold text-lg" oninput="updateSummary()">
                <span class="ml-3 text-slate-500 font-bold">äºº</span>
              </div>
            </div>
          </div>

          <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
            <div><label class="block text-sm font-bold text-slate-700 mb-2 required">ç­ç´šåº§è™Ÿ</label><input type="text" inputmode="numeric" id="classSeat" name="classSeat" placeholder="ä¾‹å¦‚ï¼š60123" class="ios-input" required></div>
            <div><label class="block text-sm font-bold text-slate-700 mb-2 required">å§“å</label><input type="text" id="name" name="name" class="ios-input" required></div>
          </div>

          <div>
            <label class="block text-sm font-bold text-slate-700 mb-3 required">ç”¨é¤è‘·ç´ </label>
            <div class="flex space-x-12 mt-2">
              <label class="flex items-center cursor-pointer group"><input type="radio" name="diet" value="è‘·" required><span class="ml-3 font-bold text-slate-700 group-hover:text-sky-600">è‘·é£Ÿ</span></label>
              <label class="flex items-center cursor-pointer group"><input type="radio" name="diet" value="ç´ "><span class="ml-3 font-bold text-slate-700 group-hover:text-sky-600">ç´ é£Ÿ</span></label>
            </div>
          </div>
        </div>
      </div>

      <!-- æ­¥é©Ÿ 2: é¸æ“‡æ—¥æœŸ -->
      <div class="ios-card p-6 sm:p-8 relative overflow-hidden">
        <div class="flex items-center justify-between mb-6">
            <h2 class="text-xl font-bold text-slate-800 flex items-center">
                <span class="bg-sky-100 text-sky-600 w-8 h-8 rounded-full flex items-center justify-center text-sm mr-3 font-bold">2</span>
                é¸æ“‡æ—¥æœŸ
            </h2>
            <div class="flex space-x-2 bg-slate-100 p-1 rounded-full">
                <button type="button" id="prevMonthBtn" onclick="changeMonth(-1)" class="w-9 h-9 flex items-center justify-center rounded-full hover:bg-white text-slate-500 disabled:opacity-30 transition-all shadow-sm"><i class="fa-solid fa-chevron-left text-xs"></i></button>
                <button type="button" id="nextMonthBtn" onclick="changeMonth(1)" class="w-9 h-9 flex items-center justify-center rounded-full hover:bg-white text-slate-500 transition-all shadow-sm"><i class="fa-solid fa-chevron-right text-xs"></i></button>
            </div>
        </div>

        <!-- æå‡åœ–ä¾‹å°æ¯”åº¦ -->
        <div class="flex flex-wrap items-center justify-center gap-4 mb-6 text-[11px] font-bold text-slate-500">
            <div class="flex items-center"><span class="w-4 h-4 rounded-md bg-sky-500 mr-2 shadow-sm"></span>å·²é¸</div>
            <div class="flex items-center"><span class="w-4 h-4 rounded-md bg-white border border-slate-300 mr-2 shadow-sm"></span>å¯é¸</div>
            <div class="flex items-center"><span class="w-4 h-4 rounded-md bg-red-100 border border-red-300 border-dashed mr-2 relative overflow-hidden"><span class="absolute inset-0 flex items-center justify-center text-red-500 text-[10px]">âœ•</span></span>åœé¤æ—¥</div>
            <div class="flex items-center"><span class="w-4 h-4 rounded-md bg-slate-200 border border-slate-300 mr-2"></span>ä¸å¯é¸</div>
        </div>
        
        <div class="bg-slate-100/50 rounded-3xl p-5 mb-6 border border-slate-200/60">
          <div id="calendar-wrapper" class="space-y-8 select-none min-h-[250px] calendar-anim-enter"></div>
        </div>

        <div class="bg-slate-800 rounded-3xl p-6 text-white shadow-2xl relative overflow-hidden">
          <div class="absolute top-0 right-0 w-32 h-32 bg-sky-500/10 rounded-full -mr-16 -mt-16"></div>
          <div class="grid grid-cols-3 gap-6 text-center divide-x divide-slate-700 relative z-10">
            <div><div class="text-[11px] text-slate-400 font-bold mb-2 uppercase tracking-widest">äººæ•¸</div><div id="displayStudentCount" class="text-2xl font-bold tracking-tight">1</div></div>
            <div><div class="text-[11px] text-slate-400 font-bold mb-2 uppercase tracking-widest">å¤©æ•¸</div><div id="displayTotalDays" class="text-2xl font-bold tracking-tight">0</div></div>
            <div><div class="text-[11px] text-slate-400 font-bold mb-2 uppercase tracking-widest">ç¸½é€€è²»</div><div class="text-2xl font-bold text-sky-400 tracking-tight">$<span id="totalAmount">0</span></div></div>
          </div>
          <div id="selected-dates-display" class="mt-6 pt-5 border-t border-slate-700/50 text-xs text-slate-300 min-h-[24px] flex flex-wrap gap-2.5">
            <span class="italic opacity-50 font-medium">è«‹åœ¨æ—¥æ›†ä¸Šé»é¸æ‚¨è¦åœé¤çš„æ—¥æœŸ...</span>
          </div>
          <input type="hidden" id="dateInput" name="dateInput" required>
        </div>
      </div>

      <!-- æ­¥é©Ÿ 3: ç¤¾åœ˜èª¿æŸ¥ -->
      <div class="ios-card p-6 sm:p-8">
        <h2 class="text-xl font-bold text-slate-800 mb-2 flex items-center">
            <span class="bg-sky-100 text-sky-600 w-8 h-8 rounded-full flex items-center justify-center text-sm mr-3 font-bold">3</span>
            ç¤¾åœ˜èª¿æŸ¥
        </h2>
        <p class="text-xs text-slate-400 mb-6 font-medium italic">åƒåŠ ç¤¾åœ˜è€…è«‹å‹™å¿…å‹¾é¸ï¼Œè‹¥ç„¡è«‹å‹¾é¸ã€Œå…¨éƒ¨æœªåƒåŠ ã€</p>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4" id="club-container"></div>
      </div>

      <div class="pb-10">
        <button type="submit" id="submitBtn" class="ios-btn-primary w-full py-5 text-xl shadow-2xl disabled:grayscale" disabled>æäº¤ç”³è«‹</button>
      </div>
    </form>
    
    <!-- Modals -->
    <div id="loadingOverlay" class="hidden fixed inset-0 bg-slate-900/40 backdrop-blur-md flex items-center justify-center z-50">
      <div class="bg-white p-8 rounded-3xl shadow-2xl text-center">
        <div class="animate-spin rounded-full h-12 w-12 border-4 border-sky-100 border-t-sky-500 mx-auto mb-6"></div>
        <p class="text-slate-700 font-bold">æ­£åœ¨ç‚ºæ‚¨è™•ç†ç”³è«‹ï¼Œè«‹ç¨å€™...</p>
      </div>
    </div>

    <div id="successModal" class="hidden fixed inset-0 bg-slate-900/60 backdrop-blur-lg flex items-center justify-center z-50 p-4">
      <div class="modal-content bg-white p-10 rounded-[2.5rem] shadow-2xl text-center max-w-sm w-full border border-emerald-100">
        <div class="w-20 h-20 bg-emerald-100 text-emerald-500 rounded-full flex items-center justify-center mx-auto mb-6 text-4xl shadow-inner"><i class="fa-solid fa-check"></i></div>
        <h3 class="text-2xl font-extrabold text-slate-800 mb-3 tracking-tight">ç”³è«‹æˆåŠŸï¼</h3>
        <p class="text-slate-500 mb-10 font-medium leading-relaxed">æ‚¨çš„åœé¤è³‡æ–™å·²æˆåŠŸé€å‡ºã€‚<br>åˆ¥å¿˜äº†ä¹Ÿè¦è·Ÿå°å¸«èªªä¸€è²å–”ï¼</p>
        <button onclick="location.reload()" class="ios-btn-primary w-full py-4 text-lg">å›åˆ°é¦–é </button>
      </div>
    </div>

    <div id="infoModal" class="hidden fixed inset-0 bg-slate-900/40 backdrop-blur-sm flex items-center justify-center z-50 p-4">
      <div class="modal-content bg-white p-8 rounded-3xl shadow-2xl text-center max-w-xs w-full">
        <div class="mb-4 text-amber-500 text-5xl"><i class="fa-solid fa-circle-exclamation"></i></div>
        <h3 class="text-lg font-bold text-slate-800 mb-3" id="infoModalTitle">å°æç¤º</h3>
        <p class="text-slate-600 mb-8 text-sm leading-relaxed font-medium" id="infoModalMessage"></p>
        <button onclick="closeInfoModal()" class="bg-slate-100 text-slate-700 font-bold py-3 px-6 rounded-2xl w-full hover:bg-slate-200 transition-colors">æˆ‘çŸ¥é“äº†</button>
      </div>
    </div>
  </div>

  <script>
    const GAS_API_URL = "https://script.google.com/macros/s/AKfycbyh7Bep2D8xivGee2-dGbGp8A1wXYPYR9kI0vuF3GOq4czWxjeGw2cTBaxAhGTp491vng/exec"; 

    const COST_PER_MEAL = 60;
    const MAKEUP_DAYS = ["2025/2/8"];
    const DEFAULT_HOLIDAYS = ["2025/1/1", "2025/1/27", "2025/1/28", "2025/1/29", "2025/1/30", "2025/1/31", "2025/2/28", "2025/4/3", "2025/4/4"];
    
    const CLUB_OPTIONS = ["å…¨éƒ¨æœªåƒåŠ ","1.2å¹´ç´šèª²å¾Œç­(ä¸€.å››.äº”)","3.4å¹´ç´šèª²å¾Œç­(äº”)","1.2å¹´ç´šç¾½çƒéšŠ(ä¸€. å››.äº”)","3.4å¹´ç´šç¾½çƒéšŠ(äº”)","é€±ä¸‰(ç¾½çƒéšŠ)","é€±ä¸‰ç±ƒçƒç­A","é€±ä¸‰ç±ƒçƒç­B","é€±ä¸‰ç±ƒçƒç­C","é€±ä¸‰æ‰è—ç­(æµè¡Œmvèˆè¹ˆç­)","é€±ä¸‰æ‰è—ç­(è‹±èªåˆéšè‡ªç„¶ç™¼éŸ³ç­P4-P6)ç­","é€±ä¸‰æ‰è—ç­(è‹±èªç¤¾åœ˜åŸºç¤å­—å½™ç­V1-V3)","é€±ä¸‰æ‰è—ç­(å¹¸ç¦æä¸€ä¸‹A)","é€±ä¸‰æ‰è—ç­(å‰µæ„DIY-ç¦®å“ï¼†é»å¿ƒå°é‹ª)","é€±ä¸‰æ‰è—ç­(å…’ç«¥å‰µæ„ç¾è¡“)","é€±ä¸‰æ‰è—ç­(æ•¸å­¸æ¡ŒéŠç¤¾å¯¶å¯å¤¢)","é€±ä¸‰æ‰è—ç­(æ€ä¸(STEAM)å‰µå®¢å¥½å°å­)","é€±ä¸‰æ‰è—ç­(å‹•æ¼«å¹³æ¿ç¹ªåœ–èˆ‡æ‰‹ä½œå‰µä½œç‡Ÿ)","é€±ä¸‰æ‰è—ç­(é»‘é·¹è¶³çƒç¤¾åœ˜èª²)","é€±äº”ç±ƒçƒç­A","å…¶ä»–"];

    let HOLIDAYS = [...DEFAULT_HOLIDAYS];
    let earliestValidDateObj = null;
    let selectedDatesSet = new Set();
    let currentCalendarBaseDate = new Date(); 

    document.addEventListener('DOMContentLoaded', () => {
      loadUserInfo();
      renderClubs();
      initReasonToggle();
      fetchSettings(); 
      setInterval(updateDashboard, 1000);
      updateMonthNavButtons();
    });

    function saveUserInfo(data) {
        if (data.applyType === 'individual') {
            localStorage.setItem('lunch_app_user', JSON.stringify({
                classSeat: data.classSeat,
                name: data.name,
                diet: data.diet
            }));
        }
    }

    function loadUserInfo() {
        const saved = localStorage.getItem('lunch_app_user');
        if (!saved) return;
        try {
            const info = JSON.parse(saved);
            if(info.classSeat) document.getElementById('classSeat').value = info.classSeat;
            if(info.name) document.getElementById('name').value = info.name;
            if(info.diet) {
                const radio = document.querySelector(`input[name="diet"][value="${info.diet}"]`);
                if(radio) radio.checked = true;
            }
            const hint = document.getElementById('autoFillHint');
            hint.classList.remove('hidden');
            setTimeout(() => hint.classList.add('hidden'), 5000);
        } catch(e) { localStorage.removeItem('lunch_app_user'); }
    }

    async function apiRequest(data) {
        const response = await fetch(GAS_API_URL, {
            method: "POST",
            body: JSON.stringify(data),
            headers: { "Content-Type": "text/plain;charset=utf-8" },
        });
        if (!response.ok) throw new Error("èˆ‡ä¼ºæœå™¨é€£ç·šå¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯ã€‚");
        return JSON.parse(await response.text());
    }

    function fetchSettings() {
        apiRequest({ action: 'getHolidays' })
        .then(data => {
            if (data.result === 'success' && Array.isArray(data.holidays)) {
                HOLIDAYS = data.holidays.length > 0 ? data.holidays : DEFAULT_HOLIDAYS;
            }
            updateDashboard();
            renderCalendar();
        })
        .catch(() => {
            updateDashboard();
            renderCalendar();
        });
    }

    function handleFormSubmit(e) {
      e.preventDefault();
      const form = document.getElementById('refundForm');
      const formData = new FormData(form);
      const data = {};
      const clubs = [];
      document.querySelectorAll('input[name="clubs"]:checked').forEach(cb => clubs.push(cb.value));
      formData.forEach((value, key) => { if (key !== 'clubs') data[key] = value; });
      if (data['reason'] === 'å…¶ä»–') {
          const otherText = document.getElementById('reasonOtherInput').value.trim();
          data['reason'] = otherText ? `å…¶ä»–ï¼š${otherText}` : "å…¶ä»–";
      }
      data['clubs'] = clubs.join(', ');
      if (data['applyType'] === 'individual') data['studentCount'] = 1;

      if (selectedDatesSet.size === 0) { showInfoModal("å“å‘€ï¼", "è«‹è‡³å°‘åœ¨æ—¥æ›†ä¸Šé¸æ“‡ä¸€å€‹è¦åœé¤çš„æ—¥æœŸå–”ï¼"); return; }
      if (parseInt(data['studentCount']) <= 0) { showInfoModal("äººæ•¸éŒ¯èª¤", "åœé¤äººæ•¸å¿…é ˆè‡³å°‘ 1 äººä»¥ä¸Šå–”ï¼"); return; }

      saveUserInfo(data);
      document.getElementById('loadingOverlay').classList.remove('hidden');
      apiRequest(data)
        .then(result => {
            document.getElementById('loadingOverlay').classList.add('hidden');
            if (result.result === "success") document.getElementById('successModal').classList.remove('hidden');
            else throw new Error(result.error || "æäº¤å¤±æ•—ï¼Œè«‹æ´½è©¢ç¸½å‹™è™•ã€‚");
        })
        .catch(err => {
            document.getElementById('loadingOverlay').classList.add('hidden');
            showInfoModal("é€£ç·šå¤±æ•—", err.message);
        });
    }

    function toggleStudentCount(isClass) {
      const container = document.getElementById('studentCountContainer');
      const input = document.getElementById('studentCount');
      if (isClass) { container.classList.remove('hidden'); input.focus(); } 
      else { container.classList.add('hidden'); input.value = "1"; }
      updateSummary();
    }

    function initReasonToggle() {
      const input = document.getElementById('reasonOtherInput');
      document.querySelectorAll('input[name="reason"]').forEach(r => {
          r.addEventListener('change', e => {
              if (e.target.value === 'å…¶ä»–') { input.classList.remove('hidden'); input.required = true; input.focus(); } 
              else { input.classList.add('hidden'); input.required = false; input.value = ''; }
          });
      });
    }

    function isWorkDay(date) {
      const dateStr = formatDateKey(date);
      if (HOLIDAYS.includes(dateStr)) return false;
      if (MAKEUP_DAYS.includes(dateStr)) return true;
      const day = date.getDay();
      return (day !== 0 && day !== 6);
    }

    function getEarliestDate() {
        const now = new Date();
        const hr = now.getHours();
        const isTodayWork = isWorkDay(now);
        let add = (!isTodayWork || hr >= 13) ? 3 : 2;
        let cur = new Date(now);
        let added = 0;
        while(added < add) {
            cur.setDate(cur.getDate() + 1);
            if (isWorkDay(cur)) added++;
        }
        cur.setHours(0,0,0,0);
        return cur;
    }

    function updateDashboard() {
      const now = new Date();
      earliestValidDateObj = getEarliestDate();
      let target = new Date(now);
      target.setHours(13,0,0,0);
      if (now.getHours() >= 13) target.setDate(target.getDate() + 1);
      
      const diff = target - now;
      const h = Math.floor(diff / 3600000);
      const m = Math.floor((diff % 3600000) / 60000);
      const s = Math.floor((diff % 60000) / 1000);

      const el = document.getElementById('rule-display');
      if (el) {
          el.innerHTML = `
            <div class="flex flex-col gap-3">
                <div class="flex items-center justify-between text-xs text-slate-500 font-bold">
                    <span>${formatDateFull(now)} ${now.toLocaleTimeString()}</span>
                </div>
                <div class="flex items-center text-sm bg-rose-50 p-3 rounded-2xl border border-rose-100 shadow-sm">
                    <i class="fa-solid fa-hourglass-start text-rose-500 mr-3 text-lg"></i>
                    <span class="text-slate-600 mr-2 font-bold">ä»Šæ—¥æ”¶å–®å€’æ•¸ï¼š</span>
                    <span class="text-rose-600 font-black font-mono text-xl">${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}</span>
                </div>
                <div class="text-sm font-black text-sky-700 flex items-center bg-white/80 p-3 rounded-2xl border border-sky-100 shadow-sm">
                    <i class="fa-solid fa-calendar-check mr-3 text-lg text-sky-400"></i>
                    <span class="text-xs text-slate-400 font-bold mr-2">æœ€æ—©é€€è²»æ—¥æœŸï¼š</span>
                    ${formatDateFull(earliestValidDateObj)}
                </div>
            </div>
          `;
      }
    }

    function renderCalendar() {
      const wrapper = document.getElementById('calendar-wrapper');
      wrapper.innerHTML = '';
      renderMonth(currentCalendarBaseDate.getFullYear(), currentCalendarBaseDate.getMonth());
      const next = new Date(currentCalendarBaseDate.getFullYear(), currentCalendarBaseDate.getMonth() + 1, 1);
      renderMonth(next.getFullYear(), next.getMonth());
      updateMonthNavButtons();
    }

    function renderMonth(year, month) {
      const wrapper = document.getElementById('calendar-wrapper');
      const container = document.createElement('div');
      const firstDay = new Date(year, month, 1);
      const daysInMonth = new Date(year, month + 1, 0).getDate();
      const startDayOfWeek = firstDay.getDay();
      const today = new Date();

      const title = document.createElement('div');
      title.className = "text-center font-black text-slate-700 mb-5 text-sm tracking-widest bg-white/50 py-1 rounded-full border border-white mx-auto w-48 shadow-sm";
      title.innerText = `æ°‘åœ‹ ${year - 1911} å¹´ ${month + 1} æœˆ`;
      container.appendChild(title);

      const grid = document.createElement('div');
      grid.className = "grid grid-cols-7 gap-1.5";

      ['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'].forEach(w => {
          const s = document.createElement('div');
          s.className = "text-[10px] text-center text-slate-400 pb-2 font-black";
          s.innerText = w;
          grid.appendChild(s);
      });

      for (let i = 0; i < startDayOfWeek; i++) grid.appendChild(document.createElement('div'));

      for (let d = 1; d <= daysInMonth; d++) {
          const dateObj = new Date(year, month, d);
          const dateStr = formatDateKey(dateObj);
          const btn = document.createElement('button');
          btn.type = "button";
          btn.innerText = d;
          btn.className = "calendar-day h-10 w-full flex items-center justify-center text-sm shadow-sm";
          
          const isToday = (dateObj.toDateString() === today.toDateString());
          const isHoliday = HOLIDAYS.includes(dateStr);
          const isMakeup = MAKEUP_DAYS.includes(dateStr);
          const isWeekend = (dateObj.getDay() === 0 || dateObj.getDay() === 6);

          if (isToday) btn.classList.add('today');
          if (isMakeup) btn.classList.add('makeup-day');

          let isDisabled = false;
          let reason = "";

          if (isHoliday) {
              isDisabled = true;
              reason = "é€™å¤©æ˜¯å­¸æ ¡é è¨­çš„åœé¤æ—¥ï¼ˆä¸ç”¨ä¾›é¤ï¼‰ã€‚";
              btn.classList.add('holiday-locked');
          } else if (dateObj < earliestValidDateObj) {
              isDisabled = true;
              reason = `å·²ç¶“è¶…é ${formatDateKey(dateObj)} çš„ç”³è«‹æˆªæ­¢æ™‚é–“å›‰ã€‚`;
              btn.classList.add('is-disabled');
          } else if (isWeekend && !isMakeup) {
              isDisabled = true;
              reason = "é€±æœ«ä¸ç”¨ä¸Šèª²ï¼Œæ‰€ä»¥æ²’æœ‰ä¾›é¤ã€‚";
              btn.classList.add('is-disabled');
          }

          if (isDisabled) {
              btn.onclick = () => showInfoModal(`é€™å¤©ä¸èƒ½é¸å–”`, reason);
              if (!btn.classList.contains('holiday-locked')) btn.classList.add('is-disabled');
          } else {
              btn.onclick = () => {
                  if (selectedDatesSet.has(dateStr)) {
                      selectedDatesSet.delete(dateStr);
                      btn.classList.remove('selected');
                  } else {
                      selectedDatesSet.add(dateStr);
                      btn.classList.add('selected');
                  }
                  updateSummary();
              };
              if (selectedDatesSet.has(dateStr)) btn.classList.add('selected');
          }
          grid.appendChild(btn);
      }
      container.appendChild(grid);
      wrapper.appendChild(container);
    }

    function changeMonth(delta) {
        currentCalendarBaseDate.setMonth(currentCalendarBaseDate.getMonth() + delta);
        renderCalendar();
    }

    function updateMonthNavButtons() {
        const today = new Date();
        const startOfThisMonth = new Date(today.getFullYear(), today.getMonth(), 1);
        const startOfDisplay = new Date(currentCalendarBaseDate.getFullYear(), currentCalendarBaseDate.getMonth(), 1);
        document.getElementById('prevMonthBtn').disabled = (startOfDisplay <= startOfThisMonth);
    }

    function updateSummary() {
      const countInput = document.getElementById('studentCount');
      let count = parseInt(countInput.value) || 0;
      if (count <= 0) countInput.classList.add('error'); else countInput.classList.remove('error');

      const sortedDates = Array.from(selectedDatesSet).sort((a,b) => new Date(a) - new Date(b));
      const display = document.getElementById('selected-dates-display');
      
      document.getElementById('displayStudentCount').innerText = count;
      document.getElementById('displayTotalDays').innerText = sortedDates.length;
      document.getElementById('totalAmount').innerText = (sortedDates.length * count * COST_PER_MEAL).toLocaleString();
      document.getElementById('dateInput').value = sortedDates.join(', ');

      if (sortedDates.length === 0) {
          display.innerHTML = '<span class="italic opacity-50 font-medium tracking-tight">è«‹åœ¨æ—¥æ›†ä¸Šé»é¸æ‚¨è¦åœé¤çš„æ—¥æœŸ...</span>';
          document.getElementById('submitBtn').disabled = true;
      } else {
          display.innerHTML = sortedDates.map(d => `<span class="bg-sky-500 text-white px-3 py-1 rounded-full shadow-md border border-sky-600 font-bold">${d.split('/')[1]}/${d.split('/')[2]}</span>`).join('');
          document.getElementById('submitBtn').disabled = (count <= 0);
      }
    }

    function renderClubs() {
      const container = document.getElementById('club-container');
      container.innerHTML = '';
      CLUB_OPTIONS.forEach((name, i) => {
          const html = `<label class="relative cursor-pointer group"><input type="checkbox" name="clubs" value="${name}" id="club_${i}" class="peer sr-only"><div class="flex items-center p-4 rounded-2xl border-2 border-slate-100 bg-white shadow-sm transition-all group-hover:border-sky-200 peer-checked:border-sky-500 peer-checked:bg-sky-50 peer-checked:shadow-inner"><div class="flex-1"><span class="text-sm font-bold text-slate-700 peer-checked:text-sky-700">${name}</span></div><div class="w-6 h-6 rounded-full border-2 border-slate-200 flex items-center justify-center peer-checked:bg-sky-500 peer-checked:border-sky-500 transition-all shadow-sm"><i class="fa-solid fa-check text-white text-xs hidden peer-checked:block"></i></div></div></label>`;
          container.insertAdjacentHTML('beforeend', html);
      });
      const noneCheckbox = document.getElementById('club_0');
      const others = Array.from(document.querySelectorAll('input[name="clubs"]:not(#club_0)'));
      noneCheckbox.addEventListener('change', e => {
          others.forEach(cb => {
              cb.checked = false;
              cb.disabled = e.target.checked;
              cb.parentElement.classList.toggle('opacity-30', e.target.checked);
              cb.parentElement.classList.toggle('grayscale', e.target.checked);
              cb.parentElement.classList.toggle('pointer-events-none', e.target.checked);
          });
      });
    }

    function formatDateKey(d) { return `${d.getFullYear()}/${d.getMonth()+1}/${d.getDate()}`; }
    function formatDateFull(d) { 
        return `${d.getFullYear()}/${String(d.getMonth()+1).padStart(2,'0')}/${String(d.getDate()).padStart(2,'0')} (${['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'][d.getDay()]})`; 
    }
    function showInfoModal(title, msg) {
        document.getElementById('infoModalTitle').innerText = title;
        document.getElementById('infoModalMessage').innerText = msg;
        document.getElementById('infoModal').classList.remove('hidden');
    }
    function closeInfoModal() { document.getElementById('infoModal').classList.add('hidden'); }
  </script>
</body>
</html>
