<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>é·ºæ±Ÿåœ‹å°åˆé¤åœé¤é€€è²»ç”³è«‹</title>
  
  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸ±</text></svg>">
  <meta property="og:title" content="é·ºæ±Ÿåœ‹å°åˆé¤åœé¤é€€è²»ç”³è«‹">
  <meta property="og:description" content="ç·šä¸Šè¾¦ç†åˆé¤é€€è²»ç”³è«‹ï¼Œè«‹ç•™æ„ç”³è«‹æˆªæ­¢æ™‚é–“ã€‚">
  <meta property="og:type" content="website">

  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&display=swap');
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans TC", sans-serif;
      background: linear-gradient(180deg, #E0F2FE 0%, #F0FDFA 50%, #DCFCE7 100%);
      background-attachment: fixed;
      color: #334155;
      -webkit-tap-highlight-color: transparent;
      min-height: 100vh;
    }

    body::before {
      content: "";
      position: fixed;
      top: 0; left: 0; width: 100%; height: 100%;
      opacity: 0.03;
      pointer-events: none;
      background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.65' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)'/%3E%3C/svg%3E");
      z-index: -1;
    }

    .ios-card { 
      background: rgba(255, 255, 255, 0.95); 
      border-radius: 1.5rem; 
      box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.05), 0 8px 10px -6px rgba(0, 0, 0, 0.05); 
      border: 1px solid rgba(203, 213, 225, 0.6);
      backdrop-filter: blur(8px);
    }

    .ios-input { 
      background: #F8FAFC; 
      border: 1px solid #E2E8F0; 
      border-radius: 12px; 
      transition: all 0.2s; 
      padding: 0.85rem; 
      width: 100%; 
      color: #1E293B;
      font-weight: 500;
    }
    .ios-input:focus { background: white; border-color: #0EA5E9; box-shadow: 0 0 0 3px rgba(14, 165, 233, 0.15); outline: none; }
    
    input[type="radio"], input[type="checkbox"] { 
        display: none !important;
    }

    .selected-amber-block {
        border-color: #F59E0B !important;
        background-color: #FFFBEB !important;
        box-shadow: 0 4px 12px -2px rgba(245, 158, 11, 0.15);
        transform: translateY(-1px);
    }
    .selected-amber-block span {
        color: #92400E !important;
    }

    .custom-indicator {
        width: 1.25rem;
        height: 1.25rem;
        border-radius: 50%;
        border: 2px solid #CBD5E1;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s;
        flex-shrink: 0;
        background: white;
    }
    .peer:checked ~ .custom-indicator {
        border-color: #F59E0B;
        background-color: #F59E0B;
    }
    .custom-indicator::after {
        content: '';
        width: 0.5rem;
        height: 0.5rem;
        background: white;
        border-radius: 50%;
        display: none;
    }
    .peer:checked ~ .custom-indicator::after {
        display: block;
    }

    .custom-check {
        width: 1.25rem;
        height: 1.25rem;
        border-radius: 6px;
        border: 2px solid #CBD5E1;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s;
        flex-shrink: 0;
        background: white;
    }
    .peer:checked ~ .custom-check {
        border-color: #F59E0B;
        background-color: #F59E0B;
    }

    .ios-btn-primary { 
      background: linear-gradient(135deg, #0EA5E9 0%, #0284C7 100%); 
      color: white; 
      border-radius: 16px; 
      font-weight: 700; 
      transition: all 0.3s; 
      box-shadow: 0 6px 20px -4px rgba(14, 165, 233, 0.4);
    }
    .ios-btn-primary:active { transform: scale(0.96); opacity: 0.9; }

    .calendar-day { 
      border-radius: 12px; 
      font-weight: 600; 
      position: relative; 
      transition: all 0.2s; 
      border: 1px solid #F1F5F9; 
      background-color: #FFFFFF; 
      color: #475569;
    }
    
    .calendar-day.selected { 
      background: linear-gradient(135deg, #0EA5E9 0%, #2563EB 100%) !important; 
      color: white !important; 
      transform: scale(1.08); 
      z-index: 10; 
      box-shadow: 0 8px 15px -3px rgba(37, 99, 235, 0.4); 
      border-color: transparent;
    }
    
    .calendar-day.today { 
      color: #0EA5E9; 
      background-color: #F0F9FF; 
      border: 2px solid #BAE6FD; 
    }
    
    .calendar-day.is-disabled { 
      color: #94A3B8 !important; 
      opacity: 0.6; 
      cursor: not-allowed !important; 
      background-color: #F1F5F9 !important; 
      border-color: #E2E8F0;
    }
    
    .calendar-day.holiday-locked { 
      color: #B91C1C !important; 
      background-color: #FEE2E2 !important; 
      text-decoration: line-through; 
      border: 1px dashed #FCA5A5; 
    }

    @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    .animate-slide-up { animation: slideUp 0.4s ease-out forwards; }
    .required::after { content: " *"; color: #EF4444; }
    
    .step-dot.active { background-color: #0EA5E9; box-shadow: 0 0 0 4px rgba(14, 165, 233, 0.2); }
    
    #sticky-summary {
        transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        transform: translateY(100px);
    }
    #sticky-summary.visible { transform: translateY(0); }
  </style>
</head>
<body class="antialiased pb-24">

  <div class="max-w-2xl mx-auto my-6 px-4 sm:px-6 pt-4">
    
    <!-- é€²åº¦æŒ‡ç¤º -->
    <div class="flex items-center justify-center mb-10 gap-2">
        <div class="step-dot active w-3 h-3 rounded-full transition-all"></div>
        <div class="w-10 h-1 bg-slate-200 rounded-full"></div>
        <div class="step-dot w-3 h-3 rounded-full bg-slate-200 transition-all" id="step2-dot"></div>
        <div class="w-10 h-1 bg-slate-200 rounded-full"></div>
        <div class="step-dot w-3 h-3 rounded-full bg-slate-200 transition-all" id="step3-dot"></div>
    </div>

    <!-- Header -->
    <div class="mb-8 text-center sm:text-left">
      <h1 class="text-3xl font-black text-slate-800 tracking-tight flex items-center justify-center sm:justify-start">
        <div class="w-12 h-12 bg-sky-500 rounded-2xl flex items-center justify-center text-white mr-4 shadow-lg bg-gradient-to-br from-sky-400 to-sky-600">
           <i class="fa-solid fa-utensils text-xl"></i>
        </div>
        é·ºæ±Ÿåœ‹å°åˆé¤é€€è²»ç”³è«‹
      </h1>
      <p class="text-slate-500 mt-2 ml-1 font-bold flex items-center justify-center sm:justify-start">
        <span class="bg-white/70 backdrop-blur px-4 py-1.5 rounded-full border border-slate-200 shadow-sm text-sm">
           æ¯é¤é€€è²»æ¨™æº– <span class="text-sky-600 font-black text-lg">$60</span> å…ƒ
        </span>
      </p>
    </div>

    <!-- è¦å‰‡èªªæ˜ -->
    <div class="ios-card p-6 mb-8 border-sky-100 animate-slide-up">
      <h3 class="font-bold text-sky-700 mb-4 flex items-center text-sm uppercase tracking-wider">
        <i class="fa-solid fa-paper-plane mr-2"></i> ç”³è«‹è¦å‰‡èˆ‡é ˆçŸ¥
      </h3>
      <div id="rule-display" class="mb-5 bg-sky-50/50 p-4 rounded-2xl border border-sky-100">
         <p class="text-xs text-slate-400 animate-pulse">ç³»çµ±æ­£åœ¨è¨ˆç®—æˆªæ­¢æ™‚é–“...</p>
      </div>
      <ul class="space-y-3 text-sm text-slate-600 font-medium">
        <li class="flex items-start"><span class="text-sky-400 mr-3 mt-1"><i class="fa-solid fa-clock-rotate-left"></i></span><span>è«‹æ–¼åœé¤æ—¥å¾€å‰<strong class="text-slate-900 mx-1">ç¬¬ 2 å€‹å·¥ä½œæ—¥ä¸‹åˆ 1:00 å‰</strong>æå‡ºã€‚</span></li>
        <li class="flex items-start"><span class="text-rose-400 mr-3 mt-1"><i class="fa-solid fa-circle-exclamation"></i></span><span>é€¾æ™‚ç”³è«‹å› é£Ÿæå·²è¨‚è³¼ï¼Œ<span class="text-rose-500 font-bold underline underline-offset-4 decoration-rose-300">ç„¡æ³•å—ç†é€€è²»</span>ã€‚</span></li>
        <li class="flex items-start"><span class="text-sky-400 mr-3 mt-1"><i class="fa-solid fa-phone"></i></span><span>æ´½è©¢é›»è©±ï¼š<a href="tel:0222819980" class="text-sky-600 font-bold hover:underline">02-22819980 åˆ†æ©Ÿ 9353</a></span></li>
      </ul>
    </div>

    <form id="refundForm" class="space-y-8" onsubmit="preSubmitCheck(event)">
      <!-- æ­¥é©Ÿ 1: åŸºæœ¬è³‡æ–™ -->
      <div class="ios-card p-6 sm:p-8 animate-slide-up" style="animation-delay: 0.1s">
        <h2 class="text-xl font-black text-slate-800 mb-6 flex items-center">
            <span class="bg-sky-500 text-white w-8 h-8 rounded-xl flex items-center justify-center text-sm mr-3 font-bold shadow-md shadow-sky-200">1</span>
            åŸºæœ¬è³‡æ–™
        </h2>
        
        <div id="autoFillHint" class="hidden mb-6 bg-emerald-50 text-emerald-700 text-xs px-4 py-3 rounded-xl border border-emerald-100 flex items-center shadow-sm">
            <i class="fa-solid fa-wand-magic-sparkles mr-2 text-emerald-500"></i> å·²è‡ªå‹•è¼‰å…¥æ‚¨ä¸Šæ¬¡å¡«å¯«çš„è³‡è¨Šã€‚
        </div>

        <div class="space-y-8">
          <div>
            <label class="block text-sm font-bold text-slate-700 mb-3 required">å¡«å ±èº«åˆ†</label>
            <div class="bg-slate-100 p-1.5 rounded-2xl flex max-w-xs border border-slate-200">
              <label class="flex-1 text-center cursor-pointer">
                  <input type="radio" name="identity" value="å­¸ç”Ÿ" class="peer" checked onchange="toggleIdentity('å­¸ç”Ÿ')">
                  <div class="py-2.5 rounded-xl text-sm font-bold text-slate-500 peer-checked:bg-amber-400 peer-checked:text-slate-900 peer-checked:shadow-inner transition-all">å­¸ç”Ÿ</div>
              </label>
              <label class="flex-1 text-center cursor-pointer">
                  <input type="radio" name="identity" value="æ•™è·å“¡" class="peer" onchange="toggleIdentity('æ•™è·å“¡')">
                  <div class="py-2.5 rounded-xl text-sm font-bold text-slate-500 peer-checked:bg-amber-400 peer-checked:text-slate-900 peer-checked:shadow-inner transition-all">æ•™è·å“¡</div>
              </label>
            </div>
          </div>

          <div>
            <label class="block text-sm font-bold text-slate-700 mb-4 required">åœé¤äº‹ç”±</label>
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
              <label class="relative flex items-center p-4 rounded-2xl border-2 border-slate-100 bg-white hover:bg-slate-50 cursor-pointer transition-all group">
                <input type="radio" name="reason" value="æ³•å®šè«‹å‡(è…¸ç—…æ¯’ã€æ°´ç—˜)" class="peer" required onchange="updateBlockStyles()">
                <div class="custom-indicator mr-4"></div>
                <div class="flex-1">
                    <span class="text-sm font-bold block text-slate-700">æ³•å®šè«‹å‡</span>
                    <span class="text-[10px] text-slate-500 block">è…¸ç—…æ¯’ã€æ°´ç—˜ç­‰</span>
                </div>
              </label>
              <label class="relative flex items-center p-4 rounded-2xl border-2 border-slate-100 bg-white hover:bg-slate-50 cursor-pointer transition-all group">
                <input type="radio" name="reason" value="ç—…å‡" class="peer" onchange="updateBlockStyles()">
                <div class="custom-indicator mr-4"></div>
                <span class="text-sm font-bold text-slate-700">ç—…å‡</span>
              </label>
              <label class="relative flex items-center p-4 rounded-2xl border-2 border-slate-100 bg-white hover:bg-slate-50 cursor-pointer transition-all group">
                <input type="radio" name="reason" value="äº‹å‡" class="peer" onchange="updateBlockStyles()">
                <div class="custom-indicator mr-4"></div>
                <span class="text-sm font-bold text-slate-700">äº‹å‡</span>
              </label>
              <label class="relative flex items-center p-4 rounded-2xl border-2 border-slate-100 bg-white hover:bg-slate-50 cursor-pointer transition-all group">
                <input type="radio" name="reason" value="å…¶ä»–" class="peer" onchange="updateBlockStyles()">
                <div class="custom-indicator mr-4"></div>
                <span class="text-sm font-bold text-slate-700">å…¶ä»– (å…¬å‡ç­‰)</span>
              </label>
            </div>
            <input type="text" id="reasonOtherInput" class="ios-input mt-4 hidden" placeholder="è«‹è¨»æ˜è©³ç´°åŸå› ...">
          </div>

          <div>
            <label class="block text-sm font-bold text-slate-700 mb-4 required">ç”³è«‹é¡åˆ¥</label>
            <div class="bg-slate-100/80 p-1.5 rounded-2xl flex border border-slate-200">
              <label class="flex-1 text-center cursor-pointer">
                  <input type="radio" name="applyType" value="individual" class="peer" checked onchange="toggleStudentCount(false)">
                  <div class="py-2.5 rounded-xl text-sm font-bold text-slate-500 peer-checked:bg-amber-400 peer-checked:text-slate-900 peer-checked:shadow-sm transition-all">å€‹äººç”³è«‹</div>
              </label>
              <label class="flex-1 text-center cursor-pointer">
                  <input type="radio" name="applyType" value="class" class="peer" onchange="toggleStudentCount(true)">
                  <div class="py-2.5 rounded-xl text-sm font-bold text-slate-500 peer-checked:bg-amber-400 peer-checked:text-slate-900 peer-checked:shadow-sm transition-all">å…¨ç­ / å¤šäºº</div>
              </label>
            </div>
            <div id="studentCountContainer" class="hidden mt-6">
              <div class="flex items-center bg-white p-4 rounded-2xl border-2 border-amber-200 shadow-sm">
                <label class="text-sm font-bold text-slate-600 mr-4">åœé¤ç¸½äººæ•¸ï¼š</label>
                <input type="number" id="studentCount" name="studentCount" value="1" min="1" class="ios-input w-28 text-center font-black text-xl border-amber-300" oninput="updateSummary()">
                <span class="ml-3 text-slate-500 font-bold">äºº</span>
              </div>
            </div>
          </div>

          <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
            <div id="identifiableField">
                <label class="block text-sm font-bold text-slate-700 mb-2 required" id="identLabel">ç­ç´šåº§è™Ÿ</label>
                <input type="text" id="classSeat" name="classSeat" placeholder="ä¾‹å¦‚ï¼š60123" class="ios-input" required maxlength="20">
            </div>
            <div><label class="block text-sm font-bold text-slate-700 mb-2 required">å§“å</label><input type="text" id="name" name="name" class="ios-input" required placeholder="å§“å"></div>
          </div>

          <div>
            <label class="block text-sm font-bold text-slate-700 mb-3 required">ç”¨é¤è‘·ç´ </label>
            <div class="flex space-x-12 mt-2">
              <label class="flex items-center cursor-pointer group">
                  <input type="radio" name="diet" value="è‘·" class="peer" required onchange="updateBlockStyles()">
                  <div class="custom-indicator mr-3"></div>
                  <span class="font-bold text-slate-700 group-hover:text-amber-600">è‘·é£Ÿ</span>
              </label>
              <label class="flex items-center cursor-pointer group">
                  <input type="radio" name="diet" value="ç´ " class="peer" onchange="updateBlockStyles()">
                  <div class="custom-indicator mr-3"></div>
                  <span class="font-bold text-slate-700 group-hover:text-amber-600">ç´ é£Ÿ</span>
              </label>
            </div>
          </div>
        </div>
      </div>

      <!-- æ­¥é©Ÿ 2: é¸æ“‡æ—¥æœŸ -->
      <div class="ios-card p-6 sm:p-8 relative overflow-hidden animate-slide-up" style="animation-delay: 0.2s">
        <div class="flex items-center justify-between mb-6">
            <h2 class="text-xl font-black text-slate-800 flex items-center">
                <span class="bg-sky-500 text-white w-8 h-8 rounded-xl flex items-center justify-center text-sm mr-3 font-bold shadow-md shadow-sky-200">2</span>
                é¸æ“‡æ—¥æœŸ
            </h2>
            <div class="flex space-x-2 bg-slate-100 p-1 rounded-full border border-slate-200">
                <button type="button" onclick="changeMonth(-1)" id="prevBtn" class="w-9 h-9 flex items-center justify-center rounded-full hover:bg-white text-slate-500 transition-all disabled:opacity-30"><i class="fa-solid fa-chevron-left text-xs"></i></button>
                <button type="button" onclick="changeMonth(1)" id="nextBtn" class="w-9 h-9 flex items-center justify-center rounded-full hover:bg-white text-slate-500 transition-all"><i class="fa-solid fa-chevron-right text-xs"></i></button>
            </div>
        </div>

        <div class="flex flex-wrap items-center justify-center gap-4 mb-6 text-[10px] sm:text-[11px] font-bold text-slate-500">
            <div class="flex items-center"><span class="w-4 h-4 rounded bg-sky-500 mr-2 shadow-sm"></span>å·²é¸</div>
            <div class="flex items-center"><span class="w-4 h-4 rounded bg-white border border-slate-300 mr-2 shadow-sm"></span>å¯é¸</div>
            <div class="flex items-center"><span class="w-4 h-4 rounded bg-red-100 border border-red-300 border-dashed mr-2 relative overflow-hidden"><span class="absolute inset-0 flex items-center justify-center text-red-500 text-[10px]">âœ•</span></span>åœé¤</div>
            <button type="button" onclick="clearSelectedDates()" class="ml-auto text-sky-600 font-bold hover:underline text-xs"><i class="fa-solid fa-trash-can mr-1"></i>æ¸…é™¤é¸å–</button>
        </div>
        
        <div class="bg-slate-100/50 rounded-3xl p-5 mb-6 border border-slate-200/60 shadow-inner">
          <div id="calendar-wrapper" class="space-y-8 select-none min-h-[250px]"></div>
        </div>

        <div class="bg-slate-800 rounded-3xl p-6 text-white shadow-2xl relative overflow-hidden">
          <div class="absolute top-0 right-0 w-32 h-32 bg-sky-500/10 rounded-full -mr-16 -mt-16"></div>
          <div class="grid grid-cols-3 gap-6 text-center divide-x divide-slate-700 relative z-10">
            <div><div class="text-[11px] text-slate-400 font-bold mb-2 uppercase tracking-widest">ç¸½äººæ•¸</div><div id="displayStudentCount" class="text-2xl font-black">1</div></div>
            <div><div class="text-[11px] text-slate-400 font-bold mb-2 uppercase tracking-widest">ç¸½å¤©æ•¸</div><div id="displayTotalDays" class="text-2xl font-black">0</div></div>
            <div><div class="text-[11px] text-slate-400 font-bold mb-2 uppercase tracking-widest">é è¨ˆé€€è²»</div><div class="text-2xl font-black text-sky-400">$<span id="totalAmount">0</span></div></div>
          </div>
          <div id="selected-dates-display" class="mt-6 pt-5 border-t border-slate-700/50 text-xs text-slate-300 min-h-[24px] flex flex-wrap gap-2.5">
            <span class="italic opacity-50 font-medium">å°šæœªé¸æ“‡ä»»ä½•æ—¥æœŸ...</span>
          </div>
          <input type="hidden" id="dateInput" name="dateInput" required>
        </div>
      </div>

      <!-- æ­¥é©Ÿ 3: ç¤¾åœ˜èª¿æŸ¥ -->
      <div class="ios-card p-6 sm:p-8 animate-slide-up" style="animation-delay: 0.3s">
        <h2 class="text-xl font-black text-slate-800 mb-2 flex items-center">
            <span class="bg-sky-500 text-white w-8 h-8 rounded-xl flex items-center justify-center text-sm mr-3 font-bold shadow-md shadow-sky-200">3</span>
            ç¤¾åœ˜èª¿æŸ¥
        </h2>
        <p class="text-xs text-slate-400 mb-6 font-bold italic tracking-wide">åƒåŠ ç¤¾åœ˜è€…è«‹å‹™å¿…å‹¾é¸ï¼Œæ–¹ä¾¿ç¸½å‹™è™•æ ¸å°åå–®</p>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4" id="club-container"></div>
      </div>

      <div class="pb-10 animate-slide-up" style="animation-delay: 0.4s">
        <button type="submit" id="submitBtn" class="ios-btn-primary w-full py-5 text-xl shadow-2xl disabled:grayscale" disabled>ç¢ºèªä¸¦æäº¤ç”³è«‹</button>
      </div>
    </form>
    
    <div id="sticky-summary" class="fixed bottom-6 left-4 right-4 bg-slate-900/95 backdrop-blur-md text-white p-4 rounded-2xl shadow-2xl z-40 sm:hidden flex items-center justify-between border border-slate-700">
        <div>
            <div class="text-[10px] text-slate-400 font-bold">å·²é¸å¤©æ•¸</div>
            <div class="text-xl font-black"><span id="sticky-days">0</span> å¤©</div>
        </div>
        <div class="text-right">
            <div class="text-[10px] text-slate-400 font-bold">é è¨ˆé€€è²»</div>
            <div class="text-2xl font-black text-amber-400">$<span id="sticky-amount">0</span></div>
        </div>
    </div>

    <!-- Modals -->
    <div id="loadingOverlay" class="hidden fixed inset-0 bg-slate-900/40 backdrop-blur-md flex items-center justify-center z-50">
      <div class="bg-white p-8 rounded-3xl shadow-2xl text-center">
        <div class="animate-spin rounded-full h-12 w-12 border-4 border-amber-100 border-t-amber-500 mx-auto mb-6"></div>
        <p class="text-slate-700 font-bold">æ­£åœ¨åŠ å¯†å‚³é€æ‚¨çš„è³‡æ–™...</p>
      </div>
    </div>

    <div id="confirmModal" class="hidden fixed inset-0 bg-slate-900/60 backdrop-blur-md flex items-center justify-center z-50 p-4">
        <div class="modal-content bg-white p-8 rounded-[2rem] shadow-2xl max-w-sm w-full border-2 border-amber-200">
            <h3 class="text-2xl font-black text-slate-800 mb-4 flex items-center"><i class="fa-solid fa-list-check text-amber-500 mr-3"></i>æœ€å¾Œæ ¸å°</h3>
            <div class="space-y-4 text-sm font-bold text-slate-600 bg-amber-50 p-6 rounded-2xl border border-amber-100 mb-8" id="preview-content"></div>
            <div class="flex gap-4">
                <button onclick="closeConfirmModal()" class="flex-1 py-4 bg-slate-200 text-slate-700 rounded-xl font-bold">ä¿®æ”¹è³‡æ–™</button>
                <button onclick="finalSubmit()" class="flex-1 py-4 bg-amber-500 text-white rounded-xl font-bold shadow-lg shadow-amber-200">ç¢ºå®šé€å‡º</button>
            </div>
        </div>
    </div>

    <div id="successModal" class="hidden fixed inset-0 bg-slate-900/60 backdrop-blur-lg flex items-center justify-center z-50 p-4">
      <div class="modal-content bg-white p-10 rounded-[2.5rem] shadow-2xl text-center max-w-sm w-full border border-emerald-100">
        <div class="w-20 h-20 bg-emerald-100 text-emerald-500 rounded-full flex items-center justify-center mx-auto mb-6 text-4xl shadow-inner"><i class="fa-solid fa-check"></i></div>
        <h3 class="text-2xl font-extrabold text-slate-800 mb-3 tracking-tight">ç”³è«‹æˆåŠŸï¼</h3>
        <p class="text-slate-500 mb-10 font-medium leading-relaxed">æ‚¨çš„é€€è²»ç”³è«‹å·²é€²å…¥ç³»çµ±ã€‚<br>åˆ¥å¿˜äº†ä¹Ÿè¦è½‰å‘Šç­ç´šè€å¸«å–”ï¼</p>
        <button onclick="location.reload()" class="ios-btn-primary w-full py-4 text-lg bg-emerald-500 shadow-emerald-200">å®Œæˆä¸¦é—œé–‰</button>
      </div>
    </div>

    <div id="infoModal" class="hidden fixed inset-0 bg-slate-900/40 backdrop-blur-sm flex items-center justify-center z-50 p-4">
      <div class="modal-content bg-white p-8 rounded-3xl shadow-2xl text-center max-w-xs w-full">
        <div class="mb-4 text-amber-500 text-5xl"><i class="fa-solid fa-circle-exclamation"></i></div>
        <h3 class="text-lg font-bold text-slate-800 mb-3" id="infoModalTitle">å°æé†’</h3>
        <p class="text-slate-600 mb-8 text-sm leading-relaxed font-medium" id="infoModalMessage"></p>
        <button onclick="closeInfoModal()" class="bg-slate-100 text-slate-700 font-bold py-3 px-6 rounded-2xl w-full">æˆ‘çŸ¥é“äº†</button>
      </div>
    </div>
  </div>

  <script>
    const GAS_API_URL = "https://script.google.com/macros/s/AKfycbyh7Bep2D8xivGee2-dGbGp8A1wXYPYR9kI0vuF3GOq4czWxjeGw2cTBaxAhGTp491vng/exec"; 
    const COST_PER_MEAL = 60;
    const MAKEUP_DAYS = ["2025/2/8"];
    const DEFAULT_HOLIDAYS = ["2025/1/1", "2025/1/27", "2025/1/28", "2025/1/29", "2025/1/30", "2025/1/31", "2025/2/28", "2025/4/3", "2025/4/4"];
    const CLUB_OPTIONS = ["å…¨éƒ¨æœªåƒåŠ ","1.2å¹´ç´šèª²å¾Œç­(ä¸€.å››.äº”)","3.4å¹´ç´šèª²å¾Œç­(äº”)","1.2å¹´ç´šç¾½çƒéšŠ(ä¸€. å››.äº”)","3.4å¹´ç´šç¾½çƒéšŠ(äº”)","é€±ä¸‰(ç¾½çƒéšŠ)","é€±ä¸‰ç±ƒçƒç­A","é€±ä¸‰ç±ƒçƒç­B","é€±ä¸‰ç±ƒçƒç­C","é€±ä¸‰æ‰è—ç­(æµè¡Œmvèˆè¹ˆç­)","é€±ä¸‰æ‰è—ç­(è‹±èªåˆéšè‡ªç„¶ç™¼éŸ³ç­P4-P6)ç­","é€±ä¸‰æ‰è—ç­(è‹±èªç¤¾åœ˜åŸºç¤å­—å½™ç­V1-V3)","é€±ä¸‰æ‰è—ç­(å¹¸ç¦æä¸€ä¸‹A)","é€±ä¸‰æ‰è—ç­(å‰µæ„DIY-ç¦®å“ï¼†é»å¿ƒå°é‹ª)","é€±ä¸‰æ‰è—ç­(å…’ç«¥å‰µæ„ç¾è¡“)","é€±ä¸‰æ‰è—ç­(æ•¸å­¸æ¡ŒéŠç¤¾å¯¶å¯å¤¢)","é€±ä¸‰æ‰è—ç­(æ€ä¸(STEAM)å‰µå®¢å¥½å°å­)","é€±ä¸‰æ‰è—ç­(å‹•æ¼«å¹³æ¿ç¹ªåœ–èˆ‡æ‰‹ä½œå‰µä½œç‡Ÿ)","é€±ä¸‰æ‰è—ç­(é»‘é·¹è¶³çƒç¤¾åœ˜èª²)","é€±äº”ç±ƒçƒç­A","å…¶ä»–"];

    let HOLIDAYS = [...DEFAULT_HOLIDAYS];
    let earliestValidDateObj = null;
    let selectedDatesSet = new Set();
    let currentCalendarBaseDate = new Date(); 
    let currentSubmitData = null;

    document.addEventListener('DOMContentLoaded', () => {
      loadUserInfo();
      renderClubs();
      initReasonToggle();
      fetchSettings(); 
      setInterval(updateDashboard, 1000);
      
      const classSeatInput = document.getElementById('classSeat');
      classSeatInput.addEventListener('input', (e) => {
          const identityInput = document.querySelector('input[name="identity"]:checked');
          const identity = identityInput ? identityInput.value : 'å­¸ç”Ÿ';
          if(identity === 'å­¸ç”Ÿ') {
            e.target.value = e.target.value.replace(/[^0-9]/g, '');
          }
          checkFormProgress();
      });
      document.getElementById('name').addEventListener('input', checkFormProgress);
      updateBlockStyles();
    });

    function updateBlockStyles() {
        document.querySelectorAll('input[type="radio"], input[type="checkbox"]').forEach(input => {
            const container = input.closest('.group, .club-container-box, label');
            if (!container) return;
            if (input.checked) {
                container.classList.add('selected-amber-block');
            } else {
                container.classList.remove('selected-amber-block');
            }
        });
    }

    function toggleIdentity(identity) {
        const label = document.getElementById('identLabel');
        const input = document.getElementById('classSeat');
        if (identity === 'æ•™è·å“¡') {
            label.innerText = "å–®ä½ / è·ç¨±";
            input.placeholder = "ä¾‹å¦‚ï¼šç¸½å‹™è™•ã€å…­å¹´ç´šæ•™å¸«";
            input.inputMode = "text";
            input.maxLength = 20;
        } else {
            label.innerText = "ç­ç´šåº§è™Ÿ";
            input.placeholder = "ä¾‹å¦‚ï¼š60123";
            input.inputMode = "numeric";
            input.maxLength = 6;
            input.value = input.value.replace(/[^0-9]/g, '');
        }
        checkFormProgress();
    }

    function checkFormProgress() {
        const hasName = document.getElementById('name').value.trim() !== "";
        const hasIdent = document.getElementById('classSeat').value.trim() !== "";
        document.getElementById('step2-dot').classList.toggle('active', hasName && hasIdent);
    }

    function saveUserInfo(data) {
        if (data.applyType === 'individual') {
            localStorage.setItem('lunch_app_user', JSON.stringify({
                identity: data.identity,
                classSeat: data.classSeat,
                name: data.name,
                diet: data.diet
            }));
        }
    }

    function loadUserInfo() {
        const saved = localStorage.getItem('lunch_app_user');
        if (!saved) return;
        try {
            const info = JSON.parse(saved);
            if(info.identity) {
                const radio = document.querySelector(`input[name="identity"][value="${info.identity}"]`);
                if(radio) { radio.checked = true; toggleIdentity(info.identity); }
            }
            if(info.classSeat) document.getElementById('classSeat').value = info.classSeat;
            if(info.name) document.getElementById('name').value = info.name;
            if(info.diet) {
                const radio = document.querySelector(`input[name="diet"][value="${info.diet}"]`);
                if(radio) radio.checked = true;
            }
            const hint = document.getElementById('autoFillHint');
            hint.classList.remove('hidden');
            setTimeout(() => hint.classList.add('hidden'), 6000);
            checkFormProgress();
        } catch(e) { localStorage.removeItem('lunch_app_user'); }
    }

    function preSubmitCheck(e) {
        e.preventDefault();
        const form = document.getElementById('refundForm');
        const formData = new FormData(form);
        const data = {};
        const clubs = [];
        
        document.querySelectorAll('input[name="clubs"]:checked').forEach(cb => clubs.push(cb.value));
        
        formData.forEach((value, key) => { 
            if (key !== 'clubs') data[key] = value; 
        });
        
        let finalCount = 1;
        if (data['applyType'] === 'class') {
            finalCount = parseInt(data['studentCount']) || 1;
        }
        data['studentCount'] = finalCount;

        if (data['reason'] === 'å…¶ä»–') {
            const otherText = document.getElementById('reasonOtherInput').value.trim();
            data['reason'] = otherText ? `å…¶ä»–ï¼š${otherText}` : "å…¶ä»–";
        }
        data['clubs'] = clubs.join(', ');

        if (selectedDatesSet.size === 0) { 
            showInfoModal("å¿˜è¨˜é¸æ—¥æœŸäº†ï¼", "è«‹å…ˆåœ¨æ—¥æ›†ä¸Šé»é¸è¦åœé¤çš„æ—¥æœŸå–”ã€‚"); 
            return; 
        }
        
        currentSubmitData = data;
        const sortedDates = Array.from(selectedDatesSet).sort((a,b) => new Date(a) - new Date(b));
        const totalAmountValue = sortedDates.length * finalCount * COST_PER_MEAL;
        const identTitle = data.identity === 'æ•™è·å“¡' ? "å–®ä½è·ç¨±" : "ç­ç´šåº§è™Ÿ";

        document.getElementById('preview-content').innerHTML = `
            <div class="flex justify-between border-b border-amber-200 pb-2 mb-2"><span>ç”³è«‹èº«åˆ†ï¼š</span><span class="text-amber-700 font-black">${data.identity}</span></div>
            <div class="flex justify-between border-b border-amber-200 pb-2 mb-2"><span>${identTitle}ï¼š</span><span class="text-amber-700 font-black">${data.classSeat}</span></div>
            <div class="flex justify-between border-b border-amber-200 pb-2 mb-2"><span>å§“åï¼š</span><span class="text-amber-700 font-black">${data.name}</span></div>
            <div class="flex justify-between border-b border-amber-200 pb-2 mb-2"><span>åœé¤äººæ•¸ï¼š</span><span class="text-amber-700 font-black">${finalCount} äºº</span></div>
            <div class="flex justify-between border-b border-amber-200 pb-2 mb-2"><span>åœé¤å¤©æ•¸ï¼š</span><span class="text-amber-700 font-black">${sortedDates.length} å¤©</span></div>
            <div class="flex justify-between pt-2"><span>é è¨ˆé€€è²»ï¼š</span><span class="text-rose-600 font-black text-xl">$${totalAmountValue.toLocaleString()}</span></div>
        `;
        document.getElementById('confirmModal').classList.remove('hidden');
    }

    function closeConfirmModal() { document.getElementById('confirmModal').classList.add('hidden'); }

    function finalSubmit() {
        if (!currentSubmitData) return;
        closeConfirmModal();
        document.getElementById('loadingOverlay').classList.remove('hidden');
        saveUserInfo(currentSubmitData);
        
        // æ ¸å¿ƒä¿®æ­£ï¼šå°‡è¨ˆç®—å¾Œçš„é‡‘é¡èˆ‡è©³ç´°è³‡è¨ŠåŠ å…¥è³‡æ–™åŒ…
        const sortedDates = Array.from(selectedDatesSet).sort((a,b) => new Date(a) - new Date(b));
        const studentCount = parseInt(currentSubmitData.studentCount) || 1;
        
        currentSubmitData.dateInput = sortedDates.join(', ');
        currentSubmitData.totalDays = sortedDates.length;
        currentSubmitData.totalAmount = sortedDates.length * studentCount * COST_PER_MEAL;

        fetch(GAS_API_URL, {
            method: "POST",
            body: JSON.stringify(currentSubmitData),
            headers: { "Content-Type": "text/plain;charset=utf-8" },
        })
        .then(res => res.json())
        .then(result => {
            document.getElementById('loadingOverlay').classList.add('hidden');
            if (result.result === "success") document.getElementById('successModal').classList.remove('hidden');
            else throw new Error(result.error || "æäº¤å¤±æ•—");
        })
        .catch(err => {
            document.getElementById('loadingOverlay').classList.add('hidden');
            showInfoModal("ç³»çµ±é€£ç·šç•°å¸¸", err.message);
        });
    }

    async function apiRequest(data) {
        const response = await fetch(GAS_API_URL, {
            method: "POST",
            body: JSON.stringify(data),
            headers: { "Content-Type": "text/plain;charset=utf-8" },
        });
        return JSON.parse(await response.text());
    }

    function fetchSettings() {
        apiRequest({ action: 'getHolidays' })
        .then(data => {
            if (data.result === 'success' && Array.isArray(data.holidays)) {
                HOLIDAYS = data.holidays.length > 0 ? data.holidays : DEFAULT_HOLIDAYS;
            }
            updateDashboard();
            renderCalendar();
        })
        .catch(() => {
            updateDashboard();
            renderCalendar();
        });
    }

    function toggleStudentCount(isClass) {
      const container = document.getElementById('studentCountContainer');
      const input = document.getElementById('studentCount');
      if (isClass) { 
          container.classList.remove('hidden'); 
          input.focus(); 
      } else { 
          container.classList.add('hidden'); 
          input.value = "1"; 
      }
      updateSummary();
    }

    function initReasonToggle() {
      const input = document.getElementById('reasonOtherInput');
      document.querySelectorAll('input[name="reason"]').forEach(r => {
          r.addEventListener('change', e => {
              if (e.target.value === 'å…¶ä»–') { input.classList.remove('hidden'); input.required = true; input.focus(); } 
              else { input.classList.add('hidden'); input.required = false; input.value = ''; }
              updateBlockStyles();
          });
      });
    }

    function isWorkDay(date) {
      const dateStr = formatDateKey(date);
      if (HOLIDAYS.includes(dateStr)) return false;
      if (MAKEUP_DAYS.includes(dateStr)) return true;
      const day = date.getDay();
      return (day !== 0 && day !== 6);
    }

    function getEarliestDate() {
        const now = new Date();
        const hr = now.getHours();
        const isTodayWork = isWorkDay(now);
        let add = (!isTodayWork || hr >= 13) ? 3 : 2;
        let cur = new Date(now);
        let added = 0;
        while(added < add) {
            cur.setDate(cur.getDate() + 1);
            if (isWorkDay(cur)) added++;
        }
        cur.setHours(0,0,0,0);
        return cur;
    }

    function updateDashboard() {
      const now = new Date();
      earliestValidDateObj = getEarliestDate();
      let target = new Date(now);
      target.setHours(13,0,0,0);
      if (now.getHours() >= 13) target.setDate(target.getDate() + 1);
      const diff = target - now;
      const h = Math.floor(diff / 3600000);
      const m = Math.floor((diff % 3600000) / 60000);
      const s = Math.floor((diff % 60000) / 1000);
      const el = document.getElementById('rule-display');
      if (el) {
          el.innerHTML = `
            <div class="flex flex-col gap-3">
                <div class="flex items-center justify-between text-xs text-slate-500 font-bold">
                    <span>${formatDateFull(now)} ${now.toLocaleTimeString()}</span>
                </div>
                <div class="flex items-center text-sm bg-rose-50 p-3 rounded-2xl border border-rose-100 shadow-sm">
                    <i class="fa-solid fa-hourglass-start text-rose-500 mr-3 text-lg"></i>
                    <span class="text-slate-600 mr-2 font-bold">æ”¶å–®å€’æ•¸ï¼š</span>
                    <span class="text-rose-600 font-black font-mono text-xl">${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}</span>
                </div>
                <div class="text-sm font-black text-sky-700 flex items-center bg-white/80 p-3 rounded-2xl border border-sky-100 shadow-sm">
                    <i class="fa-solid fa-calendar-check mr-3 text-lg text-sky-400"></i>
                    <span class="text-xs text-slate-400 font-bold mr-2">æœ€æ—©é€€è²»æ—¥æœŸï¼š</span>
                    ${formatDateFull(earliestValidDateObj)}
                </div>
            </div>
          `;
      }
    }

    function clearSelectedDates() {
        selectedDatesSet.clear();
        renderCalendar();
        updateSummary();
    }

    function renderCalendar() {
      const wrapper = document.getElementById('calendar-wrapper');
      wrapper.innerHTML = '';
      renderMonth(currentCalendarBaseDate.getFullYear(), currentCalendarBaseDate.getMonth());
      const next = new Date(currentCalendarBaseDate.getFullYear(), currentCalendarBaseDate.getMonth() + 1, 1);
      renderMonth(next.getFullYear(), next.getMonth());
      document.getElementById('prevBtn').disabled = (currentCalendarBaseDate.getMonth() === new Date().getMonth() && currentCalendarBaseDate.getFullYear() === new Date().getFullYear());
    }

    function renderMonth(year, month) {
      const wrapper = document.getElementById('calendar-wrapper');
      const container = document.createElement('div');
      const firstDay = new Date(year, month, 1);
      const daysInMonth = new Date(year, month + 1, 0).getDate();
      const startDayOfWeek = firstDay.getDay();
      const today = new Date();
      const title = document.createElement('div');
      title.className = "text-center font-black text-slate-700 mb-5 text-sm tracking-widest bg-white/50 py-1.5 rounded-full border border-white mx-auto w-48 shadow-sm";
      title.innerText = `æ°‘åœ‹ ${year - 1911} å¹´ ${month + 1} æœˆ`;
      container.appendChild(title);
      const grid = document.createElement('div');
      grid.className = "grid grid-cols-7 gap-1.5";
      ['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'].forEach(w => {
          const s = document.createElement('div');
          s.className = "text-[10px] text-center text-slate-400 pb-2 font-black";
          s.innerText = w;
          grid.appendChild(s);
      });
      for (let i = 0; i < startDayOfWeek; i++) grid.appendChild(document.createElement('div'));
      for (let d = 1; d <= daysInMonth; d++) {
          const dateObj = new Date(year, month, d);
          const dateStr = formatDateKey(dateObj);
          const btn = document.createElement('button');
          btn.type = "button";
          btn.innerText = d;
          btn.className = "calendar-day h-10 w-full flex items-center justify-center text-sm shadow-sm";
          const isHoliday = HOLIDAYS.includes(dateStr);
          const isMakeup = MAKEUP_DAYS.includes(dateStr);
          const isWeekend = (dateObj.getDay() === 0 || dateObj.getDay() === 6);
          if (dateObj.toDateString() === today.toDateString()) btn.classList.add('today');
          let isDisabled = false;
          let reason = "";
          if (isHoliday) { isDisabled = true; reason = "å­¸æ ¡åœé¤æ—¥ã€‚"; btn.classList.add('holiday-locked'); } 
          else if (dateObj < earliestValidDateObj) { isDisabled = true; reason = `å·²éæˆªæ­¢æ™‚é–“ã€‚`; btn.classList.add('is-disabled'); } 
          else if (isWeekend && !isMakeup) { isDisabled = true; reason = "é€±æœ«ä¸ä¾›é¤ã€‚"; btn.classList.add('is-disabled'); }
          
          if (isDisabled) {
              btn.onclick = () => showInfoModal(`ç„¡æ³•é¸å–`, reason);
          } else {
              btn.onclick = () => {
                  if (selectedDatesSet.has(dateStr)) selectedDatesSet.delete(dateStr);
                  else selectedDatesSet.add(dateStr);
                  updateSummary();
                  renderCalendar();
              };
              if (selectedDatesSet.has(dateStr)) btn.classList.add('selected');
          }
          grid.appendChild(btn);
      }
      container.appendChild(grid);
      wrapper.appendChild(container);
    }

    function changeMonth(delta) {
        currentCalendarBaseDate.setMonth(currentCalendarBaseDate.getMonth() + delta);
        renderCalendar();
    }

    function updateSummary() {
      const countInput = document.getElementById('studentCount');
      let count = parseInt(countInput.value) || 0;
      if (count <= 0) countInput.classList.add('error'); else countInput.classList.remove('error');
      
      const sortedDates = Array.from(selectedDatesSet).sort((a,b) => new Date(a) - new Date(b));
      const display = document.getElementById('selected-dates-display');
      const totalAmt = sortedDates.length * count * COST_PER_MEAL;
      
      document.getElementById('displayStudentCount').innerText = count;
      document.getElementById('displayTotalDays').innerText = sortedDates.length;
      document.getElementById('totalAmount').innerText = totalAmt.toLocaleString();
      document.getElementById('dateInput').value = sortedDates.join(', ');
      
      document.getElementById('sticky-days').innerText = sortedDates.length;
      document.getElementById('sticky-amount').innerText = totalAmt.toLocaleString();
      
      const sticky = document.getElementById('sticky-summary');
      if (sortedDates.length > 0) sticky.classList.add('visible');
      else sticky.classList.remove('visible');
      
      document.getElementById('step3-dot').classList.toggle('active', sortedDates.length > 0);
      
      if (sortedDates.length === 0) {
          display.innerHTML = '<span class="italic opacity-50 font-medium">å°šæœªé¸æ“‡æ—¥æœŸ...</span>';
          document.getElementById('submitBtn').disabled = true;
      } else {
          display.innerHTML = sortedDates.map(d => `<span class="bg-sky-500 text-white px-3 py-1 rounded-full shadow-md border border-sky-600 font-bold text-[10px] animate-slide-up">${d.split('/')[1]}/${d.split('/')[2]}</span>`).join('');
          document.getElementById('submitBtn').disabled = (count <= 0);
      }
      updateBlockStyles();
    }

    function renderClubs() {
      const container = document.getElementById('club-container');
      container.innerHTML = '';
      CLUB_OPTIONS.forEach((name, i) => {
          const html = `
          <label class="relative cursor-pointer group club-container-box border-2 border-slate-100 bg-white rounded-2xl p-4 transition-all shadow-sm flex items-center">
            <input type="checkbox" name="clubs" value="${name}" id="club_${i}" class="peer" onchange="updateBlockStyles()">
            <div class="custom-check mr-4">
                <i class="fa-solid fa-check text-white text-[10px] hidden peer-checked:block"></i>
            </div>
            <div class="flex-1">
                <span class="text-sm font-bold text-slate-700">${name}</span>
            </div>
          </label>`;
          container.insertAdjacentHTML('beforeend', html);
      });
      const noneCheckbox = document.getElementById('club_0');
      noneCheckbox.addEventListener('change', e => {
          document.querySelectorAll('input[name="clubs"]:not(#club_0)').forEach(cb => {
              cb.checked = false;
              cb.disabled = e.target.checked;
              cb.parentElement.classList.toggle('opacity-30', e.target.checked);
              cb.parentElement.classList.toggle('grayscale', e.target.checked);
              cb.parentElement.classList.toggle('pointer-events-none', e.target.checked);
          });
          updateBlockStyles();
      });
    }

    function formatDateKey(d) { return `${d.getFullYear()}/${d.getMonth()+1}/${d.getDate()}`; }
    function formatDateFull(d) { return `${d.getFullYear()}/${String(d.getMonth()+1).padStart(2,'0')}/${String(d.getDate()).padStart(2,'0')} (${['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'][d.getDay()]})`; }
    function showInfoModal(title, msg) { document.getElementById('infoModalTitle').innerText = title; document.getElementById('infoModalMessage').innerText = msg; document.getElementById('infoModal').classList.remove('hidden'); }
    function closeInfoModal() { document.getElementById('infoModal').classList.add('hidden'); }
  </script>
</body>
</html>
