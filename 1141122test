import React, { useState, useEffect } from 'react';
import { initializeApp } from 'firebase/app';
import {
  getAuth,
  signInAnonymously,
  onAuthStateChanged,
  signInWithCustomToken,
} from 'firebase/auth';
import {
  getFirestore,
  collection,
  addDoc,
  query,
  where,
  getDocs,
  updateDoc,
  doc,
  orderBy,
  onSnapshot,
} from 'firebase/firestore';
import {
  Utensils,
  Disc,
  Split,
  User,
  LogOut,
  CheckCircle,
  Clock,
  ArrowLeft,
  LayoutList,
} from 'lucide-react';

// --- Firebase åˆå§‹åŒ– ---
const firebaseConfig = {
  apiKey: 'AIzaSyDKXhvIBrQpJ2zfXFB544aFDiVmTWW1zaE',
  authDomain: 'schooltablewaresystem.firebaseapp.com',
  projectId: 'schooltablewaresystem',
  storageBucket: 'schooltablewaresystem.firebasestorage.app',
  messagingSenderId: '652083653766',
  appId: '1:652083653766:web:1efbf2e614a4b935e1b507',
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

// --- å…ƒä»¶ï¼šæ•¸å­—éµç›¤ (é©åˆä½å¹´ç´šå­¸ç”Ÿè¼¸å…¥å­¸è™Ÿ) ---
const NumberPad = ({ value, onChange, onEnter }) => {
  const handleNumClick = (num) => {
    if (value.length < 6) {
      // å‡è¨­å­¸è™Ÿä¸è¶…é6ä½
      onChange(value + num);
    }
  };

  const handleBackspace = () => {
    onChange(value.slice(0, -1));
  };

  return (
    <div className="grid grid-cols-3 gap-3 max-w-xs mx-auto mt-4">
      {[1, 2, 3, 4, 5, 6, 7, 8, 9].map((num) => (
        <button
          key={num}
          onClick={() => handleNumClick(num.toString())}
          className="bg-white hover:bg-blue-50 text-blue-600 font-bold text-2xl py-4 rounded-xl shadow-sm border-b-4 border-blue-200 active:border-b-0 active:translate-y-1 transition-all"
        >
          {num}
        </button>
      ))}
      <button
        onClick={() => onChange('')}
        className="bg-red-100 hover:bg-red-200 text-red-600 font-bold text-lg py-4 rounded-xl shadow-sm border-b-4 border-red-200 active:border-b-0 active:translate-y-1 transition-all"
      >
        æ¸…é™¤
      </button>
      <button
        onClick={() => handleNumClick('0')}
        className="bg-white hover:bg-blue-50 text-blue-600 font-bold text-2xl py-4 rounded-xl shadow-sm border-b-4 border-blue-200 active:border-b-0 active:translate-y-1 transition-all"
      >
        0
      </button>
      <button
        onClick={handleBackspace}
        className="bg-gray-100 hover:bg-gray-200 text-gray-600 font-bold text-lg py-4 rounded-xl shadow-sm border-b-4 border-gray-300 active:border-b-0 active:translate-y-1 transition-all"
      >
        âŒ«
      </button>
    </div>
  );
};

// --- ä¸»æ‡‰ç”¨ç¨‹å¼ ---
export default function TablewareSystem() {
  const [user, setUser] = useState(null);
  const [view, setView] = useState('home'); // home, borrow, return, admin, success
  const [studentId, setStudentId] = useState('');
  const [selectedItems, setSelectedItems] = useState({
    bowl: false,
    spoon: false,
    chopsticks: false,
  });
  const [loading, setLoading] = useState(false);
  const [activeBorrows, setActiveBorrows] = useState([]); // è©²å­¸ç”Ÿç›®å‰å€Ÿç”¨çš„é …ç›®
  const [allActiveBorrows, setAllActiveBorrows] = useState([]); // ç®¡ç†å“¡ç”¨ï¼šæ‰€æœ‰æœªæ­¸é‚„
  const [successMessage, setSuccessMessage] = useState('');

  // --- èªè­‰ ---
  useEffect(() => {
    const initAuth = async () => {
      if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
        await signInWithCustomToken(auth, __initial_auth_token);
      } else {
        await signInAnonymously(auth);
      }
    };
    initAuth();
    const unsubscribe = onAuthStateChanged(auth, setUser);
    return () => unsubscribe();
  }, []);

  // --- ç›£è½ç®¡ç†å“¡æ•¸æ“š (æ‰€æœ‰æœªæ­¸é‚„) ---
  useEffect(() => {
    if (!user || view !== 'admin') return;

    const q = query(
      collection(db, 'artifacts', appId, 'public', 'data', 'tableware_records'),
      where('status', '==', 'borrowed') // åªæŠ“æœªæ­¸é‚„çš„
    );

    const unsubscribe = onSnapshot(
      q,
      (snapshot) => {
        const records = snapshot.docs.map((doc) => ({
          id: doc.id,
          ...doc.data(),
        }));
        // å‰ç«¯æ’åº
        records.sort((a, b) => new Date(b.borrowTime) - new Date(a.borrowTime));
        setAllActiveBorrows(records);
      },
      (error) => {
        console.error('Error fetching admin data:', error);
      }
    );

    return () => unsubscribe();
  }, [user, view]);

  // --- å‹•ä½œé‚è¼¯ ---

  const handleBorrow = async () => {
    if (!studentId) {
      alert('è«‹è¼¸å…¥å­¸è™Ÿ/ç­ç´šåº§è™Ÿ');
      return;
    }
    const items = [];
    if (selectedItems.bowl) items.push('ç¢—');
    if (selectedItems.spoon) items.push('æ¹¯åŒ™');
    if (selectedItems.chopsticks) items.push('ç­·å­');

    if (items.length === 0) {
      alert('è«‹è‡³å°‘é¸æ“‡ä¸€æ¨£é¤å…·ï¼');
      return;
    }

    setLoading(true);
    try {
      await addDoc(
        collection(
          db,
          'artifacts',
          appId,
          'public',
          'data',
          'tableware_records'
        ),
        {
          studentId,
          items,
          borrowTime: new Date().toISOString(),
          returnTime: null,
          status: 'borrowed',
        }
      );
      setSuccessMessage(`å¥½æ£’ï¼${studentId} è™ŸåŒå­¸ï¼Œå€Ÿç”¨æˆåŠŸï¼`);
      setView('success');
      setTimeout(resetForm, 3000);
    } catch (e) {
      console.error(e);
      alert('å€Ÿç”¨å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
    } finally {
      setLoading(false);
    }
  };

  const checkBorrowsForReturn = async () => {
    if (!studentId) return;
    setLoading(true);
    try {
      const q = query(
        collection(
          db,
          'artifacts',
          appId,
          'public',
          'data',
          'tableware_records'
        ),
        where('studentId', '==', studentId),
        where('status', '==', 'borrowed')
      );
      const snapshot = await getDocs(q);
      const borrows = snapshot.docs.map((doc) => ({
        id: doc.id,
        ...doc.data(),
      }));

      setActiveBorrows(borrows);
      setView('return_list');
    } catch (e) {
      console.error(e);
      alert('æŸ¥è©¢å¤±æ•—');
    } finally {
      setLoading(false);
    }
  };

  const handleReturn = async (recordId) => {
    setLoading(true);
    try {
      await updateDoc(
        doc(
          db,
          'artifacts',
          appId,
          'public',
          'data',
          'tableware_records',
          recordId
        ),
        {
          returnTime: new Date().toISOString(),
          status: 'returned',
        }
      );

      // æ›´æ–°æœ¬åœ°åˆ—è¡¨ï¼Œå¦‚æœæ˜¯æœ€å¾Œä¸€å€‹ï¼Œè·³è½‰æˆåŠŸ
      const remaining = activeBorrows.filter((item) => item.id !== recordId);
      setActiveBorrows(remaining);

      if (remaining.length === 0) {
        setSuccessMessage(`${studentId} è™ŸåŒå­¸ï¼Œè¬è¬ä½ æ­¸é‚„é¤å…·ï¼`);
        setView('success');
        setTimeout(resetForm, 3000);
      }
    } catch (e) {
      console.error(e);
      alert('æ­¸é‚„å¤±æ•—');
    } finally {
      setLoading(false);
    }
  };

  const resetForm = () => {
    setStudentId('');
    setSelectedItems({ bowl: false, spoon: false, chopsticks: false });
    setView('home');
    setSuccessMessage('');
  };

  // --- ä»‹é¢æ¸²æŸ“ ---

  // 1. é¦–é  (é¸æ“‡èº«ä»½/å‹•ä½œ)
  if (view === 'home') {
    return (
      <div className="min-h-screen bg-amber-50 flex flex-col items-center justify-center p-4 font-sans">
        <div className="bg-white p-8 rounded-3xl shadow-xl w-full max-w-lg text-center border-b-8 border-amber-200">
          <h1 className="text-3xl font-bold text-amber-800 mb-2">
            ğŸ« é¤å…·å€Ÿç”¨ç«™
          </h1>
          <p className="text-gray-500 mb-8">è«‹é¸æ“‡ä½ è¦åšä»€éº¼ï¼Ÿ</p>

          <div className="grid grid-cols-2 gap-6">
            <button
              onClick={() => setView('borrow_auth')}
              className="flex flex-col items-center justify-center bg-green-100 hover:bg-green-200 border-b-4 border-green-300 active:border-b-0 active:translate-y-1 p-6 rounded-2xl transition-all h-48"
            >
              <div className="bg-green-500 text-white p-4 rounded-full mb-3 shadow-md">
                <Utensils size={40} />
              </div>
              <span className="text-2xl font-bold text-green-800">æˆ‘è¦å€Ÿ</span>
            </button>

            <button
              onClick={() => setView('return_auth')}
              className="flex flex-col items-center justify-center bg-blue-100 hover:bg-blue-200 border-b-4 border-blue-300 active:border-b-0 active:translate-y-1 p-6 rounded-2xl transition-all h-48"
            >
              <div className="bg-blue-500 text-white p-4 rounded-full mb-3 shadow-md">
                <LogOut size={40} />
              </div>
              <span className="text-2xl font-bold text-blue-800">æˆ‘è¦é‚„</span>
            </button>
          </div>

          <div className="mt-8 pt-6 border-t border-gray-100">
            <button
              onClick={() => setView('admin')}
              className="text-gray-400 hover:text-gray-600 text-sm flex items-center justify-center gap-1 mx-auto"
            >
              <LayoutList size={14} /> è€å¸«å°ˆç”¨ç®¡ç†å€
            </button>
          </div>
        </div>
      </div>
    );
  }

  // 2. è¼¸å…¥å­¸è™Ÿ (å…±ç”¨)
  if (view === 'borrow_auth' || view === 'return_auth') {
    return (
      <div className="min-h-screen bg-blue-50 flex flex-col items-center justify-center p-4">
        <div className="bg-white p-6 rounded-3xl shadow-xl w-full max-w-md border-b-8 border-blue-200">
          <div className="flex justify-between items-center mb-4">
            <button
              onClick={() => setView('home')}
              className="bg-gray-100 p-2 rounded-full hover:bg-gray-200"
            >
              <ArrowLeft className="text-gray-600" />
            </button>
            <h2 className="text-2xl font-bold text-gray-700">
              {view === 'borrow_auth' ? 'ğŸ‘‹ å€Ÿç”¨ç™»å…¥' : 'ğŸ‘‹ æ­¸é‚„ç™»å…¥'}
            </h2>
            <div className="w-10"></div>
          </div>

          <p className="text-center text-gray-500 mb-4">
            è«‹è¼¸å…¥ä½ çš„ <span className="text-blue-600 font-bold">ç­ç´šåº§è™Ÿ</span>{' '}
            æˆ– <span className="text-blue-600 font-bold">å­¸è™Ÿ</span>
          </p>

          <div className="bg-gray-100 p-4 rounded-xl text-center mb-4">
            <span className="text-4xl font-mono font-bold text-gray-800 tracking-widest min-h-[3rem] block">
              {studentId || <span className="text-gray-300">_ _ _ _</span>}
            </span>
          </div>

          <NumberPad value={studentId} onChange={setStudentId} />

          <button
            onClick={() => {
              if (!studentId) return;
              if (view === 'borrow_auth') setView('borrow_select');
              else checkBorrowsForReturn();
            }}
            disabled={!studentId}
            className={`w-full mt-6 py-4 rounded-xl text-xl font-bold text-white shadow-md transition-all
              ${
                studentId
                  ? 'bg-blue-500 hover:bg-blue-600 border-b-4 border-blue-700 active:translate-y-1 active:border-b-0'
                  : 'bg-gray-300 cursor-not-allowed'
              }`}
          >
            ä¸‹ä¸€æ­¥
          </button>
        </div>
      </div>
    );
  }

  // 3. é¸æ“‡é¤å…· (å€Ÿç”¨)
  if (view === 'borrow_select') {
    return (
      <div className="min-h-screen bg-green-50 flex flex-col items-center justify-center p-4">
        <div className="bg-white p-6 rounded-3xl shadow-xl w-full max-w-md border-b-8 border-green-200">
          <div className="flex justify-between items-center mb-2">
            <button
              onClick={() => setView('borrow_auth')}
              className="bg-gray-100 p-2 rounded-full hover:bg-gray-200"
            >
              <ArrowLeft className="text-gray-600" />
            </button>
            <div className="text-right">
              <span className="block text-xs text-gray-400">åŒå­¸</span>
              <span className="font-bold text-green-700 text-lg">
                {studentId}
              </span>
            </div>
          </div>

          <h2 className="text-2xl font-bold text-center text-gray-800 mb-6">
            ä½ è¦å€Ÿä»€éº¼ï¼Ÿ
          </h2>

          <div className="space-y-4">
            {/* ç¢— */}
            <button
              onClick={() =>
                setSelectedItems({
                  ...selectedItems,
                  bowl: !selectedItems.bowl,
                })
              }
              className={`w-full flex items-center justify-between p-4 rounded-2xl border-2 transition-all ${
                selectedItems.bowl
                  ? 'bg-orange-100 border-orange-500 shadow-md'
                  : 'bg-white border-gray-200 hover:bg-gray-50'
              }`}
            >
              <div className="flex items-center gap-4">
                <div
                  className={`p-3 rounded-full ${
                    selectedItems.bowl
                      ? 'bg-orange-500 text-white'
                      : 'bg-gray-200 text-gray-500'
                  }`}
                >
                  <Disc size={32} />
                </div>
                <span className="text-2xl font-bold text-gray-700">ç¢—</span>
              </div>
              {selectedItems.bowl && (
                <CheckCircle className="text-orange-500" size={32} />
              )}
            </button>

            {/* æ¹¯åŒ™ */}
            <button
              onClick={() =>
                setSelectedItems({
                  ...selectedItems,
                  spoon: !selectedItems.spoon,
                })
              }
              className={`w-full flex items-center justify-between p-4 rounded-2xl border-2 transition-all ${
                selectedItems.spoon
                  ? 'bg-cyan-100 border-cyan-500 shadow-md'
                  : 'bg-white border-gray-200 hover:bg-gray-50'
              }`}
            >
              <div className="flex items-center gap-4">
                <div
                  className={`p-3 rounded-full ${
                    selectedItems.spoon
                      ? 'bg-cyan-500 text-white'
                      : 'bg-gray-200 text-gray-500'
                  }`}
                >
                  <Utensils size={32} className="rotate-90" />
                </div>
                <span className="text-2xl font-bold text-gray-700">æ¹¯åŒ™</span>
              </div>
              {selectedItems.spoon && (
                <CheckCircle className="text-cyan-500" size={32} />
              )}
            </button>

            {/* ç­·å­ */}
            <button
              onClick={() =>
                setSelectedItems({
                  ...selectedItems,
                  chopsticks: !selectedItems.chopsticks,
                })
              }
              className={`w-full flex items-center justify-between p-4 rounded-2xl border-2 transition-all ${
                selectedItems.chopsticks
                  ? 'bg-purple-100 border-purple-500 shadow-md'
                  : 'bg-white border-gray-200 hover:bg-gray-50'
              }`}
            >
              <div className="flex items-center gap-4">
                <div
                  className={`p-3 rounded-full ${
                    selectedItems.chopsticks
                      ? 'bg-purple-500 text-white'
                      : 'bg-gray-200 text-gray-500'
                  }`}
                >
                  <Split size={32} className="rotate-45" />
                </div>
                <span className="text-2xl font-bold text-gray-700">ç­·å­</span>
              </div>
              {selectedItems.chopsticks && (
                <CheckCircle className="text-purple-500" size={32} />
              )}
            </button>
          </div>

          <button
            onClick={handleBorrow}
            disabled={loading}
            className="w-full mt-8 bg-green-500 hover:bg-green-600 text-white text-xl font-bold py-4 rounded-xl shadow-lg border-b-4 border-green-700 active:border-b-0 active:translate-y-1 transition-all"
          >
            {loading ? 'è™•ç†ä¸­...' : 'ç¢ºèªå€Ÿç”¨'}
          </button>
        </div>
      </div>
    );
  }

  // 4. æ­¸é‚„æ¸…å–®
  if (view === 'return_list') {
    return (
      <div className="min-h-screen bg-blue-50 flex flex-col items-center justify-center p-4">
        <div className="bg-white p-6 rounded-3xl shadow-xl w-full max-w-md border-b-8 border-blue-200">
          <div className="flex justify-between items-center mb-4">
            <button
              onClick={() => setView('return_auth')}
              className="bg-gray-100 p-2 rounded-full hover:bg-gray-200"
            >
              <ArrowLeft className="text-gray-600" />
            </button>
            <div className="text-right">
              <span className="block text-xs text-gray-400">åŒå­¸</span>
              <span className="font-bold text-blue-700 text-lg">
                {studentId}
              </span>
            </div>
          </div>

          <h2 className="text-xl font-bold text-center text-gray-800 mb-2">
            æœªæ­¸é‚„é …ç›®
          </h2>
          <p className="text-center text-gray-500 text-sm mb-6">
            é»æ“ŠæŒ‰éˆ•ä¾†æ­¸é‚„
          </p>

          {activeBorrows.length === 0 ? (
            <div className="text-center py-8">
              <p className="text-lg text-gray-600">ç›®å‰æ²’æœ‰å€Ÿç”¨ç´€éŒ„å–”ï¼</p>
              <button
                onClick={resetForm}
                className="mt-4 text-blue-500 font-bold"
              >
                å›é¦–é 
              </button>
            </div>
          ) : (
            <div className="space-y-4 max-h-[60vh] overflow-y-auto">
              {activeBorrows.map((record) => (
                <div
                  key={record.id}
                  className="bg-gray-50 p-4 rounded-xl border border-gray-200 shadow-sm flex items-center justify-between"
                >
                  <div>
                    <div className="flex gap-2 mb-1">
                      {record.items.map((item, idx) => (
                        <span
                          key={idx}
                          className={`px-2 py-1 rounded-md text-sm font-bold 
                          ${
                            item === 'ç¢—'
                              ? 'bg-orange-100 text-orange-700'
                              : item === 'æ¹¯åŒ™'
                              ? 'bg-cyan-100 text-cyan-700'
                              : 'bg-purple-100 text-purple-700'
                          }`}
                        >
                          {item}
                        </span>
                      ))}
                    </div>
                    <div className="flex items-center text-xs text-gray-400">
                      <Clock size={12} className="mr-1" />
                      {new Date(record.borrowTime).toLocaleString('zh-TW', {
                        hour: '2-digit',
                        minute: '2-digit',
                        month: 'numeric',
                        day: 'numeric',
                      })}
                    </div>
                  </div>
                  <button
                    onClick={() => handleReturn(record.id)}
                    disabled={loading}
                    className="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg font-bold shadow-sm active:scale-95 transition-transform"
                  >
                    æ­¸é‚„
                  </button>
                </div>
              ))}
            </div>
          )}
        </div>
      </div>
    );
  }

  // 5. æˆåŠŸç•«é¢
  if (view === 'success') {
    return (
      <div className="min-h-screen bg-green-50 flex flex-col items-center justify-center p-4">
        <div className="bg-white p-8 rounded-full shadow-2xl animate-bounce mb-8">
          <CheckCircle size={80} className="text-green-500" />
        </div>
        <h2 className="text-3xl font-bold text-green-800 text-center mb-4 animate-pulse">
          å®Œæˆï¼
        </h2>
        <p className="text-xl text-gray-600 text-center max-w-xs">
          {successMessage}
        </p>
        <p className="mt-8 text-gray-400 text-sm">3ç§’å¾Œè‡ªå‹•å›é¦–é ...</p>
        <button
          onClick={resetForm}
          className="mt-4 px-6 py-2 bg-gray-200 rounded-full text-gray-600"
        >
          ç«‹å³è¿”å›
        </button>
      </div>
    );
  }

  // 6. ç®¡ç†è€…å¾Œå°
  if (view === 'admin') {
    return (
      <div className="min-h-screen bg-gray-100 p-6">
        <div className="max-w-4xl mx-auto">
          <div className="flex justify-between items-center mb-6">
            <div className="flex items-center gap-3">
              <button
                onClick={resetForm}
                className="bg-white p-2 rounded-lg shadow hover:bg-gray-50"
              >
                <ArrowLeft className="text-gray-600" />
              </button>
              <h1 className="text-2xl font-bold text-gray-800">
                ğŸ“Š å­¸å‹™è™•ç®¡ç†å¾Œå°
              </h1>
            </div>
            <div className="bg-white px-4 py-2 rounded-lg shadow text-sm font-bold text-red-500">
              æœªæ­¸é‚„ç¸½æ•¸: {allActiveBorrows.length} ç­†
            </div>
          </div>

          <div className="bg-white rounded-2xl shadow-sm overflow-hidden">
            <div className="overflow-x-auto">
              <table className="w-full text-left">
                <thead className="bg-gray-50 border-b border-gray-100">
                  <tr>
                    <th className="p-4 text-sm font-semibold text-gray-600">
                      å­¸è™Ÿ/åº§è™Ÿ
                    </th>
                    <th className="p-4 text-sm font-semibold text-gray-600">
                      å€Ÿç”¨ç‰©å“
                    </th>
                    <th className="p-4 text-sm font-semibold text-gray-600">
                      å€Ÿç”¨æ™‚é–“
                    </th>
                    <th className="p-4 text-sm font-semibold text-gray-600">
                      ç‹€æ…‹
                    </th>
                    <th className="p-4 text-sm font-semibold text-gray-600">
                      æ“ä½œ
                    </th>
                  </tr>
                </thead>
                <tbody className="divide-y divide-gray-100">
                  {allActiveBorrows.length === 0 ? (
                    <tr>
                      <td colSpan="5" className="p-8 text-center text-gray-400">
                        ç›®å‰æ²’æœ‰æœªæ­¸é‚„çš„é¤å…· ğŸ‰
                      </td>
                    </tr>
                  ) : (
                    allActiveBorrows.map((record) => (
                      <tr key={record.id} className="hover:bg-gray-50">
                        <td className="p-4 font-bold text-gray-800">
                          {record.studentId}
                        </td>
                        <td className="p-4">
                          <div className="flex gap-1">
                            {record.items.map((item, i) => (
                              <span
                                key={i}
                                className="bg-gray-100 text-gray-600 text-xs px-2 py-1 rounded"
                              >
                                {item}
                              </span>
                            ))}
                          </div>
                        </td>
                        <td className="p-4 text-sm text-gray-500">
                          {new Date(record.borrowTime).toLocaleString('zh-TW')}
                        </td>
                        <td className="p-4">
                          <span className="bg-red-100 text-red-600 text-xs px-2 py-1 rounded-full font-bold">
                            å€Ÿç”¨ä¸­
                          </span>
                        </td>
                        <td className="p-4">
                          <button
                            onClick={() => handleReturn(record.id)}
                            className="text-blue-500 hover:text-blue-700 text-sm font-bold"
                          >
                            å¼·åˆ¶æ­¸é‚„
                          </button>
                        </td>
                      </tr>
                    ))
                  )}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    );
  }

  return <div>Loading...</div>;
}
